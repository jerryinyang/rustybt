
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Modern Python backtesting engine built on Zipline-Reloaded">
      
      
        <meta name="author" content="RustyBT Development Team">
      
      
        <link rel="canonical" href="https://jerryinyang.github.io/rustybt/architecture/live-trading/">
      
      
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Live Trading Engine Architecture - RustyBT Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#live-trading-engine-architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="RustyBT Documentation" class="md-header__button md-logo" aria-label="RustyBT Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RustyBT Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Live Trading Engine Architecture
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jerryinyang/rustybt" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    jerryinyang/rustybt
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting-started/installation/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../guides/decimal-precision-configuration/" class="md-tabs__link">
          
  
  
  User Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/" class="md-tabs__link">
          
  
  
  Examples & Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/data-management/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../about/license/" class="md-tabs__link">
          
  
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="RustyBT Documentation" class="md-nav__button md-logo" aria-label="RustyBT Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    RustyBT Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jerryinyang/rustybt" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    jerryinyang/rustybt
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            User Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/decimal-precision-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Decimal Precision
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/caching-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Caching System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/creating-data-adapters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating Data Adapters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/csv-data-import/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CSV Data Import
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/testnet-setup-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testnet Setup
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples & Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Examples & Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Data Management
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Data Management
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1_2" >
        
          
          <label class="md-nav__link" for="__nav_5_1_2" id="__nav_5_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Adapters
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_2">
            <span class="md-nav__icon md-icon"></span>
            Adapters
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/adapters/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/adapters/ccxt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CCXT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/adapters/yfinance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    YFinance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/adapters/csv/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CSV
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/adapters/polygon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Polygon
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/adapters/alpaca/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Alpaca
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/adapters/alphavantage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AlphaVantage
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1_3" >
        
          
          <label class="md-nav__link" for="__nav_5_1_3" id="__nav_5_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Catalog
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_3">
            <span class="md-nav__icon md-icon"></span>
            Catalog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/catalog/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/catalog/bundles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bundles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/catalog/metadata/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metadata
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/catalog/migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1_4" >
        
          
          <label class="md-nav__link" for="__nav_5_1_4" id="__nav_5_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Readers
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_4">
            <span class="md-nav__icon md-icon"></span>
            Readers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/readers/data-portal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Portal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/readers/bar-readers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bar Readers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/readers/history-loader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    History Loader
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/readers/continuous-futures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Continuous Futures
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1_5" >
        
          
          <label class="md-nav__link" for="__nav_5_1_5" id="__nav_5_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    FX System
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_5">
            <span class="md-nav__icon md-icon"></span>
            FX System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/fx/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/fx/providers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Providers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/fx/storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/fx/converters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Converters
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1_6" >
        
          
          <label class="md-nav__link" for="__nav_5_1_6" id="__nav_5_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_6">
            <span class="md-nav__icon md-icon"></span>
            Pipeline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/pipeline/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/pipeline/factors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Factors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/pipeline/filters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Filters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/pipeline/loaders/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Loaders
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/pipeline/expressions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Expressions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1_7" >
        
          
          <label class="md-nav__link" for="__nav_5_1_7" id="__nav_5_1_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Performance
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_7">
            <span class="md-nav__icon md-icon"></span>
            Performance
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/performance/caching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Caching
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/performance/optimization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Optimization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data-management/performance/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Order Management
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Order Management
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/order-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/order-management/order-types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Order Types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_3" >
        
          
          <label class="md-nav__link" for="__nav_5_2_3" id="__nav_5_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Execution
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_3">
            <span class="md-nav__icon md-icon"></span>
            Execution
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/order-management/execution/blotter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blotter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_4" >
        
          
          <label class="md-nav__link" for="__nav_5_2_4" id="__nav_5_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Transaction Costs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_4">
            <span class="md-nav__icon md-icon"></span>
            Transaction Costs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/order-management/transaction-costs/slippage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Slippage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/order-management/transaction-costs/commissions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commissions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/order-management/transaction-costs/borrow-costs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Borrow Costs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/order-management/transaction-costs/financing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Financing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_5" >
        
          
          <label class="md-nav__link" for="__nav_5_2_5" id="__nav_5_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Workflows
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_5">
            <span class="md-nav__icon md-icon"></span>
            Workflows
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/order-management/workflows/order-lifecycle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Order Lifecycle
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/order-management/workflows/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Portfolio Management
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Portfolio Management
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/portfolio-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3_2" >
        
          
          <label class="md-nav__link" for="__nav_5_3_2" id="__nav_5_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Multi-Strategy
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_2">
            <span class="md-nav__icon md-icon"></span>
            Multi-Strategy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/portfolio-management/multi-strategy/allocators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Allocators
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3_3" id="__nav_5_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Risk
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_3">
            <span class="md-nav__icon md-icon"></span>
            Risk
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/portfolio-management/risk/position-limits/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Position Limits
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3_4" >
        
          
          <label class="md-nav__link" for="__nav_5_3_4" id="__nav_5_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Performance
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_4">
            <span class="md-nav__icon md-icon"></span>
            Performance
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/portfolio-management/performance/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Optimization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            Optimization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4_2" >
        
          
          <label class="md-nav__link" for="__nav_5_4_2" id="__nav_5_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Framework
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_2">
            <span class="md-nav__icon md-icon"></span>
            Framework
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/framework/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/framework/parameter-spaces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parameter Spaces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/framework/objective-functions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Objective Functions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4_3" >
        
          
          <label class="md-nav__link" for="__nav_5_4_3" id="__nav_5_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_3">
            <span class="md-nav__icon md-icon"></span>
            Algorithms
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/algorithms/grid-search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Grid Search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/algorithms/random-search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Random Search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/algorithms/bayesian/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bayesian
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/algorithms/genetic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Genetic
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4_4" id="__nav_5_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Walk-Forward
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_4">
            <span class="md-nav__icon md-icon"></span>
            Walk-Forward
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/walk-forward/framework/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Framework
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/walk-forward/windows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Windows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/walk-forward/validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4_5" >
        
          
          <label class="md-nav__link" for="__nav_5_4_5" id="__nav_5_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Monte Carlo
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_5">
            <span class="md-nav__icon md-icon"></span>
            Monte Carlo
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/monte-carlo/stability-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stability Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4_6" >
        
          
          <label class="md-nav__link" for="__nav_5_4_6" id="__nav_5_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Parallel
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_6">
            <span class="md-nav__icon md-icon"></span>
            Parallel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/parallel/multiprocessing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multiprocessing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4_7" >
        
          
          <label class="md-nav__link" for="__nav_5_4_7" id="__nav_5_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Best Practices
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_7">
            <span class="md-nav__icon md-icon"></span>
            Best Practices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization/best-practices/overfitting-prevention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overfitting Prevention
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Analytics
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Analytics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/analytics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_5_2" id="__nav_5_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Risk
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5_2">
            <span class="md-nav__icon md-icon"></span>
            Risk
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/analytics/risk/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/analytics/risk/var-cvar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VaR & CVaR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/analytics/risk/drawdown/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Drawdown
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Live Trading
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            Live Trading
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/live-trading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6_2" >
        
          
          <label class="md-nav__link" for="__nav_5_6_2" id="__nav_5_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Safety
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_2">
            <span class="md-nav__icon md-icon"></span>
            Safety
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/live-trading/safety/circuit-breakers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Circuit Breakers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Overview Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            API Overview Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/datasource-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Datasource API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/finance-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Finance API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimization-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Optimization API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/live-trading-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Live Trading API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/analytics-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Analytics API
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    About
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            About
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    License
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#design-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Design Principles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-context-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      System Context Diagram
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shadow-trading-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Shadow Trading Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-components" class="md-nav__link">
    <span class="md-ellipsis">
      Core Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-livetradingengine" class="md-nav__link">
    <span class="md-ellipsis">
      1. LiveTradingEngine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-brokeradapter-abstract-base" class="md-nav__link">
    <span class="md-ellipsis">
      2. BrokerAdapter (Abstract Base)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-ordermanager" class="md-nav__link">
    <span class="md-ellipsis">
      3. OrderManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-datafeed" class="md-nav__link">
    <span class="md-ellipsis">
      4. DataFeed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-statemanager" class="md-nav__link">
    <span class="md-ellipsis">
      5. StateManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-positionreconciler" class="md-nav__link">
    <span class="md-ellipsis">
      6. PositionReconciler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-websocket-streaming-adapters" class="md-nav__link">
    <span class="md-ellipsis">
      7. WebSocket Streaming Adapters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-tradingscheduler" class="md-nav__link">
    <span class="md-ellipsis">
      8. TradingScheduler
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event-system-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Event System Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Event System Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-types" class="md-nav__link">
    <span class="md-ellipsis">
      Event Types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-schema-pydantic-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Event Schema (Pydantic Validation)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-priority-queue" class="md-nav__link">
    <span class="md-ellipsis">
      Event Priority Queue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-flow-sequence-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      Event Flow Sequence Diagram
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asyncawait-concurrency-model" class="md-nav__link">
    <span class="md-ellipsis">
      Async/Await Concurrency Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Async/Await Concurrency Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asyncio-usage-for-io-bound-operations" class="md-nav__link">
    <span class="md-ellipsis">
      Asyncio Usage for I/O-Bound Operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threading-for-cpu-bound-operations" class="md-nav__link">
    <span class="md-ellipsis">
      Threading for CPU-Bound Operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-safe-state-access" class="md-nav__link">
    <span class="md-ellipsis">
      Thread-Safe State Access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-group-pattern-for-concurrent-operations" class="md-nav__link">
    <span class="md-ellipsis">
      Task Group Pattern for Concurrent Operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#race-condition-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      Race Condition Prevention
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#state-persistence-and-crash-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      State Persistence and Crash Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Persistence and Crash Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpoint-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoint Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint-frequency-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoint Frequency Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage-format" class="md-nav__link">
    <span class="md-ellipsis">
      Storage Format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atomic-write-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Atomic Write Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-restoration-procedure" class="md-nav__link">
    <span class="md-ellipsis">
      State Restoration Procedure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#position-reconciliation" class="md-nav__link">
    <span class="md-ellipsis">
      Position Reconciliation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crash-recovery-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Crash Recovery Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling-and-retry-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling and Retry Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling and Retry Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#error-classification" class="md-nav__link">
    <span class="md-ellipsis">
      Error Classification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-logic-with-exponential-backoff" class="md-nav__link">
    <span class="md-ellipsis">
      Retry Logic with Exponential Backoff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#circuit-breaker-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Circuit Breaker Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graceful-degradation-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Graceful Degradation Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timeout-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Timeout Strategies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-propagation-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Error Propagation Strategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-alerting" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Alerting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring and Alerting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitoring-event-hooks" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring Event Hooks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metric-emission-points" class="md-nav__link">
    <span class="md-ellipsis">
      Metric Emission Points
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alerting-triggers" class="md-nav__link">
    <span class="md-ellipsis">
      Alerting Triggers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-points-for-external-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Points for External Monitoring
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#health-check-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Health Check Endpoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shadow-trading-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Shadow Trading Validation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shadow Trading Validation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-components" class="md-nav__link">
    <span class="md-ellipsis">
      Key Components
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alignment-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      Alignment Metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-example" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategy-reusability-guarantee" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy Reusability Guarantee
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategy Reusability Guarantee">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-contract" class="md-nav__link">
    <span class="md-ellipsis">
      The Contract
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-single-strategy-multiple-execution-modes" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Single Strategy, Multiple Execution Modes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mandatory-strategy-api" class="md-nav__link">
    <span class="md-ellipsis">
      Mandatory Strategy API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context-api-compatibility" class="md-nav__link">
    <span class="md-ellipsis">
      Context API Compatibility
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared-components" class="md-nav__link">
    <span class="md-ellipsis">
      Shared Components
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-and-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration and Deployment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration and Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration-file-example" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration File Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Docker Deployment
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-targets" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Targets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Targets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#latency-targets" class="md-nav__link">
    <span class="md-ellipsis">
      Latency Targets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throughput-targets" class="md-nav__link">
    <span class="md-ellipsis">
      Throughput Targets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resource-usage-targets" class="md-nav__link">
    <span class="md-ellipsis">
      Resource Usage Targets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalability-limits" class="md-nav__link">
    <span class="md-ellipsis">
      Scalability Limits
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-review-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture Review Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture Review Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#production-readiness-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Production Readiness Checklist
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-findings" class="md-nav__link">
    <span class="md-ellipsis">
      Review Findings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paper-trading-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Paper Trading Mode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Paper Trading Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-with-strategy-reusability-guarantee" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with Strategy Reusability Guarantee
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validation-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Validation Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limitations" class="md-nav__link">
    <span class="md-ellipsis">
      Limitations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#files" class="md-nav__link">
    <span class="md-ellipsis">
      Files
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Next Steps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interactive-brokers-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Interactive Brokers Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interactive Brokers Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_2" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#design-decision-ib-async-vs-custom-tws-api" class="md-nav__link">
    <span class="md-ellipsis">
      Design Decision: ib-async vs Custom TWS API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Setup Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#twsib-gateway-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TWS/IB Gateway Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Python Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supported-features" class="md-nav__link">
    <span class="md-ellipsis">
      Supported Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Supported Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asset-types" class="md-nav__link">
    <span class="md-ellipsis">
      Asset Types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-types" class="md-nav__link">
    <span class="md-ellipsis">
      Order Types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-information" class="md-nav__link">
    <span class="md-ellipsis">
      Account Information
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#position-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Position Queries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-ib-error-codes" class="md-nav__link">
    <span class="md-ellipsis">
      Common IB Error Codes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Retry Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-loss-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Connection Loss Handling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limits" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing_1" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Unit Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Characteristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Production Deployment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Production Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recommended-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Recommended Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#high-availability-setup" class="md-nav__link">
    <span class="md-ellipsis">
      High Availability Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cannot-connect-to-tws-error-502" class="md-nav__link">
    <span class="md-ellipsis">
      "Cannot connect to TWS" (Error 502)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-rejected-error-201" class="md-nav__link">
    <span class="md-ellipsis">
      "Order rejected" (Error 201)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#duplicate-order-id-error-103" class="md-nav__link">
    <span class="md-ellipsis">
      "Duplicate order ID" (Error 103)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Example Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Enhancements
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-api-provider-adapters" class="md-nav__link">
    <span class="md-ellipsis">
      Data API Provider Adapters
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data API Provider Adapters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_3" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supported-providers" class="md-nav__link">
    <span class="md-ellipsis">
      Supported Providers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Supported Providers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#polygonio" class="md-nav__link">
    <span class="md-ellipsis">
      Polygon.io
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alpaca-markets" class="md-nav__link">
    <span class="md-ellipsis">
      Alpaca Markets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alpha-vantage" class="md-nav__link">
    <span class="md-ellipsis">
      Alpha Vantage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-key-management" class="md-nav__link">
    <span class="md-ellipsis">
      API Key Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Key Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-variables-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Environment Variables (Recommended)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-file-alternative" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration File (Alternative)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limiting" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling_1" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing_2" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests_1" class="md-nav__link">
    <span class="md-ellipsis">
      Unit Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-tests_1" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting_1" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-issues" class="md-nav__link">
    <span class="md-ellipsis">
      Common Issues
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    <span class="md-ellipsis">
      Debugging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#circuit-breakers-and-risk-management" class="md-nav__link">
    <span class="md-ellipsis">
      Circuit Breakers and Risk Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Circuit Breakers and Risk Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_4" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#circuit-breaker-types" class="md-nav__link">
    <span class="md-ellipsis">
      Circuit Breaker Types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Circuit Breaker Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-drawdown-circuit-breaker" class="md-nav__link">
    <span class="md-ellipsis">
      1. Drawdown Circuit Breaker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-daily-loss-circuit-breaker" class="md-nav__link">
    <span class="md-ellipsis">
      2. Daily Loss Circuit Breaker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-order-rate-circuit-breaker" class="md-nav__link">
    <span class="md-ellipsis">
      3. Order Rate Circuit Breaker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-error-rate-circuit-breaker" class="md-nav__link">
    <span class="md-ellipsis">
      4. Error Rate Circuit Breaker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-manual-circuit-breaker" class="md-nav__link">
    <span class="md-ellipsis">
      5. Manual Circuit Breaker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#circuit-breaker-states" class="md-nav__link">
    <span class="md-ellipsis">
      Circuit Breaker States
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#circuit-breaker-manager" class="md-nav__link">
    <span class="md-ellipsis">
      Circuit Breaker Manager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alert-system" class="md-nav__link">
    <span class="md-ellipsis">
      Alert System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Alert System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alert-channels" class="md-nav__link">
    <span class="md-ellipsis">
      Alert Channels
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limiting_1" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security" class="md-nav__link">
    <span class="md-ellipsis">
      Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring Dashboard
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-with-livetradingengine" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with LiveTradingEngine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risk-profile-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Risk Profile Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Risk Profile Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conservative-low-risk-tolerance" class="md-nav__link">
    <span class="md-ellipsis">
      Conservative (Low Risk Tolerance)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#moderate-balanced-risk" class="md-nav__link">
    <span class="md-ellipsis">
      Moderate (Balanced Risk)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggressive-high-risk-tolerance" class="md-nav__link">
    <span class="md-ellipsis">
      Aggressive (High Risk Tolerance)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting_2" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#circuit-breaker-not-tripping" class="md-nav__link">
    <span class="md-ellipsis">
      Circuit Breaker Not Tripping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#false-positive-trips" class="md-nav__link">
    <span class="md-ellipsis">
      False Positive Trips
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alerts-not-delivered" class="md-nav__link">
    <span class="md-ellipsis">
      Alerts Not Delivered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-halt-not-working" class="md-nav__link">
    <span class="md-ellipsis">
      Manual Halt Not Working
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="live-trading-engine-architecture">Live Trading Engine Architecture<a class="headerlink" href="#live-trading-engine-architecture" title="Permanent link">&para;</a></h1>
<p><strong>Version:</strong> 1.0
<strong>Date:</strong> 2025-10-03
<strong>Author:</strong> James (Developer)
<strong>Status:</strong> Approved - Ready for Implementation</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#core-components">Core Components</a></li>
<li><a href="#event-system-architecture">Event System Architecture</a></li>
<li><a href="#asyncawait-concurrency-model">Async/Await Concurrency Model</a></li>
<li><a href="#state-persistence-and-crash-recovery">State Persistence and Crash Recovery</a></li>
<li><a href="#error-handling-and-retry-strategy">Error Handling and Retry Strategy</a></li>
<li><a href="#monitoring-and-alerting">Monitoring and Alerting</a></li>
<li><a href="#shadow-trading-validation">Shadow Trading Validation</a></li>
<li><a href="#strategy-reusability-guarantee">Strategy Reusability Guarantee</a></li>
<li><a href="#configuration-and-deployment">Configuration and Deployment</a></li>
<li><a href="#performance-targets">Performance Targets</a></li>
<li><a href="#architecture-review-summary">Architecture Review Summary</a></li>
</ol>
<hr />
<h2 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">&para;</a></h2>
<h3 id="design-principles">Design Principles<a class="headerlink" href="#design-principles" title="Permanent link">&para;</a></h3>
<p>The RustyBT Live Trading Engine follows these core principles:</p>
<ol>
<li><strong>Event-Driven Architecture</strong>: All market data, order fills, and system events flow through a prioritized event loop</li>
<li><strong>Async-First Design</strong>: All I/O-bound operations (broker API calls, data fetching) use asyncio</li>
<li><strong>Strategy Reusability</strong>: Same <code>TradingAlgorithm</code> code runs in backtest, paper trading, and live modes without modification</li>
<li><strong>Defensive Programming</strong>: Circuit breakers, retry logic, and graceful degradation prevent cascading failures</li>
<li><strong>Continuous Validation</strong>: Shadow trading framework validates backtest-live alignment during production</li>
<li><strong>Crash Recovery</strong>: Checkpoint-based state persistence enables resume-from-failure</li>
<li><strong>Production-Ready Monitoring</strong>: Structured logging, metrics emission, and health checks built-in</li>
</ol>
<h3 id="system-context-diagram">System Context Diagram<a class="headerlink" href="#system-context-diagram" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>┌──────────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>│                        Live Trading System                                │
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>├──────────────────────────────────────────────────────────────────────────┤
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>│                                                                            │
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>│  ┌─────────────────────┐        ┌──────────────────────┐                 │
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>│  │   User Strategy     │        │  LiveTradingEngine   │                 │
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>│  │  (TradingAlgorithm) │◄───────┤   (Orchestrator)     │                 │
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>│  └─────────────────────┘        └──────────────────────┘                 │
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>│            │                              │                               │
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>│            │                              │                               │
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>│            ▼                              ▼                               │
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>│  ┌─────────────────────┐        ┌──────────────────────┐                 │
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>│  │   Context/Data      │        │   Event Loop         │                 │
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>│  │   (Unified API)     │        │  (asyncio.Queue)     │                 │
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>│  └─────────────────────┘        └──────────────────────┘                 │
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>│            │                              │                               │
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>│            │                              │                               │
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>│  ┌─────────┴──────────┬─────────────────┴──────────┬────────────────┐   │
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>│  │                    │                             │                 │   │
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>│  ▼                    ▼                             ▼                 ▼   │
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>│ ┌────────────┐ ┌──────────────┐ ┌──────────────┐ ┌─────────────────┐   │
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>│ │DataFeed    │ │OrderManager  │ │StateManager  │ │Scheduler        │   │
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>│ │(MarketData)│ │(Lifecycle)   │ │(Checkpoint)  │ │(APScheduler)    │   │
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>│ └────────────┘ └──────────────┘ └──────────────┘ └─────────────────┘   │
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>│       │                │                 │                │              │
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>│       │                │                 │                │              │
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>│       └────────────────┴─────────────────┴────────────────┘              │
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>│                        │                                                  │
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>│                        ▼                                                  │
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>│              ┌─────────────────────┐                                     │
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>│              │   BrokerAdapter     │                                     │
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>│              │  (Abstract Base)    │                                     │
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>│              └─────────────────────┘                                     │
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>│                        │                                                  │
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>│       ┌────────────────┼────────────────┐                                │
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>│       │                │                │                                │
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>│       ▼                ▼                ▼                                │
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>│  ┌─────────┐   ┌──────────┐   ┌──────────────┐                          │
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>│  │CCXT     │   │IB        │   │PaperBroker   │                          │
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>│  │Adapter  │   │Adapter   │   │(Simulated)   │                          │
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>│  └─────────┘   └──────────┘   └──────────────┘                          │
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>│       │              │                 │                                 │
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>└───────┼──────────────┼─────────────────┼─────────────────────────────────┘
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        │              │                 │
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        ▼              ▼                 ▼
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>┌────────────┐  ┌──────────────┐  ┌──────────────┐
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>│Binance     │  │Interactive   │  │In-Memory     │
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>│Bybit       │  │Brokers       │  │Simulation    │
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>│Hyperliquid │  │(TWS/Gateway) │  │              │
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>└────────────┘  └──────────────┘  └──────────────┘
</code></pre></div>
<h3 id="shadow-trading-integration">Shadow Trading Integration<a class="headerlink" href="#shadow-trading-integration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>┌───────────────────────────────────────────────────────────────────────┐
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>│                     Shadow Trading Validation                         │
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>├───────────────────────────────────────────────────────────────────────┤
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>│                                                                         │
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>│                    Live Market Data Feed                                │
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>│                            │                                            │
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>│           ┌────────────────┼────────────────┐                          │
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>│           │                │                │                          │
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>│           ▼                ▼                ▼                          │
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>│  ┌────────────────┐ ┌─────────────┐ ┌──────────────────┐              │
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>│  │LiveTradingEngine│ │Shadow       │ │SignalAlignment   │              │
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>│  │(Real Broker)    │ │BacktestEngine│ │Validator         │              │
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>│  └────────────────┘ └─────────────┘ └──────────────────┘              │
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>│           │                │                │                          │
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>│           │                │                │                          │
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>│           ▼                ▼                ▼                          │
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>│  ┌────────────────┐ ┌─────────────┐ ┌──────────────────┐              │
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>│  │Real Broker     │ │Simulated    │ │ExecutionQuality  │              │
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>│  │Orders/Fills    │ │Fills        │ │Tracker           │              │
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>│  └────────────────┘ └─────────────┘ └──────────────────┘              │
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>│                                              │                          │
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>│                                              ▼                          │
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>│                                     ┌──────────────────┐                │
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>│                                     │AlignmentCircuit  │                │
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>│                                     │Breaker           │                │
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>│                                     └──────────────────┘                │
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>│                                              │                          │
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>│                                              ▼                          │
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>│                                     Halt Trading if                     │
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>│                                     Alignment &lt; Threshold               │
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>└───────────────────────────────────────────────────────────────────────┘
</code></pre></div>
<hr />
<h2 id="core-components">Core Components<a class="headerlink" href="#core-components" title="Permanent link">&para;</a></h2>
<h3 id="1-livetradingengine">1. LiveTradingEngine<a class="headerlink" href="#1-livetradingengine" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Main orchestrator for live trading execution</p>
<p><strong>Location:</strong> <code>rustybt/live/engine.py</code></p>
<p><strong>Key Responsibilities:</strong>
- Initialize broker connections via <code>BrokerAdapter</code>
- Manage asyncio event loop for event processing
- Coordinate between user strategy and broker
- Execute scheduled calculations (market triggers)
- Handle order lifecycle (submit → fill/cancel/reject)
- Checkpoint strategy state via <code>StateManager</code>
- Reconcile positions with broker via <code>PositionReconciler</code>
- Optionally run <code>ShadowBacktestEngine</code> for validation</p>
<p><strong>Class Signature:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">import</span> <span class="nn">asyncio</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span> <span class="nn">rustybt.algorithm</span> <span class="kn">import</span> <span class="n">TradingAlgorithm</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kn">from</span> <span class="nn">rustybt.live.brokers.base</span> <span class="kn">import</span> <span class="n">BrokerAdapter</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="kn">from</span> <span class="nn">rustybt.live.state_manager</span> <span class="kn">import</span> <span class="n">StateManager</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="kn">from</span> <span class="nn">rustybt.live.reconciler</span> <span class="kn">import</span> <span class="n">PositionReconciler</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="kn">from</span> <span class="nn">rustybt.live.scheduler</span> <span class="kn">import</span> <span class="n">TradingScheduler</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="kn">from</span> <span class="nn">rustybt.data.polars.data_portal</span> <span class="kn">import</span> <span class="n">PolarsDataPortal</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="k">class</span> <span class="nc">LiveTradingEngine</span><span class="p">:</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Event-driven live trading engine with async I/O.&quot;&quot;&quot;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="n">strategy</span><span class="p">:</span> <span class="n">TradingAlgorithm</span><span class="p">,</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>        <span class="n">broker</span><span class="p">:</span> <span class="n">BrokerAdapter</span><span class="p">,</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="n">capital_base</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>        <span class="n">data_portal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PolarsDataPortal</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>        <span class="n">shadow_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>        <span class="n">checkpoint_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>  <span class="c1"># seconds</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>        <span class="n">state_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>    <span class="p">):</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize live trading engine.</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="sd">        Args:</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="sd">            strategy: User strategy (TradingAlgorithm subclass)</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="sd">            broker: Broker adapter for order execution</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="sd">            capital_base: Starting capital</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="sd">            data_portal: Data access layer (optional, can use broker data)</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="sd">            shadow_mode: Enable shadow trading validation</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="sd">            checkpoint_interval: State checkpoint frequency (seconds)</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="sd">            state_file: Path to state checkpoint file</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">broker</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">capital_base</span> <span class="o">=</span> <span class="n">capital_base</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span> <span class="o">=</span> <span class="n">data_portal</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_broker_data_portal</span><span class="p">()</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>        <span class="c1"># Core components</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span> <span class="o">=</span> <span class="n">StateManager</span><span class="p">(</span><span class="n">state_file</span><span class="p">)</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">position_reconciler</span> <span class="o">=</span> <span class="n">PositionReconciler</span><span class="p">(</span><span class="n">broker</span><span class="p">)</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">TradingScheduler</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">PriorityQueue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">PriorityQueue</span><span class="p">()</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>        <span class="c1"># Shadow trading components (optional)</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shadow_mode</span> <span class="o">=</span> <span class="n">shadow_mode</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shadow_engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ShadowBacktestEngine</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>        <span class="k">if</span> <span class="n">shadow_mode</span><span class="p">:</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_shadow_engine</span><span class="p">()</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>        <span class="c1"># State</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main event loop.&quot;&quot;&quot;</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting live trading engine&quot;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>        <span class="c1"># Load saved state if exists</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_state</span><span class="p">()</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>        <span class="c1"># Initialize strategy</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_strategy</span><span class="p">()</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>        <span class="c1"># Schedule strategy triggers</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_triggers</span><span class="p">()</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>        <span class="c1"># Start broker connection</span>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a>        <span class="c1"># Subscribe to market data</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subscribe_market_data</span><span class="p">()</span>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a>        <span class="c1"># Start checkpoint task</span>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_loop</span><span class="p">())</span>
<a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a>
<a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a>        <span class="c1"># Start shadow engine if enabled</span>
<a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shadow_mode</span><span class="p">:</span>
<a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a>            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shadow_engine</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>
<a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a>
<a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a>        <span class="c1"># Main event loop</span>
<a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a>            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
<a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a>                <span class="n">event</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Engine crashed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emergency_checkpoint</span><span class="p">()</span>
<a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a>            <span class="k">raise</span>
<a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span><span class="p">()</span>
<a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a>
<a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_process_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
<a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process single event from queue.&quot;&quot;&quot;</span>
<a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a>        <span class="n">event_type</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
<a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a>
<a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;MarketData&#39;</span><span class="p">:</span>
<a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_market_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;OrderFill&#39;</span><span class="p">:</span>
<a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_order_fill</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;OrderReject&#39;</span><span class="p">:</span>
<a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_order_reject</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;ScheduledTrigger&#39;</span><span class="p">:</span>
<a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_scheduled_trigger</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a>        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;SystemError&#39;</span><span class="p">:</span>
<a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_system_error</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown event type&quot;</span><span class="p">,</span> <span class="n">event_type</span><span class="o">=</span><span class="n">event_type</span><span class="p">)</span>
<a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>
<a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gracefully shutdown engine.&quot;&quot;&quot;</span>
<a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shutting down live trading engine&quot;</span><span class="p">)</span>
<a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_state_snapshot</span><span class="p">())</span>
<a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</code></pre></div>
<p><strong>Event Processing Flow:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Broker/Scheduler → Event Queue (Priority) → Event Dispatcher → Event Handlers
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>                                              ├─ MarketData → strategy.handle_data()
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>                                              ├─ OrderFill → update_position()
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>                                              ├─ OrderReject → log_rejection()
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>                                              ├─ ScheduledTrigger → before_trading_start()
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>                                              └─ SystemError → handle_error()
</code></pre></div>
<hr />
<h3 id="2-brokeradapter-abstract-base">2. BrokerAdapter (Abstract Base)<a class="headerlink" href="#2-brokeradapter-abstract-base" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Standardized interface for broker integrations</p>
<p><strong>Location:</strong> <code>rustybt/live/brokers/base.py</code></p>
<p><strong>Interface:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span> <span class="nn">rustybt.assets.assets</span> <span class="kn">import</span> <span class="n">Asset</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">class</span> <span class="nc">BrokerAdapter</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for broker integrations.&quot;&quot;&quot;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish connection to broker API.</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="sd">        Args:</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="sd">            credentials: API keys, secrets (optional if set via env vars)</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="sd">        Returns:</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="sd">            True if connection successful</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="sd">        Raises:</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="sd">            BrokerConnectionError: If connection fails</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_order</span><span class="p">(</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="n">asset</span><span class="p">:</span> <span class="n">Asset</span><span class="p">,</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="n">order_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;market&quot;</span><span class="p">,</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>        <span class="n">limit_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Decimal</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="n">stop_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Decimal</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>        <span class="n">time_in_force</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gtc&quot;</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Submit order to broker.</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="sd">        Args:</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="sd">            asset: Asset to trade</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="sd">            amount: Quantity (positive=buy, negative=sell)</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="sd">            order_type: &#39;market&#39;, &#39;limit&#39;, &#39;stop&#39;, &#39;stop-limit&#39;</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="sd">            limit_price: Limit price for limit/stop-limit orders</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="sd">            stop_price: Stop price for stop/stop-limit orders</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="sd">            time_in_force: &#39;gtc&#39;, &#39;day&#39;, &#39;ioc&#39;, &#39;fok&#39;</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a><span class="sd">        Returns:</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="sd">            Broker order ID (string)</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="sd">        Raises:</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="sd">            BrokerError: If submission fails</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="sd">            OrderRejectedError: If order rejected by broker</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker_order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel pending order.</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a><span class="sd">        Args:</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a><span class="sd">            broker_order_id: Broker&#39;s order ID</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a><span class="sd">        Returns:</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a><span class="sd">            True if cancellation successful</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a><span class="sd">        Raises:</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a><span class="sd">            BrokerError: If cancellation fails</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]]:</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch current positions from broker.</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a><span class="sd">        Returns:</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a><span class="sd">            List of position dicts with keys:</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a><span class="sd">            - asset: Asset object</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a><span class="sd">            - amount: Position size (Decimal)</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a><span class="sd">            - market_value: Current market value</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a><span class="sd">            - cost_basis: Average cost basis</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch open orders from broker.</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a><span class="sd">        Returns:</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a><span class="sd">            List of order dicts with keys:</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a><span class="sd">            - order_id: Broker order ID</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a><span class="sd">            - asset: Asset object</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a><span class="sd">            - amount: Order quantity</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a><span class="sd">            - order_type: Order type</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a><span class="sd">            - limit_price: Limit price (if applicable)</span>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a><span class="sd">            - status: &#39;pending&#39;, &#39;partial&#39;</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_account_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch account balance and margin info.</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a><span class="sd">        Returns:</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a><span class="sd">            Dict with keys:</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a><span class="sd">            - cash: Available cash</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a><span class="sd">            - portfolio_value: Total portfolio value</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a><span class="sd">            - buying_power: Available buying power</span>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a><span class="sd">            - margin_used: Margin currently used (if applicable)</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">subscribe_market_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Asset</span><span class="p">]):</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Subscribe to real-time market data for assets.</span>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a><span class="sd">        Args:</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a><span class="sd">            assets: List of assets to subscribe to</span>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_next_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get next event from broker (blocking).</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a><span class="sd">        Returns:</span>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a><span class="sd">            Event dict with keys:</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a><span class="sd">            - type: &#39;MarketData&#39;, &#39;OrderFill&#39;, &#39;OrderReject&#39;, &#39;OrderCancel&#39;</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a><span class="sd">            - timestamp: Event timestamp</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a><span class="sd">            - ... (type-specific fields)</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close broker connection.&quot;&quot;&quot;</span>
</code></pre></div>
<p><strong>Concrete Implementations:</strong></p>
<ol>
<li><strong>CCXTAdapter</strong> (<code>rustybt/live/brokers/ccxt_adapter.py</code>)</li>
<li>100+ crypto exchanges via CCXT</li>
<li>Spot and futures markets</li>
<li>
<p>WebSocket support</p>
</li>
<li>
<p><strong>IBAdapter</strong> (<code>rustybt/live/brokers/ib_adapter.py</code>)</p>
</li>
<li>Interactive Brokers (stocks, futures, options, forex)</li>
<li>TWS/Gateway connection</li>
<li>
<p>Uses ib_async library</p>
</li>
<li>
<p><strong>BinanceAdapter</strong> (<code>rustybt/live/brokers/binance_adapter.py</code>)</p>
</li>
<li>Binance-specific (native SDK)</li>
<li>Better performance than CCXT</li>
<li>
<p>WebSocket streaming</p>
</li>
<li>
<p><strong>BybitAdapter</strong> (<code>rustybt/live/brokers/bybit_adapter.py</code>)</p>
</li>
<li>Bybit-specific (native SDK)</li>
<li>
<p>Perpetual futures focus</p>
</li>
<li>
<p><strong>HyperliquidAdapter</strong> (<code>rustybt/live/brokers/hyperliquid_adapter.py</code>)</p>
</li>
<li>Decentralized perpetuals</li>
<li>
<p>Official Python SDK</p>
</li>
<li>
<p><strong>PaperBroker</strong> (<code>rustybt/live/brokers/paper_broker.py</code>)</p>
</li>
<li>Simulated execution for paper trading</li>
<li>Uses backtest slippage/commission models</li>
<li>No real broker connection</li>
</ol>
<hr />
<h3 id="3-ordermanager">3. OrderManager<a class="headerlink" href="#3-ordermanager" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Track order lifecycle and manage pending orders</p>
<p><strong>Location:</strong> <code>rustybt/live/engine.py</code> (internal component)</p>
<p><strong>Key Responsibilities:</strong>
- Track order states: <code>PENDING → FILLED | REJECTED | CANCELED</code>
- Match broker order IDs to internal order objects
- Handle partial fills (update remaining quantity)
- Timeout detection for stale orders
- Order audit logging</p>
<p><strong>Order State Machine:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>         submit_order()
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>              │
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>              ▼
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>         ┌──────────┐
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>         │ PENDING  │
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>         └──────────┘
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>              │
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>      ┌───────┼───────┐
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>      │       │       │
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>      ▼       ▼       ▼
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a> ┌────────┐ ┌────┐ ┌────────┐
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a> │ FILLED │ │REJ │ │CANCELED│
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a> └────────┘ └────┘ └────────┘
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>      │
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>      ▼
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a> update_position()
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a> log_transaction()
</code></pre></div>
<hr />
<h3 id="4-datafeed">4. DataFeed<a class="headerlink" href="#4-datafeed" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Coordinate real-time market data flow</p>
<p><strong>Location:</strong> <code>rustybt/live/engine.py</code> (internal component)</p>
<p><strong>Key Responsibilities:</strong>
- Subscribe to broker WebSocket feeds
- Buffer market data into event queue
- Handle data gaps and reconnections
- Convert broker data format to RustyBT format (Decimal, Polars)
- Support multiple data sources (broker + external)</p>
<p><strong>Data Flow:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>Broker WebSocket → DataFeed Buffer → Event Queue → strategy.handle_data()
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>                                          ↓
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>                                    ShadowEngine (if enabled)
</code></pre></div>
<hr />
<h3 id="5-statemanager">5. StateManager<a class="headerlink" href="#5-statemanager" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Checkpoint strategy state for crash recovery</p>
<p><strong>Location:</strong> <code>rustybt/live/state_manager.py</code></p>
<p><strong>Key Responsibilities:</strong>
- Checkpoint strategy state, positions, orders, cash
- Atomic write to prevent corruption
- Restore state after crash
- Stale state detection (warn if checkpoint &gt;1 hour old)
- Include alignment metrics (if shadow mode enabled)</p>
<p><strong>Checkpoint Schema:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="p">{</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="s2">&quot;checkpoint_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-10-03T10:30:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;MomentumStrategy&quot;</span><span class="p">,</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>        <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>            <span class="s2">&quot;asset&quot;</span><span class="p">:</span> <span class="s2">&quot;SPY&quot;</span><span class="p">,</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>            <span class="s2">&quot;sma_fast&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>            <span class="s2">&quot;sma_slow&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>            <span class="c1"># ... user-defined state</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>        <span class="p">}</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="p">},</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="s2">&quot;portfolio&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="s2">&quot;cash&quot;</span><span class="p">:</span> <span class="s2">&quot;95000.00&quot;</span><span class="p">,</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="s2">&quot;portfolio_value&quot;</span><span class="p">:</span> <span class="s2">&quot;105000.00&quot;</span><span class="p">,</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>            <span class="p">{</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>                <span class="s2">&quot;asset&quot;</span><span class="p">:</span> <span class="s2">&quot;SPY&quot;</span><span class="p">,</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>                <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="s2">&quot;100&quot;</span><span class="p">,</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>                <span class="s2">&quot;cost_basis&quot;</span><span class="p">:</span> <span class="s2">&quot;450.00&quot;</span><span class="p">,</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>                <span class="s2">&quot;last_sale_price&quot;</span><span class="p">:</span> <span class="s2">&quot;455.00&quot;</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>            <span class="p">}</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>        <span class="p">],</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        <span class="s2">&quot;pending_orders&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>            <span class="p">{</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>                <span class="s2">&quot;order_id&quot;</span><span class="p">:</span> <span class="s2">&quot;order-123&quot;</span><span class="p">,</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>                <span class="s2">&quot;asset&quot;</span><span class="p">:</span> <span class="s2">&quot;AAPL&quot;</span><span class="p">,</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>                <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="s2">&quot;50&quot;</span><span class="p">,</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>                <span class="s2">&quot;order_type&quot;</span><span class="p">:</span> <span class="s2">&quot;limit&quot;</span><span class="p">,</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>                <span class="s2">&quot;limit_price&quot;</span><span class="p">:</span> <span class="s2">&quot;180.00&quot;</span><span class="p">,</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;pending&quot;</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>            <span class="p">}</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>        <span class="p">]</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>    <span class="p">},</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>    <span class="s2">&quot;alignment_metrics&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>        <span class="s2">&quot;signal_match_rate&quot;</span><span class="p">:</span> <span class="s2">&quot;0.98&quot;</span><span class="p">,</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>        <span class="s2">&quot;slippage_error_bps&quot;</span><span class="p">:</span> <span class="s2">&quot;3.2&quot;</span><span class="p">,</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="s2">&quot;fill_rate_error_pct&quot;</span><span class="p">:</span> <span class="s2">&quot;1.5&quot;</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>    <span class="p">}</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Checkpoint Frequency:</strong>
- Every 60 seconds (configurable)
- On shutdown (graceful)
- On significant portfolio changes (&gt;10% value change)
- On emergency (crash handler)</p>
<p><strong>Atomic Write Strategy:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Atomically write state checkpoint.&quot;&quot;&quot;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">temp_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state_file</span><span class="si">}</span><span class="s2">.tmp&quot;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="c1"># Write to temp file</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="c1"># Atomic rename</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_file</span><span class="p">)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;State checkpoint saved&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_file</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="6-positionreconciler">6. PositionReconciler<a class="headerlink" href="#6-positionreconciler" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Reconcile local positions with broker positions</p>
<p><strong>Location:</strong> <code>rustybt/live/reconciler.py</code></p>
<p><strong>Key Responsibilities:</strong>
- Fetch broker positions periodically (every 5 minutes)
- Compare local <code>DecimalLedger</code> positions vs. broker positions
- Detect discrepancies (position drift)
- Resolve discrepancies (trust broker, update local state)
- Log reconciliation events for audit
- Alert on significant drift (&gt;1% of position value)</p>
<p><strong>Reconciliation Logic:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">reconcile_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare local vs. broker positions.&quot;&quot;&quot;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="n">broker_positions</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="n">local_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ledger</span><span class="o">.</span><span class="n">positions</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">mismatches</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">local_positions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;asset&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">broker_positions</span><span class="p">):</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="n">local_amount</span> <span class="o">=</span> <span class="n">local_positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">DecimalPosition</span><span class="p">())</span><span class="o">.</span><span class="n">amount</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        <span class="n">broker_amount</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">broker_positions</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;asset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">asset</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">local_amount</span> <span class="o">-</span> <span class="n">broker_amount</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.01&quot;</span><span class="p">):</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>            <span class="n">mismatches</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>                <span class="s1">&#39;asset&#39;</span><span class="p">:</span> <span class="n">asset</span><span class="p">,</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>                <span class="s1">&#39;local_amount&#39;</span><span class="p">:</span> <span class="n">local_amount</span><span class="p">,</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>                <span class="s1">&#39;broker_amount&#39;</span><span class="p">:</span> <span class="n">broker_amount</span><span class="p">,</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>                <span class="s1">&#39;difference&#39;</span><span class="p">:</span> <span class="n">broker_amount</span> <span class="o">-</span> <span class="n">local_amount</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>            <span class="p">})</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>    <span class="k">if</span> <span class="n">mismatches</span><span class="p">:</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Position mismatch detected&quot;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="n">mismatches</span><span class="p">)</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_mismatches</span><span class="p">(</span><span class="n">mismatches</span><span class="p">)</span>
</code></pre></div>
<p><strong>Resolution Strategy:</strong>
1. <strong>Trust Broker</strong>: Broker position is source of truth
2. <strong>Update Local</strong>: Sync local <code>DecimalLedger</code> to match broker
3. <strong>Log Discrepancy</strong>: Audit log for investigation
4. <strong>Alert</strong>: Notify user if drift significant</p>
<hr />
<h3 id="7-websocket-streaming-adapters">7. WebSocket Streaming Adapters<a class="headerlink" href="#7-websocket-streaming-adapters" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Real-time market data streaming via WebSocket connections</p>
<p><strong>Location:</strong> <code>rustybt/live/streaming/</code></p>
<p><strong>Key Responsibilities:</strong>
- Manage WebSocket connections with auto-reconnect
- Subscribe/unsubscribe to market data channels
- Parse exchange-specific messages to standardized format
- Buffer ticks into OHLCV bars for strategy consumption
- Handle heartbeat/keepalive with stale connection detection
- Provide error handling with circuit breaker pattern</p>
<p><strong>Architecture:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>┌──────────────────────────────────────────────────────────────┐
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>│                  WebSocket Streaming Layer                    │
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>├──────────────────────────────────────────────────────────────┤
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>│                                                                │
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>│  ┌────────────────────────────────────────────────────────┐  │
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>│  │          BaseWebSocketAdapter (Abstract)                │  │
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>│  │  • Connection lifecycle (connect/disconnect/reconnect)  │  │
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>│  │  • Subscription management                               │  │
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>│  │  • Message parsing framework                             │  │
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>│  │  • Heartbeat monitoring                                  │  │
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>│  │  • Error handling &amp; circuit breaker                      │  │
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>│  └────────────────────────────────────────────────────────┘  │
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>│                          │                                    │
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>│            ┌─────────────┼─────────────┐                      │
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>│            │                            │                     │
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>│            ▼                            ▼                     │
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>│  ┌──────────────────┐        ┌──────────────────┐           │
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>│  │BinanceWebSocket  │        │ ... Other         │           │
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>│  │Adapter           │        │ Exchange          │           │
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>│  │• Spot market     │        │ Adapters          │           │
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>│  │• Futures market  │        │                   │           │
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>│  │• Kline &amp; Trade   │        │                   │           │
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>│  └──────────────────┘        └──────────────────┘           │
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>│                                                                │
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>└──────────────────────────────────────────────────────────────┘
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>         │                           │
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>         │                           │
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>         ▼                           ▼
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>    TickData                   BarBuffer
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>   (Standardized)           (Tick → OHLCV)
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>         │                           │
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>         └───────────┬───────────────┘
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>                     │
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>                     ▼
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>               DataFeed / Engine
</code></pre></div>
<p><strong>Core Classes:</strong></p>
<ol>
<li><strong>BaseWebSocketAdapter</strong></li>
<li>Abstract base class for all WebSocket adapters</li>
<li>Location: <code>rustybt/live/streaming/base.py</code></li>
<li>
<p>Implements connection management, reconnection, heartbeat</p>
</li>
<li>
<p><strong>BinanceWebSocketAdapter</strong></p>
</li>
<li>Concrete implementation for Binance</li>
<li>Location: <code>rustybt/live/streaming/binance_stream.py</code></li>
<li>Supports spot and futures markets</li>
<li>
<p>Parses kline and trade messages</p>
</li>
<li>
<p><strong>BarBuffer</strong></p>
</li>
<li>Accumulates ticks into OHLCV bars</li>
<li>Location: <code>rustybt/live/streaming/bar_buffer.py</code></li>
<li>Configurable bar resolution (1m, 5m, 15m, etc.)</li>
<li>Emits completed bars aligned to time boundaries</li>
</ol>
<p><strong>Data Models:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">class</span> <span class="nc">TickData</span><span class="p">:</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Standardized tick data from any exchange.&quot;&quot;&quot;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="n">price</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="n">volume</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="n">side</span><span class="p">:</span> <span class="n">TickSide</span>  <span class="c1"># BUY, SELL, UNKNOWN</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="k">class</span> <span class="nc">StreamConfig</span><span class="p">:</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;WebSocket stream configuration.&quot;&quot;&quot;</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>    <span class="n">bar_resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># seconds</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>    <span class="n">heartbeat_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="n">reconnect_attempts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># infinite</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>    <span class="n">reconnect_delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>    <span class="n">reconnect_max_delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>    <span class="n">circuit_breaker_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="nd">@dataclass</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="k">class</span> <span class="nc">OHLCVBar</span><span class="p">:</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;OHLCV bar aggregated from ticks.&quot;&quot;&quot;</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>  <span class="c1"># Bar start time (aligned)</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>    <span class="nb">open</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="n">high</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>    <span class="n">low</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>    <span class="n">close</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>    <span class="n">volume</span><span class="p">:</span> <span class="n">Decimal</span>
</code></pre></div>
<p><strong>Connection Lifecycle:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span> <span class="nn">rustybt.live.streaming</span> <span class="kn">import</span> <span class="n">BinanceWebSocketAdapter</span><span class="p">,</span> <span class="n">StreamConfig</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="c1"># Initialize adapter</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">StreamConfig</span><span class="p">(</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    <span class="n">bar_resolution</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>  <span class="c1"># 1-minute bars</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">heartbeat_interval</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">circuit_breaker_threshold</span><span class="o">=</span><span class="mi">10</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="p">)</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="n">adapter</span> <span class="o">=</span> <span class="n">BinanceWebSocketAdapter</span><span class="p">(</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="n">market_type</span><span class="o">=</span><span class="s2">&quot;spot&quot;</span><span class="p">,</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    <span class="n">on_tick</span><span class="o">=</span><span class="n">handle_tick_callback</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="p">)</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="c1"># Connect</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="c1"># Subscribe to symbols</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>    <span class="n">symbols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BTCUSDT&quot;</span><span class="p">,</span> <span class="s2">&quot;ETHUSDT&quot;</span><span class="p">],</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>    <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;kline_1m&quot;</span><span class="p">,</span> <span class="s2">&quot;trade&quot;</span><span class="p">]</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="p">)</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="c1"># Adapter automatically:</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="c1"># - Reconnects on disconnect (exponential backoff: 1s, 2s, 4s, 8s, 16s max)</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="c1"># - Re-subscribes after reconnect</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="c1"># - Monitors heartbeat (trips circuit breaker on stale connection)</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="c1"># - Parses messages to TickData</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="c1"># - Calls on_tick callback for each tick</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="c1"># Unsubscribe</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>    <span class="n">symbols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ETHUSDT&quot;</span><span class="p">],</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>    <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;trade&quot;</span><span class="p">]</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="p">)</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a><span class="c1"># Disconnect</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a><span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</code></pre></div>
<p><strong>Reconnection Strategy:</strong></p>
<ul>
<li><strong>Initial connect:</strong> Immediate</li>
<li><strong>Reconnect on disconnect:</strong> Exponential backoff</li>
<li>Attempt 1: 1 second delay</li>
<li>Attempt 2: 2 seconds delay</li>
<li>Attempt 3: 4 seconds delay</li>
<li>Attempt 4: 8 seconds delay</li>
<li>Attempt 5+: 16 seconds delay (max)</li>
<li><strong>Re-subscription:</strong> Automatically re-subscribe to all active subscriptions after reconnect</li>
<li><strong>Reconnect attempts:</strong> Configurable (default: infinite)</li>
</ul>
<p><strong>Heartbeat Monitoring:</strong></p>
<ul>
<li>Sends ping every <code>heartbeat_interval</code> seconds (default: 30s)</li>
<li>Expects pong within timeout (default: 60s)</li>
<li>Triggers reconnect if no message received in <code>heartbeat_timeout</code></li>
<li>Logs heartbeat activity at DEBUG level</li>
</ul>
<p><strong>Error Handling:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># Circuit breaker pattern</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">adapter</span><span class="o">.</span><span class="n">_consecutive_errors</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="k">if</span> <span class="n">adapter</span><span class="o">.</span><span class="n">_consecutive_errors</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">circuit_breaker_threshold</span><span class="p">:</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;circuit_breaker_tripped&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">adapter</span><span class="o">.</span><span class="n">_consecutive_errors</span><span class="p">)</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>  <span class="c1"># Attempt recovery</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="c1"># Error types handled:</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="c1"># - ConnectionClosed: WebSocket disconnected</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="c1"># - WebSocketException: WebSocket protocol error</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="c1"># - ParseError: Invalid message format</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="c1"># - SubscriptionError: Subscription failed</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="c1"># - JSONDecodeError: Invalid JSON</span>
</code></pre></div>
<p><strong>Tick-to-Bar Buffering:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">from</span> <span class="nn">rustybt.live.streaming</span> <span class="kn">import</span> <span class="n">BarBuffer</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c1"># Create buffer</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="n">buffer</span> <span class="o">=</span> <span class="n">BarBuffer</span><span class="p">(</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="n">bar_resolution</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>  <span class="c1"># 1-minute bars</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="n">on_bar_complete</span><span class="o">=</span><span class="n">handle_bar_callback</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="p">)</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="c1"># Add ticks</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="n">tick1</span> <span class="o">=</span> <span class="n">TickData</span><span class="p">(</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;BTCUSDT&quot;</span><span class="p">,</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="n">price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50000.00&quot;</span><span class="p">),</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="n">volume</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.5&quot;</span><span class="p">)</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="p">)</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="n">buffer</span><span class="o">.</span><span class="n">add_tick</span><span class="p">(</span><span class="n">tick1</span><span class="p">)</span>  <span class="c1"># Returns None (bar incomplete)</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="n">tick2</span> <span class="o">=</span> <span class="n">TickData</span><span class="p">(</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>    <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;BTCUSDT&quot;</span><span class="p">,</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>  <span class="c1"># Next minute</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>    <span class="n">price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50500.00&quot;</span><span class="p">),</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>    <span class="n">volume</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="p">)</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="n">completed_bar</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">add_tick</span><span class="p">(</span><span class="n">tick2</span><span class="p">)</span>  <span class="c1"># Returns completed bar</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="c1"># completed_bar:</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="c1"># OHLCVBar(</span>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="c1">#     symbol=&quot;BTCUSDT&quot;,</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="c1">#     timestamp=datetime(2025, 10, 3, 12, 0, 0),  # Aligned to minute boundary</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="c1">#     open=Decimal(&quot;50000.00&quot;),  # First tick</span>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="c1">#     high=Decimal(&quot;50000.00&quot;),  # Max price</span>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="c1">#     low=Decimal(&quot;50000.00&quot;),   # Min price</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="c1">#     close=Decimal(&quot;50000.00&quot;), # Last tick</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="c1">#     volume=Decimal(&quot;1.5&quot;)      # Sum of volumes</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="c1"># )</span>
</code></pre></div>
<p><strong>Exchange-Specific Message Parsing:</strong></p>
<p>Example: Binance kline message</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Raw Binance message</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">raw_message</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="s2">&quot;kline&quot;</span><span class="p">,</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="mi">1638747420000</span><span class="p">,</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="s2">&quot;BTCUSDT&quot;</span><span class="p">,</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">1638747360000</span><span class="p">,</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="mi">1638747419999</span><span class="p">,</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="s2">&quot;BTCUSDT&quot;</span><span class="p">,</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="s2">&quot;1m&quot;</span><span class="p">,</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>        <span class="s2">&quot;o&quot;</span><span class="p">:</span> <span class="s2">&quot;49500.00&quot;</span><span class="p">,</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;49550.00&quot;</span><span class="p">,</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="s2">&quot;49600.00&quot;</span><span class="p">,</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>        <span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="s2">&quot;49480.00&quot;</span><span class="p">,</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>        <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="s2">&quot;123.456&quot;</span><span class="p">,</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="kc">False</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="p">}</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="p">}</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="c1"># Parsed to TickData</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="n">tick</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="n">parse_message</span><span class="p">(</span><span class="n">raw_message</span><span class="p">)</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="c1"># TickData(</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="c1">#     symbol=&quot;BTCUSDT&quot;,</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="c1">#     timestamp=datetime(2021, 12, 5, 20, 3, 39, 999000),</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="c1">#     price=Decimal(&quot;49550.00&quot;),  # Close price</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="c1">#     volume=Decimal(&quot;123.456&quot;),</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="c1">#     side=TickSide.UNKNOWN</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="c1"># )</span>
</code></pre></div>
<p><strong>Implementing New Exchange Adapters:</strong></p>
<p>To add support for a new exchange:</p>
<ol>
<li>
<p><strong>Subclass BaseWebSocketAdapter:</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">class</span> <span class="nc">ExchangeWebSocketAdapter</span><span class="p">(</span><span class="n">BaseWebSocketAdapter</span><span class="p">):</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_tick</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;wss://exchange.com/ws&quot;</span><span class="p">,</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>            <span class="n">on_tick</span><span class="o">=</span><span class="n">on_tick</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>        <span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Implement abstract methods:</strong></p>
</li>
<li><code>subscribe(symbols, channels)</code>: Send subscription message</li>
<li><code>unsubscribe(symbols, channels)</code>: Send unsubscription message</li>
<li><code>parse_message(raw_message)</code>: Parse to TickData</li>
<li><code>_build_subscription_message(symbols, channels)</code>: Build subscription JSON</li>
<li>
<p><code>_build_unsubscription_message(symbols, channels)</code>: Build unsubscription JSON</p>
</li>
<li>
<p><strong>Handle exchange-specific formats:</strong></p>
</li>
<li>Message structure</li>
<li>Timestamp format (ms/s since epoch, ISO string, etc.)</li>
<li>Price/volume precision</li>
<li>Error codes</li>
<li>
<p>Heartbeat format (if exchange-specific)</p>
</li>
<li>
<p><strong>Write tests:</strong></p>
</li>
<li>Connection lifecycle</li>
<li>Subscription management</li>
<li>Message parsing with sample messages</li>
<li>Error handling</li>
</ol>
<p><strong>Testing:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># Run all streaming unit tests</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests/live/streaming/<span class="w"> </span>-v
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="c1"># Run individual test modules</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests/live/streaming/test_base_adapter.py<span class="w"> </span>-v
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests/live/streaming/test_binance_stream.py<span class="w"> </span>-v
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests/live/streaming/test_bar_buffer.py<span class="w"> </span>-v
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests/live/streaming/test_models.py<span class="w"> </span>-v
</code></pre></div>
<p><strong>Integration with LiveTradingEngine:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># Engine creates WebSocket adapter</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">adapter</span> <span class="o">=</span> <span class="n">BinanceWebSocketAdapter</span><span class="p">(</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="n">market_type</span><span class="o">=</span><span class="s2">&quot;spot&quot;</span><span class="p">,</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stream_config</span><span class="p">,</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    <span class="n">on_tick</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_tick</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="p">)</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="c1"># Start streaming</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>    <span class="n">symbols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">,</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>    <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;trade&quot;</span><span class="p">,</span> <span class="s2">&quot;kline_1m&quot;</span><span class="p">]</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="p">)</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="c1"># Engine handles ticks</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">_handle_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">TickData</span><span class="p">):</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>    <span class="c1"># Buffer tick to bar</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>    <span class="n">bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar_buffer</span><span class="o">.</span><span class="n">add_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>    <span class="c1"># Emit bar as market data event</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>    <span class="k">if</span> <span class="n">bar</span><span class="p">:</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>        <span class="n">event</span> <span class="o">=</span> <span class="n">MarketDataEvent</span><span class="p">(</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">bar</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>            <span class="n">symbol</span><span class="o">=</span><span class="n">bar</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>            <span class="n">data</span><span class="o">=</span><span class="n">bar</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>        <span class="p">)</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="8-tradingscheduler">8. TradingScheduler<a class="headerlink" href="#8-tradingscheduler" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Flexible scheduling for strategy callbacks and market event triggers</p>
<p><strong>Location:</strong> <code>rustybt/live/scheduler.py</code></p>
<p><strong>Key Responsibilities:</strong>
- Schedule market event triggers (market_open, market_close, pre_market, after_hours)
- Support cron-like expressions for flexible scheduling
- Timezone-aware scheduling with exchange-specific timezones
- Trading calendar integration (skip weekends, holidays)
- Missed trigger handling with grace time
- Callback registration and lifecycle management</p>
<p><strong>Key Features:</strong>
- Built on APScheduler for production-ready scheduling
- Emits <code>ScheduledTriggerEvent</code> to engine event queue
- Supports cron, interval, and date triggers
- Exchange-specific market hours (NYSE, LSE, TSE, etc.)
- Handles DST transitions correctly
- Callback exceptions don't crash scheduler</p>
<p><strong>Class Signature:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">from</span> <span class="nn">rustybt.live.scheduler</span> <span class="kn">import</span> <span class="n">TradingScheduler</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="n">scheduler</span> <span class="o">=</span> <span class="n">TradingScheduler</span><span class="p">(</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="n">event_queue</span><span class="o">=</span><span class="n">event_queue</span><span class="p">,</span>           <span class="c1"># Async queue for events</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>    <span class="n">misfire_grace_time</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>             <span class="c1"># Seconds to allow late execution</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="n">timezone</span><span class="o">=</span><span class="s2">&quot;America/New_York&quot;</span>        <span class="c1"># Default timezone</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="p">)</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># Start scheduler</span>
</code></pre></div>
<p><strong>Common Scheduling Patterns:</strong></p>
<ol>
<li>
<p><strong>Daily Rebalancing at Market Close:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">rebalance_portfolio</span><span class="p">():</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Rebalance portfolio to target allocations.&quot;&quot;&quot;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>    <span class="c1"># Rebalancing logic here</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    <span class="k">pass</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">schedule_market_close</span><span class="p">(</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">rebalance_portfolio</span><span class="p">,</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="n">exchange</span><span class="o">=</span><span class="s2">&quot;NYSE&quot;</span><span class="p">,</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    <span class="n">timezone</span><span class="o">=</span><span class="s2">&quot;America/New_York&quot;</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Hourly Risk Check:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">check_risk_limits</span><span class="p">,</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;cron&quot;</span><span class="p">,</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    <span class="n">cron</span><span class="o">=</span><span class="s2">&quot;0 * * * *&quot;</span>  <span class="c1"># Every hour</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Every 15 Minutes During Market Hours:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">generate_signals</span><span class="p">,</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;cron&quot;</span><span class="p">,</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="n">cron</span><span class="o">=</span><span class="s2">&quot;*/15 9-16 * * MON-FRI&quot;</span>  <span class="c1"># Every 15min, 9am-4pm</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Weekly Report on Friday Close:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">generate_weekly_report</span><span class="p">,</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>    <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;cron&quot;</span><span class="p">,</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>    <span class="n">cron</span><span class="o">=</span><span class="s2">&quot;0 16 * * FRI&quot;</span>  <span class="c1"># 4pm ET every Friday</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Crypto Strategy Every 5 Minutes (24/7):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">crypto_signal_check</span><span class="p">,</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>    <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>    <span class="n">minutes</span><span class="o">=</span><span class="mi">5</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="p">)</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>Market Event Triggers:</strong></p>
<p>The scheduler provides convenience methods for common market events:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># Market open (9:30 ET for NYSE)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">schedule_market_open</span><span class="p">(</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">pre_market_analysis</span><span class="p">,</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="n">exchange</span><span class="o">=</span><span class="s2">&quot;NYSE&quot;</span><span class="p">,</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="n">timezone</span><span class="o">=</span><span class="s2">&quot;America/New_York&quot;</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="p">)</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="c1"># Market close (16:00 ET for NYSE)</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">schedule_market_close</span><span class="p">(</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">daily_rebalance</span><span class="p">,</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>    <span class="n">exchange</span><span class="o">=</span><span class="s2">&quot;NYSE&quot;</span><span class="p">,</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>    <span class="n">timezone</span><span class="o">=</span><span class="s2">&quot;America/New_York&quot;</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="p">)</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="c1"># Pre-market (30 minutes before open)</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">schedule_pre_market</span><span class="p">(</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">scan_overnight_news</span><span class="p">,</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>    <span class="n">exchange</span><span class="o">=</span><span class="s2">&quot;NYSE&quot;</span><span class="p">,</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>    <span class="n">offset_minutes</span><span class="o">=-</span><span class="mi">30</span>  <span class="c1"># 9:00 ET</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="p">)</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="c1"># After-hours (30 minutes after close)</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">schedule_after_hours</span><span class="p">(</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">post_market_analysis</span><span class="p">,</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>    <span class="n">exchange</span><span class="o">=</span><span class="s2">&quot;NYSE&quot;</span><span class="p">,</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>    <span class="n">offset_minutes</span><span class="o">=</span><span class="mi">30</span>  <span class="c1"># 16:30 ET</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="p">)</span>
</code></pre></div>
<p><strong>Supported Exchanges:</strong></p>
<table>
<thead>
<tr>
<th>Exchange</th>
<th>Market Open</th>
<th>Market Close</th>
<th>Timezone</th>
</tr>
</thead>
<tbody>
<tr>
<td>NYSE</td>
<td>9:30</td>
<td>16:00</td>
<td>America/New_York</td>
</tr>
<tr>
<td>XLON (LSE)</td>
<td>8:00</td>
<td>16:30</td>
<td>Europe/London</td>
</tr>
<tr>
<td>XTKS (TSE)</td>
<td>9:00</td>
<td>15:00</td>
<td>Asia/Tokyo</td>
</tr>
<tr>
<td>Crypto (24/7)</td>
<td>N/A</td>
<td>N/A</td>
<td>UTC</td>
</tr>
</tbody>
</table>
<p><strong>Callback Management:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Add job</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">job_id</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">my_callback</span><span class="p">,</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    <span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>    <span class="n">callback_name</span><span class="o">=</span><span class="s2">&quot;risk_check&quot;</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="p">)</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="c1"># Disable callback without removing</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">disable_callback</span><span class="p">(</span><span class="s2">&quot;risk_check&quot;</span><span class="p">)</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="c1"># Re-enable callback</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">enable_callback</span><span class="p">(</span><span class="s2">&quot;risk_check&quot;</span><span class="p">)</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="c1"># Remove callback completely</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">remove_job</span><span class="p">(</span><span class="s2">&quot;risk_check&quot;</span><span class="p">)</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="c1"># List all active jobs</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="n">jobs</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">()</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;callback_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;next_run_time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Missed Trigger Handling:</strong></p>
<p>If the engine is offline during a scheduled time, the scheduler handles it based on <code>misfire_grace_time</code>:</p>
<ul>
<li><strong>Within grace time</strong> (default: 60s): Trigger executes immediately upon startup</li>
<li><strong>Beyond grace time</strong>: Trigger is skipped and logged as missed</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># Configure grace time</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">scheduler</span> <span class="o">=</span> <span class="n">TradingScheduler</span><span class="p">(</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>    <span class="n">event_queue</span><span class="o">=</span><span class="n">event_queue</span><span class="p">,</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>    <span class="n">misfire_grace_time</span><span class="o">=</span><span class="mi">120</span>  <span class="c1"># 2 minutes</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="p">)</span>
</code></pre></div>
<p><strong>Integration with LiveTradingEngine:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">_schedule_triggers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Schedule strategy callbacks.&quot;&quot;&quot;</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>    <span class="c1"># Schedule before_trading_start at market open</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="s1">&#39;before_trading_start&#39;</span><span class="p">):</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">schedule_market_open</span><span class="p">(</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>            <span class="n">callback</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">before_trading_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">),</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>            <span class="n">exchange</span><span class="o">=</span><span class="s2">&quot;NYSE&quot;</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>        <span class="p">)</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>    <span class="c1"># Schedule custom intervals from strategy</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="s1">&#39;rebalance_interval&#39;</span><span class="p">):</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>            <span class="n">callback</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">rebalance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">),</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>            <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">rebalance_interval</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>        <span class="p">)</span>
</code></pre></div>
<p><strong>Error Handling:</strong></p>
<p>Callback exceptions are caught and logged but don't crash the scheduler:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">risky_callback</span><span class="p">():</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Something went wrong!&quot;</span><span class="p">)</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="c1"># Scheduler logs error but continues running</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>    <span class="n">callback</span><span class="o">=</span><span class="n">risky_callback</span><span class="p">,</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    <span class="n">minutes</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="p">)</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="c1"># Scheduler still fires subsequent callbacks</span>
</code></pre></div>
<p><strong>Testing:</strong></p>
<p>The scheduler supports time-based testing with asyncio:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kn">import</span> <span class="nn">asyncio</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="kn">import</span> <span class="nn">pytest</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">test_scheduled_callback</span><span class="p">():</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>    <span class="n">event_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">TradingScheduler</span><span class="p">(</span><span class="n">event_queue</span><span class="o">=</span><span class="n">event_queue</span><span class="p">)</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>    <span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>    <span class="c1"># Schedule callback for 1 second from now</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>    <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>        <span class="n">callback</span><span class="o">=</span><span class="n">test_callback</span><span class="p">,</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>        <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>        <span class="n">run_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">UTC</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>    <span class="p">)</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>    <span class="c1"># Wait for event</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>    <span class="n">event</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>    <span class="k">assert</span> <span class="n">event</span><span class="o">.</span><span class="n">callback_name</span> <span class="o">==</span> <span class="s2">&quot;test_callback&quot;</span>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a>    <span class="n">scheduler</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="event-system-architecture">Event System Architecture<a class="headerlink" href="#event-system-architecture" title="Permanent link">&para;</a></h2>
<h3 id="event-types">Event Types<a class="headerlink" href="#event-types" title="Permanent link">&para;</a></h3>
<p>All events flow through <code>asyncio.PriorityQueue</code> with priority ordering:</p>
<table>
<thead>
<tr>
<th>Event Type</th>
<th>Priority</th>
<th>Description</th>
<th>Payload Fields</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SystemError</code></td>
<td>0 (highest)</td>
<td>Critical system errors</td>
<td><code>error_type</code>, <code>message</code>, <code>severity</code>, <code>timestamp</code></td>
</tr>
<tr>
<td><code>OrderFill</code></td>
<td>1</td>
<td>Order execution confirmation</td>
<td><code>order_id</code>, <code>fill_price</code>, <code>fill_amount</code>, <code>commission</code>, <code>timestamp</code></td>
</tr>
<tr>
<td><code>OrderReject</code></td>
<td>2</td>
<td>Order rejection</td>
<td><code>order_id</code>, <code>reason</code>, <code>timestamp</code></td>
</tr>
<tr>
<td><code>ScheduledTrigger</code></td>
<td>3</td>
<td>Scheduled callback</td>
<td><code>trigger_type</code>, <code>scheduled_time</code>, <code>actual_time</code></td>
</tr>
<tr>
<td><code>MarketData</code></td>
<td>4 (lowest)</td>
<td>Market price/volume update</td>
<td><code>asset</code>, <code>timestamp</code>, <code>price</code>, <code>volume</code></td>
</tr>
</tbody>
</table>
<h3 id="event-schema-pydantic-validation">Event Schema (Pydantic Validation)<a class="headerlink" href="#event-schema-pydantic-validation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="k">class</span> <span class="nc">EventType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>    <span class="n">MARKET_DATA</span> <span class="o">=</span> <span class="s2">&quot;MarketData&quot;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>    <span class="n">ORDER_FILL</span> <span class="o">=</span> <span class="s2">&quot;OrderFill&quot;</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>    <span class="n">ORDER_REJECT</span> <span class="o">=</span> <span class="s2">&quot;OrderReject&quot;</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>    <span class="n">SCHEDULED_TRIGGER</span> <span class="o">=</span> <span class="s2">&quot;ScheduledTrigger&quot;</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>    <span class="n">SYSTEM_ERROR</span> <span class="o">=</span> <span class="s2">&quot;SystemError&quot;</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="k">class</span> <span class="nc">EventPriority</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>    <span class="n">SYSTEM_ERROR</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>    <span class="n">ORDER_FILL</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>    <span class="n">ORDER_REJECT</span> <span class="o">=</span> <span class="mi">2</span>
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>    <span class="n">SCHEDULED_TRIGGER</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>    <span class="n">MARKET_DATA</span> <span class="o">=</span> <span class="mi">4</span>
<a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>
<a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base event model.&quot;&quot;&quot;</span>
<a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a>    <span class="nb">type</span><span class="p">:</span> <span class="n">EventType</span>
<a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>    <span class="n">priority</span><span class="p">:</span> <span class="n">EventPriority</span>
<a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>
<a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="k">class</span> <span class="nc">MarketDataEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Market data update event.&quot;&quot;&quot;</span>
<a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a>    <span class="nb">type</span><span class="p">:</span> <span class="n">EventType</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">MARKET_DATA</span>
<a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a>    <span class="n">priority</span><span class="p">:</span> <span class="n">EventPriority</span> <span class="o">=</span> <span class="n">EventPriority</span><span class="o">.</span><span class="n">MARKET_DATA</span>
<a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a>    <span class="n">asset</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a>    <span class="n">price</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a>    <span class="n">volume</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a>
<a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a><span class="k">class</span> <span class="nc">OrderFillEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Order fill event.&quot;&quot;&quot;</span>
<a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a>    <span class="nb">type</span><span class="p">:</span> <span class="n">EventType</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ORDER_FILL</span>
<a id="__codelineno-31-37" name="__codelineno-31-37" href="#__codelineno-31-37"></a>    <span class="n">priority</span><span class="p">:</span> <span class="n">EventPriority</span> <span class="o">=</span> <span class="n">EventPriority</span><span class="o">.</span><span class="n">ORDER_FILL</span>
<a id="__codelineno-31-38" name="__codelineno-31-38" href="#__codelineno-31-38"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-31-39" name="__codelineno-31-39" href="#__codelineno-31-39"></a>    <span class="n">fill_price</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-31-40" name="__codelineno-31-40" href="#__codelineno-31-40"></a>    <span class="n">fill_amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-31-41" name="__codelineno-31-41" href="#__codelineno-31-41"></a>    <span class="n">commission</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-31-42" name="__codelineno-31-42" href="#__codelineno-31-42"></a>
<a id="__codelineno-31-43" name="__codelineno-31-43" href="#__codelineno-31-43"></a><span class="k">class</span> <span class="nc">OrderRejectEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<a id="__codelineno-31-44" name="__codelineno-31-44" href="#__codelineno-31-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Order rejection event.&quot;&quot;&quot;</span>
<a id="__codelineno-31-45" name="__codelineno-31-45" href="#__codelineno-31-45"></a>    <span class="nb">type</span><span class="p">:</span> <span class="n">EventType</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ORDER_REJECT</span>
<a id="__codelineno-31-46" name="__codelineno-31-46" href="#__codelineno-31-46"></a>    <span class="n">priority</span><span class="p">:</span> <span class="n">EventPriority</span> <span class="o">=</span> <span class="n">EventPriority</span><span class="o">.</span><span class="n">ORDER_REJECT</span>
<a id="__codelineno-31-47" name="__codelineno-31-47" href="#__codelineno-31-47"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-31-48" name="__codelineno-31-48" href="#__codelineno-31-48"></a>    <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-31-49" name="__codelineno-31-49" href="#__codelineno-31-49"></a>
<a id="__codelineno-31-50" name="__codelineno-31-50" href="#__codelineno-31-50"></a><span class="k">class</span> <span class="nc">ScheduledTriggerEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<a id="__codelineno-31-51" name="__codelineno-31-51" href="#__codelineno-31-51"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Scheduled trigger event.&quot;&quot;&quot;</span>
<a id="__codelineno-31-52" name="__codelineno-31-52" href="#__codelineno-31-52"></a>    <span class="nb">type</span><span class="p">:</span> <span class="n">EventType</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">SCHEDULED_TRIGGER</span>
<a id="__codelineno-31-53" name="__codelineno-31-53" href="#__codelineno-31-53"></a>    <span class="n">priority</span><span class="p">:</span> <span class="n">EventPriority</span> <span class="o">=</span> <span class="n">EventPriority</span><span class="o">.</span><span class="n">SCHEDULED_TRIGGER</span>
<a id="__codelineno-31-54" name="__codelineno-31-54" href="#__codelineno-31-54"></a>    <span class="n">trigger_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;market_open&#39;, &#39;market_close&#39;, &#39;custom&#39;</span>
<a id="__codelineno-31-55" name="__codelineno-31-55" href="#__codelineno-31-55"></a>    <span class="n">scheduled_time</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-31-56" name="__codelineno-31-56" href="#__codelineno-31-56"></a>    <span class="n">actual_time</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-31-57" name="__codelineno-31-57" href="#__codelineno-31-57"></a>
<a id="__codelineno-31-58" name="__codelineno-31-58" href="#__codelineno-31-58"></a><span class="k">class</span> <span class="nc">SystemErrorEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<a id="__codelineno-31-59" name="__codelineno-31-59" href="#__codelineno-31-59"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;System error event.&quot;&quot;&quot;</span>
<a id="__codelineno-31-60" name="__codelineno-31-60" href="#__codelineno-31-60"></a>    <span class="nb">type</span><span class="p">:</span> <span class="n">EventType</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">SYSTEM_ERROR</span>
<a id="__codelineno-31-61" name="__codelineno-31-61" href="#__codelineno-31-61"></a>    <span class="n">priority</span><span class="p">:</span> <span class="n">EventPriority</span> <span class="o">=</span> <span class="n">EventPriority</span><span class="o">.</span><span class="n">SYSTEM_ERROR</span>
<a id="__codelineno-31-62" name="__codelineno-31-62" href="#__codelineno-31-62"></a>    <span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;broker_disconnect&#39;, &#39;data_feed_failure&#39;, etc.</span>
<a id="__codelineno-31-63" name="__codelineno-31-63" href="#__codelineno-31-63"></a>    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-31-64" name="__codelineno-31-64" href="#__codelineno-31-64"></a>    <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;warning&#39;, &#39;error&#39;, &#39;critical&#39;</span>
</code></pre></div>
<h3 id="event-priority-queue">Event Priority Queue<a class="headerlink" href="#event-priority-queue" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kn">import</span> <span class="nn">asyncio</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="k">class</span> <span class="nc">PrioritizedEvent</span><span class="p">:</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for priority queue ordering.&quot;&quot;&quot;</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">priority</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compare for priority queue (lower priority value = higher priority).&quot;&quot;&quot;</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">priority</span><span class="p">:</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">priority</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">timestamp</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="c1"># Usage in LiveTradingEngine</span>
<a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="n">event_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">PriorityQueue</span><span class="p">[</span><span class="n">PrioritizedEvent</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">PriorityQueue</span><span class="p">()</span>
<a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a>
<a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="c1"># Add event</span>
<a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="k">await</span> <span class="n">event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">PrioritizedEvent</span><span class="p">(</span><span class="n">market_data_event</span><span class="p">))</span>
<a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a>
<a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="c1"># Process events in priority order</span>
<a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a>    <span class="n">prioritized</span> <span class="o">=</span> <span class="k">await</span> <span class="n">event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a>    <span class="k">await</span> <span class="n">process_event</span><span class="p">(</span><span class="n">prioritized</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
</code></pre></div>
<h3 id="event-flow-sequence-diagram">Event Flow Sequence Diagram<a class="headerlink" href="#event-flow-sequence-diagram" title="Permanent link">&para;</a></h3>
<p><strong>Normal Trading Flow:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>User Strategy   LiveEngine   EventQueue   BrokerAdapter   Broker
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>     │              │             │             │            │
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>     │  initialize  │             │             │            │
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>     ├─────────────&gt;│             │             │            │
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>     │              │  connect()  │             │            │
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>     │              ├────────────────────────────────────────&gt;│
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>     │              │             │             │     ✓      │
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>     │              │  subscribe  │             │            │
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>     │              ├────────────────────────────────────────&gt;│
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>     │              │             │             │            │
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>     │              │             │ ┌───MarketData─────────&gt; │
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>     │              │             │ │           │            │
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>     │              │&lt;─────MarketData Event─────┤            │
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>     │              │             │             │            │
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>     │  handle_data │             │             │            │
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>     │&lt;─────────────┤             │             │            │
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>     │              │             │             │            │
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>     │ order(SPY,100)             │             │            │
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>     ├─────────────&gt;│ submit_order│             │            │
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>     │              ├────────────────────────────────────────&gt;│
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a>     │              │             │             │  order_id  │
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>     │              │             │ ┌───OrderFill──────────&gt; │
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>     │              │             │ │           │            │
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>     │              │&lt;──────OrderFill Event─────┤            │
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a>     │              │             │             │            │
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>     │ on_order_fill│             │             │            │
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a>     │&lt;─────────────┤             │             │            │
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a>     │              │ update_position          │            │
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a>     │              │ log_transaction          │            │
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a>     │              │             │             │            │
</code></pre></div>
<p><strong>Error Handling Flow:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>LiveEngine   EventQueue   BrokerAdapter   ErrorHandler
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>     │            │             │                │
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>     │            │ ┌───SystemError─────────&gt;    │
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>     │            │ │           │                │
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>     │&lt;────SystemError Event────┤                │
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>     │            │             │                │
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>     ├───────────────────────────────handle_error&gt;
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>     │            │             │                │
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>     │            │             │      retry?    │
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>     │            │             │&lt;───────┘       │
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>     │            │             │                │
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>     │            │ ┌───retry────┘               │
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>     │            │ │           │                │
</code></pre></div>
<hr />
<h2 id="asyncawait-concurrency-model">Async/Await Concurrency Model<a class="headerlink" href="#asyncawait-concurrency-model" title="Permanent link">&para;</a></h2>
<h3 id="asyncio-usage-for-io-bound-operations">Asyncio Usage for I/O-Bound Operations<a class="headerlink" href="#asyncio-usage-for-io-bound-operations" title="Permanent link">&para;</a></h3>
<p>All broker API calls and data fetching use <code>async</code>/<code>await</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># Broker operations (I/O-bound)</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">submit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">order_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>            <span class="k">return</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="c1"># Data fetching (I/O-bound)</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>            <span class="k">return</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>
<h3 id="threading-for-cpu-bound-operations">Threading for CPU-Bound Operations<a class="headerlink" href="#threading-for-cpu-bound-operations" title="Permanent link">&para;</a></h3>
<p>If strategy calculations are CPU-intensive, offload to thread pool:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="c1"># CPU-bound calculation (e.g., indicator computation)</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>    <span class="c1"># Heavy computation</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>    <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="c1"># Run in thread pool</span>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="n">calculate_indicators</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>
<p><strong>Note:</strong> Most indicator calculations are fast enough to run inline. Only use threading if profiling shows significant blocking.</p>
<h3 id="thread-safe-state-access">Thread-Safe State Access<a class="headerlink" href="#thread-safe-state-access" title="Permanent link">&para;</a></h3>
<p>Use <code>asyncio.Lock</code> to protect shared state:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">class</span> <span class="nc">LiveTradingEngine</span><span class="p">:</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span> <span class="o">=</span> <span class="n">DecimalLedger</span><span class="p">()</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Thread-safe position update.&quot;&quot;&quot;</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_lock</span><span class="p">:</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">process_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
</code></pre></div>
<h3 id="task-group-pattern-for-concurrent-operations">Task Group Pattern for Concurrent Operations<a class="headerlink" href="#task-group-pattern-for-concurrent-operations" title="Permanent link">&para;</a></h3>
<p>Use <code>asyncio.TaskGroup</code> (Python 3.11+) for structured concurrency:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_all_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assets</span><span class="p">):</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch positions for multiple assets concurrently.&quot;&quot;&quot;</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TaskGroup</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tg</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset</span><span class="p">))</span> <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">]</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
</code></pre></div>
<p><strong>For Python 3.10 compatibility:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_all_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assets</span><span class="p">):</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch positions for multiple assets concurrently.&quot;&quot;&quot;</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span> <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">]</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
</code></pre></div>
<h3 id="race-condition-prevention">Race Condition Prevention<a class="headerlink" href="#race-condition-prevention" title="Permanent link">&para;</a></h3>
<p><strong>1. Immutable Events:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="k">class</span> <span class="nc">MarketDataEvent</span><span class="p">:</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Immutable event (cannot be modified after creation).&quot;&quot;&quot;</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>    <span class="n">asset</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>    <span class="n">price</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>    <span class="n">volume</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
</code></pre></div>
<p><strong>2. Async Queues for Event Passing:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="c1"># Thread-safe by design</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="n">event_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="c1"># Producer</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="k">await</span> <span class="n">event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="c1"># Consumer</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="n">event</span> <span class="o">=</span> <span class="k">await</span> <span class="n">event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</code></pre></div>
<p><strong>3. Atomic Operations:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1"># Use Decimal for atomic arithmetic</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="n">cash</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100000.00&quot;</span><span class="p">)</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="n">cash</span> <span class="o">-=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">cost</span>  <span class="c1"># Atomic update</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="c1"># Use locks for multi-step updates</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_lock</span><span class="p">:</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_position</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="n">new_cash</span>
</code></pre></div>
<hr />
<h2 id="state-persistence-and-crash-recovery">State Persistence and Crash Recovery<a class="headerlink" href="#state-persistence-and-crash-recovery" title="Permanent link">&para;</a></h2>
<h3 id="checkpoint-structure">Checkpoint Structure<a class="headerlink" href="#checkpoint-structure" title="Permanent link">&para;</a></h3>
<p>See <a href="#5-statemanager">StateManager section</a> for schema.</p>
<h3 id="checkpoint-frequency-strategy">Checkpoint Frequency Strategy<a class="headerlink" href="#checkpoint-frequency-strategy" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Time-Based</strong>: Every 60 seconds (configurable)</li>
<li><strong>Event-Based</strong>: On significant portfolio changes (&gt;10% value change)</li>
<li><strong>Shutdown</strong>: On graceful shutdown</li>
<li><strong>Emergency</strong>: On crash (exception handler)</li>
</ol>
<h3 id="storage-format">Storage Format<a class="headerlink" href="#storage-format" title="Permanent link">&para;</a></h3>
<p><strong>JSON (Default):</strong>
- Human-readable for debugging
- Easy to inspect and modify
- Slower to parse (acceptable for checkpoint frequency)</p>
<p><strong>Pickle (Alternative):</strong>
- Faster to serialize/deserialize
- Binary format (not human-readable)
- Requires Python version compatibility</p>
<p><strong>Recommendation:</strong> Use JSON for simplicity, switch to Pickle only if profiling shows performance issue.</p>
<h3 id="atomic-write-strategy">Atomic Write Strategy<a class="headerlink" href="#atomic-write-strategy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="kn">import</span> <span class="nn">tempfile</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Atomically write checkpoint.&quot;&quot;&quot;</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>    <span class="c1"># Write to temp file first</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>    <span class="n">temp_fd</span><span class="p">,</span> <span class="n">temp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_file</span><span class="p">))</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>        <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">temp_fd</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>  <span class="c1"># Decimal → str</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>        <span class="c1"># Atomic rename (POSIX guarantee)</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a>        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_file</span><span class="p">)</span>
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checkpoint saved&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_file</span><span class="p">)</span>
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Checkpoint failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>        <span class="k">raise</span>
</code></pre></div>
<h3 id="state-restoration-procedure">State Restoration Procedure<a class="headerlink" href="#state-restoration-procedure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">restore_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Restore state from checkpoint.&quot;&quot;&quot;</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_file</span><span class="p">):</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No checkpoint found, starting fresh&quot;</span><span class="p">)</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>    <span class="c1"># Validate checkpoint timestamp</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>    <span class="n">checkpoint_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>    <span class="n">age</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">checkpoint_time</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>    <span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>            <span class="s2">&quot;Checkpoint is stale&quot;</span><span class="p">,</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>            <span class="n">age_hours</span><span class="o">=</span><span class="n">age</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">,</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>            <span class="n">checkpoint_time</span><span class="o">=</span><span class="n">checkpoint_time</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>        <span class="p">)</span>
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>        <span class="n">user_confirm</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Checkpoint is &gt;1 hour old. Continue? (y/n): &quot;</span><span class="p">)</span>
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>        <span class="k">if</span> <span class="n">user_confirm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Stale checkpoint rejected by user&quot;</span><span class="p">)</span>
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>    <span class="c1"># Restore portfolio state</span>
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;portfolio&#39;</span><span class="p">][</span><span class="s1">&#39;cash&#39;</span><span class="p">])</span>
<a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;portfolio&#39;</span><span class="p">][</span><span class="s1">&#39;positions&#39;</span><span class="p">]:</span>
<a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;asset&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">DecimalPosition</span><span class="p">(</span>
<a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>            <span class="n">asset</span><span class="o">=</span><span class="n">Asset</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;asset&#39;</span><span class="p">]),</span>
<a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]),</span>
<a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>            <span class="n">cost_basis</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;cost_basis&#39;</span><span class="p">]),</span>
<a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a>            <span class="n">last_sale_price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;last_sale_price&#39;</span><span class="p">])</span>
<a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a>        <span class="p">)</span>
<a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>
<a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a>    <span class="c1"># Restore strategy context</span>
<a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">][</span><span class="s1">&#39;context&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-44-37" name="__codelineno-44-37" href="#__codelineno-44-37"></a>
<a id="__codelineno-44-38" name="__codelineno-44-38" href="#__codelineno-44-38"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;State restored from checkpoint&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">checkpoint_time</span><span class="p">)</span>
<a id="__codelineno-44-39" name="__codelineno-44-39" href="#__codelineno-44-39"></a>    <span class="k">return</span> <span class="n">state</span>
</code></pre></div>
<h3 id="position-reconciliation">Position Reconciliation<a class="headerlink" href="#position-reconciliation" title="Permanent link">&para;</a></h3>
<p><strong>Reconciliation Overview:</strong></p>
<p>The PositionReconciler compares local state (positions, cash, orders) against broker state to detect and handle discrepancies. Reconciliation runs:
1. On engine startup (after state restoration)
2. Periodically during operation (default: every 5 minutes)
3. After significant events (large order fills, connection recovery)</p>
<p><strong>Reconciliation Components:</strong></p>
<ol>
<li><strong>Position Reconciliation</strong>: Compare local positions vs. broker positions</li>
<li>Quantity mismatches</li>
<li>Missing positions (local only or broker only)</li>
<li>
<p>Side mismatches (long vs. short)</p>
</li>
<li>
<p><strong>Cash Balance Reconciliation</strong>: Compare local cash vs. broker account balance</p>
</li>
<li>Configurable tolerance (default: 1%)</li>
<li>
<p>Accounts for rounding and commission differences</p>
</li>
<li>
<p><strong>Order Reconciliation</strong>: Compare local pending orders vs. broker open orders</p>
</li>
<li>Orphaned orders (exists locally but not at broker, or vice versa)</li>
<li>Status mismatches (local=pending, broker=filled)</li>
</ol>
<p><strong>Discrepancy Severity Classification:</strong></p>
<table>
<thead>
<tr>
<th>Severity</th>
<th>Criteria</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>MINOR</strong></td>
<td>&lt;1% quantity difference</td>
<td>Local=1000 shares, Broker=1005 shares (0.5%)</td>
</tr>
<tr>
<td><strong>MODERATE</strong></td>
<td>1-5% quantity difference</td>
<td>Local=100 shares, Broker=103 shares (3%)</td>
</tr>
<tr>
<td><strong>CRITICAL</strong></td>
<td>&gt;5% difference, missing position, or side mismatch</td>
<td>Local=100 shares, Broker=0 shares</td>
</tr>
</tbody>
</table>
<p><strong>Discrepancy Types:</strong></p>
<ul>
<li><code>QUANTITY_MISMATCH</code>: Position amounts differ</li>
<li><code>MISSING_LOCAL</code>: Position exists at broker but not locally</li>
<li><code>MISSING_BROKER</code>: Position exists locally but not at broker</li>
<li><code>SIDE_MISMATCH</code>: Position direction opposite (long vs. short)</li>
</ul>
<p><strong>Reconciliation Strategies:</strong></p>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Description</th>
<th>Use Case</th>
<th>Risk Level</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WARN_ONLY</code></td>
<td>Log discrepancies, continue operation</td>
<td>Development, minor discrepancies</td>
<td>Low</td>
</tr>
<tr>
<td><code>SYNC_TO_BROKER</code></td>
<td>Update local state to match broker</td>
<td>Production (recommended)</td>
<td>Low</td>
</tr>
<tr>
<td><code>SYNC_TO_LOCAL</code></td>
<td>Submit orders to match local state</td>
<td>Advanced users only</td>
<td><strong>HIGH</strong></td>
</tr>
<tr>
<td><code>HALT_AND_ALERT</code></td>
<td>Stop engine for manual intervention</td>
<td>Critical discrepancies</td>
<td>Conservative</td>
</tr>
</tbody>
</table>
<p><strong>Reconciliation Report:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="k">class</span> <span class="nc">ReconciliationReport</span><span class="p">:</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>    <span class="n">position_discrepancies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PositionDiscrepancy</span><span class="p">]</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>    <span class="n">cash_discrepancy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CashDiscrepancy</span><span class="p">]</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>    <span class="n">order_discrepancies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderDiscrepancy</span><span class="p">]</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>    <span class="n">actions_taken</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>    <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>    <span class="k">def</span> <span class="nf">has_critical_discrepancies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if report contains critical discrepancies.&quot;&quot;&quot;</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a>        <span class="o">...</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>    <span class="k">def</span> <span class="nf">total_discrepancy_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get total count of all discrepancies.&quot;&quot;&quot;</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a>        <span class="o">...</span>
</code></pre></div>
<p><strong>Usage Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1"># Configure reconciliation</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">LiveTradingEngine</span><span class="p">(</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>    <span class="n">broker_adapter</span><span class="o">=</span><span class="n">broker</span><span class="p">,</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>    <span class="n">data_portal</span><span class="o">=</span><span class="n">portal</span><span class="p">,</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>    <span class="n">reconciliation_strategy</span><span class="o">=</span><span class="n">ReconciliationStrategy</span><span class="o">.</span><span class="n">SYNC_TO_BROKER</span><span class="p">,</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>    <span class="n">reconciliation_interval_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 minutes</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="p">)</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="c1"># Reconciliation runs automatically on startup and periodically</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="c1"># Access reconciliation report via logs</span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="c1"># 2025-10-03 14:30:00 [info] reconciliation_completed</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="c1">#   total_discrepancies=0 summary=&quot;No discrepancies detected&quot;</span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a><span class="c1">#</span>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="c1"># 2025-10-03 14:35:00 [warning] reconciliation_discrepancies_detected</span>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a><span class="c1">#   discrepancy_count=2 position_discrepancies=1 cash_discrepancy=1</span>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a><span class="c1">#   summary=&quot;Found 2 discrepancies: 1 positions, 1 cash, 0 orders. Critical: 1&quot;</span>
</code></pre></div>
<p><strong>Reconciliation After State Restore:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">reconcile_after_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reconcile positions with broker after crash recovery.&quot;&quot;&quot;</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reconciling positions with broker after restore&quot;</span><span class="p">)</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>    <span class="c1"># Get restored local state</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>    <span class="n">local_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_manager</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>    <span class="n">local_cash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_manager</span><span class="o">.</span><span class="n">get_cash</span><span class="p">()</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>    <span class="n">local_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_manager</span><span class="o">.</span><span class="n">get_pending_orders</span><span class="p">()</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>    <span class="c1"># Run comprehensive reconciliation</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>    <span class="n">report</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconciler</span><span class="o">.</span><span class="n">reconcile_all</span><span class="p">(</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>        <span class="n">local_positions</span><span class="o">=</span><span class="n">local_positions</span><span class="p">,</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>        <span class="n">local_cash</span><span class="o">=</span><span class="n">local_cash</span><span class="p">,</span>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a>        <span class="n">local_orders</span><span class="o">=</span><span class="n">local_orders</span><span class="p">,</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>    <span class="p">)</span>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a>    <span class="c1"># Log results</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a>    <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">has_critical_discrepancies</span><span class="p">():</span>
<a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
<a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a>            <span class="s2">&quot;critical_reconciliation_discrepancies&quot;</span><span class="p">,</span>
<a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a>            <span class="n">discrepancy_count</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">total_discrepancy_count</span><span class="p">(),</span>
<a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a>            <span class="n">summary</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span>
<a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a>        <span class="p">)</span>
<a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a>        <span class="c1"># Strategy may halt engine for manual intervention</span>
<a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a>            <span class="s2">&quot;reconciliation_success&quot;</span><span class="p">,</span>
<a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a>            <span class="n">discrepancy_count</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">total_discrepancy_count</span><span class="p">(),</span>
<a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a>            <span class="n">summary</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span>
<a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a>        <span class="p">)</span>
</code></pre></div>
<p><strong>Reconciliation Workflow:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>┌─────────────────────────────────────────────────────────────────┐
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>│                   Reconciliation Workflow                        │
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>└─────────────────────────────────────────────────────────────────┘
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>1. Trigger Reconciliation (startup/periodic/event-based)
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>          │
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>          ▼
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>2. Fetch Broker State
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>   - get_positions()
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>   - get_account_info() → cash balance
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>   - get_open_orders()
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>          │
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>          ▼
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a>3. Compare with Local State
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>   - Position amounts (Decimal precision)
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>   - Cash balance (with tolerance)
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>   - Order statuses
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>          │
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>          ▼
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a>4. Classify Discrepancies
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a>   - Severity: MINOR / MODERATE / CRITICAL
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a>   - Type: QUANTITY_MISMATCH / MISSING_LOCAL / MISSING_BROKER / SIDE_MISMATCH
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>          │
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>          ▼
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a>5. Generate Report
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a>   - Timestamp
<a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a>   - All discrepancies with details
<a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a>   - Summary statistics
<a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a>          │
<a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a>          ▼
<a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a>6. Apply Strategy
<a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a>   ├─ WARN_ONLY → Log and continue
<a id="__codelineno-48-33" name="__codelineno-48-33" href="#__codelineno-48-33"></a>   ├─ SYNC_TO_BROKER → Update local state
<a id="__codelineno-48-34" name="__codelineno-48-34" href="#__codelineno-48-34"></a>   ├─ SYNC_TO_LOCAL → Submit corrective orders (RISKY!)
<a id="__codelineno-48-35" name="__codelineno-48-35" href="#__codelineno-48-35"></a>   └─ HALT_AND_ALERT → Stop engine, require manual intervention
<a id="__codelineno-48-36" name="__codelineno-48-36" href="#__codelineno-48-36"></a>          │
<a id="__codelineno-48-37" name="__codelineno-48-37" href="#__codelineno-48-37"></a>          ▼
<a id="__codelineno-48-38" name="__codelineno-48-38" href="#__codelineno-48-38"></a>7. Log Reconciliation Results
<a id="__codelineno-48-39" name="__codelineno-48-39" href="#__codelineno-48-39"></a>   - Structured logging with full context
<a id="__codelineno-48-40" name="__codelineno-48-40" href="#__codelineno-48-40"></a>   - Metrics emission for monitoring
</code></pre></div>
<p><strong>Troubleshooting Common Discrepancies:</strong></p>
<table>
<thead>
<tr>
<th>Discrepancy</th>
<th>Likely Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Small quantity mismatch (&lt;1%)</td>
<td>Commission/fee rounding</td>
<td>Acceptable with WARN_ONLY</td>
</tr>
<tr>
<td>Cash balance mismatch</td>
<td>Pending settlements, fees</td>
<td>Increase tolerance or SYNC_TO_BROKER</td>
</tr>
<tr>
<td>Missing local position</td>
<td>Manual broker trade during downtime</td>
<td>SYNC_TO_BROKER to import</td>
</tr>
<tr>
<td>Missing broker position</td>
<td>Order fill during crash</td>
<td>Investigate order history</td>
</tr>
<tr>
<td>Orphaned local order</td>
<td>Order cancelled at broker</td>
<td>Update local status</td>
</tr>
<tr>
<td>Orphaned broker order</td>
<td>Order placed manually</td>
<td>Cancel or import</td>
</tr>
</tbody>
</table>
<p><strong>Configuration Options:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1"># Initialize reconciler with custom settings</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="n">reconciler</span> <span class="o">=</span> <span class="n">PositionReconciler</span><span class="p">(</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="n">broker_adapter</span><span class="o">=</span><span class="n">broker</span><span class="p">,</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="n">reconciliation_strategy</span><span class="o">=</span><span class="n">ReconciliationStrategy</span><span class="o">.</span><span class="n">SYNC_TO_BROKER</span><span class="p">,</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>    <span class="n">cash_tolerance_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>  <span class="c1"># 2% tolerance for cash</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="p">)</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="c1"># Update strategy at runtime</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="n">reconciler</span><span class="o">.</span><span class="n">set_strategy</span><span class="p">(</span><span class="n">ReconciliationStrategy</span><span class="o">.</span><span class="n">HALT_AND_ALERT</span><span class="p">)</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="c1"># Update cash tolerance at runtime</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="n">reconciler</span><span class="o">.</span><span class="n">set_cash_tolerance</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># 1% tolerance</span>
</code></pre></div>
<h3 id="crash-recovery-workflow">Crash Recovery Workflow<a class="headerlink" href="#crash-recovery-workflow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>1. Detect crash (engine restart)
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>2. Load checkpoint file
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>3. Validate checkpoint timestamp (warn if stale)
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>4. Restore portfolio state (cash, positions, pending orders)
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>5. Restore strategy context
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>6. Reconnect to broker
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>7. Reconcile positions (local vs. broker)
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>8. Reconcile open orders
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>9. Resume event loop
</code></pre></div>
<hr />
<h2 id="error-handling-and-retry-strategy">Error Handling and Retry Strategy<a class="headerlink" href="#error-handling-and-retry-strategy" title="Permanent link">&para;</a></h2>
<h3 id="error-classification">Error Classification<a class="headerlink" href="#error-classification" title="Permanent link">&para;</a></h3>
<p><strong>Transient Errors</strong> (retry):
- Network timeouts
- Broker API rate limits (429)
- Temporary connection loss
- Broker maintenance (503)</p>
<p><strong>Permanent Errors</strong> (fail):
- Invalid credentials (401)
- Order validation errors (e.g., insufficient funds)
- Unsupported order type
- Asset not tradable</p>
<h3 id="retry-logic-with-exponential-backoff">Retry Logic with Exponential Backoff<a class="headerlink" href="#retry-logic-with-exponential-backoff" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="kn">import</span> <span class="nn">asyncio</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Callable</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">retry_with_backoff</span><span class="p">(</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>    <span class="n">base_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>    <span class="n">max_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">16.0</span><span class="p">,</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>    <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Retry function with exponential backoff.</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="sd">    Args:</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="sd">        func: Async function to retry</span>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="sd">        max_retries: Maximum retry attempts</span>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="sd">        base_delay: Initial delay (seconds)</span>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="sd">        max_delay: Maximum delay (seconds)</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="sd">    Returns:</span>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="sd">        Function result</span>
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a>
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a><span class="sd">    Raises:</span>
<a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a><span class="sd">        Exception: If all retries exhausted</span>
<a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a>            <span class="k">return</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a>        <span class="k">except</span> <span class="n">TransientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a>            <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a>                <span class="k">raise</span>  <span class="c1"># Last attempt failed</span>
<a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a>
<a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a>            <span class="n">delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">),</span> <span class="n">max_delay</span><span class="p">)</span>
<a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a>                <span class="s2">&quot;Retry after transient error&quot;</span><span class="p">,</span>
<a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a>                <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a>                <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">,</span>
<a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a>                <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span>
<a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a>                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-51-42" name="__codelineno-51-42" href="#__codelineno-51-42"></a>            <span class="p">)</span>
<a id="__codelineno-51-43" name="__codelineno-51-43" href="#__codelineno-51-43"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
<a id="__codelineno-51-44" name="__codelineno-51-44" href="#__codelineno-51-44"></a>        <span class="k">except</span> <span class="n">PermanentError</span><span class="p">:</span>
<a id="__codelineno-51-45" name="__codelineno-51-45" href="#__codelineno-51-45"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Permanent error, not retrying&quot;</span><span class="p">)</span>
<a id="__codelineno-51-46" name="__codelineno-51-46" href="#__codelineno-51-46"></a>            <span class="k">raise</span>
<a id="__codelineno-51-47" name="__codelineno-51-47" href="#__codelineno-51-47"></a>
<a id="__codelineno-51-48" name="__codelineno-51-48" href="#__codelineno-51-48"></a><span class="c1"># Usage</span>
<a id="__codelineno-51-49" name="__codelineno-51-49" href="#__codelineno-51-49"></a><span class="n">order_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retry_with_backoff</span><span class="p">(</span>
<a id="__codelineno-51-50" name="__codelineno-51-50" href="#__codelineno-51-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">submit_order</span><span class="p">,</span>
<a id="__codelineno-51-51" name="__codelineno-51-51" href="#__codelineno-51-51"></a>    <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span>
<a id="__codelineno-51-52" name="__codelineno-51-52" href="#__codelineno-51-52"></a>    <span class="n">amount</span><span class="o">=</span><span class="n">amount</span>
<a id="__codelineno-51-53" name="__codelineno-51-53" href="#__codelineno-51-53"></a><span class="p">)</span>
</code></pre></div>
<h3 id="circuit-breaker-pattern">Circuit Breaker Pattern<a class="headerlink" href="#circuit-breaker-pattern" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="k">class</span> <span class="nc">CircuitBreakerState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>    <span class="n">CLOSED</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>    <span class="c1"># Normal operation</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>    <span class="n">OPEN</span> <span class="o">=</span> <span class="s2">&quot;open&quot;</span>        <span class="c1"># Failing, reject requests</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>    <span class="n">HALF_OPEN</span> <span class="o">=</span> <span class="s2">&quot;half_open&quot;</span>  <span class="c1"># Testing recovery</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="k">class</span> <span class="nc">CircuitBreaker</span><span class="p">:</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Circuit breaker for broker operations.&quot;&quot;&quot;</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>        <span class="n">failure_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a>        <span class="n">recovery_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a>        <span class="n">success_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a>    <span class="p">):</span>
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failure_threshold</span> <span class="o">=</span> <span class="n">failure_threshold</span>
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">recovery_timeout</span> <span class="o">=</span> <span class="n">recovery_timeout</span>
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">success_threshold</span> <span class="o">=</span> <span class="n">success_threshold</span>
<a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a>
<a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitBreakerState</span><span class="o">.</span><span class="n">CLOSED</span>
<a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a>
<a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute function through circuit breaker.&quot;&quot;&quot;</span>
<a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CircuitBreakerState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
<a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a>            <span class="c1"># Check if recovery timeout elapsed</span>
<a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a>            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recovery_timeout</span><span class="p">):</span>
<a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Circuit breaker entering half-open state&quot;</span><span class="p">)</span>
<a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitBreakerState</span><span class="o">.</span><span class="n">HALF_OPEN</span>
<a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a>                <span class="k">raise</span> <span class="n">CircuitBreakerError</span><span class="p">(</span><span class="s2">&quot;Circuit breaker is OPEN&quot;</span><span class="p">)</span>
<a id="__codelineno-52-37" name="__codelineno-52-37" href="#__codelineno-52-37"></a>
<a id="__codelineno-52-38" name="__codelineno-52-38" href="#__codelineno-52-38"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-52-39" name="__codelineno-52-39" href="#__codelineno-52-39"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-52-40" name="__codelineno-52-40" href="#__codelineno-52-40"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_on_success</span><span class="p">()</span>
<a id="__codelineno-52-41" name="__codelineno-52-41" href="#__codelineno-52-41"></a>            <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-52-42" name="__codelineno-52-42" href="#__codelineno-52-42"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-52-43" name="__codelineno-52-43" href="#__codelineno-52-43"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_on_failure</span><span class="p">()</span>
<a id="__codelineno-52-44" name="__codelineno-52-44" href="#__codelineno-52-44"></a>            <span class="k">raise</span>
<a id="__codelineno-52-45" name="__codelineno-52-45" href="#__codelineno-52-45"></a>
<a id="__codelineno-52-46" name="__codelineno-52-46" href="#__codelineno-52-46"></a>    <span class="k">def</span> <span class="nf">_on_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-52-47" name="__codelineno-52-47" href="#__codelineno-52-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle successful call.&quot;&quot;&quot;</span>
<a id="__codelineno-52-48" name="__codelineno-52-48" href="#__codelineno-52-48"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CircuitBreakerState</span><span class="o">.</span><span class="n">HALF_OPEN</span><span class="p">:</span>
<a id="__codelineno-52-49" name="__codelineno-52-49" href="#__codelineno-52-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-52-50" name="__codelineno-52-50" href="#__codelineno-52-50"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_threshold</span><span class="p">:</span>
<a id="__codelineno-52-51" name="__codelineno-52-51" href="#__codelineno-52-51"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Circuit breaker closed after recovery&quot;</span><span class="p">)</span>
<a id="__codelineno-52-52" name="__codelineno-52-52" href="#__codelineno-52-52"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitBreakerState</span><span class="o">.</span><span class="n">CLOSED</span>
<a id="__codelineno-52-53" name="__codelineno-52-53" href="#__codelineno-52-53"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-52-54" name="__codelineno-52-54" href="#__codelineno-52-54"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-52-55" name="__codelineno-52-55" href="#__codelineno-52-55"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-52-56" name="__codelineno-52-56" href="#__codelineno-52-56"></a>
<a id="__codelineno-52-57" name="__codelineno-52-57" href="#__codelineno-52-57"></a>    <span class="k">def</span> <span class="nf">_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-52-58" name="__codelineno-52-58" href="#__codelineno-52-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle failed call.&quot;&quot;&quot;</span>
<a id="__codelineno-52-59" name="__codelineno-52-59" href="#__codelineno-52-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-52-60" name="__codelineno-52-60" href="#__codelineno-52-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-52-61" name="__codelineno-52-61" href="#__codelineno-52-61"></a>
<a id="__codelineno-52-62" name="__codelineno-52-62" href="#__codelineno-52-62"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_threshold</span><span class="p">:</span>
<a id="__codelineno-52-63" name="__codelineno-52-63" href="#__codelineno-52-63"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-52-64" name="__codelineno-52-64" href="#__codelineno-52-64"></a>                <span class="s2">&quot;Circuit breaker tripped&quot;</span><span class="p">,</span>
<a id="__codelineno-52-65" name="__codelineno-52-65" href="#__codelineno-52-65"></a>                <span class="n">failure_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span><span class="p">,</span>
<a id="__codelineno-52-66" name="__codelineno-52-66" href="#__codelineno-52-66"></a>                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">failure_threshold</span>
<a id="__codelineno-52-67" name="__codelineno-52-67" href="#__codelineno-52-67"></a>            <span class="p">)</span>
<a id="__codelineno-52-68" name="__codelineno-52-68" href="#__codelineno-52-68"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitBreakerState</span><span class="o">.</span><span class="n">OPEN</span>
<a id="__codelineno-52-69" name="__codelineno-52-69" href="#__codelineno-52-69"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CircuitBreakerState</span><span class="o">.</span><span class="n">HALF_OPEN</span><span class="p">:</span>
<a id="__codelineno-52-70" name="__codelineno-52-70" href="#__codelineno-52-70"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Circuit breaker reopened after failure during recovery&quot;</span><span class="p">)</span>
<a id="__codelineno-52-71" name="__codelineno-52-71" href="#__codelineno-52-71"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitBreakerState</span><span class="o">.</span><span class="n">OPEN</span>
</code></pre></div>
<h3 id="graceful-degradation-strategy">Graceful Degradation Strategy<a class="headerlink" href="#graceful-degradation-strategy" title="Permanent link">&para;</a></h3>
<p><strong>Fallback to Paper Trading Mode:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">handle_broker_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Fallback to paper trading on broker failure.&quot;&quot;&quot;</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Broker adapter failed, switching to paper trading mode&quot;</span><span class="p">)</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>    <span class="c1"># Switch to PaperBroker</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">PaperBroker</span><span class="p">(</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>        <span class="n">initial_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_current_portfolio_snapshot</span><span class="p">()</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>    <span class="p">)</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>    <span class="c1"># Emit alert</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>    <span class="n">emit_alert</span><span class="p">(</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>        <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;CRITICAL&quot;</span><span class="p">,</span>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Live broker failed, switched to paper trading&quot;</span><span class="p">,</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>        <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;previous_broker&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>    <span class="p">)</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>    <span class="c1"># Resume trading in paper mode</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</code></pre></div>
<h3 id="timeout-strategies">Timeout Strategies<a class="headerlink" href="#timeout-strategies" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1"># Order submission timeout</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>    <span class="n">order_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">),</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>        <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span>  <span class="c1"># 30 seconds</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>    <span class="p">)</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Order submission timeout&quot;</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>    <span class="k">raise</span> <span class="n">BrokerTimeoutError</span><span class="p">(</span><span class="s2">&quot;Order submission took &gt;30 seconds&quot;</span><span class="p">)</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="c1"># Position fetch timeout</span>
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>    <span class="n">positions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
<a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(),</span>
<a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a>        <span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span>  <span class="c1"># 10 seconds</span>
<a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a>    <span class="p">)</span>
<a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
<a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Position fetch timeout, using cached data&quot;</span><span class="p">)</span>
<a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a>    <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_positions</span><span class="p">()</span>
</code></pre></div>
<h3 id="error-propagation-strategy">Error Propagation Strategy<a class="headerlink" href="#error-propagation-strategy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># Log, alert, retry, or fail based on error type</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>    <span class="n">order_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="k">except</span> <span class="n">InsufficientFundsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>    <span class="c1"># Permanent error: log, alert, do NOT retry</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Insufficient funds&quot;</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>    <span class="n">emit_alert</span><span class="p">(</span><span class="n">severity</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Order rejected: insufficient funds&quot;</span><span class="p">)</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>    <span class="k">raise</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="k">except</span> <span class="n">BrokerConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>    <span class="c1"># Transient error: log, retry with backoff</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Broker connection error, retrying&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a>    <span class="n">order_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retry_with_backoff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">submit_order</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="k">except</span> <span class="n">BrokerMaintenanceError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a>    <span class="c1"># Temporary error: log, alert, wait for maintenance window</span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Broker in maintenance mode&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a>    <span class="n">emit_alert</span><span class="p">(</span><span class="n">severity</span><span class="o">=</span><span class="s2">&quot;CRITICAL&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Broker maintenance, trading halted&quot;</span><span class="p">)</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_broker_recovery</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="monitoring-and-alerting">Monitoring and Alerting<a class="headerlink" href="#monitoring-and-alerting" title="Permanent link">&para;</a></h2>
<h3 id="monitoring-event-hooks">Monitoring Event Hooks<a class="headerlink" href="#monitoring-event-hooks" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="k">class</span> <span class="nc">LiveTradingEngine</span><span class="p">:</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Engine with monitoring hooks.&quot;&quot;&quot;</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_order_submitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hook: Order submitted.&quot;&quot;&quot;</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;order_submitted&quot;</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">amount</span><span class="p">))</span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>        <span class="n">emit_metric</span><span class="p">(</span><span class="s2">&quot;orders_submitted&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;asset&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">symbol</span><span class="p">})</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_order_filled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hook: Order filled.&quot;&quot;&quot;</span>
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>            <span class="s2">&quot;order_filled&quot;</span><span class="p">,</span>
<a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>            <span class="n">fill_price</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">price</span><span class="p">),</span>
<a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>            <span class="n">fill_amount</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">amount</span><span class="p">),</span>
<a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a>            <span class="n">commission</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">commission</span><span class="p">)</span>
<a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a>        <span class="p">)</span>
<a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a>        <span class="n">emit_metric</span><span class="p">(</span><span class="s2">&quot;orders_filled&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;asset&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">symbol</span><span class="p">})</span>
<a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a>        <span class="n">emit_metric</span><span class="p">(</span><span class="s2">&quot;fill_price&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;asset&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">symbol</span><span class="p">})</span>
<a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>        <span class="n">emit_metric</span><span class="p">(</span><span class="s2">&quot;commission_paid&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">commission</span><span class="p">))</span>
<a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a>
<a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
<a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hook: Error occurred.&quot;&quot;&quot;</span>
<a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;error_occurred&quot;</span><span class="p">,</span> <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
<a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a>        <span class="n">emit_metric</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">})</span>
<a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a>
<a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_state_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hook: State checkpoint saved.&quot;&quot;&quot;</span>
<a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;state_checkpoint_saved&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">state_file</span><span class="p">)</span>
<a id="__codelineno-56-30" name="__codelineno-56-30" href="#__codelineno-56-30"></a>        <span class="n">emit_metric</span><span class="p">(</span><span class="s2">&quot;checkpoints_saved&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<h3 id="metric-emission-points">Metric Emission Points<a class="headerlink" href="#metric-emission-points" title="Permanent link">&para;</a></h3>
<p><strong>Latency Metrics:</strong>
- Order submission latency (strategy signal → broker API call)
- Order fill latency (broker fill → local position update)
- Event processing latency (event received → processed)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">submit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Submit order with latency tracking.&quot;&quot;&quot;</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>    <span class="n">order_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>    <span class="n">latency_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>    <span class="n">emit_metric</span><span class="p">(</span><span class="s2">&quot;order_submission_latency_ms&quot;</span><span class="p">,</span> <span class="n">latency_ms</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;asset&quot;</span><span class="p">:</span> <span class="n">asset</span><span class="o">.</span><span class="n">symbol</span><span class="p">})</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>    <span class="k">return</span> <span class="n">order_id</span>
</code></pre></div>
<p><strong>Throughput Metrics:</strong>
- Events processed per second
- Orders submitted per minute
- Market data updates per second</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="k">class</span> <span class="nc">ThroughputTracker</span><span class="p">:</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Track throughput metrics.&quot;&quot;&quot;</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">window_seconds</span> <span class="o">=</span> <span class="n">window_seconds</span>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span> <span class="n">deque</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>    <span class="k">def</span> <span class="nf">record_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record event timestamp.&quot;&quot;&quot;</span>
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
<a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a>
<a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a>        <span class="c1"># Remove events outside window</span>
<a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a>        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window_seconds</span><span class="p">)</span>
<a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
<a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
<a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a>
<a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a>    <span class="k">def</span> <span class="nf">get_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get events per second.&quot;&quot;&quot;</span>
<a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_seconds</span>
<a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a>
<a id="__codelineno-58-25" name="__codelineno-58-25" href="#__codelineno-58-25"></a><span class="c1"># Usage</span>
<a id="__codelineno-58-26" name="__codelineno-58-26" href="#__codelineno-58-26"></a><span class="n">throughput_tracker</span> <span class="o">=</span> <span class="n">ThroughputTracker</span><span class="p">()</span>
<a id="__codelineno-58-27" name="__codelineno-58-27" href="#__codelineno-58-27"></a>
<a id="__codelineno-58-28" name="__codelineno-58-28" href="#__codelineno-58-28"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">process_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-58-29" name="__codelineno-58-29" href="#__codelineno-58-29"></a>    <span class="n">throughput_tracker</span><span class="o">.</span><span class="n">record_event</span><span class="p">()</span>
<a id="__codelineno-58-30" name="__codelineno-58-30" href="#__codelineno-58-30"></a>    <span class="c1"># ... process event</span>
<a id="__codelineno-58-31" name="__codelineno-58-31" href="#__codelineno-58-31"></a>    <span class="n">emit_metric</span><span class="p">(</span><span class="s2">&quot;events_per_second&quot;</span><span class="p">,</span> <span class="n">throughput_tracker</span><span class="o">.</span><span class="n">get_rate</span><span class="p">())</span>
</code></pre></div>
<p><strong>Error Rate Metrics:</strong>
- Order rejections per hour
- Broker connection failures per day
- Position reconciliation mismatches per day</p>
<p><strong>Position Reconciliation Metrics:</strong>
- Reconciliation mismatch count
- Mismatch percentage (by value)
- Last successful reconciliation timestamp</p>
<h3 id="alerting-triggers">Alerting Triggers<a class="headerlink" href="#alerting-triggers" title="Permanent link">&para;</a></h3>
<p><strong>Critical Alerts</strong> (immediate notification):
- Circuit breaker tripped
- Position reconciliation failure (&gt;5% drift)
- Broker disconnection
- Shadow alignment circuit breaker tripped</p>
<p><strong>Warning Alerts</strong> (batch notification):
- Order rejection rate &gt;10%
- Checkpoint save failure
- Stale data warning (no market data &gt;5 minutes)</p>
<p><strong>Alert Implementation:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="kn">import</span> <span class="nn">aiohttp</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">emit_alert</span><span class="p">(</span><span class="n">severity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Emit alert to external monitoring system.</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="sd">        severity: &#39;INFO&#39;, &#39;WARNING&#39;, &#39;ERROR&#39;, &#39;CRITICAL&#39;</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="sd">        message: Alert message</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="sd">        details: Additional context (optional)</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a>        <span class="n">severity</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a>        <span class="s2">&quot;alert_emitted&quot;</span><span class="p">,</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a>        <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a>        <span class="n">details</span><span class="o">=</span><span class="n">details</span>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a>    <span class="p">)</span>
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a>
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a>    <span class="c1"># Send to webhook (e.g., Slack, PagerDuty, custom endpoint)</span>
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a>    <span class="n">webhook_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ALERT_WEBHOOK_URL&quot;</span><span class="p">)</span>
<a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a>    <span class="k">if</span> <span class="n">webhook_url</span><span class="p">:</span>
<a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a>            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a>                <span class="n">webhook_url</span><span class="p">,</span>
<a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a>                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a>                    <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
<a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
<a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a>                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
<a id="__codelineno-59-28" name="__codelineno-59-28" href="#__codelineno-59-28"></a>                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-59-29" name="__codelineno-59-29" href="#__codelineno-59-29"></a>                <span class="p">}</span>
<a id="__codelineno-59-30" name="__codelineno-59-30" href="#__codelineno-59-30"></a>            <span class="p">)</span>
<a id="__codelineno-59-31" name="__codelineno-59-31" href="#__codelineno-59-31"></a>
<a id="__codelineno-59-32" name="__codelineno-59-32" href="#__codelineno-59-32"></a>    <span class="c1"># Send email for critical alerts</span>
<a id="__codelineno-59-33" name="__codelineno-59-33" href="#__codelineno-59-33"></a>    <span class="k">if</span> <span class="n">severity</span> <span class="o">==</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">:</span>
<a id="__codelineno-59-34" name="__codelineno-59-34" href="#__codelineno-59-34"></a>        <span class="k">await</span> <span class="n">send_email_alert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</code></pre></div>
<h3 id="integration-points-for-external-monitoring">Integration Points for External Monitoring<a class="headerlink" href="#integration-points-for-external-monitoring" title="Permanent link">&para;</a></h3>
<p><strong>Prometheus:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Gauge</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="c1"># Metrics</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="n">orders_submitted</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s2">&quot;orders_submitted_total&quot;</span><span class="p">,</span> <span class="s2">&quot;Orders submitted&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;asset&quot;</span><span class="p">])</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="n">order_latency</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span><span class="s2">&quot;order_submission_latency_seconds&quot;</span><span class="p">,</span> <span class="s2">&quot;Order submission latency&quot;</span><span class="p">)</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="s2">&quot;portfolio_value_usd&quot;</span><span class="p">,</span> <span class="s2">&quot;Current portfolio value&quot;</span><span class="p">)</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="c1"># Usage</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="n">orders_submitted</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="s2">&quot;SPY&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="n">order_latency</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">latency_seconds</span><span class="p">)</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="n">portfolio_value</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">))</span>
</code></pre></div>
<p><strong>Grafana Dashboard:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="c1"># Example Grafana dashboard config</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="nt">dashboard</span><span class="p">:</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="w">  </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;RustyBT</span><span class="nv"> </span><span class="s">Live</span><span class="nv"> </span><span class="s">Trading&quot;</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="w">  </span><span class="nt">panels</span><span class="p">:</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Portfolio</span><span class="nv"> </span><span class="s">Value&quot;</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="w">      </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;portfolio_value_usd&quot;</span>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Orders</span><span class="nv"> </span><span class="s">Per</span><span class="nv"> </span><span class="s">Minute&quot;</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="w">      </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rate(orders_submitted_total[1m])&quot;</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Order</span><span class="nv"> </span><span class="s">Latency</span><span class="nv"> </span><span class="s">(p99)&quot;</span>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="w">      </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;histogram_quantile(0.99,</span><span class="nv"> </span><span class="s">order_submission_latency_seconds)&quot;</span>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Error</span><span class="nv"> </span><span class="s">Rate&quot;</span>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="w">      </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rate(errors_total[5m])&quot;</span>
</code></pre></div>
<p><strong>Custom Webhooks:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c1"># Send metrics to custom endpoint</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">emit_metric</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Emit metric to custom monitoring system.&quot;&quot;&quot;</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>    <span class="n">metrics_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;METRICS_ENDPOINT_URL&quot;</span><span class="p">)</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>    <span class="k">if</span> <span class="n">metrics_url</span><span class="p">:</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>                <span class="n">metrics_url</span><span class="p">,</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>                    <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>                    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>                <span class="p">}</span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>            <span class="p">)</span>
</code></pre></div>
<h3 id="health-check-endpoint">Health Check Endpoint<a class="headerlink" href="#health-check-endpoint" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">health_check</span><span class="p">():</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Health check endpoint for monitoring systems.&quot;&quot;&quot;</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span> <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">is_running</span> <span class="k">else</span> <span class="s2">&quot;unhealthy&quot;</span><span class="p">,</span>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>        <span class="s2">&quot;engine_state&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>            <span class="s2">&quot;is_running&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">is_running</span><span class="p">,</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>            <span class="s2">&quot;broker_connected&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">is_connected</span><span class="p">(),</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a>            <span class="s2">&quot;last_checkpoint&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">last_checkpoint_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a>            <span class="s2">&quot;last_market_data&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">last_market_data_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a>        <span class="p">},</span>
<a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>        <span class="s2">&quot;portfolio&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a>            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">),</span>
<a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a>            <span class="s2">&quot;cash&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span><span class="p">),</span>
<a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a>            <span class="s2">&quot;position_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
<a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a>        <span class="p">},</span>
<a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a>        <span class="s2">&quot;shadow_mode&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a>            <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">shadow_mode</span><span class="p">,</span>
<a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a>            <span class="s2">&quot;alignment_metrics&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">shadow_engine</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">()</span> <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">shadow_mode</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a>        <span class="p">}</span>
<a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a>    <span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="shadow-trading-validation">Shadow Trading Validation<a class="headerlink" href="#shadow-trading-validation" title="Permanent link">&para;</a></h2>
<p><strong>Full architecture in:</strong> <a href="../shadow-trading-summary/">architecture/shadow-trading-summary.md</a></p>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p>Shadow trading runs a parallel backtest engine alongside the live engine, feeding both the same real-time market data. This enables continuous validation that backtest predictions align with live execution.</p>
<h3 id="key-components">Key Components<a class="headerlink" href="#key-components" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>ShadowBacktestEngine</strong> (<code>rustybt/live/shadow/engine.py</code>)</li>
<li>Runs backtest simulation in parallel</li>
<li>Uses same market data feed as live engine</li>
<li>Generates backtest signals for comparison</li>
<li>
<p>Isolated state (doesn't affect live trading)</p>
</li>
<li>
<p><strong>SignalAlignmentValidator</strong> (<code>rustybt/live/shadow/signal_validator.py</code>)</p>
</li>
<li>Matches signals by timestamp (±100ms tolerance) and asset</li>
<li>Calculates signal match rate (% agreement)</li>
<li>
<p>Classifies alignment: EXACT_MATCH, DIRECTION_MATCH, MAGNITUDE_MISMATCH, MISSING_SIGNAL</p>
</li>
<li>
<p><strong>ExecutionQualityTracker</strong> (<code>rustybt/live/shadow/execution_tracker.py</code>)</p>
</li>
<li>Tracks slippage error (expected vs. actual in bps)</li>
<li>Tracks fill rate error (partial fill model vs. reality)</li>
<li>
<p>Tracks commission error (model vs. broker charges)</p>
</li>
<li>
<p><strong>AlignmentCircuitBreaker</strong> (<code>rustybt/live/shadow/alignment_breaker.py</code>)</p>
</li>
<li>Trips if signal_match_rate &lt; 0.95 (5% divergence)</li>
<li>Trips if slippage_error &gt; 50bps</li>
<li>Trips if fill_rate_error &gt; 20%</li>
<li>Requires manual reset</li>
</ol>
<h3 id="alignment-metrics">Alignment Metrics<a class="headerlink" href="#alignment-metrics" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="p">{</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="w">  </span><span class="nt">&quot;signal_alignment&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="w">    </span><span class="nt">&quot;signal_match_rate&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.976&quot;</span><span class="p">,</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w">    </span><span class="nt">&quot;divergence_breakdown&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="w">      </span><span class="nt">&quot;EXACT_MATCH&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">38</span><span class="p">,</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="w">      </span><span class="nt">&quot;DIRECTION_MATCH&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="w">      </span><span class="nt">&quot;MAGNITUDE_MISMATCH&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="w">      </span><span class="nt">&quot;MISSING_SIGNAL&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="w">  </span><span class="nt">&quot;execution_quality&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="w">    </span><span class="nt">&quot;expected_slippage_bps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5.2&quot;</span><span class="p">,</span>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="w">    </span><span class="nt">&quot;actual_slippage_bps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;6.8&quot;</span><span class="p">,</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="w">    </span><span class="nt">&quot;slippage_error_bps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.6&quot;</span><span class="p">,</span>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="w">    </span><span class="nt">&quot;fill_rate_expected&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.95&quot;</span><span class="p">,</span>
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a><span class="w">    </span><span class="nt">&quot;fill_rate_actual&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.93&quot;</span><span class="p">,</span>
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a><span class="w">    </span><span class="nt">&quot;fill_rate_error_pct&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;-2.1&quot;</span><span class="p">,</span>
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a><span class="w">    </span><span class="nt">&quot;commission_expected&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;12.50&quot;</span><span class="p">,</span>
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a><span class="w">    </span><span class="nt">&quot;commission_actual&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;13.20&quot;</span><span class="p">,</span>
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a><span class="w">    </span><span class="nt">&quot;commission_error_pct&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5.6&quot;</span>
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a><span class="p">}</span>
</code></pre></div>
<h3 id="configuration-example">Configuration Example<a class="headerlink" href="#configuration-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="kn">from</span> <span class="nn">rustybt.live.shadow.config</span> <span class="kn">import</span> <span class="n">ShadowTradingConfig</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="n">shadow_config</span> <span class="o">=</span> <span class="n">ShadowTradingConfig</span><span class="p">(</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>    <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>    <span class="n">signal_match_rate_min</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.95&quot;</span><span class="p">),</span>  <span class="c1"># 95% alignment required</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>    <span class="n">slippage_error_bps_max</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50&quot;</span><span class="p">),</span>   <span class="c1"># Max 50bps slippage error</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>    <span class="n">fill_rate_error_pct_max</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;20&quot;</span><span class="p">),</span>  <span class="c1"># Max 20% fill rate error</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>    <span class="n">window_hours</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Rolling 1-hour window</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a>    <span class="n">emit_metrics</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Send metrics to monitoring</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a><span class="p">)</span>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">LiveTradingEngine</span><span class="p">(</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>    <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a>    <span class="n">broker</span><span class="o">=</span><span class="n">broker</span><span class="p">,</span>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>    <span class="n">shadow_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a>    <span class="n">shadow_config</span><span class="o">=</span><span class="n">shadow_config</span>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a><span class="p">)</span>
</code></pre></div>
<h3 id="workflow">Workflow<a class="headerlink" href="#workflow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>Phase 1: Backtest (Offline)
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>  ↓
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>Phase 2: Paper Trading + Shadow Mode (Validate 99% alignment)
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>  ↓
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>Phase 3: Live Trading + Shadow Mode (Monitor 95% alignment)
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>  ↓
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>Phase 4: Production (Optional disable shadow, re-enable quarterly)
</code></pre></div>
<hr />
<h2 id="strategy-reusability-guarantee">Strategy Reusability Guarantee<a class="headerlink" href="#strategy-reusability-guarantee" title="Permanent link">&para;</a></h2>
<p><strong>Full specification in:</strong> <a href="../strategy-reusability-guarantee/">architecture/strategy-reusability-guarantee.md</a></p>
<h3 id="the-contract">The Contract<a class="headerlink" href="#the-contract" title="Permanent link">&para;</a></h3>
<p><strong>Guarantee:</strong> Any strategy written for RustyBT's backtest engine <strong>MUST</strong> run in live/paper trading mode <strong>without any code changes</strong>.</p>
<h3 id="example-single-strategy-multiple-execution-modes">Example: Single Strategy, Multiple Execution Modes<a class="headerlink" href="#example-single-strategy-multiple-execution-modes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="c1"># Define strategy once</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="k">class</span> <span class="nc">MomentumStrategy</span><span class="p">(</span><span class="n">TradingAlgorithm</span><span class="p">):</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>        <span class="n">context</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s1">&#39;SPY&#39;</span><span class="p">)</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sma_fast</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sma_slow</span> <span class="o">=</span> <span class="mi">30</span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a>        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_slow</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">)</span>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>        <span class="n">fast_mavg</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sma_fast</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a>        <span class="n">slow_mavg</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a>        <span class="k">if</span> <span class="n">fast_mavg</span> <span class="o">&gt;</span> <span class="n">slow_mavg</span><span class="p">:</span>
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">order_target_percent</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">order_target_percent</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a>
<a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a><span class="c1"># Backtest mode</span>
<a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_algorithm</span><span class="p">(</span>
<a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a>    <span class="n">strategy</span><span class="o">=</span><span class="n">MomentumStrategy</span><span class="p">(),</span>
<a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a>    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2023-01-01&#39;</span><span class="p">,</span>
<a id="__codelineno-67-22" name="__codelineno-67-22" href="#__codelineno-67-22"></a>    <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2023-12-31&#39;</span><span class="p">,</span>
<a id="__codelineno-67-23" name="__codelineno-67-23" href="#__codelineno-67-23"></a>    <span class="n">bundle</span><span class="o">=</span><span class="s1">&#39;quandl&#39;</span>
<a id="__codelineno-67-24" name="__codelineno-67-24" href="#__codelineno-67-24"></a><span class="p">)</span>
<a id="__codelineno-67-25" name="__codelineno-67-25" href="#__codelineno-67-25"></a>
<a id="__codelineno-67-26" name="__codelineno-67-26" href="#__codelineno-67-26"></a><span class="c1"># Paper trading mode (same code)</span>
<a id="__codelineno-67-27" name="__codelineno-67-27" href="#__codelineno-67-27"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">LiveTradingEngine</span><span class="p">(</span>
<a id="__codelineno-67-28" name="__codelineno-67-28" href="#__codelineno-67-28"></a>    <span class="n">strategy</span><span class="o">=</span><span class="n">MomentumStrategy</span><span class="p">(),</span>  <span class="c1"># ← Same strategy</span>
<a id="__codelineno-67-29" name="__codelineno-67-29" href="#__codelineno-67-29"></a>    <span class="n">broker</span><span class="o">=</span><span class="n">PaperBroker</span><span class="p">()</span>
<a id="__codelineno-67-30" name="__codelineno-67-30" href="#__codelineno-67-30"></a><span class="p">)</span>
<a id="__codelineno-67-31" name="__codelineno-67-31" href="#__codelineno-67-31"></a><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>
<a id="__codelineno-67-32" name="__codelineno-67-32" href="#__codelineno-67-32"></a>
<a id="__codelineno-67-33" name="__codelineno-67-33" href="#__codelineno-67-33"></a><span class="c1"># Live trading mode (same code)</span>
<a id="__codelineno-67-34" name="__codelineno-67-34" href="#__codelineno-67-34"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">LiveTradingEngine</span><span class="p">(</span>
<a id="__codelineno-67-35" name="__codelineno-67-35" href="#__codelineno-67-35"></a>    <span class="n">strategy</span><span class="o">=</span><span class="n">MomentumStrategy</span><span class="p">(),</span>  <span class="c1"># ← Same strategy</span>
<a id="__codelineno-67-36" name="__codelineno-67-36" href="#__codelineno-67-36"></a>    <span class="n">broker</span><span class="o">=</span><span class="n">IBAdapter</span><span class="p">()</span>
<a id="__codelineno-67-37" name="__codelineno-67-37" href="#__codelineno-67-37"></a><span class="p">)</span>
<a id="__codelineno-67-38" name="__codelineno-67-38" href="#__codelineno-67-38"></a><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>
</code></pre></div>
<h3 id="mandatory-strategy-api">Mandatory Strategy API<a class="headerlink" href="#mandatory-strategy-api" title="Permanent link">&para;</a></h3>
<p><strong>Required Methods:</strong>
- <code>initialize(self, context)</code>: Strategy setup
- <code>handle_data(self, context, data)</code>: Bar-by-bar processing</p>
<p><strong>Optional Methods (Backtest &amp; Live):</strong>
- <code>before_trading_start(self, context, data)</code>: Pre-market calculations
- <code>analyze(self, context, results)</code>: Post-backtest analysis (backtest only)</p>
<p><strong>Optional Methods (Live Trading Only):</strong>
- <code>on_order_fill(self, context, order, transaction)</code>: Real-time fill notifications
- <code>on_order_cancel(self, context, order, reason)</code>: Cancellation handling
- <code>on_order_reject(self, context, order, reason)</code>: Rejection handling
- <code>on_broker_message(self, context, message)</code>: Custom broker events</p>
<p><strong>Key Point:</strong> Strategies with only <code>initialize</code> and <code>handle_data</code> work in all modes.</p>
<h3 id="context-api-compatibility">Context API Compatibility<a class="headerlink" href="#context-api-compatibility" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>    <span class="c1"># Portfolio access (same API in backtest and live)</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>    <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>    <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">portfolio_value</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>    <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>    <span class="c1"># Order placement (same API)</span>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">order_target_percent</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">target_pct</span><span class="p">)</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">order_target_value</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">target_value</span><span class="p">)</span>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>    <span class="c1"># Data access (same API)</span>
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>    <span class="n">data</span><span class="o">.</span><span class="n">current</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>    <span class="n">data</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="n">bar_count</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">)</span>
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>    <span class="n">data</span><span class="o">.</span><span class="n">can_trade</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
</code></pre></div>
<h3 id="shared-components">Shared Components<a class="headerlink" href="#shared-components" title="Permanent link">&para;</a></h3>
<p>Both backtest and live use:
- ✅ Same <code>DecimalLedger</code> (portfolio accounting)
- ✅ Same <code>DecimalPosition</code> (position tracking)
- ✅ Same <code>DecimalTransaction</code> (trade records)
- ✅ Same <code>PolarsDataPortal</code> (data access)
- ✅ Same commission models
- ✅ Same slippage models</p>
<p><strong>Execution differs, but financial calculations are identical.</strong></p>
<hr />
<h2 id="configuration-and-deployment">Configuration and Deployment<a class="headerlink" href="#configuration-and-deployment" title="Permanent link">&para;</a></h2>
<h3 id="configuration-file-example">Configuration File Example<a class="headerlink" href="#configuration-file-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1"># config/live_trading.yaml</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="nt">strategy</span><span class="p">:</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="w">  </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;strategies.momentum.MomentumStrategy&quot;</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="w">  </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="w">    </span><span class="nt">sma_fast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="w">    </span><span class="nt">sma_slow</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="nt">broker</span><span class="p">:</span>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="w">  </span><span class="nt">adapter</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;IBAdapter&quot;</span><span class="w">  </span><span class="c1"># or &quot;CCXTAdapter&quot;, &quot;BinanceAdapter&quot;, etc.</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="w">  </span><span class="nt">credentials</span><span class="p">:</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="w">    </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${IB_API_KEY}&quot;</span><span class="w">  </span><span class="c1"># From environment variable</span>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a><span class="w">    </span><span class="nt">api_secret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${IB_API_SECRET}&quot;</span>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="w">  </span><span class="nt">connection</span><span class="p">:</span>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.1&quot;</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7497</span>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="nt">engine</span><span class="p">:</span>
<a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="w">  </span><span class="nt">capital_base</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100000.00</span>
<a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="w">  </span><span class="nt">checkpoint_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span><span class="w">  </span><span class="c1"># seconds</span>
<a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a><span class="w">  </span><span class="nt">state_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;state/momentum_strategy.json&quot;</span>
<a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a>
<a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a><span class="nt">shadow_mode</span><span class="p">:</span>
<a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a><span class="w">  </span><span class="nt">signal_match_rate_min</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.95</span>
<a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a><span class="w">  </span><span class="nt">slippage_error_bps_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<a id="__codelineno-69-27" name="__codelineno-69-27" href="#__codelineno-69-27"></a><span class="w">  </span><span class="nt">fill_rate_error_pct_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
<a id="__codelineno-69-28" name="__codelineno-69-28" href="#__codelineno-69-28"></a>
<a id="__codelineno-69-29" name="__codelineno-69-29" href="#__codelineno-69-29"></a><span class="nt">scheduler</span><span class="p">:</span>
<a id="__codelineno-69-30" name="__codelineno-69-30" href="#__codelineno-69-30"></a><span class="w">  </span><span class="nt">calendar</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NYSE&quot;</span><span class="w">  </span><span class="c1"># or &quot;24/7&quot; for crypto</span>
<a id="__codelineno-69-31" name="__codelineno-69-31" href="#__codelineno-69-31"></a><span class="w">  </span><span class="nt">triggers</span><span class="p">:</span>
<a id="__codelineno-69-32" name="__codelineno-69-32" href="#__codelineno-69-32"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;market_open&quot;</span>
<a id="__codelineno-69-33" name="__codelineno-69-33" href="#__codelineno-69-33"></a><span class="w">      </span><span class="nt">callback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;before_trading_start&quot;</span>
<a id="__codelineno-69-34" name="__codelineno-69-34" href="#__codelineno-69-34"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;interval&quot;</span>
<a id="__codelineno-69-35" name="__codelineno-69-35" href="#__codelineno-69-35"></a><span class="w">      </span><span class="nt">minutes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
<a id="__codelineno-69-36" name="__codelineno-69-36" href="#__codelineno-69-36"></a><span class="w">      </span><span class="nt">callback</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;handle_data&quot;</span>
<a id="__codelineno-69-37" name="__codelineno-69-37" href="#__codelineno-69-37"></a>
<a id="__codelineno-69-38" name="__codelineno-69-38" href="#__codelineno-69-38"></a><span class="nt">monitoring</span><span class="p">:</span>
<a id="__codelineno-69-39" name="__codelineno-69-39" href="#__codelineno-69-39"></a><span class="w">  </span><span class="nt">prometheus_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9090</span>
<a id="__codelineno-69-40" name="__codelineno-69-40" href="#__codelineno-69-40"></a><span class="w">  </span><span class="nt">alert_webhook</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://hooks.slack.com/services/...&quot;</span>
<a id="__codelineno-69-41" name="__codelineno-69-41" href="#__codelineno-69-41"></a><span class="w">  </span><span class="nt">log_level</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;INFO&quot;</span>
</code></pre></div>
<h3 id="deployment-workflow">Deployment Workflow<a class="headerlink" href="#deployment-workflow" title="Permanent link">&para;</a></h3>
<p><strong>1. Development:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1"># Backtest strategy</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>python<span class="w"> </span>-m<span class="w"> </span>rustybt<span class="w"> </span>run<span class="w"> </span>backtest<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="w">    </span>--strategy<span class="w"> </span>strategies.momentum.MomentumStrategy<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="w">    </span>--start<span class="w"> </span><span class="m">2023</span>-01-01<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="w">    </span>--end<span class="w"> </span><span class="m">2023</span>-12-31<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="w">    </span>--capital<span class="w"> </span><span class="m">100000</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="c1"># Paper trading validation</span>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>python<span class="w"> </span>-m<span class="w"> </span>rustybt<span class="w"> </span>live<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a><span class="w">    </span>--config<span class="w"> </span>config/live_trading.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a><span class="w">    </span>--broker<span class="w"> </span>PaperBroker<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a><span class="w">    </span>--shadow-mode
</code></pre></div></p>
<p><strong>2. Staging (Paper Trading):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="c1"># Run paper trading with shadow mode for 24 hours</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>python<span class="w"> </span>-m<span class="w"> </span>rustybt<span class="w"> </span>live<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="w">    </span>--config<span class="w"> </span>config/live_trading.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="w">    </span>--broker<span class="w"> </span>PaperBroker<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="w">    </span>--shadow-mode<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="w">    </span>--validate-alignment
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="c1"># Check alignment metrics</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>python<span class="w"> </span>-m<span class="w"> </span>rustybt<span class="w"> </span>live<span class="w"> </span>metrics<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="w">    </span>--state-file<span class="w"> </span>state/momentum_strategy.json
</code></pre></div></p>
<p><strong>3. Production (Live Trading):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="c1"># Run live trading with shadow mode</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>python<span class="w"> </span>-m<span class="w"> </span>rustybt<span class="w"> </span>live<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="w">    </span>--config<span class="w"> </span>config/live_trading.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="w">    </span>--broker<span class="w"> </span>IBAdapter<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="w">    </span>--shadow-mode
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="c1"># Monitor dashboard</span>
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>open<span class="w"> </span>http://localhost:9090/dashboard
</code></pre></div></p>
<h3 id="docker-deployment">Docker Deployment<a class="headerlink" href="#docker-deployment" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c"># Dockerfile</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-slim</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="c"># Install dependencies</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="k">COPY</span><span class="w"> </span>pyproject.toml<span class="w"> </span>uv.lock<span class="w"> </span>./
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>uv<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>uv<span class="w"> </span>sync<span class="w"> </span>--frozen
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="c"># Copy source code</span>
<a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a><span class="k">COPY</span><span class="w"> </span>rustybt/<span class="w"> </span>./rustybt/
<a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a><span class="k">COPY</span><span class="w"> </span>strategies/<span class="w"> </span>./strategies/
<a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a><span class="k">COPY</span><span class="w"> </span>config/<span class="w"> </span>./config/
<a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>
<a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a><span class="c"># Run live trading engine</span>
<a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a><span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uv&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;rustybt&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;live&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--config&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;config/live_trading.yaml&quot;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># docker-compose.yml</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3.8&quot;</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="nt">services</span><span class="p">:</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="w">  </span><span class="nt">trading-engine</span><span class="p">:</span>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./state:/app/state</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./logs:/app/logs</span>
<a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IB_API_KEY=${IB_API_KEY}</span>
<a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IB_API_SECRET=${IB_API_SECRET}</span>
<a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL}</span>
<a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;9090:9090&quot;</span><span class="w">  </span><span class="c1"># Prometheus metrics</span>
<a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a>
<a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="w">  </span><span class="nt">prometheus</span><span class="p">:</span>
<a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prom/prometheus</span>
<a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml</span>
<a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;9091:9090&quot;</span>
<a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a>
<a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a><span class="w">  </span><span class="nt">grafana</span><span class="p">:</span>
<a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana/grafana</span>
<a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./monitoring/grafana:/etc/grafana/provisioning</span>
<a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-74-30" name="__codelineno-74-30" href="#__codelineno-74-30"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3000:3000&quot;</span>
</code></pre></div>
<hr />
<h2 id="performance-targets">Performance Targets<a class="headerlink" href="#performance-targets" title="Permanent link">&para;</a></h2>
<h3 id="latency-targets">Latency Targets<a class="headerlink" href="#latency-targets" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Acceptable</th>
<th>Critical</th>
</tr>
</thead>
<tbody>
<tr>
<td>Order Submission Latency</td>
<td>&lt;100ms</td>
<td>&lt;500ms</td>
<td>&gt;1s</td>
</tr>
<tr>
<td>Event Processing Latency</td>
<td>&lt;10ms</td>
<td>&lt;50ms</td>
<td>&gt;100ms</td>
</tr>
<tr>
<td>Position Reconciliation</td>
<td>&lt;1s</td>
<td>&lt;5s</td>
<td>&gt;10s</td>
</tr>
<tr>
<td>Checkpoint Save</td>
<td>&lt;500ms</td>
<td>&lt;2s</td>
<td>&gt;5s</td>
</tr>
<tr>
<td>Shadow Mode Overhead</td>
<td>&lt;5%</td>
<td>&lt;10%</td>
<td>&gt;20%</td>
</tr>
</tbody>
</table>
<h3 id="throughput-targets">Throughput Targets<a class="headerlink" href="#throughput-targets" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Minimum</th>
</tr>
</thead>
<tbody>
<tr>
<td>Events Per Second</td>
<td>1000+</td>
<td>100+</td>
</tr>
<tr>
<td>Orders Per Minute</td>
<td>100+</td>
<td>10+</td>
</tr>
<tr>
<td>Market Data Updates Per Second</td>
<td>500+</td>
<td>50+</td>
</tr>
</tbody>
</table>
<h3 id="resource-usage-targets">Resource Usage Targets<a class="headerlink" href="#resource-usage-targets" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Maximum</th>
</tr>
</thead>
<tbody>
<tr>
<td>Memory Usage</td>
<td>&lt;500MB</td>
<td>&lt;2GB</td>
</tr>
<tr>
<td>CPU Usage (single core)</td>
<td>&lt;30%</td>
<td>&lt;80%</td>
</tr>
<tr>
<td>Disk I/O (checkpoint)</td>
<td>&lt;10MB/min</td>
<td>&lt;100MB/min</td>
</tr>
</tbody>
</table>
<h3 id="scalability-limits">Scalability Limits<a class="headerlink" href="#scalability-limits" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Strategy Signals</strong>: &lt;100 signals/minute (recommended), &lt;1000 signals/minute (tested)</li>
<li><strong>Concurrent Assets</strong>: &lt;100 assets (recommended), &lt;1000 assets (tested)</li>
<li><strong>Shadow Mode</strong>: Recommended for &lt;100 signals/minute strategies (overhead &lt;5%)</li>
</ul>
<hr />
<h2 id="architecture-review-summary">Architecture Review Summary<a class="headerlink" href="#architecture-review-summary" title="Permanent link">&para;</a></h2>
<h3 id="production-readiness-checklist">Production Readiness Checklist<a class="headerlink" href="#production-readiness-checklist" title="Permanent link">&para;</a></h3>
<p><strong>Error Handling:</strong>
- ✅ Retry logic with exponential backoff for transient errors
- ✅ Circuit breaker pattern to prevent cascading failures
- ✅ Graceful degradation (fallback to paper trading on broker failure)
- ✅ Specific exception hierarchy (RustyBTError → BrokerError → OrderRejectedError)
- ✅ Timeout strategies for all broker operations</p>
<p><strong>Monitoring:</strong>
- ✅ Structured logging with structlog (JSON output)
- ✅ Metric emission points (latency, throughput, error rates)
- ✅ Alerting triggers (critical, warning, info)
- ✅ Integration points for Prometheus, Grafana, custom webhooks
- ✅ Health check endpoint for monitoring systems</p>
<p><strong>Recovery:</strong>
- ✅ Checkpoint-based state persistence (every 60s, on shutdown, on significant changes)
- ✅ Atomic write strategy (temp file + rename)
- ✅ Crash recovery workflow (restore → reconcile → resume)
- ✅ Position reconciliation with broker (detect and resolve drift)
- ✅ Stale state detection (warn if checkpoint &gt;1 hour old)</p>
<p><strong>Scalability:</strong>
- ✅ Async I/O for all broker operations (non-blocking)
- ✅ Priority event queue (handle critical events first)
- ✅ Thread pool for CPU-bound operations (if needed)
- ✅ Performance targets defined (latency, throughput, resource usage)
- ✅ Tested with 1000+ events/second</p>
<p><strong>Correctness:</strong>
- ✅ Immutable events (no race conditions)
- ✅ Async locks for shared state (portfolio, positions)
- ✅ Atomic operations (Decimal arithmetic, database transactions)
- ✅ Position reconciliation (local vs. broker)
- ✅ Shadow trading validation (backtest-live alignment)</p>
<p><strong>Maintainability:</strong>
- ✅ Clear component boundaries (Engine, BrokerAdapter, StateManager, etc.)
- ✅ Abstract base classes for extensibility (BrokerAdapter, BaseDataAdapter)
- ✅ Comprehensive documentation (this file)
- ✅ Configuration-driven deployment (YAML config)
- ✅ Docker support for reproducible deployments</p>
<h3 id="review-findings">Review Findings<a class="headerlink" href="#review-findings" title="Permanent link">&para;</a></h3>
<p><strong>Strengths:</strong>
1. Event-driven architecture enables clean separation of concerns
2. Strategy reusability guarantee enforced through shared <code>TradingAlgorithm</code> base class
3. Shadow trading framework provides continuous validation in production
4. Comprehensive error handling with retry logic and circuit breakers
5. State persistence enables crash recovery without data loss</p>
<p><strong>Risks Mitigated:</strong>
1. <strong>Broker Failure</strong>: Circuit breaker + fallback to paper trading
2. <strong>Crash Recovery</strong>: Checkpoint-based state persistence + reconciliation
3. <strong>Edge Degradation</strong>: Shadow trading + alignment circuit breaker
4. <strong>Race Conditions</strong>: Immutable events + async locks + atomic operations
5. <strong>Silent Failures</strong>: Monitoring hooks + alerting triggers</p>
<p><strong>Recommendations:</strong>
1. <strong>Performance Testing</strong>: Validate latency targets with production-like load
2. <strong>Broker Testing</strong>: Test all broker adapters with paper trading accounts
3. <strong>Failure Scenarios</strong>: Test crash recovery, broker disconnect, data feed failure
4. <strong>Shadow Mode Tuning</strong>: Validate alignment thresholds with historical data
5. <strong>Documentation</strong>: Add runbooks for common operational scenarios</p>
<hr />
<h2 id="paper-trading-mode">Paper Trading Mode<a class="headerlink" href="#paper-trading-mode" title="Permanent link">&para;</a></h2>
<h3 id="overview_1">Overview<a class="headerlink" href="#overview_1" title="Permanent link">&para;</a></h3>
<p>Paper trading mode allows validation of live trading strategies without risking real capital by simulating broker execution with realistic market data. The <code>PaperBroker</code> implements the <code>BrokerAdapter</code> interface to provide a drop-in replacement for real brokers during validation.</p>
<h3 id="key-features">Key Features<a class="headerlink" href="#key-features" title="Permanent link">&para;</a></h3>
<p><strong>1. Realistic Order Execution</strong>
- Market orders: Fill immediately at current market price + slippage
- Limit orders: Fill when market price crosses limit (marketable limits fill immediately)
- Stop orders: Trigger at stop price, fill as market order
- Stop-limit orders: Trigger at stop price, fill as limit order</p>
<p><strong>2. Latency Simulation</strong>
- Configurable base latency (default: 100ms for stocks, 50ms for crypto)
- Jitter simulation (±20% variation) for realistic network delays
- Delays applied using <code>asyncio.sleep()</code> for async compatibility</p>
<p><strong>3. Partial Fill Simulation</strong>
- Volume-based fill calculation: <code>fill_pct = min(1.0, order_size / (volume × volume_limit_pct))</code>
- Default volume limit: 2.5% of bar volume per order
- Multiple fills for large orders exceeding volume limit</p>
<p><strong>4. Commission and Slippage</strong>
- Uses same commission models as backtest (PerShareCommission, PerTradeCommission, PerDollarCommission, CryptoCommission)
- Uses same slippage models as backtest (FixedSlippage, FixedBasisPointsSlippage, VolumeShareSlippage)
- <strong>CRITICAL:</strong> Exact Decimal arithmetic matching backtest for alignment validation</p>
<p><strong>5. Position and Balance Tracking</strong>
- Paper positions tracked separately using <code>DecimalPosition</code>
- Paper cash balance updated on fills (buy: decrease, sell: increase)
- Commission deducted from cash balance
- Transaction history maintained for audit trail</p>
<h3 id="usage-example">Usage Example<a class="headerlink" href="#usage-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="kn">from</span> <span class="nn">rustybt.assets</span> <span class="kn">import</span> <span class="n">Equity</span><span class="p">,</span> <span class="n">ExchangeInfo</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="kn">from</span> <span class="nn">rustybt.finance.decimal.commission</span> <span class="kn">import</span> <span class="n">PerShareCommission</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="kn">from</span> <span class="nn">rustybt.finance.decimal.slippage</span> <span class="kn">import</span> <span class="n">FixedBasisPointsSlippage</span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="kn">from</span> <span class="nn">rustybt.live.brokers</span> <span class="kn">import</span> <span class="n">PaperBroker</span>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="c1"># Initialize PaperBroker</span>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="n">broker</span> <span class="o">=</span> <span class="n">PaperBroker</span><span class="p">(</span>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>    <span class="n">starting_cash</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100000&quot;</span><span class="p">),</span>
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>    <span class="n">commission_model</span><span class="o">=</span><span class="n">PerShareCommission</span><span class="p">(</span>
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>        <span class="n">rate</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.005&quot;</span><span class="p">),</span>
<a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>        <span class="n">minimum</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.00&quot;</span><span class="p">)</span>
<a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a>    <span class="p">),</span>
<a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a>    <span class="n">slippage_model</span><span class="o">=</span><span class="n">FixedBasisPointsSlippage</span><span class="p">(</span>
<a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>        <span class="n">basis_points</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">)</span>  <span class="c1"># 5 bps = 0.05%</span>
<a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a>    <span class="p">),</span>
<a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a>    <span class="n">order_latency_ms</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a>    <span class="n">volume_limit_pct</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.025&quot;</span><span class="p">)</span>  <span class="c1"># 2.5%</span>
<a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a><span class="p">)</span>
<a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a>
<a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a><span class="c1"># Connect to paper broker</span>
<a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a><span class="k">await</span> <span class="n">broker</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a id="__codelineno-75-23" name="__codelineno-75-23" href="#__codelineno-75-23"></a>
<a id="__codelineno-75-24" name="__codelineno-75-24" href="#__codelineno-75-24"></a><span class="c1"># Submit order</span>
<a id="__codelineno-75-25" name="__codelineno-75-25" href="#__codelineno-75-25"></a><span class="n">order_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">broker</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span>
<a id="__codelineno-75-26" name="__codelineno-75-26" href="#__codelineno-75-26"></a>    <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span>
<a id="__codelineno-75-27" name="__codelineno-75-27" href="#__codelineno-75-27"></a>    <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span>
<a id="__codelineno-75-28" name="__codelineno-75-28" href="#__codelineno-75-28"></a>    <span class="n">order_type</span><span class="o">=</span><span class="s2">&quot;market&quot;</span>
<a id="__codelineno-75-29" name="__codelineno-75-29" href="#__codelineno-75-29"></a><span class="p">)</span>
<a id="__codelineno-75-30" name="__codelineno-75-30" href="#__codelineno-75-30"></a>
<a id="__codelineno-75-31" name="__codelineno-75-31" href="#__codelineno-75-31"></a><span class="c1"># Check account</span>
<a id="__codelineno-75-32" name="__codelineno-75-32" href="#__codelineno-75-32"></a><span class="n">account_info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">broker</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span>
<a id="__codelineno-75-33" name="__codelineno-75-33" href="#__codelineno-75-33"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cash: $</span><span class="si">{</span><span class="n">account_info</span><span class="p">[</span><span class="s1">&#39;cash&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-75-34" name="__codelineno-75-34" href="#__codelineno-75-34"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio value: $</span><span class="si">{</span><span class="n">account_info</span><span class="p">[</span><span class="s1">&#39;portfolio_value&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-75-35" name="__codelineno-75-35" href="#__codelineno-75-35"></a>
<a id="__codelineno-75-36" name="__codelineno-75-36" href="#__codelineno-75-36"></a><span class="c1"># Get positions</span>
<a id="__codelineno-75-37" name="__codelineno-75-37" href="#__codelineno-75-37"></a><span class="n">positions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">broker</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
<a id="__codelineno-75-38" name="__codelineno-75-38" href="#__codelineno-75-38"></a><span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
<a id="__codelineno-75-39" name="__codelineno-75-39" href="#__codelineno-75-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;asset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> shares @ $</span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;cost_basis&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="integration-with-strategy-reusability-guarantee">Integration with Strategy Reusability Guarantee<a class="headerlink" href="#integration-with-strategy-reusability-guarantee" title="Permanent link">&para;</a></h3>
<p>Paper trading validates the strategy reusability guarantee (<a href="../strategy-reusability-guarantee/">strategy-reusability-guarantee.md</a>):</p>
<ol>
<li><strong>Same Strategy Code</strong>: <code>TradingAlgorithm</code> runs identically in backtest and paper modes</li>
<li><strong>Same Commission/Slippage Models</strong>: Exact same model instances used for alignment</li>
<li><strong>Decimal Precision</strong>: All calculations use Decimal for exact reproducibility</li>
<li><strong>&gt;99% Correlation</strong>: Validation tests confirm backtest vs. paper trading alignment (AC10)</li>
</ol>
<h3 id="validation-workflow">Validation Workflow<a class="headerlink" href="#validation-workflow" title="Permanent link">&para;</a></h3>
<p><strong>Phase 1: Backtest</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="c1"># Run strategy in backtest mode</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_algorithm</span><span class="p">(</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>    <span class="n">strategy</span><span class="o">=</span><span class="n">MyStrategy</span><span class="p">(),</span>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2023-01-01&#39;</span><span class="p">,</span>
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>    <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2023-12-31&#39;</span><span class="p">,</span>
<a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>    <span class="n">capital_base</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
<a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>    <span class="n">commission</span><span class="o">=</span><span class="n">PerShareCommission</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.005&quot;</span><span class="p">)),</span>
<a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>    <span class="n">slippage</span><span class="o">=</span><span class="n">FixedBasisPointsSlippage</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">))</span>
<a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>Phase 2: Paper Trading Validation</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1"># Run same strategy in paper trading with same models</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="n">broker</span> <span class="o">=</span> <span class="n">PaperBroker</span><span class="p">(</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>    <span class="n">starting_cash</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100000&quot;</span><span class="p">),</span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>    <span class="n">commission_model</span><span class="o">=</span><span class="n">PerShareCommission</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.005&quot;</span><span class="p">)),</span>  <span class="c1"># Same model</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>    <span class="n">slippage_model</span><span class="o">=</span><span class="n">FixedBasisPointsSlippage</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">))</span>   <span class="c1"># Same model</span>
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="p">)</span>
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">LiveTradingEngine</span><span class="p">(</span>
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a>    <span class="n">strategy</span><span class="o">=</span><span class="n">MyStrategy</span><span class="p">(),</span>  <span class="c1"># Same strategy code</span>
<a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>    <span class="n">broker</span><span class="o">=</span><span class="n">broker</span><span class="p">,</span>
<a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>    <span class="n">shadow_mode</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Enable validation</span>
<a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a><span class="p">)</span>
<a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a>
<a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a><span class="k">await</span> <span class="n">engine</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></p>
<p><strong>Phase 3: Alignment Verification</strong>
- Compare portfolio values (should match within 0.1%)
- Compare position histories (should match exactly)
- Compare order execution prices (should match within slippage tolerance)
- Correlation coefficient &gt; 0.99 confirms alignment</p>
<h3 id="limitations">Limitations<a class="headerlink" href="#limitations" title="Permanent link">&para;</a></h3>
<p><strong>Not Simulated (Intentionally Simplified for Paper Trading)</strong>
- Market impact: Orders don't affect market price in simulation
- Liquidity exhaustion: Assumes sufficient liquidity within volume limit
- Order queue position: Limit orders fill instantly if marketable (no queue simulation)
- Adverse selection: No simulation of information asymmetry effects</p>
<p><strong>These limitations are acceptable for validation</strong> since paper trading validates strategy logic and execution models, not microstructure effects. For precise microstructure simulation, use backtest mode with historical limit order book data.</p>
<h3 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h3>
<p><strong>Unit Tests:</strong> 31 tests covering:
- Order execution (market, limit, stop, stop-limit)
- Commission and slippage application
- Partial fill simulation
- Position and balance tracking
- Latency simulation
- Market data handling
- Transaction history</p>
<p><strong>Test Coverage:</strong> 100% of PaperBroker methods</p>
<p><strong>Example:</strong> <code>examples/paper_trading_simple.py</code> demonstrates complete workflow</p>
<h3 id="files">Files<a class="headerlink" href="#files" title="Permanent link">&para;</a></h3>
<p><strong>Implementation:</strong>
- <code>rustybt/live/brokers/paper_broker.py</code> - PaperBroker implementation (800+ lines)</p>
<p><strong>Tests:</strong>
- <code>tests/live/brokers/test_paper_broker.py</code> - Comprehensive unit tests (31 tests)</p>
<p><strong>Examples:</strong>
- <code>examples/paper_trading_simple.py</code> - Usage example</p>
<p><strong>Documentation:</strong>
- This section
- <a href="../strategy-reusability-guarantee/">strategy-reusability-guarantee.md</a> - Strategy API contract
- <a href="../shadow-trading-summary/">shadow-trading-summary.md</a> - Shadow trading integration</p>
<hr />
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h2>
<p><strong>Story 6.2: Implement Async Trading Engine Core</strong>
- Implement <code>LiveTradingEngine</code> class
- Implement event loop and event processing
- Implement order lifecycle management
- Implement basic broker adapter (PaperBroker)</p>
<p><strong>Story 6.3: Implement State Management with Save/Restore</strong>
- Implement <code>StateManager</code> class
- Implement checkpoint logic (atomic write, restore)
- Implement crash recovery workflow
- Test recovery scenarios</p>
<p><strong>Story 6.4: Implement Position Reconciliation</strong>
- Implement <code>PositionReconciler</code> class
- Implement broker position fetching
- Implement mismatch detection and resolution
- Test reconciliation scenarios</p>
<p><strong>Story 6.5: Implement Scheduled Calculations</strong>
- Implement <code>TradingScheduler</code> class
- Integrate APScheduler for market triggers
- Implement before_trading_start callback scheduling
- Support custom intervals</p>
<p><strong>Story 6.6: Implement WebSocket Data Adapter Foundation</strong> ✅
- ✅ Implemented <code>BaseWebSocketAdapter</code> with connection lifecycle management
- ✅ Implemented auto-reconnect with exponential backoff (1s → 16s max)
- ✅ Implemented subscription management with re-subscription on reconnect
- ✅ Implemented message parsing framework with exchange-agnostic <code>TickData</code> model
- ✅ Implemented <code>BarBuffer</code> for tick-to-OHLCV aggregation
- ✅ Implemented heartbeat/keepalive monitoring with stale connection detection
- ✅ Implemented error handling with circuit breaker pattern
- ✅ Implemented <code>BinanceWebSocketAdapter</code> for Binance spot and futures markets
- ✅ Comprehensive test coverage (models, bar buffer, base adapter, Binance adapter)</p>
<p><strong>Story 6.7: Implement Paper Trading Mode</strong> ✅
- ✅ Implemented <code>PaperBroker</code> adapter implementing <code>BrokerAdapter</code> interface
- ✅ Real-time market data integration (via <code>_update_market_data()</code> for testing)
- ✅ Simulated order execution (market, limit, stop, stop-limit orders)
- ✅ Latency simulation with configurable jitter (100ms base for stocks, 50ms for crypto)
- ✅ Partial fill simulation based on volume limit (default 2.5% of bar volume)
- ✅ Commission and slippage models integration (uses same models as backtest)
- ✅ Paper position and balance tracking with Decimal precision
- ✅ Transaction history tracking
- ✅ Comprehensive test coverage (31 tests, 100% pass rate)
- ✅ Example demonstrating paper trading workflow (<code>examples/paper_trading_simple.py</code>)</p>
<p><strong>Story 6.8-6.10: Implement Broker Adapters</strong>
- Implement <code>CCXTAdapter</code>, <code>IBAdapter</code>, <code>BinanceAdapter</code>, <code>BybitAdapter</code>, <code>HyperliquidAdapter</code></p>
<p><strong>Story 6.11: Implement Circuit Breakers and Monitoring</strong>
- Implement circuit breaker pattern
- Implement monitoring hooks and metrics
- Implement alerting system</p>
<p><strong>Story 6.12: Implement Shadow Trading Validation</strong>
- Implement <code>ShadowBacktestEngine</code>
- Implement <code>SignalAlignmentValidator</code>
- Implement <code>ExecutionQualityTracker</code>
- Implement <code>AlignmentCircuitBreaker</code></p>
<hr />
<p><strong>Document Version:</strong> 1.0
<strong>Last Updated:</strong> 2025-10-03
<strong>Author:</strong> James (Developer)
<strong>Approved By:</strong> Winston (Architect), Bob (Scrum Master)</p>
<hr />
<h2 id="interactive-brokers-integration">Interactive Brokers Integration<a class="headerlink" href="#interactive-brokers-integration" title="Permanent link">&para;</a></h2>
<h3 id="overview_2">Overview<a class="headerlink" href="#overview_2" title="Permanent link">&para;</a></h3>
<p>RustyBT integrates with Interactive Brokers (IB) for professional-grade trading across stocks, options, futures, and forex markets globally. The integration uses the <code>ib-async</code> library for a Pythonic async/await interface with IB's Trader Workstation (TWS) or IB Gateway.</p>
<h3 id="design-decision-ib-async-vs-custom-tws-api">Design Decision: ib-async vs Custom TWS API<a class="headerlink" href="#design-decision-ib-async-vs-custom-tws-api" title="Permanent link">&para;</a></h3>
<p><strong>Decision:</strong> Use <code>ib-async</code> library instead of custom TWS API implementation.</p>
<p><strong>Rationale:</strong>
- <strong>Async/Await Support</strong>: Native Python <code>async</code>/<code>await</code> integrates seamlessly with LiveTradingEngine's async architecture
- <strong>Active Maintenance</strong>: Well-maintained library with comprehensive documentation and active community
- <strong>Production Proven</strong>: Used in production trading systems with proven reliability
- <strong>Connection Management</strong>: Handles connection lifecycle, reconnection, and event subscriptions automatically
- <strong>Development Efficiency</strong>: Custom TWS API would require significant development effort (est. 4-6 weeks) with marginal performance gains (&lt;5ms latency improvement)
- <strong>Risk Mitigation</strong>: Reduces implementation risk and maintenance burden</p>
<p><strong>Trade-offs:</strong>
- ✅ Faster time-to-market (2 weeks vs 6 weeks)
- ✅ Lower maintenance overhead
- ✅ Better documentation and community support
- ❌ Minimal dependency on external library (acceptable given maturity)
- ❌ Theoretical 3-5ms latency overhead (negligible for most strategies)</p>
<h3 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>│                    IBBrokerAdapter                          │
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>├─────────────────────────────────────────────────────────────┤
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>│                                                             │
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>│  Connection Management                                      │
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>│  ├── connectAsync() to TWS/Gateway                          │
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>│  ├── Auto-reconnection with exponential backoff             │
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a>│  └── Health monitoring (heartbeat)                          │
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>│                                                             │
<a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a>│  Order Management                                           │
<a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>│  ├── submit_order() → placeOrder()                          │
<a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a>│  ├── cancel_order() → cancelOrder()                         │
<a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a>│  ├── Order status event subscriptions                       │
<a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a>│  └── Execution event handling                               │
<a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a>│                                                             │
<a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a>│  Market Data                                                │
<a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a>│  ├── subscribe_market_data() → reqMktData()                 │
<a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a>│  ├── Real-time price updates                                │
<a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a>│  └── Snapshot quotes                                        │
<a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a>│                                                             │
<a id="__codelineno-78-21" name="__codelineno-78-21" href="#__codelineno-78-21"></a>│  Account/Position Queries                                   │
<a id="__codelineno-78-22" name="__codelineno-78-22" href="#__codelineno-78-22"></a>│  ├── get_account_info() → accountSummary()                  │
<a id="__codelineno-78-23" name="__codelineno-78-23" href="#__codelineno-78-23"></a>│  ├── get_positions() → positions()                          │
<a id="__codelineno-78-24" name="__codelineno-78-24" href="#__codelineno-78-24"></a>│  └── get_open_orders() → openTrades()                       │
<a id="__codelineno-78-25" name="__codelineno-78-25" href="#__codelineno-78-25"></a>│                                                             │
<a id="__codelineno-78-26" name="__codelineno-78-26" href="#__codelineno-78-26"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-78-27" name="__codelineno-78-27" href="#__codelineno-78-27"></a>                         │
<a id="__codelineno-78-28" name="__codelineno-78-28" href="#__codelineno-78-28"></a>                         ▼
<a id="__codelineno-78-29" name="__codelineno-78-29" href="#__codelineno-78-29"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-78-30" name="__codelineno-78-30" href="#__codelineno-78-30"></a>│                    ib-async Library                         │
<a id="__codelineno-78-31" name="__codelineno-78-31" href="#__codelineno-78-31"></a>│          (Pythonic wrapper for IB TWS API)                  │
<a id="__codelineno-78-32" name="__codelineno-78-32" href="#__codelineno-78-32"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-78-33" name="__codelineno-78-33" href="#__codelineno-78-33"></a>                         │
<a id="__codelineno-78-34" name="__codelineno-78-34" href="#__codelineno-78-34"></a>                         ▼
<a id="__codelineno-78-35" name="__codelineno-78-35" href="#__codelineno-78-35"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-78-36" name="__codelineno-78-36" href="#__codelineno-78-36"></a>│              TWS or IB Gateway                              │
<a id="__codelineno-78-37" name="__codelineno-78-37" href="#__codelineno-78-37"></a>│         (localhost:7496 paper, :7497 live)                  │
<a id="__codelineno-78-38" name="__codelineno-78-38" href="#__codelineno-78-38"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-78-39" name="__codelineno-78-39" href="#__codelineno-78-39"></a>                         │
<a id="__codelineno-78-40" name="__codelineno-78-40" href="#__codelineno-78-40"></a>                         ▼
<a id="__codelineno-78-41" name="__codelineno-78-41" href="#__codelineno-78-41"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-78-42" name="__codelineno-78-42" href="#__codelineno-78-42"></a>│          Interactive Brokers Backend                        │
<a id="__codelineno-78-43" name="__codelineno-78-43" href="#__codelineno-78-43"></a>│    (Stocks, Options, Futures, Forex globally)               │
<a id="__codelineno-78-44" name="__codelineno-78-44" href="#__codelineno-78-44"></a>└─────────────────────────────────────────────────────────────┘
</code></pre></div>
<h3 id="setup-requirements">Setup Requirements<a class="headerlink" href="#setup-requirements" title="Permanent link">&para;</a></h3>
<h4 id="twsib-gateway-configuration">TWS/IB Gateway Configuration<a class="headerlink" href="#twsib-gateway-configuration" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Install TWS or IB Gateway</strong></li>
<li>Download from <a href="https://www.interactivebrokers.com/en/trading/tws.php">Interactive Brokers</a></li>
<li>TWS: Full featured trading platform (recommended for development)</li>
<li>
<p>IB Gateway: Lightweight headless version (recommended for production)</p>
</li>
<li>
<p><strong>Enable API Connections</strong></p>
</li>
<li>Open TWS/Gateway</li>
<li>Navigate to: Edit → Global Configuration → API → Settings</li>
<li>Enable "Enable ActiveX and Socket Clients"</li>
<li>Set socket port:<ul>
<li>TWS Paper: 7496</li>
<li>TWS Live: 7497</li>
<li>Gateway Paper: 4002</li>
<li>Gateway Live: 4001</li>
</ul>
</li>
<li>Add your client ID to "Trusted IPs" (default: 127.0.0.1)</li>
<li>
<p>Set "Master API client ID" (optional, for advanced use cases)</p>
</li>
<li>
<p><strong>Paper Trading Account</strong></p>
</li>
<li>Request paper trading account from IB</li>
<li>Login to TWS/Gateway with paper account credentials</li>
<li>Verify account is in paper trading mode (check account name)</li>
</ol>
<h4 id="python-configuration">Python Configuration<a class="headerlink" href="#python-configuration" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="kn">from</span> <span class="nn">rustybt.live.brokers</span> <span class="kn">import</span> <span class="n">IBBrokerAdapter</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="c1"># Create IB adapter</span>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="n">ib_adapter</span> <span class="o">=</span> <span class="n">IBBrokerAdapter</span><span class="p">(</span>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>    <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>           <span class="c1"># TWS/Gateway host</span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>    <span class="n">port</span><span class="o">=</span><span class="mi">7496</span><span class="p">,</span>                  <span class="c1"># TWS paper trading port</span>
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>    <span class="n">client_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                <span class="c1"># Unique client ID (1-32)</span>
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>    <span class="n">auto_reconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>        <span class="c1"># Enable auto-reconnection</span>
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="p">)</span>
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="c1"># Connect to IB</span>
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a><span class="k">await</span> <span class="n">ib_adapter</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="c1"># Check connection</span>
<a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a><span class="k">assert</span> <span class="n">ib_adapter</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
</code></pre></div>
<h3 id="supported-features">Supported Features<a class="headerlink" href="#supported-features" title="Permanent link">&para;</a></h3>
<h4 id="asset-types">Asset Types<a class="headerlink" href="#asset-types" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>RustyBT Asset Type</th>
<th>IB Contract Type</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Equity</code></td>
<td><code>Stock</code></td>
<td>AAPL (Apple Inc.)</td>
</tr>
<tr>
<td><code>Future</code></td>
<td><code>Future</code></td>
<td>ESZ5 (E-mini S&amp;P 500 Dec 2025)</td>
</tr>
<tr>
<td><code>Option</code></td>
<td><code>Option</code></td>
<td>AAPL 250117C00150000 (Call)</td>
</tr>
<tr>
<td><code>Forex</code></td>
<td><code>Forex</code></td>
<td>EUR.USD (Euro/US Dollar)</td>
</tr>
</tbody>
</table>
<h4 id="order-types">Order Types<a class="headerlink" href="#order-types" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Order Type</th>
<th>IB Order Type</th>
<th>Parameters</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Market</td>
<td><code>MKT</code></td>
<td>None</td>
<td><code>submit_order(asset, 100, "market")</code></td>
</tr>
<tr>
<td>Limit</td>
<td><code>LMT</code></td>
<td><code>limit_price</code></td>
<td><code>submit_order(asset, 100, "limit", limit_price=150.50)</code></td>
</tr>
<tr>
<td>Stop</td>
<td><code>STP</code></td>
<td><code>stop_price</code></td>
<td><code>submit_order(asset, 100, "stop", stop_price=140.00)</code></td>
</tr>
<tr>
<td>Stop-Limit</td>
<td><code>STP LMT</code></td>
<td><code>limit_price</code>, <code>stop_price</code></td>
<td><code>submit_order(asset, 100, "stop-limit", limit_price=145, stop_price=140)</code></td>
</tr>
<tr>
<td>Trailing Stop</td>
<td><code>TRAIL</code></td>
<td><code>stop_price</code> (trailing amt)</td>
<td><code>submit_order(asset, 100, "trailing-stop", stop_price=5.00)</code></td>
</tr>
</tbody>
</table>
<h4 id="account-information">Account Information<a class="headerlink" href="#account-information" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="n">account_info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ib_adapter</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="c1"># Returns:</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="p">{</span>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>    <span class="s2">&quot;cash&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100000.50&quot;</span><span class="p">),</span>                <span class="c1"># Available cash</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>    <span class="s2">&quot;equity&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;150000.75&quot;</span><span class="p">),</span>              <span class="c1"># Net liquidation value</span>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>    <span class="s2">&quot;buying_power&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;400000.00&quot;</span><span class="p">),</span>        <span class="c1"># Available buying power</span>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>    <span class="s2">&quot;initial_margin&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;25000.00&quot;</span><span class="p">),</span>       <span class="c1"># Initial margin requirement</span>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>    <span class="s2">&quot;maintenance_margin&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;15000.00&quot;</span><span class="p">),</span>   <span class="c1"># Maintenance margin requirement</span>
<a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>    <span class="s2">&quot;gross_position_value&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50000.25&quot;</span><span class="p">),</span> <span class="c1"># Total position value</span>
<a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a><span class="p">}</span>
</code></pre></div>
<h4 id="position-queries">Position Queries<a class="headerlink" href="#position-queries" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="n">positions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ib_adapter</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="c1"># Returns list of positions:</span>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="p">[</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>    <span class="p">{</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>        <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;AAPL&quot;</span><span class="p">,</span>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>        <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>        <span class="s2">&quot;cost_basis&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;150.50&quot;</span><span class="p">),</span>
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>        <span class="s2">&quot;market_value&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;15050.00&quot;</span><span class="p">),</span>
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>    <span class="p">},</span>
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>    <span class="o">...</span>
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a><span class="p">]</span>
</code></pre></div>
<h3 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h3>
<h4 id="common-ib-error-codes">Common IB Error Codes<a class="headerlink" href="#common-ib-error-codes" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Error Code</th>
<th>Meaning</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>502</td>
<td>Cannot connect to TWS</td>
<td>Check TWS is running and port is correct</td>
</tr>
<tr>
<td>103</td>
<td>Duplicate order ID</td>
<td>Use unique order IDs (handled automatically)</td>
</tr>
<tr>
<td>201</td>
<td>Order rejected</td>
<td>Check account balance, margin, and contract validity</td>
</tr>
<tr>
<td>110</td>
<td>Price does not conform to minimum price variation</td>
<td>Adjust limit price to valid tick size</td>
</tr>
<tr>
<td>162</td>
<td>Historical market data service error</td>
<td>Check market data subscription</td>
</tr>
<tr>
<td>1100</td>
<td>Connectivity lost</td>
<td>Auto-reconnection will attempt recovery</td>
</tr>
</tbody>
</table>
<h4 id="retry-strategy">Retry Strategy<a class="headerlink" href="#retry-strategy" title="Permanent link">&para;</a></h4>
<p>IBBrokerAdapter implements exponential backoff retry logic:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="c1"># Initial delay: 1 second</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="c1"># Max delay: 16 seconds</span>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="c1"># Delays: 1s → 2s → 4s → 8s → 16s → 16s → ...</span>
</code></pre></div>
<h4 id="connection-loss-handling">Connection Loss Handling<a class="headerlink" href="#connection-loss-handling" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="c1"># Auto-reconnection enabled by default</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="n">ib_adapter</span> <span class="o">=</span> <span class="n">IBBrokerAdapter</span><span class="p">(</span><span class="n">auto_reconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="c1"># On disconnect:</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a><span class="c1"># 1. Log disconnection event</span>
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="c1"># 2. Wait for backoff delay</span>
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a><span class="c1"># 3. Attempt reconnection</span>
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a><span class="c1"># 4. On success, restore subscriptions</span>
<a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a><span class="c1"># 5. On failure, increase backoff delay and retry</span>
</code></pre></div>
<h3 id="rate-limits">Rate Limits<a class="headerlink" href="#rate-limits" title="Permanent link">&para;</a></h3>
<p>Interactive Brokers imposes rate limits:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Rate Limit</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Market data requests</td>
<td>50/second</td>
<td>Per client ID</td>
</tr>
<tr>
<td>Order submissions</td>
<td>100/second</td>
<td>Per client ID</td>
</tr>
<tr>
<td>Historical data requests</td>
<td>60/10 minutes</td>
<td>Per client ID</td>
</tr>
</tbody>
</table>
<p><strong>Mitigation:</strong>
- Use multiple client IDs for parallel strategies
- Implement request queuing with rate limiting
- Cache market data snapshots</p>
<h3 id="testing_1">Testing<a class="headerlink" href="#testing_1" title="Permanent link">&para;</a></h3>
<h4 id="unit-tests">Unit Tests<a class="headerlink" href="#unit-tests" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c1"># Run unit tests (mock ib-async)</span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>pytest<span class="w"> </span>tests/live/brokers/test_ib_adapter.py<span class="w"> </span>-v
</code></pre></div>
<p>Unit tests mock the <code>ib-async</code> library and test:
- Connection lifecycle
- Order submission (all types)
- Order cancellation
- Account info queries
- Position queries
- Market data subscription
- Error handling</p>
<h4 id="integration-tests">Integration Tests<a class="headerlink" href="#integration-tests" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="c1"># Run integration tests (requires IB paper account and TWS/Gateway running)</span>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a>pytest<span class="w"> </span>--run-ib-integration<span class="w"> </span>tests/integration/live/test_ib_integration.py<span class="w"> </span>-v
</code></pre></div>
<p><strong>Setup for Integration Tests:</strong></p>
<ol>
<li>Start TWS/Gateway in paper trading mode</li>
<li>Enable API connections (port 7496 for TWS paper)</li>
<li>Set environment variables (optional):
   <div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">IB_HOST</span><span class="o">=</span><span class="m">127</span>.0.0.1
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">IB_PORT</span><span class="o">=</span><span class="m">7496</span>
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">IB_CLIENT_ID</span><span class="o">=</span><span class="m">1</span>
</code></pre></div></li>
</ol>
<p>Integration tests validate:
- Real connection to IB paper account
- Market order execution and fills
- Limit order submission and cancellation
- Position reconciliation
- Account balance queries
- Real-time market data streaming</p>
<h3 id="performance-characteristics">Performance Characteristics<a class="headerlink" href="#performance-characteristics" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Latency</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Connection</td>
<td>200-500ms</td>
<td>Initial handshake</td>
</tr>
<tr>
<td>Order submission</td>
<td>10-30ms</td>
<td>Round-trip to IB backend</td>
</tr>
<tr>
<td>Market data update</td>
<td>5-15ms</td>
<td>Real-time streaming</td>
</tr>
<tr>
<td>Position query</td>
<td>20-50ms</td>
<td>Snapshot request</td>
</tr>
<tr>
<td>Account info query</td>
<td>20-50ms</td>
<td>Snapshot request</td>
</tr>
</tbody>
</table>
<p><strong>Optimization Tips:</strong>
- Use market data subscriptions (streaming) instead of repeated snapshots
- Batch account/position queries when possible
- Maintain persistent connection (don't reconnect per order)</p>
<h3 id="production-deployment">Production Deployment<a class="headerlink" href="#production-deployment" title="Permanent link">&para;</a></h3>
<h4 id="recommended-configuration">Recommended Configuration<a class="headerlink" href="#recommended-configuration" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="c1"># Live trading configuration</span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="n">live_config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>        <span class="c1"># Localhost (TWS/Gateway on same machine)</span>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>    <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">4001</span><span class="p">,</span>               <span class="c1"># Gateway live port</span>
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>    <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>             <span class="c1"># Unique per strategy</span>
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>    <span class="s2">&quot;auto_reconnect&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>     <span class="c1"># Always enable for production</span>
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="p">}</span>
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>
<a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a><span class="n">ib_adapter</span> <span class="o">=</span> <span class="n">IBBrokerAdapter</span><span class="p">(</span><span class="o">**</span><span class="n">live_config</span><span class="p">)</span>
</code></pre></div>
<h4 id="high-availability-setup">High Availability Setup<a class="headerlink" href="#high-availability-setup" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>┌─────────────────┐
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>│  Primary Server │
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>│   (client_id=1) │
<a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a>└────────┬────────┘
<a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>         │
<a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a>         ▼
<a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a>┌─────────────────┐
<a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a>│   IB Gateway    │ ←─── Monitor process (systemd/supervisor)
<a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a>│   (localhost)   │
<a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a>└────────┬────────┘
<a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a>         │
<a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a>         ▼
<a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a>┌─────────────────┐
<a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a>│  IB Backend     │
<a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a>└─────────────────┘
<a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a>
<a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a>Failover Strategy:
<a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a>1. Monitor IB Gateway process health
<a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a>2. Restart Gateway on crash (auto-login)
<a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a>3. IBBrokerAdapter auto-reconnects
<a id="__codelineno-88-21" name="__codelineno-88-21" href="#__codelineno-88-21"></a>4. StateManager restores strategy state
<a id="__codelineno-88-22" name="__codelineno-88-22" href="#__codelineno-88-22"></a>5. Position reconciliation validates sync
</code></pre></div>
<h4 id="monitoring">Monitoring<a class="headerlink" href="#monitoring" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="kn">import</span> <span class="nn">structlog</span>
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>
<a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="c1"># IBBrokerAdapter emits structured logs:</span>
<a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ib_connected&quot;</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;order_submitted&quot;</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="s2">&quot;AAPL&quot;</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="s2">&quot;100&quot;</span><span class="p">)</span>
<a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;order_filled&quot;</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">fill_price</span><span class="o">=</span><span class="s2">&quot;150.75&quot;</span><span class="p">,</span> <span class="n">commission</span><span class="o">=</span><span class="s2">&quot;1.00&quot;</span><span class="p">)</span>
<a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ib_error&quot;</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="n">error_string</span><span class="o">=</span><span class="s2">&quot;Order rejected&quot;</span><span class="p">)</span>
<a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ib_disconnected&quot;</span><span class="p">)</span>
<a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ib_reconnection_successful&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Key Metrics to Monitor:</strong>
- Connection uptime percentage
- Order submission latency (p50, p95, p99)
- Order fill rate
- Market data update frequency
- Reconnection events per day
- Error rate by error code</p>
<h3 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h3>
<h4 id="cannot-connect-to-tws-error-502">"Cannot connect to TWS" (Error 502)<a class="headerlink" href="#cannot-connect-to-tws-error-502" title="Permanent link">&para;</a></h4>
<p><strong>Symptoms:</strong> <code>IBConnectionError: Failed to connect to IB at 127.0.0.1:7496</code></p>
<p><strong>Diagnosis:</strong>
1. Verify TWS/Gateway is running
2. Check API settings are enabled
3. Verify port matches (7496 for TWS paper)
4. Check firewall rules</p>
<p><strong>Resolution:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="c1"># Check if TWS is listening on port</span>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>netstat<span class="w"> </span>-an<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">7496</span>
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="c1"># Expected output:</span>
<a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>tcp4<span class="w">       </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w">  </span><span class="m">127</span>.0.0.1.7496<span class="w">         </span>*.*<span class="w">                    </span>LISTEN
</code></pre></div></p>
<h4 id="order-rejected-error-201">"Order rejected" (Error 201)<a class="headerlink" href="#order-rejected-error-201" title="Permanent link">&para;</a></h4>
<p><strong>Symptoms:</strong> Order submission succeeds but IB rejects order</p>
<p><strong>Common Causes:</strong>
- Insufficient buying power
- Invalid contract (symbol not found)
- Market closed
- Invalid price (outside price bands)</p>
<p><strong>Resolution:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="c1"># Check account buying power</span>
<a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a><span class="n">account_info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ib_adapter</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span>
<a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Buying power: </span><span class="si">{</span><span class="n">account_info</span><span class="p">[</span><span class="s1">&#39;buying_power&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>
<a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a><span class="c1"># Verify contract is valid</span>
<a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a><span class="n">price</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ib_adapter</span><span class="o">.</span><span class="n">get_current_price</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
<a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current price: </span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="duplicate-order-id-error-103">"Duplicate order ID" (Error 103)<a class="headerlink" href="#duplicate-order-id-error-103" title="Permanent link">&para;</a></h4>
<p><strong>Symptoms:</strong> Order submission fails with duplicate ID error</p>
<p><strong>Cause:</strong> Order ID collision (rare, handled automatically)</p>
<p><strong>Resolution:</strong> IBBrokerAdapter auto-increments order IDs. If error persists, restart adapter.</p>
<h3 id="example-usage">Example Usage<a class="headerlink" href="#example-usage" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="kn">import</span> <span class="nn">asyncio</span>
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="kn">from</span> <span class="nn">rustybt.live.brokers</span> <span class="kn">import</span> <span class="n">IBBrokerAdapter</span>
<a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="kn">from</span> <span class="nn">rustybt.assets</span> <span class="kn">import</span> <span class="n">Equity</span>
<a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a>
<a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a>    <span class="c1"># Create adapter</span>
<a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a>    <span class="n">ib</span> <span class="o">=</span> <span class="n">IBBrokerAdapter</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7496</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a>
<a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a>    <span class="c1"># Connect</span>
<a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a>    <span class="k">await</span> <span class="n">ib</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a id="__codelineno-92-13" name="__codelineno-92-13" href="#__codelineno-92-13"></a>
<a id="__codelineno-92-14" name="__codelineno-92-14" href="#__codelineno-92-14"></a>    <span class="c1"># Create asset</span>
<a id="__codelineno-92-15" name="__codelineno-92-15" href="#__codelineno-92-15"></a>    <span class="n">aapl</span> <span class="o">=</span> <span class="n">Equity</span><span class="p">(</span>
<a id="__codelineno-92-16" name="__codelineno-92-16" href="#__codelineno-92-16"></a>        <span class="n">sid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-92-17" name="__codelineno-92-17" href="#__codelineno-92-17"></a>        <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;AAPL&quot;</span><span class="p">,</span>
<a id="__codelineno-92-18" name="__codelineno-92-18" href="#__codelineno-92-18"></a>        <span class="n">exchange</span><span class="o">=</span><span class="s2">&quot;NASDAQ&quot;</span><span class="p">,</span>
<a id="__codelineno-92-19" name="__codelineno-92-19" href="#__codelineno-92-19"></a>        <span class="n">start_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2000-01-01&quot;</span><span class="p">),</span>
<a id="__codelineno-92-20" name="__codelineno-92-20" href="#__codelineno-92-20"></a>        <span class="n">end_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2030-01-01&quot;</span><span class="p">),</span>
<a id="__codelineno-92-21" name="__codelineno-92-21" href="#__codelineno-92-21"></a>    <span class="p">)</span>
<a id="__codelineno-92-22" name="__codelineno-92-22" href="#__codelineno-92-22"></a>
<a id="__codelineno-92-23" name="__codelineno-92-23" href="#__codelineno-92-23"></a>    <span class="c1"># Get current price</span>
<a id="__codelineno-92-24" name="__codelineno-92-24" href="#__codelineno-92-24"></a>    <span class="n">price</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ib</span><span class="o">.</span><span class="n">get_current_price</span><span class="p">(</span><span class="n">aapl</span><span class="p">)</span>
<a id="__codelineno-92-25" name="__codelineno-92-25" href="#__codelineno-92-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AAPL price: $</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-92-26" name="__codelineno-92-26" href="#__codelineno-92-26"></a>
<a id="__codelineno-92-27" name="__codelineno-92-27" href="#__codelineno-92-27"></a>    <span class="c1"># Submit market order</span>
<a id="__codelineno-92-28" name="__codelineno-92-28" href="#__codelineno-92-28"></a>    <span class="n">order_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ib</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span>
<a id="__codelineno-92-29" name="__codelineno-92-29" href="#__codelineno-92-29"></a>        <span class="n">asset</span><span class="o">=</span><span class="n">aapl</span><span class="p">,</span>
<a id="__codelineno-92-30" name="__codelineno-92-30" href="#__codelineno-92-30"></a>        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10&quot;</span><span class="p">),</span>
<a id="__codelineno-92-31" name="__codelineno-92-31" href="#__codelineno-92-31"></a>        <span class="n">order_type</span><span class="o">=</span><span class="s2">&quot;market&quot;</span><span class="p">,</span>
<a id="__codelineno-92-32" name="__codelineno-92-32" href="#__codelineno-92-32"></a>    <span class="p">)</span>
<a id="__codelineno-92-33" name="__codelineno-92-33" href="#__codelineno-92-33"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order submitted: </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-92-34" name="__codelineno-92-34" href="#__codelineno-92-34"></a>
<a id="__codelineno-92-35" name="__codelineno-92-35" href="#__codelineno-92-35"></a>    <span class="c1"># Wait for fill</span>
<a id="__codelineno-92-36" name="__codelineno-92-36" href="#__codelineno-92-36"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-92-37" name="__codelineno-92-37" href="#__codelineno-92-37"></a>
<a id="__codelineno-92-38" name="__codelineno-92-38" href="#__codelineno-92-38"></a>    <span class="c1"># Check positions</span>
<a id="__codelineno-92-39" name="__codelineno-92-39" href="#__codelineno-92-39"></a>    <span class="n">positions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ib</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
<a id="__codelineno-92-40" name="__codelineno-92-40" href="#__codelineno-92-40"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Positions: </span><span class="si">{</span><span class="n">positions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-92-41" name="__codelineno-92-41" href="#__codelineno-92-41"></a>
<a id="__codelineno-92-42" name="__codelineno-92-42" href="#__codelineno-92-42"></a>    <span class="c1"># Check account</span>
<a id="__codelineno-92-43" name="__codelineno-92-43" href="#__codelineno-92-43"></a>    <span class="n">account</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ib</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span>
<a id="__codelineno-92-44" name="__codelineno-92-44" href="#__codelineno-92-44"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cash: $</span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;cash&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-92-45" name="__codelineno-92-45" href="#__codelineno-92-45"></a>
<a id="__codelineno-92-46" name="__codelineno-92-46" href="#__codelineno-92-46"></a>    <span class="c1"># Disconnect</span>
<a id="__codelineno-92-47" name="__codelineno-92-47" href="#__codelineno-92-47"></a>    <span class="k">await</span> <span class="n">ib</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
<a id="__codelineno-92-48" name="__codelineno-92-48" href="#__codelineno-92-48"></a>
<a id="__codelineno-92-49" name="__codelineno-92-49" href="#__codelineno-92-49"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-92-50" name="__codelineno-92-50" href="#__codelineno-92-50"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<h3 id="future-enhancements">Future Enhancements<a class="headerlink" href="#future-enhancements" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Multi-leg order support (spreads, combos)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Advanced order types (bracket, OCA, trailing limit)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Historical data fetching via IB API</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Real-time news feed integration</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Scanner/watchlist integration</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Portfolio analytics via IB Flex queries</li>
</ul>
<hr />
<h2 id="data-api-provider-adapters">Data API Provider Adapters<a class="headerlink" href="#data-api-provider-adapters" title="Permanent link">&para;</a></h2>
<h3 id="overview_3">Overview<a class="headerlink" href="#overview_3" title="Permanent link">&para;</a></h3>
<p>RustyBT supports professional data API providers for high-quality market data. The API provider adapter framework extends the base data adapter with authentication, rate limiting, and provider-specific error handling.</p>
<h3 id="supported-providers">Supported Providers<a class="headerlink" href="#supported-providers" title="Permanent link">&para;</a></h3>
<h4 id="polygonio">Polygon.io<a class="headerlink" href="#polygonio" title="Permanent link">&para;</a></h4>
<p><strong>Coverage:</strong> US stocks, options, forex, cryptocurrencies
<strong>Documentation:</strong> https://polygon.io/docs</p>
<p><strong>Features:</strong>
- Real-time and historical OHLCV data
- Corporate actions (splits, dividends)
- Multiple timeframes: minute, hour, day, week, month
- Global market coverage</p>
<p><strong>Rate Limits:</strong>
- Free tier: 5 requests/minute
- Starter tier: 10 requests/minute
- Developer tier: 100 requests/minute</p>
<p><strong>Pricing:</strong>
- Free: Limited features, delayed data
- Starter: $29/month
- Developer: $99/month
- Advanced: $399/month</p>
<p><strong>Setup:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="c1"># Set environment variable</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">POLYGON_API_KEY</span><span class="o">=</span>your_polygon_api_key_here
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="c1"># Or add to .env file</span>
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;POLYGON_API_KEY=your_polygon_api_key_here&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>.env
</code></pre></div></p>
<p><strong>Usage:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="kn">from</span> <span class="nn">rustybt.data.adapters</span> <span class="kn">import</span> <span class="n">PolygonAdapter</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a><span class="c1"># Initialize adapter</span>
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a><span class="n">adapter</span> <span class="o">=</span> <span class="n">PolygonAdapter</span><span class="p">(</span><span class="n">tier</span><span class="o">=</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="n">asset_type</span><span class="o">=</span><span class="s2">&quot;stocks&quot;</span><span class="p">)</span>
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a><span class="c1"># Fetch stock data</span>
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a><span class="n">df</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span>
<a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>    <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;AAPL&quot;</span><span class="p">,</span>
<a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a>    <span class="n">start_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-01&quot;</span><span class="p">),</span>
<a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a>    <span class="n">end_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-31&quot;</span><span class="p">),</span>
<a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a>    <span class="n">timeframe</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span>
<a id="__codelineno-94-13" name="__codelineno-94-13" href="#__codelineno-94-13"></a><span class="p">)</span>
<a id="__codelineno-94-14" name="__codelineno-94-14" href="#__codelineno-94-14"></a>
<a id="__codelineno-94-15" name="__codelineno-94-15" href="#__codelineno-94-15"></a><span class="c1"># Fetch crypto data</span>
<a id="__codelineno-94-16" name="__codelineno-94-16" href="#__codelineno-94-16"></a><span class="n">crypto_adapter</span> <span class="o">=</span> <span class="n">PolygonAdapter</span><span class="p">(</span><span class="n">tier</span><span class="o">=</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="n">asset_type</span><span class="o">=</span><span class="s2">&quot;crypto&quot;</span><span class="p">)</span>
<a id="__codelineno-94-17" name="__codelineno-94-17" href="#__codelineno-94-17"></a><span class="n">btc_df</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crypto_adapter</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span>
<a id="__codelineno-94-18" name="__codelineno-94-18" href="#__codelineno-94-18"></a>    <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;BTCUSD&quot;</span><span class="p">,</span>
<a id="__codelineno-94-19" name="__codelineno-94-19" href="#__codelineno-94-19"></a>    <span class="n">start_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-01&quot;</span><span class="p">),</span>
<a id="__codelineno-94-20" name="__codelineno-94-20" href="#__codelineno-94-20"></a>    <span class="n">end_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-31&quot;</span><span class="p">),</span>
<a id="__codelineno-94-21" name="__codelineno-94-21" href="#__codelineno-94-21"></a>    <span class="n">timeframe</span><span class="o">=</span><span class="s2">&quot;1h&quot;</span>
<a id="__codelineno-94-22" name="__codelineno-94-22" href="#__codelineno-94-22"></a><span class="p">)</span>
<a id="__codelineno-94-23" name="__codelineno-94-23" href="#__codelineno-94-23"></a>
<a id="__codelineno-94-24" name="__codelineno-94-24" href="#__codelineno-94-24"></a><span class="c1"># Cleanup</span>
<a id="__codelineno-94-25" name="__codelineno-94-25" href="#__codelineno-94-25"></a><span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></p>
<h4 id="alpaca-markets">Alpaca Markets<a class="headerlink" href="#alpaca-markets" title="Permanent link">&para;</a></h4>
<p><strong>Coverage:</strong> US stocks
<strong>Documentation:</strong> https://alpaca.markets/docs</p>
<p><strong>Features:</strong>
- Commission-free trading
- Real-time and historical market data
- Paper trading (free)
- IEX feed for paper, SIP feed for live</p>
<p><strong>Rate Limits:</strong>
- Data API: 200 requests/minute</p>
<p><strong>Pricing:</strong>
- Paper trading: Free
- Live trading: Free (data subscriptions separate)
- Market data: Starting at $9/month</p>
<p><strong>Setup:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="c1"># Set environment variables</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ALPACA_API_KEY</span><span class="o">=</span>your_alpaca_key_id_here
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ALPACA_API_SECRET</span><span class="o">=</span>your_alpaca_secret_key_here
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a><span class="c1"># Or add to .env file</span>
<a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ALPACA_API_KEY=your_alpaca_key_id_here&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>.env
<a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ALPACA_API_SECRET=your_alpaca_secret_key_here&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>.env
</code></pre></div></p>
<p><strong>Usage:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="kn">from</span> <span class="nn">rustybt.data.adapters</span> <span class="kn">import</span> <span class="n">AlpacaAdapter</span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a>
<a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a><span class="c1"># Initialize adapter (paper trading)</span>
<a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a><span class="n">adapter</span> <span class="o">=</span> <span class="n">AlpacaAdapter</span><span class="p">(</span><span class="n">is_paper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a>
<a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a><span class="c1"># Fetch stock data</span>
<a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a><span class="n">df</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span>
<a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a>    <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;AAPL&quot;</span><span class="p">,</span>
<a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a>    <span class="n">start_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-01&quot;</span><span class="p">),</span>
<a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a>    <span class="n">end_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-31&quot;</span><span class="p">),</span>
<a id="__codelineno-96-12" name="__codelineno-96-12" href="#__codelineno-96-12"></a>    <span class="n">timeframe</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span>
<a id="__codelineno-96-13" name="__codelineno-96-13" href="#__codelineno-96-13"></a><span class="p">)</span>
<a id="__codelineno-96-14" name="__codelineno-96-14" href="#__codelineno-96-14"></a>
<a id="__codelineno-96-15" name="__codelineno-96-15" href="#__codelineno-96-15"></a><span class="c1"># Fetch intraday data</span>
<a id="__codelineno-96-16" name="__codelineno-96-16" href="#__codelineno-96-16"></a><span class="n">intraday_df</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span>
<a id="__codelineno-96-17" name="__codelineno-96-17" href="#__codelineno-96-17"></a>    <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;MSFT&quot;</span><span class="p">,</span>
<a id="__codelineno-96-18" name="__codelineno-96-18" href="#__codelineno-96-18"></a>    <span class="n">start_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-31&quot;</span><span class="p">),</span>
<a id="__codelineno-96-19" name="__codelineno-96-19" href="#__codelineno-96-19"></a>    <span class="n">end_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-31&quot;</span><span class="p">),</span>
<a id="__codelineno-96-20" name="__codelineno-96-20" href="#__codelineno-96-20"></a>    <span class="n">timeframe</span><span class="o">=</span><span class="s2">&quot;1m&quot;</span>
<a id="__codelineno-96-21" name="__codelineno-96-21" href="#__codelineno-96-21"></a><span class="p">)</span>
<a id="__codelineno-96-22" name="__codelineno-96-22" href="#__codelineno-96-22"></a>
<a id="__codelineno-96-23" name="__codelineno-96-23" href="#__codelineno-96-23"></a><span class="c1"># Cleanup</span>
<a id="__codelineno-96-24" name="__codelineno-96-24" href="#__codelineno-96-24"></a><span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></p>
<h4 id="alpha-vantage">Alpha Vantage<a class="headerlink" href="#alpha-vantage" title="Permanent link">&para;</a></h4>
<p><strong>Coverage:</strong> Global stocks, forex, cryptocurrencies
<strong>Documentation:</strong> https://www.alphavantage.co/documentation/</p>
<p><strong>Features:</strong>
- Global market data
- Technical indicators
- Fundamental data
- Economic indicators</p>
<p><strong>Rate Limits:</strong>
- Free tier: 5 requests/minute, 500 requests/day
- Premium tier: 75 requests/minute, 1200 requests/day</p>
<p><strong>Pricing:</strong>
- Free: Limited requests
- Premium: Starting at $49.99/month</p>
<p><strong>Setup:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="c1"># Set environment variable</span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ALPHAVANTAGE_API_KEY</span><span class="o">=</span>your_alphavantage_api_key_here
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a>
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="c1"># Or add to .env file</span>
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ALPHAVANTAGE_API_KEY=your_alphavantage_api_key_here&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>.env
</code></pre></div></p>
<p><strong>Usage:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="kn">from</span> <span class="nn">rustybt.data.adapters</span> <span class="kn">import</span> <span class="n">AlphaVantageAdapter</span>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a>
<a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a><span class="c1"># Initialize adapter</span>
<a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a><span class="n">adapter</span> <span class="o">=</span> <span class="n">AlphaVantageAdapter</span><span class="p">(</span><span class="n">tier</span><span class="o">=</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="n">asset_type</span><span class="o">=</span><span class="s2">&quot;stocks&quot;</span><span class="p">)</span>
<a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a>
<a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a><span class="c1"># Fetch stock data</span>
<a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a><span class="n">df</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span>
<a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a>    <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;AAPL&quot;</span><span class="p">,</span>
<a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a>    <span class="n">start_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-01&quot;</span><span class="p">),</span>
<a id="__codelineno-98-11" name="__codelineno-98-11" href="#__codelineno-98-11"></a>    <span class="n">end_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-31&quot;</span><span class="p">),</span>
<a id="__codelineno-98-12" name="__codelineno-98-12" href="#__codelineno-98-12"></a>    <span class="n">timeframe</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span>
<a id="__codelineno-98-13" name="__codelineno-98-13" href="#__codelineno-98-13"></a><span class="p">)</span>
<a id="__codelineno-98-14" name="__codelineno-98-14" href="#__codelineno-98-14"></a>
<a id="__codelineno-98-15" name="__codelineno-98-15" href="#__codelineno-98-15"></a><span class="c1"># Fetch forex data</span>
<a id="__codelineno-98-16" name="__codelineno-98-16" href="#__codelineno-98-16"></a><span class="n">forex_adapter</span> <span class="o">=</span> <span class="n">AlphaVantageAdapter</span><span class="p">(</span><span class="n">tier</span><span class="o">=</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="n">asset_type</span><span class="o">=</span><span class="s2">&quot;forex&quot;</span><span class="p">)</span>
<a id="__codelineno-98-17" name="__codelineno-98-17" href="#__codelineno-98-17"></a><span class="n">fx_df</span> <span class="o">=</span> <span class="k">await</span> <span class="n">forex_adapter</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span>
<a id="__codelineno-98-18" name="__codelineno-98-18" href="#__codelineno-98-18"></a>    <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;EUR/USD&quot;</span><span class="p">,</span>
<a id="__codelineno-98-19" name="__codelineno-98-19" href="#__codelineno-98-19"></a>    <span class="n">start_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-01&quot;</span><span class="p">),</span>
<a id="__codelineno-98-20" name="__codelineno-98-20" href="#__codelineno-98-20"></a>    <span class="n">end_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2024-01-31&quot;</span><span class="p">),</span>
<a id="__codelineno-98-21" name="__codelineno-98-21" href="#__codelineno-98-21"></a>    <span class="n">timeframe</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span>
<a id="__codelineno-98-22" name="__codelineno-98-22" href="#__codelineno-98-22"></a><span class="p">)</span>
<a id="__codelineno-98-23" name="__codelineno-98-23" href="#__codelineno-98-23"></a>
<a id="__codelineno-98-24" name="__codelineno-98-24" href="#__codelineno-98-24"></a><span class="c1"># Cleanup</span>
<a id="__codelineno-98-25" name="__codelineno-98-25" href="#__codelineno-98-25"></a><span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></p>
<h3 id="api-key-management">API Key Management<a class="headerlink" href="#api-key-management" title="Permanent link">&para;</a></h3>
<h4 id="environment-variables-recommended">Environment Variables (Recommended)<a class="headerlink" href="#environment-variables-recommended" title="Permanent link">&para;</a></h4>
<p>Store API keys in environment variables or <code>.env</code> file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="c1"># .env file (NEVER commit to version control!)</span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="nv">POLYGON_API_KEY</span><span class="o">=</span>your_polygon_key_here
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="nv">ALPACA_API_KEY</span><span class="o">=</span>your_alpaca_key_here
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a><span class="nv">ALPACA_API_SECRET</span><span class="o">=</span>your_alpaca_secret_here
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a><span class="nv">ALPHAVANTAGE_API_KEY</span><span class="o">=</span>your_alphavantage_key_here
</code></pre></div>
<h4 id="configuration-file-alternative">Configuration File (Alternative)<a class="headerlink" href="#configuration-file-alternative" title="Permanent link">&para;</a></h4>
<p>Store API keys in <code>~/.rustybt/api_keys.ini</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="k">[polygon_stocks_free]</span>
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="na">api_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">your_polygon_api_key_here</span>
<a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a>
<a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a><span class="k">[alpaca_paper]</span>
<a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a><span class="na">api_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">your_alpaca_key_id_here</span>
<a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a><span class="na">api_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">your_alpaca_secret_key_here</span>
<a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a>
<a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a><span class="k">[alphavantage_stocks_free]</span>
<a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a><span class="na">api_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">your_alphavantage_api_key_here</span>
</code></pre></div>
<p><strong>Security Best Practices:</strong>
1. Never commit API keys to version control
2. Use environment variables or config files outside project directory
3. Rotate API keys regularly
4. Use separate keys for development and production
5. Monitor API usage for unauthorized access</p>
<h3 id="rate-limiting">Rate Limiting<a class="headerlink" href="#rate-limiting" title="Permanent link">&para;</a></h3>
<p>All API provider adapters include built-in rate limiting:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="c1"># Rate limiter enforces limits per provider tier</span>
<a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="n">adapter</span> <span class="o">=</span> <span class="n">PolygonAdapter</span><span class="p">(</span><span class="n">tier</span><span class="o">=</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="n">asset_type</span><span class="o">=</span><span class="s2">&quot;stocks&quot;</span><span class="p">)</span>  <span class="c1"># 5 req/min</span>
<a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a>
<a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="c1"># Automatic throttling when limit reached</span>
<a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a><span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
<a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a>    <span class="c1"># Rate limiter automatically waits if limit exceeded</span>
<a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a>    <span class="n">df</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s2">&quot;1d&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Quota Warnings:</strong>
- Warning logged at 80% of daily quota
- QuotaExceededError raised when quota exhausted
- Retry-After header respected for 429 responses</p>
<h3 id="error-handling_1">Error Handling<a class="headerlink" href="#error-handling_1" title="Permanent link">&para;</a></h3>
<p>API provider adapters handle provider-specific errors:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="kn">from</span> <span class="nn">rustybt.data.adapters.api_provider_base</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a>    <span class="n">AuthenticationError</span><span class="p">,</span>
<a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>    <span class="n">SymbolNotFoundError</span><span class="p">,</span>
<a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>    <span class="n">QuotaExceededError</span><span class="p">,</span>
<a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a>    <span class="n">DataParsingError</span>
<a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a><span class="p">)</span>
<a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a>
<a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a>    <span class="n">df</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adapter</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="s2">&quot;INVALID&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s2">&quot;1d&quot;</span><span class="p">)</span>
<a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a><span class="k">except</span> <span class="n">AuthenticationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-102-11" name="__codelineno-102-11" href="#__codelineno-102-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-102-12" name="__codelineno-102-12" href="#__codelineno-102-12"></a><span class="k">except</span> <span class="n">SymbolNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-102-13" name="__codelineno-102-13" href="#__codelineno-102-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symbol not found: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-102-14" name="__codelineno-102-14" href="#__codelineno-102-14"></a><span class="k">except</span> <span class="n">QuotaExceededError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-102-15" name="__codelineno-102-15" href="#__codelineno-102-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quota exceeded: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-102-16" name="__codelineno-102-16" href="#__codelineno-102-16"></a><span class="k">except</span> <span class="n">DataParsingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-102-17" name="__codelineno-102-17" href="#__codelineno-102-17"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="testing_2">Testing<a class="headerlink" href="#testing_2" title="Permanent link">&para;</a></h3>
<h4 id="unit-tests_1">Unit Tests<a class="headerlink" href="#unit-tests_1" title="Permanent link">&para;</a></h4>
<p>Run unit tests with mocked API responses:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a>pytest<span class="w"> </span>tests/data/adapters/test_polygon_adapter.py<span class="w"> </span>-v
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a>pytest<span class="w"> </span>tests/data/adapters/test_alpaca_adapter.py<span class="w"> </span>-v
<a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a>pytest<span class="w"> </span>tests/data/adapters/test_alphavantage_adapter.py<span class="w"> </span>-v
</code></pre></div>
<h4 id="integration-tests_1">Integration Tests<a class="headerlink" href="#integration-tests_1" title="Permanent link">&para;</a></h4>
<p>Run integration tests with real API calls (requires valid API keys):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="c1"># Set up API keys first</span>
<a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">POLYGON_API_KEY</span><span class="o">=</span>your_key
<a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ALPACA_API_KEY</span><span class="o">=</span>your_key
<a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ALPACA_API_SECRET</span><span class="o">=</span>your_secret
<a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ALPHAVANTAGE_API_KEY</span><span class="o">=</span>your_key
<a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a>
<a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a><span class="c1"># Run integration tests</span>
<a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a>pytest<span class="w"> </span>tests/integration/data/test_api_providers.py<span class="w"> </span>-m<span class="w"> </span>api_integration<span class="w"> </span>-v
</code></pre></div>
<p><strong>Note:</strong> Integration tests count against your API rate limits. Use with caution on free tiers.</p>
<h3 id="troubleshooting_1">Troubleshooting<a class="headerlink" href="#troubleshooting_1" title="Permanent link">&para;</a></h3>
<h4 id="common-issues">Common Issues<a class="headerlink" href="#common-issues" title="Permanent link">&para;</a></h4>
<p><strong>1. Authentication Error</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a>AuthenticationError: API key not found. Set environment variable POLYGON_API_KEY...
</code></pre></div>
<strong>Solution:</strong> Set API key in environment variable or <code>~/.rustybt/api_keys.ini</code></p>
<p><strong>2. Rate Limit Exceeded</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a>QuotaExceededError: Daily quota of 500 requests exceeded. Resets in 3600 seconds.
</code></pre></div>
<strong>Solution:</strong> Upgrade to paid tier or wait for quota reset</p>
<p><strong>3. Symbol Not Found</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a>SymbolNotFoundError: Symbol &#39;XYZ&#39; not found in Polygon stocks
</code></pre></div>
<strong>Solution:</strong> Verify symbol is valid and supported by provider</p>
<p><strong>4. Data Parsing Error</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a>DataParsingError: No results found in Polygon response for AAPL
</code></pre></div>
<strong>Solution:</strong> Check date range (may be weekend/holiday), verify symbol format</p>
<h4 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link">&para;</a></h4>
<p>Enable debug logging:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a><span class="kn">import</span> <span class="nn">structlog</span>
<a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a>
<a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a><span class="c1"># Configure debug logging</span>
<a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a><span class="n">structlog</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
<a id="__codelineno-109-5" name="__codelineno-109-5" href="#__codelineno-109-5"></a>    <span class="n">processors</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-109-6" name="__codelineno-109-6" href="#__codelineno-109-6"></a>        <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">add_log_level</span><span class="p">,</span>
<a id="__codelineno-109-7" name="__codelineno-109-7" href="#__codelineno-109-7"></a>        <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">TimeStamper</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;iso&quot;</span><span class="p">),</span>
<a id="__codelineno-109-8" name="__codelineno-109-8" href="#__codelineno-109-8"></a>        <span class="n">structlog</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">ConsoleRenderer</span><span class="p">()</span>
<a id="__codelineno-109-9" name="__codelineno-109-9" href="#__codelineno-109-9"></a>    <span class="p">]</span>
<a id="__codelineno-109-10" name="__codelineno-109-10" href="#__codelineno-109-10"></a><span class="p">)</span>
<a id="__codelineno-109-11" name="__codelineno-109-11" href="#__codelineno-109-11"></a>
<a id="__codelineno-109-12" name="__codelineno-109-12" href="#__codelineno-109-12"></a><span class="c1"># Adapter will log all API requests/responses</span>
<a id="__codelineno-109-13" name="__codelineno-109-13" href="#__codelineno-109-13"></a><span class="n">adapter</span> <span class="o">=</span> <span class="n">PolygonAdapter</span><span class="p">(</span><span class="n">tier</span><span class="o">=</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="n">asset_type</span><span class="o">=</span><span class="s2">&quot;stocks&quot;</span><span class="p">)</span>
</code></pre></div>
<hr />
<hr />
<h2 id="circuit-breakers-and-risk-management">Circuit Breakers and Risk Management<a class="headerlink" href="#circuit-breakers-and-risk-management" title="Permanent link">&para;</a></h2>
<h3 id="overview_4">Overview<a class="headerlink" href="#overview_4" title="Permanent link">&para;</a></h3>
<p>Circuit breakers are automated safety mechanisms that halt trading when certain risk thresholds are exceeded. They prevent catastrophic losses and provide time for manual intervention when market conditions become adverse or system errors occur.</p>
<h3 id="circuit-breaker-types">Circuit Breaker Types<a class="headerlink" href="#circuit-breaker-types" title="Permanent link">&para;</a></h3>
<h4 id="1-drawdown-circuit-breaker">1. Drawdown Circuit Breaker<a class="headerlink" href="#1-drawdown-circuit-breaker" title="Permanent link">&para;</a></h4>
<p><strong>Purpose:</strong> Halt trading if portfolio drawdown exceeds threshold</p>
<p><strong>Configuration:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="kn">from</span> <span class="nn">rustybt.live.circuit_breakers</span> <span class="kn">import</span> <span class="n">DrawdownCircuitBreaker</span>
<a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a>
<a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a><span class="n">breaker</span> <span class="o">=</span> <span class="n">DrawdownCircuitBreaker</span><span class="p">(</span>
<a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a>    <span class="n">threshold</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.10&quot;</span><span class="p">),</span>  <span class="c1"># -10% drawdown</span>
<a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a>    <span class="n">initial_portfolio_value</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100000&quot;</span><span class="p">)</span>
<a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>How it works:</strong>
- Tracks high-water mark (highest portfolio value ever reached)
- Calculates drawdown: <code>(current_value - high_water_mark) / high_water_mark</code>
- Trips when drawdown &lt;= threshold (e.g., -10%)
- Updates high-water mark when portfolio increases</p>
<p><strong>Use cases:</strong>
- Protect against market crashes
- Limit losses from strategy malfunctions
- Prevent emotional trading decisions</p>
<h4 id="2-daily-loss-circuit-breaker">2. Daily Loss Circuit Breaker<a class="headerlink" href="#2-daily-loss-circuit-breaker" title="Permanent link">&para;</a></h4>
<p><strong>Purpose:</strong> Halt trading if daily loss exceeds limit</p>
<p><strong>Configuration (Percentage):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="n">breaker</span> <span class="o">=</span> <span class="n">DailyLossCircuitBreaker</span><span class="p">(</span>
<a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a>    <span class="n">limit</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.05&quot;</span><span class="p">),</span>  <span class="c1"># -5% daily loss</span>
<a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a>    <span class="n">initial_portfolio_value</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100000&quot;</span><span class="p">),</span>
<a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a>    <span class="n">is_percentage</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>Configuration (Absolute):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="n">breaker</span> <span class="o">=</span> <span class="n">DailyLossCircuitBreaker</span><span class="p">(</span>
<a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a>    <span class="n">limit</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-5000&quot;</span><span class="p">),</span>  <span class="c1"># -$5000 daily loss</span>
<a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a>    <span class="n">initial_portfolio_value</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100000&quot;</span><span class="p">),</span>
<a id="__codelineno-112-4" name="__codelineno-112-4" href="#__codelineno-112-4"></a>    <span class="n">is_percentage</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-112-5" name="__codelineno-112-5" href="#__codelineno-112-5"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>How it works:</strong>
- Tracks starting portfolio value at market open (reset daily)
- Calculates daily loss: <code>current_value - starting_value</code>
- Trips when loss exceeds configured limit
- Automatically resets at market open (via Scheduler integration)</p>
<p><strong>Use cases:</strong>
- Enforce daily loss limits per risk management policy
- Prevent runaway losses in volatile markets
- Comply with regulatory requirements</p>
<h4 id="3-order-rate-circuit-breaker">3. Order Rate Circuit Breaker<a class="headerlink" href="#3-order-rate-circuit-breaker" title="Permanent link">&para;</a></h4>
<p><strong>Purpose:</strong> Prevent runaway order submission</p>
<p><strong>Configuration:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="n">breaker</span> <span class="o">=</span> <span class="n">OrderRateCircuitBreaker</span><span class="p">(</span>
<a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a>    <span class="n">max_orders</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># Max 100 orders</span>
<a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a>    <span class="n">window_seconds</span><span class="o">=</span><span class="mi">60</span>  <span class="c1"># Per 60 seconds</span>
<a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>How it works:</strong>
- Tracks order submission timestamps in sliding window
- Counts orders in last <code>window_seconds</code>
- Trips when count exceeds <code>max_orders</code>
- Raises <code>CircuitBreakerError</code> on subsequent order attempts</p>
<p><strong>Use cases:</strong>
- Detect strategy bugs causing order loops
- Prevent exchange rate limiting
- Reduce commission costs from excessive trading</p>
<h4 id="4-error-rate-circuit-breaker">4. Error Rate Circuit Breaker<a class="headerlink" href="#4-error-rate-circuit-breaker" title="Permanent link">&para;</a></h4>
<p><strong>Purpose:</strong> Halt on repeated errors (order rejections, broker errors)</p>
<p><strong>Configuration:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="n">breaker</span> <span class="o">=</span> <span class="n">ErrorRateCircuitBreaker</span><span class="p">(</span>
<a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a>    <span class="n">max_errors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># Max 10 errors</span>
<a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a>    <span class="n">window_seconds</span><span class="o">=</span><span class="mi">60</span>  <span class="c1"># Per 60 seconds</span>
<a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>How it works:</strong>
- Tracks errors in sliding window with error types
- Counts errors in last <code>window_seconds</code>
- Trips when count exceeds <code>max_errors</code>
- Logs error type breakdown (order_rejected, broker_error, data_error)</p>
<p><strong>Use cases:</strong>
- Detect broker connectivity issues
- Identify order parameter validation errors
- Halt trading when data feed degrades</p>
<h4 id="5-manual-circuit-breaker">5. Manual Circuit Breaker<a class="headerlink" href="#5-manual-circuit-breaker" title="Permanent link">&para;</a></h4>
<p><strong>Purpose:</strong> Emergency stop capability</p>
<p><strong>Configuration:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a><span class="n">breaker</span> <span class="o">=</span> <span class="n">ManualCircuitBreaker</span><span class="p">()</span>
<a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a>
<a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a><span class="c1"># Trigger halt</span>
<a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a><span class="n">event</span> <span class="o">=</span> <span class="n">breaker</span><span class="o">.</span><span class="n">trip</span><span class="p">(</span>
<a id="__codelineno-115-5" name="__codelineno-115-5" href="#__codelineno-115-5"></a>    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Market anomaly detected&quot;</span><span class="p">,</span>
<a id="__codelineno-115-6" name="__codelineno-115-6" href="#__codelineno-115-6"></a>    <span class="n">operator</span><span class="o">=</span><span class="s2">&quot;trader_alice&quot;</span>
<a id="__codelineno-115-7" name="__codelineno-115-7" href="#__codelineno-115-7"></a><span class="p">)</span>
<a id="__codelineno-115-8" name="__codelineno-115-8" href="#__codelineno-115-8"></a>
<a id="__codelineno-115-9" name="__codelineno-115-9" href="#__codelineno-115-9"></a><span class="c1"># Reset after issue resolved</span>
<a id="__codelineno-115-10" name="__codelineno-115-10" href="#__codelineno-115-10"></a><span class="n">breaker</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</code></pre></div></p>
<p><strong>How it works:</strong>
- Provides explicit manual trip/reset methods
- Sets state to <code>MANUALLY_HALTED</code>
- Requires manual reset (no auto-recovery)
- Logs operator and reason for audit trail</p>
<p><strong>Use cases:</strong>
- Emergency halt during market anomalies
- Manual intervention during investigation
- Planned maintenance or system upgrades</p>
<h3 id="circuit-breaker-states">Circuit Breaker States<a class="headerlink" href="#circuit-breaker-states" title="Permanent link">&para;</a></h3>
<p>Circuit breakers have 4 states:</p>
<ol>
<li><strong>NORMAL</strong>: Operating normally, monitoring enabled</li>
<li><strong>TRIPPED</strong>: Threshold exceeded, trading halted</li>
<li><strong>MANUALLY_HALTED</strong>: Manual emergency stop active</li>
<li><strong>RESETTING</strong>: Transitioning back to NORMAL (not used yet)</li>
</ol>
<h3 id="circuit-breaker-manager">Circuit Breaker Manager<a class="headerlink" href="#circuit-breaker-manager" title="Permanent link">&para;</a></h3>
<p>The <code>CircuitBreakerManager</code> coordinates all circuit breakers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="kn">from</span> <span class="nn">rustybt.live.circuit_breakers</span> <span class="kn">import</span> <span class="n">CircuitBreakerManager</span>
<a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a>
<a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a><span class="n">manager</span> <span class="o">=</span> <span class="n">CircuitBreakerManager</span><span class="p">(</span>
<a id="__codelineno-116-4" name="__codelineno-116-4" href="#__codelineno-116-4"></a>    <span class="n">drawdown_breaker</span><span class="o">=</span><span class="n">drawdown</span><span class="p">,</span>
<a id="__codelineno-116-5" name="__codelineno-116-5" href="#__codelineno-116-5"></a>    <span class="n">daily_loss_breaker</span><span class="o">=</span><span class="n">daily_loss</span><span class="p">,</span>
<a id="__codelineno-116-6" name="__codelineno-116-6" href="#__codelineno-116-6"></a>    <span class="n">order_rate_breaker</span><span class="o">=</span><span class="n">order_rate</span><span class="p">,</span>
<a id="__codelineno-116-7" name="__codelineno-116-7" href="#__codelineno-116-7"></a>    <span class="n">error_rate_breaker</span><span class="o">=</span><span class="n">error_rate</span><span class="p">,</span>
<a id="__codelineno-116-8" name="__codelineno-116-8" href="#__codelineno-116-8"></a>    <span class="c1"># manual_breaker created automatically</span>
<a id="__codelineno-116-9" name="__codelineno-116-9" href="#__codelineno-116-9"></a><span class="p">)</span>
<a id="__codelineno-116-10" name="__codelineno-116-10" href="#__codelineno-116-10"></a>
<a id="__codelineno-116-11" name="__codelineno-116-11" href="#__codelineno-116-11"></a><span class="c1"># Register callback for circuit breaker events</span>
<a id="__codelineno-116-12" name="__codelineno-116-12" href="#__codelineno-116-12"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">handle_circuit_breaker_event</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<a id="__codelineno-116-13" name="__codelineno-116-13" href="#__codelineno-116-13"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;circuit_breaker_tripped&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-116-14" name="__codelineno-116-14" href="#__codelineno-116-14"></a>    <span class="c1"># Send alerts, halt trading, notify operators</span>
<a id="__codelineno-116-15" name="__codelineno-116-15" href="#__codelineno-116-15"></a>
<a id="__codelineno-116-16" name="__codelineno-116-16" href="#__codelineno-116-16"></a><span class="n">manager</span><span class="o">.</span><span class="n">register_event_callback</span><span class="p">(</span><span class="n">handle_circuit_breaker_event</span><span class="p">)</span>
<a id="__codelineno-116-17" name="__codelineno-116-17" href="#__codelineno-116-17"></a>
<a id="__codelineno-116-18" name="__codelineno-116-18" href="#__codelineno-116-18"></a><span class="c1"># Check circuit breakers</span>
<a id="__codelineno-116-19" name="__codelineno-116-19" href="#__codelineno-116-19"></a><span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">check_drawdown</span><span class="p">(</span><span class="n">current_portfolio_value</span><span class="p">)</span>
<a id="__codelineno-116-20" name="__codelineno-116-20" href="#__codelineno-116-20"></a><span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">check_daily_loss</span><span class="p">(</span><span class="n">current_portfolio_value</span><span class="p">)</span>
<a id="__codelineno-116-21" name="__codelineno-116-21" href="#__codelineno-116-21"></a><span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">record_order</span><span class="p">()</span>  <span class="c1"># Call before submitting order</span>
<a id="__codelineno-116-22" name="__codelineno-116-22" href="#__codelineno-116-22"></a><span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">record_error</span><span class="p">(</span><span class="s2">&quot;order_rejected&quot;</span><span class="p">)</span>
<a id="__codelineno-116-23" name="__codelineno-116-23" href="#__codelineno-116-23"></a>
<a id="__codelineno-116-24" name="__codelineno-116-24" href="#__codelineno-116-24"></a><span class="c1"># Manual halt</span>
<a id="__codelineno-116-25" name="__codelineno-116-25" href="#__codelineno-116-25"></a><span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">manual_halt</span><span class="p">(</span><span class="s2">&quot;Emergency stop&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s2">&quot;trader_bob&quot;</span><span class="p">)</span>
<a id="__codelineno-116-26" name="__codelineno-116-26" href="#__codelineno-116-26"></a>
<a id="__codelineno-116-27" name="__codelineno-116-27" href="#__codelineno-116-27"></a><span class="c1"># Reset all breakers (requires manual confirmation in production)</span>
<a id="__codelineno-116-28" name="__codelineno-116-28" href="#__codelineno-116-28"></a><span class="n">manager</span><span class="o">.</span><span class="n">reset_all</span><span class="p">()</span>
<a id="__codelineno-116-29" name="__codelineno-116-29" href="#__codelineno-116-29"></a>
<a id="__codelineno-116-30" name="__codelineno-116-30" href="#__codelineno-116-30"></a><span class="c1"># Get status</span>
<a id="__codelineno-116-31" name="__codelineno-116-31" href="#__codelineno-116-31"></a><span class="n">status</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
<a id="__codelineno-116-32" name="__codelineno-116-32" href="#__codelineno-116-32"></a><span class="c1"># {</span>
<a id="__codelineno-116-33" name="__codelineno-116-33" href="#__codelineno-116-33"></a><span class="c1">#     &quot;overall_state&quot;: &quot;tripped&quot;,</span>
<a id="__codelineno-116-34" name="__codelineno-116-34" href="#__codelineno-116-34"></a><span class="c1">#     &quot;is_tripped&quot;: True,</span>
<a id="__codelineno-116-35" name="__codelineno-116-35" href="#__codelineno-116-35"></a><span class="c1">#     &quot;drawdown&quot;: {&quot;enabled&quot;: True, &quot;state&quot;: &quot;tripped&quot;},</span>
<a id="__codelineno-116-36" name="__codelineno-116-36" href="#__codelineno-116-36"></a><span class="c1">#     &quot;daily_loss&quot;: {&quot;enabled&quot;: True, &quot;state&quot;: &quot;normal&quot;},</span>
<a id="__codelineno-116-37" name="__codelineno-116-37" href="#__codelineno-116-37"></a><span class="c1">#     ...</span>
<a id="__codelineno-116-38" name="__codelineno-116-38" href="#__codelineno-116-38"></a><span class="c1"># }</span>
</code></pre></div>
<h3 id="alert-system">Alert System<a class="headerlink" href="#alert-system" title="Permanent link">&para;</a></h3>
<p>The <code>AlertManager</code> sends notifications when circuit breakers trip:</p>
<h4 id="alert-channels">Alert Channels<a class="headerlink" href="#alert-channels" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Email (SMTP)</strong></li>
<li><strong>SMS (Twilio)</strong></li>
<li><strong>Webhooks (Custom endpoints)</strong></li>
</ol>
<h4 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h4>
<p><strong>Environment Variables:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="c1"># Email (SMTP)</span>
<a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="nv">SMTP_HOST</span><span class="o">=</span>smtp.gmail.com
<a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a><span class="nv">SMTP_PORT</span><span class="o">=</span><span class="m">587</span>
<a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a><span class="nv">SMTP_USERNAME</span><span class="o">=</span>your_email@gmail.com
<a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a><span class="nv">SMTP_PASSWORD</span><span class="o">=</span>your_app_password
<a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a><span class="nv">ALERT_EMAIL_FROM</span><span class="o">=</span>alerts@yourcompany.com
<a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a><span class="nv">ALERT_EMAIL_TO</span><span class="o">=</span>recipient1@example.com,recipient2@example.com
<a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a>
<a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a><span class="c1"># SMS (Twilio)</span>
<a id="__codelineno-117-10" name="__codelineno-117-10" href="#__codelineno-117-10"></a><span class="nv">TWILIO_ACCOUNT_SID</span><span class="o">=</span>AC123...
<a id="__codelineno-117-11" name="__codelineno-117-11" href="#__codelineno-117-11"></a><span class="nv">TWILIO_AUTH_TOKEN</span><span class="o">=</span>token123...
<a id="__codelineno-117-12" name="__codelineno-117-12" href="#__codelineno-117-12"></a><span class="nv">TWILIO_FROM_NUMBER</span><span class="o">=</span>+15551234567
<a id="__codelineno-117-13" name="__codelineno-117-13" href="#__codelineno-117-13"></a><span class="nv">ALERT_PHONE_TO</span><span class="o">=</span>+15559876543,+15551112222
<a id="__codelineno-117-14" name="__codelineno-117-14" href="#__codelineno-117-14"></a>
<a id="__codelineno-117-15" name="__codelineno-117-15" href="#__codelineno-117-15"></a><span class="c1"># Webhooks</span>
<a id="__codelineno-117-16" name="__codelineno-117-16" href="#__codelineno-117-16"></a><span class="nv">ALERT_WEBHOOK_URLS</span><span class="o">=</span>https://hooks.slack.com/services/YOUR/WEBHOOK/URL
<a id="__codelineno-117-17" name="__codelineno-117-17" href="#__codelineno-117-17"></a><span class="nv">ALERT_WEBHOOK_HMAC_SECRET</span><span class="o">=</span>secret123<span class="w">  </span><span class="c1"># Optional HMAC signature</span>
<a id="__codelineno-117-18" name="__codelineno-117-18" href="#__codelineno-117-18"></a>
<a id="__codelineno-117-19" name="__codelineno-117-19" href="#__codelineno-117-19"></a><span class="c1"># Rate limiting</span>
<a id="__codelineno-117-20" name="__codelineno-117-20" href="#__codelineno-117-20"></a><span class="nv">ALERT_RATE_LIMIT</span><span class="o">=</span><span class="m">10</span><span class="w">  </span><span class="c1"># Max 10 alerts per breaker per hour</span>
</code></pre></div></p>
<p><strong>Usage:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="kn">from</span> <span class="nn">rustybt.live.alerts</span> <span class="kn">import</span> <span class="n">AlertConfig</span><span class="p">,</span> <span class="n">AlertManager</span>
<a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a>
<a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a><span class="c1"># Load from environment</span>
<a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">AlertConfig</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span>
<a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a>
<a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="n">manager</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">strategy_name</span><span class="o">=</span><span class="s2">&quot;MyStrategy&quot;</span><span class="p">)</span>
<a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a>
<a id="__codelineno-118-8" name="__codelineno-118-8" href="#__codelineno-118-8"></a><span class="c1"># Send alert</span>
<a id="__codelineno-118-9" name="__codelineno-118-9" href="#__codelineno-118-9"></a><span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span>
<a id="__codelineno-118-10" name="__codelineno-118-10" href="#__codelineno-118-10"></a>    <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;circuit_breaker_tripped&quot;</span><span class="p">,</span>
<a id="__codelineno-118-11" name="__codelineno-118-11" href="#__codelineno-118-11"></a>    <span class="n">circuit_breaker_type</span><span class="o">=</span><span class="s2">&quot;drawdown&quot;</span><span class="p">,</span>
<a id="__codelineno-118-12" name="__codelineno-118-12" href="#__codelineno-118-12"></a>    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Portfolio drawdown exceeded -10%&quot;</span><span class="p">,</span>
<a id="__codelineno-118-13" name="__codelineno-118-13" href="#__codelineno-118-13"></a>    <span class="n">details</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-118-14" name="__codelineno-118-14" href="#__codelineno-118-14"></a>        <span class="s2">&quot;current_value&quot;</span><span class="p">:</span> <span class="s2">&quot;89000.00&quot;</span><span class="p">,</span>
<a id="__codelineno-118-15" name="__codelineno-118-15" href="#__codelineno-118-15"></a>        <span class="s2">&quot;high_water_mark&quot;</span><span class="p">:</span> <span class="s2">&quot;100000.00&quot;</span><span class="p">,</span>
<a id="__codelineno-118-16" name="__codelineno-118-16" href="#__codelineno-118-16"></a>        <span class="s2">&quot;drawdown&quot;</span><span class="p">:</span> <span class="s2">&quot;-0.11&quot;</span>
<a id="__codelineno-118-17" name="__codelineno-118-17" href="#__codelineno-118-17"></a>    <span class="p">}</span>
<a id="__codelineno-118-18" name="__codelineno-118-18" href="#__codelineno-118-18"></a><span class="p">)</span>
</code></pre></div></p>
<h4 id="rate-limiting_1">Rate Limiting<a class="headerlink" href="#rate-limiting_1" title="Permanent link">&para;</a></h4>
<ul>
<li>Prevents alert spam</li>
<li>Configurable per-breaker limit (default: 10 alerts/hour)</li>
<li>Separate limits for each circuit breaker type</li>
</ul>
<h4 id="security">Security<a class="headerlink" href="#security" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>HMAC Signatures</strong>: Webhook endpoints can verify requests using HMAC SHA-256 signatures</li>
<li><strong>Bearer Tokens</strong>: Optional per-URL authentication tokens</li>
<li><strong>URL Validation</strong>: Webhook URLs must be valid HTTPS endpoints</li>
</ul>
<h3 id="monitoring-dashboard">Monitoring Dashboard<a class="headerlink" href="#monitoring-dashboard" title="Permanent link">&para;</a></h3>
<p>Optional Streamlit dashboard for real-time monitoring:</p>
<p><strong>Features:</strong>
- Live portfolio value and PnL
- Current positions with market values
- Circuit breaker status (NORMAL / TRIPPED / MANUALLY_HALTED)
- Recent orders and fills
- Error log with filtering
- Manual halt button with confirmation</p>
<p><strong>Running the Dashboard:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="c1"># Install Streamlit (optional)</span>
<a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a>pip<span class="w"> </span>install<span class="w"> </span>streamlit
<a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a>
<a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a><span class="c1"># Run dashboard</span>
<a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a>streamlit<span class="w"> </span>run<span class="w"> </span>rustybt/live/dashboard.py<span class="w"> </span>--<span class="w"> </span>--strategy-name<span class="w"> </span>MyStrategy
</code></pre></div></p>
<p><strong>Alternative: Grafana</strong></p>
<p>For production environments, we recommend Grafana with Prometheus metrics:</p>
<ol>
<li>Export metrics to Prometheus</li>
<li>Create Grafana dashboard</li>
<li>Set up alerts in Grafana</li>
<li>Monitor across multiple strategies/servers</li>
</ol>
<h3 id="integration-with-livetradingengine">Integration with LiveTradingEngine<a class="headerlink" href="#integration-with-livetradingengine" title="Permanent link">&para;</a></h3>
<p>Circuit breakers integrate with the <code>LiveTradingEngine</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="kn">from</span> <span class="nn">rustybt.live.engine</span> <span class="kn">import</span> <span class="n">LiveTradingEngine</span>
<a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="kn">from</span> <span class="nn">rustybt.live.circuit_breakers</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a>    <span class="n">CircuitBreakerManager</span><span class="p">,</span>
<a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a>    <span class="n">DrawdownCircuitBreaker</span><span class="p">,</span>
<a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a>    <span class="n">DailyLossCircuitBreaker</span><span class="p">,</span>
<a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a>    <span class="n">OrderRateCircuitBreaker</span><span class="p">,</span>
<a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a>    <span class="n">ErrorRateCircuitBreaker</span>
<a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a><span class="p">)</span>
<a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a><span class="kn">from</span> <span class="nn">rustybt.live.alerts</span> <span class="kn">import</span> <span class="n">AlertConfig</span><span class="p">,</span> <span class="n">AlertManager</span>
<a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a>
<a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a><span class="c1"># Create circuit breakers</span>
<a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a><span class="n">drawdown</span> <span class="o">=</span> <span class="n">DrawdownCircuitBreaker</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.10&quot;</span><span class="p">),</span> <span class="n">initial_portfolio_value</span><span class="p">)</span>
<a id="__codelineno-120-13" name="__codelineno-120-13" href="#__codelineno-120-13"></a><span class="n">daily_loss</span> <span class="o">=</span> <span class="n">DailyLossCircuitBreaker</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.05&quot;</span><span class="p">),</span> <span class="n">initial_portfolio_value</span><span class="p">)</span>
<a id="__codelineno-120-14" name="__codelineno-120-14" href="#__codelineno-120-14"></a><span class="n">order_rate</span> <span class="o">=</span> <span class="n">OrderRateCircuitBreaker</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<a id="__codelineno-120-15" name="__codelineno-120-15" href="#__codelineno-120-15"></a><span class="n">error_rate</span> <span class="o">=</span> <span class="n">ErrorRateCircuitBreaker</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<a id="__codelineno-120-16" name="__codelineno-120-16" href="#__codelineno-120-16"></a>
<a id="__codelineno-120-17" name="__codelineno-120-17" href="#__codelineno-120-17"></a><span class="c1"># Create manager</span>
<a id="__codelineno-120-18" name="__codelineno-120-18" href="#__codelineno-120-18"></a><span class="n">cb_manager</span> <span class="o">=</span> <span class="n">CircuitBreakerManager</span><span class="p">(</span>
<a id="__codelineno-120-19" name="__codelineno-120-19" href="#__codelineno-120-19"></a>    <span class="n">drawdown_breaker</span><span class="o">=</span><span class="n">drawdown</span><span class="p">,</span>
<a id="__codelineno-120-20" name="__codelineno-120-20" href="#__codelineno-120-20"></a>    <span class="n">daily_loss_breaker</span><span class="o">=</span><span class="n">daily_loss</span><span class="p">,</span>
<a id="__codelineno-120-21" name="__codelineno-120-21" href="#__codelineno-120-21"></a>    <span class="n">order_rate_breaker</span><span class="o">=</span><span class="n">order_rate</span><span class="p">,</span>
<a id="__codelineno-120-22" name="__codelineno-120-22" href="#__codelineno-120-22"></a>    <span class="n">error_rate_breaker</span><span class="o">=</span><span class="n">error_rate</span>
<a id="__codelineno-120-23" name="__codelineno-120-23" href="#__codelineno-120-23"></a><span class="p">)</span>
<a id="__codelineno-120-24" name="__codelineno-120-24" href="#__codelineno-120-24"></a>
<a id="__codelineno-120-25" name="__codelineno-120-25" href="#__codelineno-120-25"></a><span class="c1"># Create alert manager</span>
<a id="__codelineno-120-26" name="__codelineno-120-26" href="#__codelineno-120-26"></a><span class="n">alert_config</span> <span class="o">=</span> <span class="n">AlertConfig</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span>
<a id="__codelineno-120-27" name="__codelineno-120-27" href="#__codelineno-120-27"></a><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">(</span><span class="n">alert_config</span><span class="p">,</span> <span class="s2">&quot;MyStrategy&quot;</span><span class="p">)</span>
<a id="__codelineno-120-28" name="__codelineno-120-28" href="#__codelineno-120-28"></a>
<a id="__codelineno-120-29" name="__codelineno-120-29" href="#__codelineno-120-29"></a><span class="c1"># Register alert callback</span>
<a id="__codelineno-120-30" name="__codelineno-120-30" href="#__codelineno-120-30"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">send_alerts</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<a id="__codelineno-120-31" name="__codelineno-120-31" href="#__codelineno-120-31"></a>    <span class="k">await</span> <span class="n">alert_manager</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span>
<a id="__codelineno-120-32" name="__codelineno-120-32" href="#__codelineno-120-32"></a>        <span class="n">event_type</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">,</span>
<a id="__codelineno-120-33" name="__codelineno-120-33" href="#__codelineno-120-33"></a>        <span class="n">circuit_breaker_type</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">breaker_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-120-34" name="__codelineno-120-34" href="#__codelineno-120-34"></a>        <span class="n">reason</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
<a id="__codelineno-120-35" name="__codelineno-120-35" href="#__codelineno-120-35"></a>        <span class="n">details</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">details</span>
<a id="__codelineno-120-36" name="__codelineno-120-36" href="#__codelineno-120-36"></a>    <span class="p">)</span>
<a id="__codelineno-120-37" name="__codelineno-120-37" href="#__codelineno-120-37"></a>
<a id="__codelineno-120-38" name="__codelineno-120-38" href="#__codelineno-120-38"></a><span class="n">cb_manager</span><span class="o">.</span><span class="n">register_event_callback</span><span class="p">(</span><span class="n">send_alerts</span><span class="p">)</span>
<a id="__codelineno-120-39" name="__codelineno-120-39" href="#__codelineno-120-39"></a>
<a id="__codelineno-120-40" name="__codelineno-120-40" href="#__codelineno-120-40"></a><span class="c1"># Pass to engine (future integration)</span>
<a id="__codelineno-120-41" name="__codelineno-120-41" href="#__codelineno-120-41"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">LiveTradingEngine</span><span class="p">(</span>
<a id="__codelineno-120-42" name="__codelineno-120-42" href="#__codelineno-120-42"></a>    <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-120-43" name="__codelineno-120-43" href="#__codelineno-120-43"></a>    <span class="n">broker_adapter</span><span class="o">=</span><span class="n">broker</span><span class="p">,</span>
<a id="__codelineno-120-44" name="__codelineno-120-44" href="#__codelineno-120-44"></a>    <span class="n">data_portal</span><span class="o">=</span><span class="n">portal</span><span class="p">,</span>
<a id="__codelineno-120-45" name="__codelineno-120-45" href="#__codelineno-120-45"></a>    <span class="n">circuit_breaker_manager</span><span class="o">=</span><span class="n">cb_manager</span>  <span class="c1"># Future parameter</span>
<a id="__codelineno-120-46" name="__codelineno-120-46" href="#__codelineno-120-46"></a><span class="p">)</span>
<a id="__codelineno-120-47" name="__codelineno-120-47" href="#__codelineno-120-47"></a>
<a id="__codelineno-120-48" name="__codelineno-120-48" href="#__codelineno-120-48"></a><span class="c1"># Engine will check circuit breakers:</span>
<a id="__codelineno-120-49" name="__codelineno-120-49" href="#__codelineno-120-49"></a><span class="c1"># - Before submitting orders (order rate)</span>
<a id="__codelineno-120-50" name="__codelineno-120-50" href="#__codelineno-120-50"></a><span class="c1"># - After order fills (drawdown, daily loss)</span>
<a id="__codelineno-120-51" name="__codelineno-120-51" href="#__codelineno-120-51"></a><span class="c1"># - After errors (error rate)</span>
<a id="__codelineno-120-52" name="__codelineno-120-52" href="#__codelineno-120-52"></a><span class="c1"># - Block orders when tripped</span>
</code></pre></div>
<h3 id="risk-profile-examples">Risk Profile Examples<a class="headerlink" href="#risk-profile-examples" title="Permanent link">&para;</a></h3>
<h4 id="conservative-low-risk-tolerance">Conservative (Low Risk Tolerance)<a class="headerlink" href="#conservative-low-risk-tolerance" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="n">circuit_breakers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a>    <span class="s2">&quot;drawdown&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.05&quot;</span><span class="p">)},</span>  <span class="c1"># -5% drawdown</span>
<a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a>    <span class="s2">&quot;daily_loss&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.02&quot;</span><span class="p">)},</span>    <span class="c1"># -2% daily loss</span>
<a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>    <span class="s2">&quot;order_rate&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_orders&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
<a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a>    <span class="s2">&quot;error_rate&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_errors&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}</span>
<a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a><span class="p">}</span>
</code></pre></div>
<h4 id="moderate-balanced-risk">Moderate (Balanced Risk)<a class="headerlink" href="#moderate-balanced-risk" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="n">circuit_breakers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a>    <span class="s2">&quot;drawdown&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.10&quot;</span><span class="p">)},</span>  <span class="c1"># -10% drawdown</span>
<a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>    <span class="s2">&quot;daily_loss&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.05&quot;</span><span class="p">)},</span>    <span class="c1"># -5% daily loss</span>
<a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a>    <span class="s2">&quot;order_rate&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_orders&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
<a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a>    <span class="s2">&quot;error_rate&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_errors&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}</span>
<a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a><span class="p">}</span>
</code></pre></div>
<h4 id="aggressive-high-risk-tolerance">Aggressive (High Risk Tolerance)<a class="headerlink" href="#aggressive-high-risk-tolerance" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="n">circuit_breakers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a>    <span class="s2">&quot;drawdown&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.20&quot;</span><span class="p">)},</span>  <span class="c1"># -20% drawdown</span>
<a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a>    <span class="s2">&quot;daily_loss&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-0.10&quot;</span><span class="p">)},</span>    <span class="c1"># -10% daily loss</span>
<a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a>    <span class="s2">&quot;order_rate&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_orders&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
<a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a>    <span class="s2">&quot;error_rate&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_errors&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}</span>
<a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a><span class="p">}</span>
</code></pre></div>
<h3 id="best-practices">Best Practices<a class="headerlink" href="#best-practices" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Always Use Circuit Breakers in Production</strong></li>
<li>Never run live trading without circuit breakers</li>
<li>Configure thresholds based on risk tolerance</li>
<li>
<p>Test breakers in paper trading first</p>
</li>
<li>
<p><strong>Set Up Multiple Alert Channels</strong></p>
</li>
<li>Email for detailed logs</li>
<li>SMS for urgent notifications</li>
<li>
<p>Webhook for team chat integration</p>
</li>
<li>
<p><strong>Monitor Circuit Breaker Status</strong></p>
</li>
<li>Use dashboard or Grafana for real-time visibility</li>
<li>Log all trips for post-mortem analysis</li>
<li>
<p>Track false positives and adjust thresholds</p>
</li>
<li>
<p><strong>Document Manual Interventions</strong></p>
</li>
<li>Always provide reason when manually halting</li>
<li>Include operator name for audit trail</li>
<li>
<p>Review manual halts in retrospectives</p>
</li>
<li>
<p><strong>Test Circuit Breakers Regularly</strong></p>
</li>
<li>Verify breakers trip at correct thresholds</li>
<li>Test alert delivery end-to-end</li>
<li>
<p>Practice manual halt procedures</p>
</li>
<li>
<p><strong>Gradual Reset After Trip</strong></p>
</li>
<li>Investigate root cause before resetting</li>
<li>Consider reducing position size after reset</li>
<li>Monitor closely after resuming trading</li>
</ol>
<h3 id="troubleshooting_2">Troubleshooting<a class="headerlink" href="#troubleshooting_2" title="Permanent link">&para;</a></h3>
<h4 id="circuit-breaker-not-tripping">Circuit Breaker Not Tripping<a class="headerlink" href="#circuit-breaker-not-tripping" title="Permanent link">&para;</a></h4>
<ul>
<li>Check threshold configuration (negative values for losses)</li>
<li>Verify portfolio value calculation is correct</li>
<li>Check if breaker was accidentally reset</li>
</ul>
<h4 id="false-positive-trips">False Positive Trips<a class="headerlink" href="#false-positive-trips" title="Permanent link">&para;</a></h4>
<ul>
<li>Review threshold settings (too conservative?)</li>
<li>Check for data quality issues causing spikes</li>
<li>Consider increasing thresholds for volatile markets</li>
</ul>
<h4 id="alerts-not-delivered">Alerts Not Delivered<a class="headerlink" href="#alerts-not-delivered" title="Permanent link">&para;</a></h4>
<ul>
<li>Verify SMTP/Twilio credentials</li>
<li>Check rate limiting (may be dropping alerts)</li>
<li>Verify webhook URL accessibility</li>
<li>Check email spam folders</li>
</ul>
<h4 id="manual-halt-not-working">Manual Halt Not Working<a class="headerlink" href="#manual-halt-not-working" title="Permanent link">&para;</a></h4>
<ul>
<li>Ensure manual circuit breaker is configured</li>
<li>Check if state transition is logged</li>
<li>Verify engine respects circuit breaker state</li>
</ul>
<hr />












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jerryinyang/rustybt" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/rustybt/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "navigation.footer", "toc.follow", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>