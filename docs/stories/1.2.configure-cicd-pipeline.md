# Story 1.2: Configure CI/CD Pipeline

## Status
Draft

## Story
**As a** developer,
**I want** automated CI/CD pipeline with testing, linting, coverage tracking, and type checking,
**so that** code quality is enforced automatically and regressions are caught early.

## Acceptance Criteria
1. GitHub Actions workflow created for pull request validation
2. Automated test suite execution on every commit (pytest with parallel execution)
3. Code coverage tracking configured (Coverage.py) with ≥90% threshold enforcement
4. Type checking integrated (mypy --strict mode) with failures blocking merge
5. Linting configured (ruff or pylint) with consistent code style enforcement
6. Coverage reports uploaded to Codecov or similar service for visualization
7. Build status badge added to README showing CI/CD status
8. Workflow runs successfully on Linux, macOS, and Windows environments

## Tasks / Subtasks
- [ ] Create GitHub Actions workflow file (AC: 1)
  - [ ] Create `.github/workflows/` directory
  - [ ] Create `ci.yml` workflow file
  - [ ] Define workflow triggers: `on: [push, pull_request]`
  - [ ] Set up job matrix for multiple OS and Python versions
  - [ ] Configure checkout action

- [ ] Configure automated test execution (AC: 2)
  - [ ] Add job step to install dependencies
  - [ ] Add pytest execution step with coverage: `pytest -v --cov=rustybt --cov-report=xml --cov-report=term`
  - [ ] Enable parallel test execution with pytest-xdist: `pytest -n auto`
  - [ ] Configure test result reporting
  - [ ] Set up test failure notifications

- [ ] Implement coverage tracking and enforcement (AC: 3, 6)
  - [ ] Configure Coverage.py in pyproject.toml with ≥90% threshold
  - [ ] Add coverage report generation step
  - [ ] Integrate Codecov upload action
  - [ ] Set up Codecov account and repository
  - [ ] Configure coverage status checks in GitHub branch protection
  - [ ] Add coverage report artifact upload for failed builds

- [ ] Integrate type checking (AC: 4)
  - [ ] Add mypy configuration to pyproject.toml with --strict mode
  - [ ] Add mypy execution step in workflow: `mypy --strict rustybt`
  - [ ] Configure mypy to check all Python files in rustybt package
  - [ ] Set job to fail if mypy finds type errors
  - [ ] Add mypy cache to GitHub Actions cache for faster runs

- [ ] Configure linting and formatting (AC: 5)
  - [ ] Add ruff configuration to pyproject.toml (line length: 100, target: py312)
  - [ ] Add black configuration to pyproject.toml (line length: 100)
  - [ ] Add ruff linting step: `ruff check rustybt`
  - [ ] Add black format check step: `black --check rustybt`
  - [ ] Configure linting rules based on coding standards

- [ ] Set up multi-platform testing (AC: 8)
  - [ ] Configure matrix strategy for OS: [ubuntu-latest, macos-latest, windows-latest]
  - [ ] Configure matrix strategy for Python: ['3.12', '3.13']
  - [ ] Test workflow on all platform combinations
  - [ ] Document any platform-specific issues or exclusions
  - [ ] Verify test suite passes on all platforms

- [ ] Add CI/CD status badge to README (AC: 7)
  - [ ] Generate GitHub Actions badge URL
  - [ ] Add badge markdown to README.md: `![CI](https://github.com/{org}/{repo}/workflows/CI/badge.svg)`
  - [ ] Add Codecov badge to README.md
  - [ ] Verify badges display correctly
  - [ ] Commit README.md changes

- [ ] Configure branch protection rules
  - [ ] Enable required status checks for main branch
  - [ ] Require CI workflow to pass before merge
  - [ ] Require coverage threshold to be met
  - [ ] Require at least 1 approval for PRs
  - [ ] Enforce linear history (optional)

## Dev Notes

### Testing Standards
[Source: architecture/testing-strategy.md]

**CI Pipeline Requirements:**
```yaml
name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.12', '3.13']

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"

      - name: Run tests
        run: |
          pytest -v --cov=rustybt --cov-report=xml --cov-report=term

      - name: Type check
        run: |
          mypy --strict rustybt

      - name: Lint
        run: |
          ruff check rustybt

      - name: Format check
        run: |
          black --check rustybt

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
```

**Coverage Enforcement:**
- Fail PR if coverage drops below 90%
- Require 95%+ coverage for financial modules
- Coverage reports uploaded to Codecov
- Coverage badge displayed in README

**Test Execution:**
- Run tests with pytest: `pytest -v --cov=rustybt --cov-report=xml --cov-report=term`
- Parallel execution: `pytest -n auto` (uses pytest-xdist)
- Test timeout: 15 minutes maximum per job

### Coding Standards
[Source: architecture/coding-standards.md]

**Code Quality Tools Configuration:**

**black (pyproject.toml):**
```toml
[tool.black]
line-length = 100
target-version = ['py312']
```

**ruff (pyproject.toml):**
```toml
[tool.ruff]
line-length = 100
target-version = "py312"
select = ["E", "F", "W", "I", "N", "UP", "ANN", "B", "A", "C4", "DTZ", "T20", "SIM"]

[tool.ruff.lint.mccabe]
max-complexity = 10
```

**mypy (pyproject.toml):**
```toml
[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_incomplete_defs = true
check_untyped_defs = true
disallow_untyped_decorators = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
strict_equality = true
strict = true
```

**Coverage.py (pyproject.toml):**
```toml
[tool.coverage.run]
source = ["rustybt"]
omit = ["*/tests/*", "*/testing/*"]

[tool.coverage.report]
fail_under = 90
show_missing = true
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
]
```

**pytest (pyproject.toml):**
```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = "-v --strict-markers --cov=rustybt --cov-report=term-missing"
markers = [
    "slow: marks tests as slow",
    "integration: marks tests as integration tests",
    "benchmark: marks tests as benchmark tests",
]
```

### Zero-Mock Enforcement
[Source: architecture/coding-standards.md#zero-mock-enforcement-mandatory]

**Pre-Commit Checklist (CI/CD Enforcement):**
- No TODO/FIXME/HACK comments without issue tracking
- No hardcoded return values
- No empty except blocks or pass statements in production code
- No "mock", "fake", "stub", "dummy" in variable/function names (except in tests)
- All tests exercise real functionality

**Automated Enforcement in CI/CD:**
Add additional quality-enforcement job to workflow:
```yaml
jobs:
  zero-mock-enforcement:
    runs-on: ubuntu-latest
    steps:
      - name: Detect mock patterns (BLOCKING)
        run: |
          python scripts/detect_mocks.py --strict

      - name: Validate hardcoded values (BLOCKING)
        run: |
          python scripts/detect_hardcoded_values.py --fail-on-found

      - name: Check validation functions (BLOCKING)
        run: |
          python scripts/verify_validations.py --ensure-real-checks
```

Note: Scripts for zero-mock enforcement (detect_mocks.py, detect_hardcoded_values.py, verify_validations.py) will be implemented in later stories. For Story 1.2, create placeholder scripts or skip these checks until scripts are available.

### GitHub Actions Best Practices
[Source: architecture/testing-strategy.md]

**Caching:**
- Cache pip dependencies to speed up builds
- Cache mypy cache for faster type checking
- Example cache configuration:
```yaml
- name: Cache pip
  uses: actions/cache@v3
  with:
    path: ~/.cache/pip
    key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
    restore-keys: |
      ${{ runner.os }}-pip-
```

**Performance Optimization:**
- Use pytest-xdist for parallel test execution
- Run linting and type checking in parallel with tests
- Use matrix strategy to parallelize platform testing

**Security:**
- Use Codecov token stored in GitHub Secrets
- Limit workflow permissions to minimum required
- Use pinned versions for GitHub Actions

### Branch Protection Configuration
[Source: architecture/coding-standards.md#code-quality-guardrails-mandatory]

**Required Settings:**
- Require status checks to pass before merging
- Require CI workflow success
- Require coverage threshold (≥90%)
- Require at least 1 PR approval
- Dismiss stale PR approvals on new commits
- Require linear history (recommended)

**Status Checks:**
- test (all matrix combinations)
- type-check
- lint
- format-check
- coverage

### Codecov Integration
[Source: architecture/testing-strategy.md]

**Setup Steps:**
1. Create Codecov account (https://codecov.io)
2. Link GitHub repository
3. Generate Codecov token
4. Add token to GitHub repository secrets: `CODECOV_TOKEN`
5. Configure coverage upload in workflow
6. Add Codecov badge to README: `[![codecov](https://codecov.io/gh/{org}/{repo}/branch/main/graph/badge.svg)](https://codecov.io/gh/{org}/{repo})`

**Coverage Thresholds:**
- Overall project: ≥90%
- Financial modules (rustybt/finance/): ≥95%
- New components: ≥90%

### Badge Examples
[Source: architecture/coding-standards.md]

**CI Status Badge:**
```markdown
![CI](https://github.com/{org}/{repo}/workflows/CI/badge.svg)
```

**Codecov Badge:**
```markdown
[![codecov](https://codecov.io/gh/{org}/{repo}/branch/main/graph/badge.svg)](https://codecov.io/gh/{org}/{repo})
```

**Python Version Badge:**
```markdown
![Python](https://img.shields.io/badge/python-3.12%2B-blue)
```

### Testing

**Test File Location:**
- CI/CD workflow: `.github/workflows/ci.yml`
- pyproject.toml: Project root
- Test workflow by creating PR and verifying all checks pass

**Test Standards:**
- Workflow must complete successfully on all platforms
- All quality checks must pass (tests, coverage, mypy, ruff, black)
- Coverage must meet ≥90% threshold
- Type checking must pass in --strict mode

**Testing Frameworks:**
- GitHub Actions for CI/CD orchestration
- pytest for test execution
- Coverage.py for coverage tracking
- mypy for type checking
- ruff for linting
- black for formatting

**Manual Verification:**
1. Create test branch
2. Make trivial change and push
3. Verify workflow triggers automatically
4. Check all jobs complete successfully
5. Verify coverage report uploads to Codecov
6. Verify badges display correctly in README
7. Test PR creation and status checks

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
