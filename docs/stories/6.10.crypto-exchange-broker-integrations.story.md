# Story 6.10: Implement Binance, Bybit, Hyperliquid, and CCXT Broker Integrations

## Status
Draft

## Story
**As a** quantitative trader,
**I want** integrations for Binance, Bybit, Hyperliquid, and CCXT-supported exchanges,
**so that** I have broad exchange coverage for crypto strategies.

## Acceptance Criteria
1. BinanceBrokerAdapter implements BrokerAdapter (using binance-connector 3.12+ OR custom API)
2. BybitBrokerAdapter implements BrokerAdapter (using pybit OR custom API)
3. HyperliquidBrokerAdapter implements BrokerAdapter (using hyperliquid-python-sdk OR custom)
4. CCXTBrokerAdapter implements BrokerAdapter (using CCXT unified API for 100+ exchanges)
5. All adapters support order submission, position queries, balance queries
6. All adapters handle exchange-specific order types and constraints
7. WebSocket integration for real-time data where available
8. Error handling for exchange-specific issues (maintenance, delisted pairs, rate limits)
9. Rate limiting per exchange (respect individual exchange limits)
10. Integration tests with testnet/demo accounts for each exchange

## Tasks / Subtasks
- [ ] Implement BinanceBrokerAdapter (AC: 1)
  - [ ] Create BinanceBrokerAdapter in rustybt/live/brokers/binance_adapter.py
  - [ ] Use binance-connector 3.12+ library (evaluate vs custom implementation)
  - [ ] Implement connect() with API key and secret authentication
  - [ ] Implement submit_order() for spot and futures markets
  - [ ] Support order types: Market, Limit, Stop-Loss, Stop-Loss-Limit, Take-Profit, Take-Profit-Limit, OCO, Iceberg
  - [ ] Implement get_positions() for futures positions (spot has no positions, only balances)
  - [ ] Implement get_account_info() for balances and buying power
  - [ ] Configure rate limits: REST API 1200 req/min (weight-based), order placement 100 orders/10s per symbol
  - [ ] Handle Binance error codes (-1021 timestamp, -1022 signature, -2010 insufficient balance, -2011 order would trigger)
  - [ ] Support testnet mode (https://testnet.binance.vision)
- [ ] Implement BybitBrokerAdapter (AC: 2)
  - [ ] Create BybitBrokerAdapter in rustybt/live/brokers/bybit_adapter.py
  - [ ] Use pybit library (official SDK)
  - [ ] Implement connect() with API key and secret authentication
  - [ ] Implement submit_order() for spot and derivatives markets
  - [ ] Support order types: Market, Limit, Conditional (stop/take-profit), Post-Only, Reduce-Only
  - [ ] Implement get_positions() for derivatives positions
  - [ ] Implement get_account_info() for balances and wallet info
  - [ ] Configure rate limits: REST API 120 req/min, WebSocket 10 msg/sec, order placement 100 orders/sec per symbol
  - [ ] Handle Bybit error codes (authentication, rate limit, invalid parameters)
  - [ ] Support testnet mode (https://api-testnet.bybit.com)
- [ ] Implement HyperliquidBrokerAdapter (AC: 3)
  - [ ] Create HyperliquidBrokerAdapter in rustybt/live/brokers/hyperliquid_adapter.py
  - [ ] Use hyperliquid-python-sdk (official SDK)
  - [ ] Implement connect() with Ethereum private key authentication
  - [ ] Implement Hyperliquid private key security
    - [ ] Store private key encrypted (use python cryptography library)
    - [ ] Load from secure keystore (environment variable or encrypted config file)
    - [ ] Never log private key in plaintext
    - [ ] Implement key rotation support
    - [ ] Document secure key management in README
  - [ ] Implement submit_order() for perpetual futures only (no spot market)
  - [ ] Support order types: Market, Limit, Stop-Market, Stop-Limit, Post-Only, Reduce-Only
  - [ ] Implement get_positions() for perpetual positions
  - [ ] Implement get_account_info() for account balance and leverage
  - [ ] Configure rate limits: REST API 600 req/min, order placement 20 orders/sec
  - [ ] Handle Hyperliquid-specific errors (on-chain settlement errors, insufficient margin)
  - [ ] Support mainnet (Arbitrum L1) and testnet if available
- [ ] Implement CCXTBrokerAdapter for unified multi-exchange support (AC: 4)
  - [ ] Create CCXTBrokerAdapter in rustybt/live/brokers/ccxt_adapter.py
  - [ ] Use CCXT 4.x+ library with unified API
  - [ ] Implement connect() with exchange_id parameter (e.g., 'binance', 'coinbase', 'kraken')
  - [ ] Implement submit_order() using ccxt.create_order() unified method
  - [ ] Support unified order types: Market, Limit (exchange-specific types via params)
  - [ ] Implement get_positions() using ccxt.fetch_positions() (where supported)
  - [ ] Implement get_account_info() using ccxt.fetch_balance()
  - [ ] Configure rate limiting using enableRateLimit: true (automatic per exchange)
  - [ ] Handle CCXT error types (NetworkError, ExchangeError, InsufficientFunds, InvalidOrder)
  - [ ] Support 100+ exchanges via unified interface
  **CCXT Exchange Support Caveat:** While CCXT supports 100+ exchanges, many have incomplete implementations or limited testing. For production use, focus on well-supported exchanges (Binance, Coinbase, Kraken, Bybit, OKX). Document tested exchange list in README and add warning for untested exchanges.
- [ ] Implement order submission and management (AC: 5)
  - [ ] Standardize order submission across all adapters
  - [ ] Convert RustyBT Decimal amounts to exchange float/string formats
  - [ ] Handle exchange-specific order constraints (min order size, tick size, lot size)
  - [ ] Implement cancel_order() for all adapters
  - [ ] Track order status updates (submitted → pending → filled/canceled/rejected)
  - [ ] Generate OrderFillEvent on fills with exchange-specific commission structure
  - [ ] Generate OrderRejectEvent on rejections with exchange error codes
- [ ] Handle exchange-specific order types and constraints (AC: 6)
  - [ ] Document supported order types per exchange in adapter docstrings
  - [ ] Implement exchange-specific order params (Binance: icebergQty, Bybit: reduceOnly, Hyperliquid: postOnly)
  - [ ] Validate order params before submission (fail fast with clear error)
  - [ ] Handle exchange min/max order sizes (query from exchange info API)
  - [ ] Handle exchange price/quantity precision (round to exchange tick/lot size)
  - [ ] Log exchange constraints and validation results
- [ ] Integrate WebSocket streaming for real-time data (AC: 7)
  - [ ] Binance: Use Binance WebSocket from Story 6.6 for real-time market data
  - [ ] Bybit: Implement Bybit WebSocket for kline and trade streams
  - [ ] Hyperliquid: Implement Hyperliquid WebSocket for real-time updates
  - [ ] CCXT: Use exchange-specific WebSocket where available (e.g., via ccxt.pro)
  - [ ] Subscribe to market data on connect()
  - [ ] Dispatch market data as MarketDataEvent to engine
  - [ ] Handle WebSocket disconnections and auto-reconnect
  **WebSocket Integration Architecture:** Each exchange adapter integrates with corresponding WebSocket adapter from Story 6.6 (BinanceWebSocketAdapter, etc.). BrokerAdapter.subscribe_market_data() registers symbols with WebSocket adapter. Market data flows: WebSocket → BarBuffer → MarketDataEvent → Engine event queue.
- [ ] Implement exchange-specific error handling (AC: 8)
  - [ ] Handle maintenance mode (exchange down for maintenance) → pause trading, log alert
  - [ ] Handle delisted trading pairs (symbol not found) → reject order, log warning
  - [ ] Handle rate limits with backoff (429 errors or exchange-specific codes)
  - [ ] Handle insufficient funds (specific error codes per exchange)
  - [ ] Handle invalid order params (price out of range, size too small)
  - [ ] Map exchange error codes to RustyBT error types (BrokerError subclasses)
  - [ ] Log all errors with exchange context (exchange_id, symbol, error_code, message)
- [ ] Implement rate limiting per exchange (AC: 9)
  - [ ] Binance: Weight-based rate limiting (track weights per request)
  - [ ] Bybit: Request count rate limiting (120 req/min)
  - [ ] Hyperliquid: Request count rate limiting (600 req/min)
  - [ ] CCXT: Use built-in enableRateLimit for automatic throttling
  - [ ] Implement adaptive rate limiting (slow down on 429 errors)
  - [ ] Log rate limit warnings (e.g., "80% of quota used")
  - [ ] Support configurable rate limits (override defaults for paid tiers)
- [ ] Implement integration tests with testnet accounts (AC: 10)
  - [ ] Test Binance adapter with Binance testnet (https://testnet.binance.vision)
  - [ ] Test Bybit adapter with Bybit testnet (https://api-testnet.bybit.com)
  - [ ] Test Hyperliquid adapter with testnet if available (or mainnet with small amounts)
  - [ ] Test CCXT adapter with multiple exchanges (Binance, Coinbase, Kraken)
  - [ ] Mark tests as integration with @pytest.mark.exchange_integration
  - [ ] Document testnet API key setup in tests/README.md
  - [ ] Verify order submission, fills, position queries, balance queries
  - [ ] Test error handling for various exchange error scenarios
- [ ] Create exchange integration documentation
  - [ ] Document each exchange adapter in docs/architecture/live-trading.md
  - [ ] Provide setup guide for testnet/demo accounts
  - [ ] Document supported order types and constraints per exchange
  - [ ] Document rate limits and tier differences
  - [ ] Add troubleshooting guide for common exchange errors
  - [ ] Provide configuration examples for each exchange

## Dev Notes

### Previous Story Insights
[From Story 6.1: Design Live Trading Engine Architecture]
- Broker adapter pattern for multiple exchanges
- Standardized async interface (submit_order, get_positions, get_account_info)
- Error handling with retry logic and rate limiting

[From Story 6.8: Implement WebSocket Data Adapter Foundation]
- WebSocket streaming for real-time market data
- Binance WebSocket adapter already implemented
- Connection management and auto-reconnect

### Architecture Context

**Broker Integration Design:**
[Source: architecture/external-api-integration.md#broker-api-integration]
- Binance (binance-connector): Spot and futures, 1200 req/min, 100 orders/10s per symbol
- Bybit (pybit): Spot and derivatives, 120 req/min, 100 orders/sec per symbol
- Hyperliquid (hyperliquid-python-sdk): Perpetual futures, 600 req/min, 20 orders/sec
- CCXT: 100+ exchanges with unified API, automatic rate limiting

**BrokerAdapter Interface:**
[Source: architecture/component-architecture.md#brokeradapter-abstract-base]
- Required methods: connect(), submit_order(), cancel_order(), get_positions(), get_account_info(), subscribe_market_data(), get_next_event()
- Async interface using asyncio
- Standardized return types (positions, account_info, events)

**Tech Stack:**
[Source: architecture/tech-stack.md#new-technology-additions]
- binance-connector 3.x+ for Binance native SDK
- pybit 5.x+ for Bybit native SDK
- hyperliquid-python-sdk for Hyperliquid DEX
- ccxt 4.x+ for unified multi-exchange API
- Python Decimal for all financial values

**Coding Standards:**
[Source: architecture/coding-standards.md]
- Type hints: mypy --strict compliance
- Async/await for all broker operations
- Structured logging for order events and errors
- Error handling: BrokerError, OrderRejectedError, RateLimitError

### File Locations
[Source: architecture/source-tree.md]
- Binance adapter: `rustybt/live/brokers/binance_adapter.py`
- Bybit adapter: `rustybt/live/brokers/bybit_adapter.py`
- Hyperliquid adapter: `rustybt/live/brokers/hyperliquid_adapter.py`
- CCXT adapter: `rustybt/live/brokers/ccxt_adapter.py`
- Tests: `tests/live/brokers/test_binance_adapter.py`, `test_bybit_adapter.py`, `test_hyperliquid_adapter.py`, `test_ccxt_adapter.py`
- Integration tests: `tests/integration/live/test_exchange_integrations.py`
- Documentation: `docs/architecture/live-trading.md` (add exchange integrations section)

### Integration Points
- BrokerAdapter: Implements abstract interface
- WebSocketAdapter: Used for real-time market data (from Story 6.8)
- LiveTradingEngine: Uses exchange adapters for live trading
- OrderManager: Receives order status updates
- EventQueue: Receives OrderFillEvent and MarketDataEvent

### Exchange-Specific Order Types

**Binance:**
- Market, Limit, Stop-Loss, Stop-Loss-Limit, Take-Profit, Take-Profit-Limit
- OCO (One-Cancels-Other), Iceberg (partial quantity display)

**Bybit:**
- Market, Limit, Conditional (stop/take-profit)
- Post-Only (maker-only), Reduce-Only (close positions)

**Hyperliquid:**
- Market, Limit, Stop-Market, Stop-Limit
- Post-Only (maker-only), Reduce-Only (close positions)

**CCXT Unified:**
- Market, Limit (all exchanges)
- Stop, Stop-Limit (where supported, exchange-specific params)

### Testing
[Source: architecture/testing-strategy.md]

**Test Location:**
- Unit tests: `tests/live/brokers/test_*_adapter.py` (mock exchange APIs)
- Integration tests: `tests/integration/live/test_exchange_integrations.py` (real testnet calls)

**Testing Standards:**
- Unit tests: ≥90% coverage (mock HTTP and WebSocket responses)
- Integration tests: Require testnet API keys (skip if not configured)
- Mark integration tests: @pytest.mark.exchange_integration
- Test order lifecycle, position queries, error handling

**Key Test Scenarios:**
- Connection succeeds with valid API keys
- Order submission returns broker_order_id
- Order fills generate OrderFillEvent
- Order rejections generate OrderRejectEvent
- Position query returns correct positions
- Account info query returns balances
- Rate limiting throttles requests appropriately
- Error handling for maintenance mode, delisted pairs, rate limits
- WebSocket receives real-time market data

**Test Fixtures:**
- Mock exchange API responses for each adapter
- Testnet API keys (document setup in tests/README.md)
- Sample orders for various order types
- Sample positions and balances

**Testnet Setup:**
- Binance: Register at https://testnet.binance.vision
- Bybit: Register at https://testnet.bybit.com
- Hyperliquid: Check documentation for testnet availability
- CCXT: Use exchange-specific testnet credentials

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
Not yet implemented

### Completion Notes List
Not yet implemented

### File List
Not yet implemented

## QA Results
Not yet implemented
