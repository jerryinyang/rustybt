# Story 6.11: Implement Circuit Breakers and Monitoring

## Status
Draft

## Story
**As a** quantitative trader,
**I want** circuit breakers and comprehensive monitoring for live trading,
**so that** I can prevent catastrophic losses and detect issues before they escalate.

## Acceptance Criteria
1. DrawdownCircuitBreaker halts trading if portfolio drawdown exceeds threshold (e.g., -10%)
2. DailyLossCircuitBreaker halts trading if daily loss exceeds limit
3. OrderRateCircuitBreaker prevents runaway order submission (e.g., max 100 orders/minute)
4. ErrorRateCircuitBreaker halts on repeated errors (e.g., 10 order rejections in 1 minute)
5. Manual circuit breaker (emergency stop button or API endpoint)
6. Circuit breaker state tracked (NORMAL, TRIPPED, MANUALLY_HALTED)
7. Alert system (email, SMS, webhook) when circuit breaker trips
8. Monitoring dashboard (optional Streamlit/Grafana) shows live positions, PnL, circuit breaker status
9. Tests validate circuit breakers trip correctly under adverse conditions
10. Documentation explains circuit breaker configuration and best practices for risk management

## Tasks / Subtasks
- [ ] Implement DrawdownCircuitBreaker (AC: 1)
  - [ ] Create DrawdownCircuitBreaker class in rustybt/live/circuit_breakers.py
  - [ ] Track high-water mark (highest portfolio value)
  - [ ] Calculate current drawdown: (current_value - high_water_mark) / high_water_mark
  - [ ] Trip if drawdown exceeds threshold (configurable, default: -10%)
  - [ ] Emit CircuitBreakerTrippedEvent when threshold exceeded
  - [ ] Halt all new order submissions (cancel pending orders, reject new orders)
  - [ ] Log drawdown breaker trip with portfolio value and drawdown percentage
- [ ] Implement DailyLossCircuitBreaker (AC: 2)
  - [ ] Create DailyLossCircuitBreaker class in rustybt/live/circuit_breakers.py
  - [ ] Track starting portfolio value at market open (reset daily)
  - [ ] Calculate daily loss: (current_value - starting_value)
  - [ ] Trip if daily loss exceeds limit (configurable, e.g., -$5000 or -5%)
  - [ ] Emit CircuitBreakerTrippedEvent when limit exceeded
  - [ ] Reset daily loss counter at market open (use Scheduler from Story 6.5)
  - [ ] Log daily loss breaker trip with loss amount and percentage
- [ ] Implement OrderRateCircuitBreaker (AC: 3)
  - [ ] Create OrderRateCircuitBreaker class in rustybt/live/circuit_breakers.py
  - [ ] Track order submission timestamps in sliding window (e.g., last 1 minute)
  - [ ] Count orders in window, trip if exceeds limit (configurable, default: 100 orders/minute)
  - [ ] Emit CircuitBreakerTrippedEvent when limit exceeded
  - [ ] Block new order submissions until window clears
  - [ ] Log order rate breaker trip with order count and time window
- [ ] Implement ErrorRateCircuitBreaker (AC: 4)
  - [ ] Create ErrorRateCircuitBreaker class in rustybt/live/circuit_breakers.py
  - [ ] Track order rejections and errors in sliding window (e.g., last 1 minute)
  - [ ] Count errors in window, trip if exceeds limit (configurable, default: 10 errors/minute)
  - [ ] Distinguish error types (order rejections, broker errors, data errors)
  - [ ] Emit CircuitBreakerTrippedEvent when limit exceeded
  - [ ] Halt trading and require manual intervention
  - [ ] Log error rate breaker trip with error count and types
- [ ] Implement manual circuit breaker (AC: 5)
  - [ ] Create ManualCircuitBreaker class with trip() and reset() methods
  - [ ] Provide CLI command for emergency stop: rustybt live stop --strategy <name>
  - [ ] Provide API endpoint for emergency stop (if REST API available from Epic 9)
  - [ ] Immediately halt all trading activity (cancel orders, stop strategy execution)
  - [ ] Emit ManualHaltEvent with reason and operator
  - [ ] Log manual halt with timestamp and operator context
  - [ ] Require explicit manual reset to resume trading
- [ ] Implement circuit breaker state management (AC: 6)
  - [ ] Define CircuitBreakerState enum (NORMAL, TRIPPED, MANUALLY_HALTED, RESETTING)
  - [ ] Track global circuit breaker state in LiveTradingEngine
  - [ ] Implement state transitions: NORMAL → TRIPPED → RESETTING → NORMAL
  - [ ] Prevent order submission when state is TRIPPED or MANUALLY_HALTED
  - [ ] Implement reset_circuit_breaker() method (requires manual confirmation)
  - [ ] Log all state transitions with context
  - [ ] Persist circuit breaker state in checkpoint (resume after restart)
- [ ] Implement alert system for circuit breaker trips (AC: 7)
  - [ ] Create AlertManager class in rustybt/live/alerts.py
  - [ ] Implement email alerts using SMTP (configurable SMTP server)
  - [ ] Implement SMS alerts using Twilio API (optional, requires API key)
  - [ ] Implement webhook alerts (POST to configured URL with alert payload)
  - [ ] Define alert payload: {event_type, strategy_name, circuit_breaker_type, details, timestamp}
  - [ ] Send alerts immediately on circuit breaker trip
  - [ ] Support multiple alert channels (email + SMS + webhook)
  - [ ] Log alert delivery status (sent, failed)
  - [ ] Implement alert security and rate limiting
    - [ ] Add rate limiting for alerts (max 10 alerts per circuit breaker per hour)
    - [ ] Implement webhook endpoint authentication (HMAC signature or bearer token)
    - [ ] Validate webhook URLs (allowlist or pattern matching)
    - [ ] Log all alert delivery attempts with status
    - [ ] Prevent alert spam on repeated trips
- [ ] Implement monitoring dashboard (AC: 8)
  - [ ] Create optional Streamlit dashboard in rustybt/live/dashboard.py
  - [ ] Display live portfolio value and PnL
  - [ ] Display current positions with market values
  - [ ] Display circuit breaker status (NORMAL / TRIPPED / MANUALLY_HALTED)
  - [ ] Display recent orders and fills
  - [ ] Display error log (recent errors and rejections)
  - [ ] Provide manual halt button on dashboard
  - [ ] Auto-refresh every 5 seconds
  - [ ] Alternative: Document Grafana integration for production monitoring
- [ ] Implement unit tests for circuit breakers (AC: 9)
  - [ ] Test DrawdownCircuitBreaker trips at correct threshold
  - [ ] Test DailyLossCircuitBreaker trips at daily loss limit
  - [ ] Test OrderRateCircuitBreaker trips with rapid order submissions
  - [ ] Test ErrorRateCircuitBreaker trips with repeated errors
  - [ ] Test manual circuit breaker halts immediately
  - [ ] Test circuit breaker state transitions
  - [ ] Test alert system sends alerts on trip
  - [ ] Test order submission blocked when circuit breaker tripped
  - [ ] Use mock LiveTradingEngine and portfolios for testing
- [ ] Create circuit breaker documentation (AC: 10)
  - [ ] Document circuit breaker types and configurations in docs/architecture/live-trading.md
  - [ ] Explain drawdown and daily loss calculations
  - [ ] Provide configuration examples for different risk profiles (conservative, moderate, aggressive)
  - [ ] Document alert system setup (SMTP, Twilio, webhooks)
  - [ ] Explain manual circuit breaker usage (CLI, API, dashboard)
  - [ ] Provide best practices for risk management with circuit breakers
  - [ ] Add troubleshooting guide for circuit breaker issues

## Dev Notes

### Previous Story Insights
[From Story 6.1: Design Live Trading Engine Architecture]
- Circuit breakers design: drawdown, daily loss, order rate, error rate
- Alert system for circuit breaker trips (email, SMS, webhook)
- Monitoring dashboard (optional Streamlit/Grafana)
- Circuit breaker state tracking (NORMAL, TRIPPED, MANUALLY_HALTED)

[From Story 6.2: Implement Event-Driven Async Trading Engine Core]
- Event system for CircuitBreakerTrippedEvent
- Order submission blocking when circuit breaker active
- Graceful shutdown integration

### Architecture Context

**Circuit Breaker Design:**
[Source: docs/architecture/live-trading.md (from Story 6.1)]
- DrawdownCircuitBreaker: Halt if portfolio drawdown exceeds threshold (e.g., -10%)
- DailyLossCircuitBreaker: Halt if daily loss exceeds limit
- OrderRateCircuitBreaker: Prevent runaway order submission (max 100 orders/minute)
- ErrorRateCircuitBreaker: Halt on repeated errors (10 order rejections in 1 minute)
- Manual circuit breaker: Emergency stop button or API endpoint
- Alert system: Email, SMS, webhook on trip

**Monitoring Integration:**
[Source: Epic 6 PRD Story 6.11]
- Monitoring dashboard (optional Streamlit/Grafana) shows live positions, PnL, circuit breaker status
- Real-time metrics: portfolio value, positions, orders, errors
- Manual halt capability via dashboard

**Tech Stack:**
[Source: architecture/tech-stack.md]
- Python Decimal for portfolio calculations
- SMTP for email alerts
- Twilio API for SMS alerts (optional)
- Streamlit for optional dashboard
- Grafana for production monitoring (alternative)

**Streamlit Dependency (Optional):** Streamlit is optional for dashboard (not in core tech stack). Install with: pip install streamlit. Dashboard can be run separately: streamlit run rustybt/live/dashboard.py. For production, Grafana integration is recommended (documented as alternative).

**Coding Standards:**
[Source: architecture/coding-standards.md]
- Type hints: mypy --strict compliance
- Structured logging for circuit breaker events
- Error handling: CircuitBreakerError for trip conditions
- Immutable state tracking for circuit breaker status

### File Locations
[Source: architecture/source-tree.md]
- Circuit breakers: `rustybt/live/circuit_breakers.py`
- Alert manager: `rustybt/live/alerts.py`
- Dashboard: `rustybt/live/dashboard.py` (optional Streamlit app)
- Events: `rustybt/live/events.py` (CircuitBreakerTrippedEvent, ManualHaltEvent)
- Tests: `tests/live/test_circuit_breakers.py`, `tests/live/test_alerts.py`
- Documentation: `docs/architecture/live-trading.md` (add circuit breakers section)

### Integration Points
- LiveTradingEngine: Monitors circuit breakers, blocks orders when tripped
- DecimalLedger: Provides portfolio value for drawdown calculation
- OrderManager: Provides order count for rate limiting
- EventQueue: Dispatches CircuitBreakerTrippedEvent
- AlertManager: Sends alerts on circuit breaker trips
- Scheduler: Resets daily loss at market open

### Circuit Breaker Configuration Examples

**Conservative (Low Risk Tolerance):**
```python
circuit_breakers = {
    "drawdown": {"threshold": -0.05},  # -5% drawdown
    "daily_loss": {"limit": -0.02},    # -2% daily loss
    "order_rate": {"max_orders": 50, "window": 60},  # 50 orders/minute
    "error_rate": {"max_errors": 5, "window": 60}    # 5 errors/minute
}
```

**Moderate (Balanced Risk):**
```python
circuit_breakers = {
    "drawdown": {"threshold": -0.10},  # -10% drawdown
    "daily_loss": {"limit": -0.05},    # -5% daily loss
    "order_rate": {"max_orders": 100, "window": 60},  # 100 orders/minute
    "error_rate": {"max_errors": 10, "window": 60}    # 10 errors/minute
}
```

**Aggressive (High Risk Tolerance):**
```python
circuit_breakers = {
    "drawdown": {"threshold": -0.20},  # -20% drawdown
    "daily_loss": {"limit": -0.10},    # -10% daily loss
    "order_rate": {"max_orders": 200, "window": 60},  # 200 orders/minute
    "error_rate": {"max_errors": 20, "window": 60}    # 20 errors/minute
}
```

### Alert System Configuration Example (.env)
```
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your_email@gmail.com
SMTP_PASSWORD=your_app_password
ALERT_EMAIL=alerts@yourcompany.com

TWILIO_ACCOUNT_SID=your_twilio_account_sid
TWILIO_AUTH_TOKEN=your_twilio_auth_token
TWILIO_FROM_NUMBER=+15551234567
ALERT_PHONE=+15559876543

ALERT_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

### Streamlit Dashboard Features
- Real-time portfolio value chart
- Current positions table with live prices
- Recent orders and fills log
- Circuit breaker status indicators (green = NORMAL, red = TRIPPED)
- Manual halt button (requires confirmation)
- Error log with filtering

### Testing
[Source: architecture/testing-strategy.md]

**Test Location:**
- Unit tests: `tests/live/test_circuit_breakers.py`, `tests/live/test_alerts.py`
- Integration tests: `tests/integration/live/test_circuit_breaker_integration.py`

**Testing Standards:**
- Unit tests: ≥90% coverage
- Test all circuit breaker trip conditions
- Test alert delivery (mock SMTP, Twilio, webhook endpoints)
- Integration tests simulate adverse conditions (drawdown, rapid orders, errors)

**Key Test Scenarios:**
- Drawdown circuit breaker trips when portfolio drops 10%
- Daily loss circuit breaker trips at daily limit
- Order rate circuit breaker trips with 150 orders in 1 minute
- Error rate circuit breaker trips with 15 errors in 1 minute
- Manual circuit breaker halts immediately
- Circuit breaker state transitions correctly
- Alerts sent on all circuit breaker trips
- Order submission blocked when circuit breaker tripped
- Circuit breaker reset requires manual confirmation

**Test Fixtures:**
- Mock DecimalLedger with configurable portfolio value
- Mock OrderManager with order submission tracking
- Mock AlertManager for alert delivery verification
- Sample adverse scenarios (drawdown, rapid orders, errors)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
Not yet implemented

### Completion Notes List
Not yet implemented

### File List
Not yet implemented

## QA Results
Not yet implemented
