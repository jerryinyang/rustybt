# Story 6.4: Implement Position Reconciliation with Broker

## Status
Draft

## Story
**As a** quantitative trader,
**I want** automatic position reconciliation comparing local state vs. broker positions,
**so that** I can detect and resolve discrepancies before they cause trading errors.

## Acceptance Criteria
1. Reconciliation runs on engine startup and periodically during operation (e.g., every 5 minutes)
2. Fetch positions from broker via API
3. Compare local positions vs. broker positions (symbol, quantity, side)
4. Discrepancy detection (differences flagged with severity: minor vs. critical)
5. Reconciliation strategies configurable (sync_to_broker, sync_to_local, halt_and_alert)
6. Cash balance reconciliation (compare local cash vs. broker account balance)
7. Order reconciliation (compare local pending orders vs. broker open orders)
8. Reconciliation report generated (summary of discrepancies and actions taken)
9. Tests validate reconciliation with simulated discrepancies
10. Documentation explains reconciliation logic and configuration options

## Tasks / Subtasks
- [ ] Implement PositionReconciler core (AC: 1, 2, 3)
  - [ ] Create PositionReconciler class in rustybt/live/reconciler.py
  - [ ] Implement async reconcile_positions() method
  - [ ] Fetch broker positions via BrokerAdapter.get_positions()
  - [ ] Fetch local positions from DecimalLedger
  - [ ] Compare positions by asset (sid matching)
  - [ ] Detect quantity discrepancies (local.amount != broker.amount)
  - [ ] Detect missing positions (exists in local but not broker, or vice versa)
- [ ] Implement discrepancy detection and severity classification (AC: 4)
  - [ ] Define PositionDiscrepancy dataclass (asset, local_amount, broker_amount, severity, discrepancy_type)
  - [ ] Classify severity: MINOR (<1% difference), MODERATE (1-5% difference), CRITICAL (>5% difference or missing position)
  - [ ] Detect discrepancy types: QUANTITY_MISMATCH, MISSING_LOCAL, MISSING_BROKER, SIDE_MISMATCH
  - [ ] Calculate discrepancy percentage: abs(local - broker) / max(local, broker)
  - [ ] Flag critical discrepancies for immediate attention
- [ ] Implement reconciliation strategies (AC: 5)
  - [ ] Define ReconciliationStrategy enum (SYNC_TO_BROKER, SYNC_TO_LOCAL, HALT_AND_ALERT, WARN_ONLY)
  - [ ] Implement SYNC_TO_BROKER: Update local positions to match broker
  - [ ] Implement SYNC_TO_LOCAL: Submit orders to broker to match local positions (use with caution!)
  - [ ] Implement HALT_AND_ALERT: Stop engine, log critical alert, require manual intervention
  - [ ] Implement WARN_ONLY: Log discrepancies, continue operation (default for minor discrepancies)
  - [ ] Apply strategy based on discrepancy severity and configuration
  - [ ] Log all reconciliation actions with before/after state
- [ ] Implement cash balance reconciliation (AC: 6)
  - [ ] Fetch broker cash balance via BrokerAdapter.get_account_info()
  - [ ] Fetch local cash balance from DecimalLedger
  - [ ] Compare cash balances with tolerance (allow 1% difference for rounding)
  - [ ] Detect cash discrepancies exceeding tolerance
  - [ ] Apply reconciliation strategy for cash discrepancies
  - [ ] Log cash reconciliation results
- [ ] Implement order reconciliation (AC: 7)
  - [ ] Implement get_open_orders() method for BrokerAdapter (extends interface defined in Story 6.1, update base.py)
  - [ ] Fetch local pending orders from OrderManager
  - [ ] Compare orders by broker_order_id
  - [ ] Detect orphaned orders (in OrderManager but not in broker, or vice versa)
  - [ ] Detect status mismatches (local=pending, broker=filled)
  - [ ] Apply reconciliation: update local order status or cancel orphaned broker orders
  - [ ] Log order reconciliation results
- [ ] Implement periodic reconciliation scheduling (AC: 1)
  - [ ] Integrate with LiveTradingEngine and APScheduler
  - [ ] Schedule reconciliation job (default: every 5 minutes, configurable)
  - [ ] Run reconciliation on engine startup (after state restoration)
  - [ ] Run reconciliation after significant events (large order fills, strategy changes)
  - [ ] Add configurable reconciliation_interval parameter
- [ ] Generate reconciliation reports (AC: 8)
  - [ ] Create ReconciliationReport dataclass (timestamp, discrepancies, actions_taken, summary)
  - [ ] Include position discrepancies with details
  - [ ] Include cash discrepancies with details
  - [ ] Include order discrepancies with details
  - [ ] Summarize actions taken (synced positions, halted engine, etc.)
  - [ ] Log report to structured log with reconciliation context
  - [ ] Optionally save report to file for audit trail
- [ ] Implement unit tests for reconciliation (AC: 9)
  - [ ] Test position comparison with matching positions (no discrepancies)
  - [ ] Test quantity mismatch detection with various percentages
  - [ ] Test missing position detection (local only, broker only)
  - [ ] Test severity classification (MINOR, MODERATE, CRITICAL)
  - [ ] Test SYNC_TO_BROKER strategy updates local state correctly
  - [ ] Test HALT_AND_ALERT strategy stops engine
  - [ ] Test cash balance reconciliation with tolerance
  - [ ] Test order reconciliation with orphaned orders
- [ ] Create reconciliation documentation (AC: 10)
  - [ ] Document reconciliation logic in docs/architecture/live-trading.md
  - [ ] Explain discrepancy detection and severity classification
  - [ ] Document reconciliation strategies with use cases and risks
  - [ ] Provide configuration examples for different risk profiles
  - [ ] Add troubleshooting guide for common discrepancies
  - [ ] Document reconciliation report format
  - [ ] Add sequence diagram for reconciliation workflow

## Dev Notes

### Previous Story Insights
[From Story 6.1: Design Live Trading Engine Architecture]
- Reconciliation design: run on startup and periodically (every 5 minutes)
- Discrepancy detection: compare local vs broker (positions, cash, orders)
- Reconciliation strategies: sync_to_broker, sync_to_local, halt_and_alert

[From Story 6.3: Implement State Management with Save/Restore]
- Position reconciliation called after state restoration
- Reconciliation strategies: WARN_ONLY, SYNC_TO_BROKER, HALT_AND_ALERT
- Reconciliation integrated with crash recovery workflow

### Architecture Context

**Reconciliation Design:**
[Source: docs/architecture/live-trading.md (from Story 6.1)]
- Runs on engine startup and periodically during operation
- Fetches broker positions, compares with local state
- Detects discrepancies: quantity mismatches, missing positions, cash differences
- Configurable strategies: sync_to_broker (safe), sync_to_local (risky), halt_and_alert (conservative)

**Component Integration:**
[Source: architecture/component-architecture.md#live-trading-components]
- PositionReconciler: Compare local state vs broker positions, handle discrepancies
- BrokerAdapter: Provides get_positions(), get_account_info(), get_open_orders() methods
- DecimalLedger: Source of local positions and cash balance

**Interface Extension:** This story extends the BrokerAdapter interface with get_open_orders(). Update rustybt/live/brokers/base.py to add this method to the abstract base class.
- OrderManager: Source of local pending orders
- StateManager: Triggers reconciliation after state restoration

**Data Models:**
[Source: architecture/data-models-and-schema-changes.md]
- live_positions table: Stores reconciliation results for audit
- DecimalPosition: Local position representation
- Broker position format varies by adapter (standardized in BrokerAdapter)

**Tech Stack:**
[Source: architecture/tech-stack.md]
- Python Decimal for position amounts and cash balance comparison
- Pydantic for PositionDiscrepancy and ReconciliationReport models
- APScheduler for periodic reconciliation scheduling
- asyncio for async broker API calls

**Coding Standards:**
[Source: architecture/coding-standards.md]
- Type hints: mypy --strict compliance
- Structured logging for reconciliation events (discrepancies, actions)
- Error handling: ReconciliationError for critical discrepancies
- Immutable dataclasses for discrepancy records

### File Locations
[Source: architecture/source-tree.md]
- Position reconciler: `rustybt/live/reconciler.py`
- Reconciliation models: `rustybt/live/models.py` (PositionDiscrepancy, ReconciliationReport)
- Tests: `tests/live/test_reconciler.py`
- Integration tests: `tests/integration/live/test_reconciliation.py`
- Documentation: `docs/architecture/live-trading.md` (add reconciliation section)

### Integration Points
- BrokerAdapter: get_positions(), get_account_info(), get_open_orders() methods
- DecimalLedger: Provides local positions and cash balance
- OrderManager: Provides pending orders for comparison
- LiveTradingEngine: Schedules periodic reconciliation, calls on startup
- StateManager: Triggers reconciliation after state restoration

### Discrepancy Severity Examples
- MINOR: Local=100 shares, Broker=101 shares (1% difference)
- MODERATE: Local=100 shares, Broker=103 shares (3% difference)
- CRITICAL: Local=100 shares, Broker=0 shares (missing position)
- CRITICAL: Local=long 100 shares, Broker=short 100 shares (side mismatch)

### Reconciliation Strategy Risks
- SYNC_TO_BROKER: Safe, updates local state to match broker (recommended)
- SYNC_TO_LOCAL: Risky, submits orders to broker to match local (can cause unintended trades!)
- HALT_AND_ALERT: Conservative, stops engine for manual review (safest for critical discrepancies)
- WARN_ONLY: Permissive, logs but continues operation (use for minor discrepancies only)

### Testing
[Source: architecture/testing-strategy.md]

**Test Location:**
- Unit tests: `tests/live/test_reconciler.py`
- Integration tests: `tests/integration/live/test_reconciliation.py`

**Testing Standards:**
- Unit tests: â‰¥90% coverage
- Test all reconciliation strategies with simulated discrepancies
- Property-based tests with Hypothesis for discrepancy detection
- Integration tests with mock broker returning discrepant positions

**Key Test Scenarios:**
- Position comparison with no discrepancies (all match)
- Quantity mismatch with various severity levels
- Missing position detection (local only, broker only)
- Cash balance discrepancy within and beyond tolerance
- Order reconciliation with orphaned orders
- Strategy application: SYNC_TO_BROKER updates local state
- Strategy application: HALT_AND_ALERT stops engine
- Periodic reconciliation triggers on schedule

**Test Fixtures:**
- Mock BrokerAdapter with configurable position responses
- Sample DecimalLedger with known positions
- Sample OrderManager with pending orders
- Discrepant broker positions for various test scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
Not yet implemented

### Completion Notes List
Not yet implemented

### File List
Not yet implemented

## QA Results
Not yet implemented
