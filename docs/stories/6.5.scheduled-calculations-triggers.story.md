# Story 6.5: Implement Scheduled Calculations and Triggers

## Status
Draft

## Story
**As a** quantitative trader,
**I want** flexible scheduling for strategy calculations (market open/close, custom intervals),
**so that** I can run periodic rebalancing, risk checks, or strategy signals on defined schedules.

## Acceptance Criteria
1. Scheduler supports cron-like expressions (e.g., "0 9 30 * * MON-FRI" for market open)
2. Market event triggers (market_open, market_close, pre_market, after_hours)
3. Custom time-based triggers (every N minutes, specific times, custom cron expressions)
4. Trading calendar integration (skip non-trading days, handle holidays)
5. Timezone-aware scheduling (convert triggers to exchange local time)
6. Callback registration (strategy registers callbacks for scheduled events)
7. Missed trigger handling (if engine offline during scheduled time, handle on startup)
8. Tests validate scheduling accuracy (<1 second deviation from scheduled time)
9. Integration test demonstrates strategy with scheduled daily rebalancing
10. Documentation provides examples for common scheduling patterns

## Tasks / Subtasks
- [ ] Implement TradingScheduler core with APScheduler (AC: 1, 3)
  - [ ] Create TradingScheduler class in rustybt/live/scheduler.py
  - [ ] Initialize APScheduler with BackgroundScheduler or AsyncIOScheduler
  - [ ] Implement add_job(trigger, callback, **kwargs) method
  - [ ] Support cron triggers with cron expressions
  - [ ] Support interval triggers (every N minutes/hours)
  - [ ] Support date triggers (specific datetime)
  - [ ] Wrap callbacks to emit ScheduledTriggerEvent to engine event queue
  - [ ] Implement remove_job(job_id) for dynamic schedule changes
  - [ ] Implement list_jobs() to query active scheduled jobs
- [ ] Implement market event triggers (AC: 2, 4)
  - [ ] Add schedule_market_open(callback, timezone='America/New_York') method
  - [ ] Add schedule_market_close(callback, timezone='America/New_York') method
  - [ ] Add schedule_pre_market(callback, offset_minutes=-30) method
  - [ ] Add schedule_after_hours(callback, offset_minutes=30) method
  - [ ] Integrate with exchange-calendars library for trading calendar
  - [ ] Skip non-trading days (weekends, holidays) using trading calendar
  - [ ] Handle half-days with adjusted market hours
  - [ ] Support multiple exchanges with different market hours
  - [ ] Implement 24/7 crypto calendar support
    - [ ] Create CryptoTradingCalendar class extending exchange-calendars AbstractExchangeCalendar
    - [ ] Configure 24/7 operation (no holidays, no market close)
    - [ ] Support multiple crypto exchanges (Binance, Coinbase, Kraken) with continuous trading
    - [ ] Document usage for crypto strategies
- [ ] Implement timezone-aware scheduling (AC: 5)
  - [ ] Use pytz for timezone management
  - [ ] Convert all trigger times to UTC internally
  - [ ] Support exchange-specific timezones (NYSE=America/New_York, LSE=Europe/London, etc.)
  - [ ] Handle daylight saving time transitions correctly
  - [ ] Log all scheduled times in both local and UTC
  - [ ] Validate timezone strings on registration
- [ ] Implement callback registration system (AC: 6)
  - [ ] Create ScheduledCallback dataclass (callback_func, trigger_config, enabled)
  - [ ] Implement register_callback(name, trigger, callback) in TradingAlgorithm
  - [ ] Allow strategies to register multiple callbacks
  - [ ] Support callback enable/disable without removing job
  - [ ] Pass context to callbacks (current time, scheduled time, strategy context)
  - [ ] Handle callback exceptions without crashing scheduler
- [ ] Implement missed trigger handling (AC: 7)
  - [ ] Add misfire_grace_time parameter (default: 60 seconds)
  - [ ] Configure APScheduler misfire handling: run immediately if within grace time
  - [ ] Log missed triggers that exceed grace time
  - [ ] Optionally run missed critical triggers on engine startup
  - [ ] Provide configuration for missed trigger behavior (skip, run_immediately, run_on_startup)
- [ ] Implement unit tests for scheduling (AC: 8)
  - [ ] Test cron trigger creates job with correct schedule
  - [ ] Test interval trigger fires at correct intervals
  - [ ] Test market_open trigger uses correct exchange hours
  - [ ] Test trading calendar skips weekends and holidays
  - [ ] Test timezone conversion (schedule in ET, execute in UTC)
  - [ ] Test callback registration and execution
  - [ ] Test missed trigger handling within grace time
  - [ ] Test scheduling accuracy (±1 second tolerance)
- [ ] Implement integration test with scheduled rebalancing (AC: 9)
  - [ ] Create RebalancingStrategy that registers daily rebalancing callback
  - [ ] Schedule rebalancing at market close
  - [ ] Run strategy for multiple days (simulate time progression)
  - [ ] Verify rebalancing executes on schedule
  - [ ] Verify rebalancing skips weekends/holidays
  - [ ] Verify callback receives correct context
- [ ] Create scheduling documentation and examples (AC: 10)
  - [ ] Document TradingScheduler API in docs/architecture/live-trading.md
  - [ ] Provide example: Daily rebalancing at market close
  - [ ] Provide example: Hourly risk check during market hours
  - [ ] Provide example: Weekly portfolio report on Friday close
  - [ ] Provide example: Custom cron schedule (every 15 minutes 9:30-16:00 Mon-Fri)
  - [ ] Document market event triggers and timezone handling
  - [ ] Document missed trigger behavior and configuration
  - [ ] Add troubleshooting guide for scheduling issues

## Dev Notes

### Previous Story Insights
[From Story 6.1: Design Live Trading Engine Architecture]
- Scheduler component: APScheduler integration for market triggers and custom schedules
- Market event triggers: market_open, market_close, pre_market, after_hours
- Trading calendar integration for non-trading days and holidays
- Timezone-aware scheduling with exchange local time support

[From Story 6.2: Implement Event-Driven Async Trading Engine Core]
- ScheduledTriggerEvent dispatched to strategy callbacks
- Event queue integration for scheduled events
- Graceful shutdown handling for scheduler cleanup

### Architecture Context

**Scheduler Design:**
[Source: docs/architecture/live-trading.md (from Story 6.1)]
- APScheduler for cron-like expressions and market triggers
- Trading calendar integration (skip non-trading days, handle holidays)
- Timezone-aware scheduling (convert to exchange local time)
- Callback registration for strategy scheduled events
- Missed trigger handling (run on startup or within grace time)

**Component Integration:**
[Source: architecture/component-architecture.md#live-trading-components]
- TradingScheduler: Market triggers using APScheduler (market_open, market_close, custom intervals)
- LiveTradingEngine: Uses scheduler for periodic tasks (reconciliation, checkpoints, strategy callbacks)
- StrategyExecutor: Executes scheduled callbacks with strategy context

**Tech Stack:**
[Source: architecture/tech-stack.md#new-technology-additions]
- APScheduler 3.x+ for task scheduling
- exchange-calendars >= 4.2.4 for trading calendar data (extend for 24/7 crypto)
- pytz for timezone management
- Python asyncio for async scheduling coordination

**Coding Standards:**
[Source: architecture/coding-standards.md]
- Type hints: mypy --strict compliance
- Structured logging for scheduling events (job_added, job_fired, job_missed)
- Error handling: SchedulerError for scheduling failures
- Callback exceptions logged but don't crash scheduler

### File Locations
[Source: architecture/source-tree.md]
- Scheduler: `rustybt/live/scheduler.py` (TradingScheduler class)
- Callback models: `rustybt/live/models.py` (ScheduledCallback)
- Tests: `tests/live/test_scheduler.py`
- Integration test: `tests/integration/live/test_scheduled_rebalancing.py`
- Documentation: `docs/architecture/live-trading.md` (add scheduling section)

### Integration Points
- LiveTradingEngine: Creates scheduler instance, registers periodic tasks
- TradingAlgorithm: Provides register_callback() method for strategies
- EventQueue: Scheduled triggers emit ScheduledTriggerEvent
- exchange-calendars: Provides trading calendar for market hour lookups
- APScheduler: Underlying scheduling engine

### Market Hours Examples
- NYSE: 9:30-16:00 ET (America/New_York)
- LSE: 8:00-16:30 GMT (Europe/London)
- TSE: 9:00-15:00 JST (Asia/Tokyo)
- Crypto: 24/7 (use UTC, no trading calendar)

### Common Scheduling Patterns
1. Daily rebalancing at market close: `schedule_market_close(rebalance_callback)`
2. Hourly risk check: `add_job(cron='0 * * * *', risk_check_callback)`
3. Every 15 minutes during market hours: `add_job(cron='*/15 9-16 * * MON-FRI', signal_callback)`
4. Weekly report on Friday close: `add_job(cron='0 16 * * FRI', weekly_report_callback)`
5. Crypto strategy every 5 minutes: `add_job(interval=timedelta(minutes=5), crypto_signal_callback)`

### Testing
[Source: architecture/testing-strategy.md]

**Test Location:**
- Unit tests: `tests/live/test_scheduler.py`
- Integration tests: `tests/integration/live/test_scheduled_rebalancing.py`

**Testing Standards:**
- Unit tests: ≥90% coverage
- Test scheduling accuracy with time mocking (freezegun or similar)
- Test trading calendar integration with known holidays
- Test timezone conversion with various exchanges
- Property-based tests for cron expression parsing

**Key Test Scenarios:**
- Cron trigger fires at correct time (±1 second)
- Market open/close triggers use correct exchange hours
- Trading calendar skips weekends and holidays
- Timezone conversion handles DST transitions
- Callback registration and execution
- Missed trigger within grace time runs immediately
- Missed trigger beyond grace time is logged and skipped
- Multiple callbacks fire in correct order

**Test Fixtures:**
- Mock trading calendar with known holidays
- Mock current time for deterministic scheduling tests
- Sample strategy with scheduled callbacks
- Sample callbacks for various trigger types

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
Not yet implemented

### Completion Notes List
Not yet implemented

### File List
Not yet implemented

## QA Results
Not yet implemented
