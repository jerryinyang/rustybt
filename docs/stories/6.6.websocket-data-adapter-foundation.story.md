# Story 6.6: Implement WebSocket Data Adapter Foundation (Moved from Epic 3)

## Status
Draft

## Story
**As a** developer,
**I want** WebSocket adapter base class for real-time streaming data,
**so that** live trading can integrate real-time market data feeds.

## Acceptance Criteria
1. BaseWebSocketAdapter created for real-time data streaming
2. Connection management implemented (connect, disconnect, reconnect on failure)
3. Subscription management (subscribe to symbols/channels, unsubscribe)
4. Message parsing framework (standardize exchange-specific WebSocket messages to OHLCV)
5. Buffering system implemented (accumulate ticks into OHLCV bars for configured resolution)
6. Heartbeat/keepalive handling (maintain connection, detect stale connections)
7. Error handling covers disconnections, invalid messages, rate limits
8. Example WebSocket adapter implemented for one exchange (e.g., Binance WebSocket)
9. Tests validate connection lifecycle and message parsing (using mock WebSocket server)
10. Documentation explains WebSocket adapter architecture for extension

## Tasks / Subtasks
- [ ] Implement BaseWebSocketAdapter core (AC: 1, 2)
  - [ ] Create BaseWebSocketAdapter abstract class in rustybt/live/streaming/base.py
  - [ ] Implement async connect(url, **kwargs) method using websockets library
  - [ ] Implement async disconnect() method with cleanup
  - [ ] Implement auto-reconnect on disconnect with exponential backoff (1s, 2s, 4s, 8s, 16s max)
  - [ ] Track connection state (DISCONNECTED, CONNECTING, CONNECTED, RECONNECTING)
  - [ ] Implement connection health monitoring (last_message_time tracking)
  - [ ] Add configurable reconnect_attempts parameter (default: infinite)
- [ ] Implement subscription management (AC: 3)
  - [ ] Implement abstract subscribe(symbols: List[str], channels: List[str]) method
  - [ ] Implement abstract unsubscribe(symbols: List[str], channels: List[str]) method
  - [ ] Track active subscriptions (symbol → channels mapping)
  - [ ] Handle subscription confirmation from exchange
  - [ ] Re-subscribe after reconnection
  - [ ] Support dynamic subscription changes (add/remove symbols while connected)
- [ ] Implement message parsing framework (AC: 4)
  - [ ] Create TickData dataclass (symbol, timestamp, price, volume, side)
  - [ ] Implement abstract parse_message(raw_message: dict) → TickData method
  - [ ] Standardize tick data format across exchanges
  - [ ] Handle exchange-specific message formats (override in subclasses)
  - [ ] Validate parsed data (required fields, data types)
  - [ ] Handle parsing errors gracefully (log and skip invalid messages)
- [ ] Implement tick-to-bar buffering system (AC: 5)
  - [ ] Create BarBuffer class to accumulate ticks into OHLCV bars
  - [ ] Support configurable bar resolution (1m, 5m, 15m, 1h, etc.)
  - [ ] Implement bar aggregation logic (first tick → open, last tick → close, max price → high, min price → low, sum volume)
  - [ ] Emit completed bars as MarketDataEvent
  - [ ] Handle bar boundaries correctly (align to minute/hour boundaries)
  - [ ] Support multiple symbols with separate buffers
- [ ] Implement heartbeat and keepalive handling (AC: 6)
  - [ ] Implement ping/pong mechanism (send ping, expect pong response)
  - [ ] Detect stale connections (no message received in N seconds, configurable)
  - [ ] Trigger reconnection on stale connection detected
  - [ ] Handle exchange-specific heartbeat formats (some exchanges send heartbeat messages)
  - [ ] Log heartbeat activity at DEBUG level
- [ ] Implement error handling and rate limiting (AC: 7)
  - [ ] Handle WebSocket disconnections (ConnectionClosed, ConnectionError)
  - [ ] Handle invalid JSON messages (log and skip)
  - [ ] Handle rate limit errors from exchange (backoff and retry)
  - [ ] Handle subscription errors (symbol not found, invalid channel)
  - [ ] Implement circuit breaker for repeated errors (trip after N consecutive errors)
  - [ ] Log all errors with context (symbol, channel, error_message)
- [ ] Implement Binance WebSocket adapter example (AC: 8)
  - [ ] Create BinanceWebSocketAdapter in rustybt/live/streaming/binance_stream.py
  - [ ] Implement connect() to wss://stream.binance.com:9443/ws
  - [ ] Implement subscribe() with Binance subscription format (kline, trade, ticker)
  - [ ] Implement parse_message() for Binance kline messages
  - [ ] Convert Binance kline to TickData format
  - [ ] Support both spot and futures streams
  - [ ] Handle Binance-specific error codes
- [ ] Implement unit and integration tests (AC: 9)
  - [ ] Test connection lifecycle (connect → disconnect)
  - [ ] Test auto-reconnect on disconnect
  - [ ] Test subscription management (subscribe → receive messages → unsubscribe)
  - [ ] Test message parsing with sample Binance messages
  - [ ] Test tick-to-bar buffering (accumulate ticks, emit completed bars)
  - [ ] Test heartbeat handling (send ping, receive pong)
  - [ ] Test error handling for various failure scenarios
  - [ ] Use pytest-asyncio with mock WebSocket server (websockets library provides test utilities, or use pytest-aiohttp for WebSocket mocking)
- [ ] Create WebSocket adapter documentation (AC: 10)
  - [ ] Document BaseWebSocketAdapter architecture in docs/architecture/live-trading.md
  - [ ] Explain connection lifecycle and auto-reconnect strategy
  - [ ] Document subscription management and re-subscription on reconnect
  - [ ] Explain message parsing framework and standardization
  - [ ] Document tick-to-bar buffering system
  - [ ] Provide guide for implementing new exchange adapters
  - [ ] Add example for Binance WebSocket usage

## Dev Notes

### Previous Story Insights
[From Story 6.1: Design Live Trading Engine Architecture]
- WebSocket streaming foundation for real-time data (deferred from Epic 3)
- BaseStreamAdapter for standardizing exchange WebSocket messages
- Buffering system to accumulate ticks into OHLCV bars

[From Story 6.5: Scheduled Calculations]
- Event system already in place for scheduled triggers
- Integration point for real-time data event triggering

**Note:** This story is now Story 6.6, positioned before Paper Trading (6.7) to provide WebSocket foundation for real-time data.

### Architecture Context

**WebSocket Streaming Design:**
[Source: architecture/external-api-integration.md#websocket-streaming-epic-6]
- Supported brokers: Binance (wss://stream.binance.com:9443), Bybit, Hyperliquid, IB
- Features: orderbook updates, trade stream, kline/candlestick stream, account updates
- Connection management: auto-reconnect, heartbeat, subscription management

**Data Adapter Pattern:**
[Source: architecture/component-architecture.md#data-adapter-components]
- BaseDataAdapter: Extensible framework for data sources
- Standard schema: timestamp, symbol, open, high, low, close, volume (Decimal columns)
- Validation: OHLCV relationships, outlier detection, temporal consistency

**Tech Stack:**
[Source: architecture/tech-stack.md#new-technology-additions]
- websockets 14.x+ for WebSocket streaming
- asyncio for async connection management
- Python Decimal for price and volume data
- Pydantic for message validation

**Coding Standards:**
[Source: architecture/coding-standards.md]
- Type hints: mypy --strict compliance
- Async/await for all WebSocket operations
- Structured logging for connection events and errors
- Error handling: WebSocketError, ConnectionError, ParseError

### File Locations
[Source: architecture/source-tree.md#rustybt-directory-structure]
- Base adapter: `rustybt/live/streaming/base.py` (BaseWebSocketAdapter)
- Binance adapter: `rustybt/live/streaming/binance_stream.py` (BinanceWebSocketAdapter)
- Tick buffer: `rustybt/live/streaming/bar_buffer.py` (BarBuffer)
- Models: `rustybt/live/streaming/models.py` (TickData, StreamConfig)
- Tests: `tests/live/streaming/test_base_adapter.py`, `tests/live/streaming/test_binance_stream.py`
- Documentation: `docs/architecture/live-trading.md` (add WebSocket streaming section)

### Integration Points
- LiveTradingEngine: Uses WebSocket adapters for real-time market data
- DataFeed: Dispatches TickData as MarketDataEvent
- BarBuffer: Converts ticks to OHLCV bars
- BrokerAdapter: May provide WebSocket data (e.g., IB streaming)

### Binance WebSocket Message Format Examples

**Binance Message Format Note:** Examples shown are for spot market. Futures format may differ slightly (additional fields like markPrice, fundingRate). Adapter should handle both.

**Kline (Candlestick):**
```json
{
  "e": "kline",
  "E": 1638747420000,
  "s": "BTCUSDT",
  "k": {
    "t": 1638747360000,
    "T": 1638747419999,
    "s": "BTCUSDT",
    "i": "1m",
    "o": "49500.00",
    "c": "49550.00",
    "h": "49600.00",
    "l": "49480.00",
    "v": "123.456",
    "x": false
  }
}
```

**Trade:**
```json
{
  "e": "trade",
  "E": 1638747420000,
  "s": "BTCUSDT",
  "t": 123456,
  "p": "49500.00",
  "q": "0.5",
  "T": 1638747420000,
  "m": true
}
```

### Bar Buffering Logic
1. Receive tick with timestamp, price, volume
2. Determine bar interval (e.g., 1 minute → round down to minute boundary)
3. Add tick to current bar buffer:
   - If first tick in bar: open = price
   - Update: high = max(high, price), low = min(low, price)
   - If last tick (bar complete): close = price
   - Aggregate: volume += tick_volume
4. On bar boundary: Emit completed bar, start new bar

### Reconnection Strategy
- Initial connect: immediate
- Reconnect on disconnect: exponential backoff (1s, 2s, 4s, 8s, 16s max)
- Re-subscribe to all active subscriptions after reconnect
- Log reconnection attempts and successes

### Testing
[Source: architecture/testing-strategy.md]

**Test Location:**
- Unit tests: `tests/live/streaming/test_base_adapter.py`, `tests/live/streaming/test_binance_stream.py`
- Integration tests: `tests/integration/live/test_websocket_streaming.py`

**Testing Standards:**
- Unit tests: ≥90% coverage (mock WebSocket server)
- Integration tests: Use real WebSocket connections (mark with @pytest.mark.websocket_integration)
- Test connection lifecycle, message parsing, buffering, error handling

**Key Test Scenarios:**
- Connection succeeds and receives messages
- Auto-reconnect on disconnect
- Subscription management (subscribe → messages → unsubscribe)
- Message parsing with various formats
- Tick-to-bar buffering produces correct OHLCV bars
- Heartbeat maintains connection
- Error handling for disconnect, parse errors, rate limits
- Re-subscription after reconnect

**Test Fixtures:**
- Mock WebSocket server returning sample messages
- Sample Binance kline and trade messages
- Sample tick data for buffering tests
- WebSocket test client

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation (moved from Epic 3) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
Not yet implemented

### Completion Notes List
Not yet implemented

### File List
Not yet implemented

## QA Results
Not yet implemented
