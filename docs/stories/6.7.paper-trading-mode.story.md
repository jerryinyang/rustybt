# Story 6.7: Implement Paper Trading Mode

## Status
Draft

## Story
**As a** quantitative trader,
**I want** paper trading mode simulating broker with real market data,
**so that** I can validate live strategy behavior before risking real capital.

## Acceptance Criteria
1. PaperBroker implements BrokerAdapter interface mimicking real broker
2. Real-time market data consumed (via WebSocket adapters from Story 6.6 - WebSocket foundation now available)
3. Simulated order execution with realistic fills (market orders fill at current price)
4. Latency simulation applied (same as backtest latency models)
5. Partial fills simulated based on volume (same as backtest partial fill model)
6. Commission and slippage applied (same models as backtest)
7. Paper positions tracked separately (not sent to real broker)
8. Paper account balance tracked (starting capital configurable)
9. Tests validate paper trading produces expected results (matches backtest for same data)
10. Example demonstrates backtest → paper trading comparison showing >99% correlation

## Tasks / Subtasks
- [ ] Implement PaperBroker class implementing BrokerAdapter (AC: 1)
  - [ ] Create PaperBroker class in rustybt/live/brokers/paper_broker.py
  - [ ] Implement all BrokerAdapter methods: connect(), submit_order(), cancel_order(), get_positions(), get_account_info()
  - [ ] Initialize with starting_cash parameter (default: Decimal("100000"))
  - [ ] Maintain internal paper positions dict (asset → DecimalPosition)
  - [ ] Maintain internal paper cash balance
  - [ ] Track paper orders (id → PaperOrder)
  - [ ] No actual broker connection (connect() always succeeds)
- [ ] Integrate real-time market data for fills (AC: 2)
  - [ ] Subscribe to market data via subscribe_market_data(assets)
  - [ ] Store latest market prices for each asset
  - [ ] Use real-time prices for order execution simulation
  - [ ] Handle missing market data gracefully (use last known price or reject order)
  - [ ] Support multiple asset classes (stocks, crypto, futures)
- [ ] Implement simulated order execution (AC: 3)
  - [ ] Market orders: Fill immediately at current market price
  - [ ] Limit orders: Fill when market price crosses limit price
  - [ ] Stop orders: Trigger when market price crosses stop price, then fill as market order
  - [ ] Stop-limit orders: Trigger at stop price, then fill as limit order
  - [ ] Generate OrderFillEvent with fill details (price, amount, commission, timestamp)
  - [ ] Update paper positions and cash balance on fill
- [ ] Implement latency simulation (AC: 4)
  - [ ] Add configurable order_latency parameter (default: 100ms for stocks, 50ms for crypto)
  - [ ] Delay order fills by latency amount using asyncio.sleep()
  - [ ] Match backtest latency model for consistency
  - [ ] Simulate network jitter (±20% latency variation)
  - [ ] Log actual fill time vs submitted time
- [ ] Implement partial fill simulation (AC: 5)
  - [ ] Calculate fill percentage based on order size vs market volume
  - [ ] Use backtest partial fill model: fill_pct = min(1.0, order_size / (volume * volume_limit_pct))
  - [ ] Default volume_limit_pct = 0.025 (order can fill up to 2.5% of bar volume)
  - [ ] Generate multiple OrderFillEvents for partial fills
  - [ ] Update positions incrementally as fills occur
  - [ ] Mark order as PARTIALLY_FILLED status
- [ ] Implement commission and slippage models (AC: 6)
  - [ ] Use commission and slippage models from rustybt.finance.commission (PerShare, PerTrade, PercentOfValue implemented in Epic 4) and rustybt.finance.slippage (FixedSlippage, VolumeShareSlippage from Epic 4)
  - [ ] Calculate commission on each fill
  - [ ] Apply slippage to fill price (buy: price * (1 + slippage), sell: price * (1 - slippage))
  - [ ] Deduct commission from cash balance
  - [ ] Include commission and slippage in OrderFillEvent
- [ ] Implement paper position and balance tracking (AC: 7, 8)
  - [ ] Track paper positions separately from any real broker positions
  - [ ] Update positions on order fills (increase/decrease amount, update cost_basis)
  - [ ] Track paper cash balance (decrease on buys + commission, increase on sells - commission)
  - [ ] Implement get_positions() returning current paper positions
  - [ ] Implement get_account_info() returning paper cash, buying_power, portfolio_value
  - [ ] Support configurable starting capital
- [ ] Implement validation tests comparing paper vs backtest (AC: 9)
  - [ ] Run same strategy in backtest mode with historical data
  - [ ] Run same strategy in paper trading mode with same historical data (simulated real-time)
  - [ ] Compare final portfolio values (should match within 0.1%)
  - [ ] Compare position histories (should match exactly)
  - [ ] Compare order execution prices (should match within slippage tolerance)
  - [ ] Verify commission and slippage calculations match
- [ ] Create backtest vs paper trading comparison example (AC: 10)
  - [ ] Create examples/paper_trading_validation.py
  - [ ] Implement simple strategy (e.g., SMA crossover)
  - [ ] Run strategy in backtest mode, save results
  - [ ] Run strategy in paper trading mode with historical data as real-time feed
  - [ ] Calculate correlation between backtest and paper trading results
  - [ ] Demonstrate >99% correlation in portfolio value
  - [ ] Document discrepancies and their causes (timing, market data updates)
- [ ] Create paper trading documentation
  - [ ] Document PaperBroker configuration in docs/architecture/live-trading.md
  - [ ] Explain paper trading vs backtest differences (real-time data feed, event timing)
  - [ ] Provide usage examples for validation workflow
  - [ ] Document limitations (no real market impact, simulated fills may differ from reality)
  - [ ] Add troubleshooting guide for discrepancies between backtest and paper trading

## Dev Notes

### Previous Story Insights
[From Story 6.1: Design Live Trading Engine Architecture]
- PaperBroker implements BrokerAdapter interface
- Simulates broker with realistic fills, latency, slippage, commission
- Used for validation before live trading with real capital

[From Story 6.2: Implement Event-Driven Async Trading Engine Core]
- BrokerAdapter interface defines required methods
- OrderFillEvent generated on fills
- Async execution for order simulation

[From Story 6.6: WebSocket Data Adapter Foundation]
- WebSocket adapters now available for real-time market data
- Binance WebSocket adapter implemented
- Connection management and data streaming ready for integration

### Architecture Context

**Paper Trading Design:**
[Source: Epic 6 PRD Story 6.6]
- Real-time market data consumed (via WebSocket adapters)
- Simulated order execution with realistic fills
- Latency simulation matching backtest models
- Partial fills based on volume
- Commission and slippage models from backtest

**BrokerAdapter Interface:**
[Source: architecture/component-architecture.md#brokeradapter-abstract-base]
- Required methods: connect(), submit_order(), cancel_order(), get_positions(), get_account_info(), subscribe_market_data(), get_next_event()
- Async interface using asyncio
- Returns standardized data structures

**Commission and Slippage Models:**
[Source: architecture/component-architecture.md#decimal-finance-components]
- Commission models: PerShare, PerTrade, PercentOfValue
- Slippage models: FixedSlippage, VolumeShareSlippage
- Use Decimal for all financial calculations

**Tech Stack:**
[Source: architecture/tech-stack.md]
- Python Decimal for all monetary values
- asyncio for async order execution simulation
- Pydantic for PaperOrder and PaperPosition models

**Coding Standards:**
[Source: architecture/coding-standards.md]
- Type hints: mypy --strict compliance
- Decimal precision for prices, amounts, balances
- Structured logging for paper trading events
- No mocks - PaperBroker is a real implementation (Zero-Mock Enforcement)

### File Locations
[Source: architecture/source-tree.md]
- Paper broker: `rustybt/live/brokers/paper_broker.py`
- Paper models: `rustybt/live/brokers/models.py` (PaperOrder, PaperPosition)
- Tests: `tests/live/brokers/test_paper_broker.py`
- Validation example: `examples/paper_trading_validation.py`
- Documentation: `docs/architecture/live-trading.md` (add paper trading section)

### Integration Points
- BrokerAdapter: Implements abstract interface
- LiveTradingEngine: Uses PaperBroker for paper trading mode
- MarketDataFeed: Provides real-time prices for fills
- Commission models: From rustybt.finance.commission
- Slippage models: From rustybt.finance.slippage

### Paper Trading vs Backtest Differences
- Backtest: Bar-by-bar simulation, deterministic timing
- Paper Trading: Real-time data feed, event-driven timing
- Fills may occur at slightly different times due to event timing
- Expected correlation: >99% for portfolio value, exact match for positions

### Latency Models
- Stocks: 100ms average (simulate network + exchange latency)
- Crypto: 50ms average (faster exchanges)
- Jitter: ±20% variation (simulate network variability)

### Partial Fill Model
- fill_pct = min(1.0, order_size / (volume * volume_limit_pct))
- volume_limit_pct = 0.025 (order fills up to 2.5% of bar volume)
- Example: Order 1000 shares, volume 100k shares → fill_pct = min(1.0, 1000 / (100000 * 0.025)) = min(1.0, 0.4) = 0.4 → 40% fill

### Testing
[Source: architecture/testing-strategy.md]

**Test Location:**
- Unit tests: `tests/live/brokers/test_paper_broker.py`
- Integration tests: `tests/integration/live/test_paper_trading.py`
- Validation tests: `tests/validation/test_backtest_paper_correlation.py`

**Testing Standards:**
- Unit tests: ≥90% coverage
- Validation tests compare backtest vs paper trading results
- Property-based tests for fill calculations (Hypothesis)
- No mocks - use real PaperBroker implementation

**Key Test Scenarios:**
- Market order fills immediately at current price
- Limit order fills when price crosses limit
- Partial fill simulation based on volume
- Commission and slippage applied correctly
- Latency simulation delays fills appropriately
- Paper positions and balance tracked correctly
- Backtest vs paper trading produces >99% correlation

**Test Fixtures:**
- Sample market data with known prices
- Sample commission and slippage models
- Sample strategy for validation
- Historical data for backtest comparison

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
Not yet implemented

### Completion Notes List
Not yet implemented

### File List
Not yet implemented

## QA Results
Not yet implemented
