# Story 6.9: Implement Data API Provider Adapter Framework (Moved from Epic 3)

## Status
Draft

## Story
**As a** quantitative trader,
**I want** adapter framework for professional data API providers (Polygon, Alpaca, Alpha Vantage),
**so that** I can use paid data services for higher quality and more comprehensive data.

## Acceptance Criteria
1. BaseAPIProviderAdapter created extending BaseDataAdapter with authentication support
2. API key management implemented (load from environment variables or config file)
3. Polygon adapter implemented (stocks, options, forex, crypto via REST API)
4. Alpaca adapter implemented (stocks via market data API v2)
5. Alpha Vantage adapter implemented (stocks, forex, crypto via REST API)
6. Each adapter handles provider-specific authentication (API keys, OAuth if applicable)
7. Rate limiting configured per provider (respect tier limits: free vs. paid subscriptions)
8. Error handling covers authentication failures, quota exceeded, invalid symbols
9. Integration tests use test/demo API keys (documented in README)
10. Documentation explains setup for each provider with example configuration

## Tasks / Subtasks
- [ ] Implement BaseAPIProviderAdapter extending BaseDataAdapter (AC: 1, 2)
  - [ ] Create BaseAPIProviderAdapter in rustybt/data/adapters/api_provider_base.py
  - [ ] Extend BaseDataAdapter with authentication support
  - [ ] Implement API key loading from environment variables (POLYGON_API_KEY, ALPACA_API_KEY, etc.)
  - [ ] Implement API key loading from config file (~/.rustybt/api_keys.ini)
  - [ ] Add async authenticate() method for OAuth flows
  - [ ] Implement rate limiting base class with configurable requests/minute
  - [ ] Implement API key security validation
    - [ ] Add .env and api_keys.ini to .gitignore (verify not committed)
    - [ ] Implement API key validation on adapter initialization
    - [ ] Log warning if API keys found in version control
    - [ ] Document API key management best practices in README
  - [ ] Add request retry logic with exponential backoff
  - [ ] Track API usage for monitoring quota
- [ ] Implement Polygon adapter (AC: 3)
  - [ ] Create PolygonAdapter in rustybt/data/adapters/polygon_adapter.py
  - [ ] Authenticate with API key in query params or headers
  - [ ] Implement fetch_ohlcv() for stocks (GET /v2/aggs/ticker/{ticker}/range/{multiplier}/{timespan}/{from}/{to})
  - [ ] Implement fetch_ohlcv() for options (GET /v3/snapshot/options/{underlying_ticker})
  - [ ] Implement fetch_ohlcv() for forex (GET /v2/aggs/ticker/C:{from}{to}/range/{multiplier}/{timespan}/{from}/{to})
  - [ ] Implement fetch_ohlcv() for crypto (GET /v2/aggs/ticker/X:{from}{to}/range/{multiplier}/{timespan}/{from}/{to})
  - [ ] Support timeframes: minute, hour, day, week, month
  - [ ] Configure rate limit: Free tier (5 req/min), Starter (10 req/min), Developer+ (100 req/min)
  - [ ] Handle API errors (401 unauthorized, 429 rate limit, 404 symbol not found)
- [ ] Implement Alpaca adapter (AC: 4)
  - [ ] Create AlpacaAdapter in rustybt/data/adapters/alpaca_adapter.py
  - [ ] Authenticate with API key and secret in headers (APCA-API-KEY-ID, APCA-API-SECRET-KEY)
  - [ ] Use market data API v2 endpoint: https://data.alpaca.markets/v2
  - [ ] Implement fetch_ohlcv() for stocks (GET /v2/stocks/{symbol}/bars)
  - [ ] Support timeframes: 1Min, 5Min, 15Min, 1Hour, 1Day
  - [ ] Configure rate limit: Free tier (200 req/min data API)
  - [ ] Handle API errors (401 unauthorized, 403 forbidden, 429 rate limit)
  - [ ] Support paper and live data feeds (configurable endpoint)
- [ ] Implement Alpha Vantage adapter (AC: 5)
  - [ ] Create AlphaVantageAdapter in rustybt/data/adapters/alphavantage_adapter.py
  - [ ] Authenticate with API key in query param (apikey=...)
  - [ ] Implement fetch_ohlcv() for stocks (function=TIME_SERIES_INTRADAY, TIME_SERIES_DAILY)
  - [ ] Implement fetch_ohlcv() for forex (function=FX_INTRADAY, FX_DAILY)
  - [ ] Implement fetch_ohlcv() for crypto (function=CRYPTO_INTRADAY, DIGITAL_CURRENCY_DAILY)
  - [ ] Support intervals: 1min, 5min, 15min, 30min, 60min, daily, weekly, monthly
  - [ ] Configure rate limit: Free tier (5 req/min, 500 req/day), Premium (75 req/min)
  - [ ] Parse CSV or JSON response format
  - [ ] Handle API errors (API key invalid, rate limit exceeded, symbol not supported)
- [ ] Implement provider-specific authentication handling (AC: 6)
  - [ ] Polygon: API key in query param or Authorization header
  - [ ] Alpaca: API key + secret in custom headers
  - [ ] Alpha Vantage: API key in query param
  - [ ] Validate API keys on adapter initialization
  - [ ] Log authentication success/failure with provider context
  - [ ] Handle expired API keys with clear error messages
- [ ] Implement rate limiting per provider (AC: 7)
  - [ ] Create RateLimiter class with requests/minute and requests/day limits
  - [ ] Track request count and reset on interval boundary
  - [ ] Implement async wait when rate limit reached (sleep until reset)
  - [ ] Support tier-specific limits (free vs paid)
  - [ ] Log rate limit warnings (e.g., "80% of quota used")
  - [ ] Provide configuration for custom rate limits
- [ ] Implement comprehensive error handling (AC: 8)
  - [ ] Handle authentication failures (401, 403) → raise AuthenticationError
  - [ ] Handle quota exceeded (429, or provider-specific codes) → raise RateLimitError
  - [ ] Handle invalid symbols (404, or provider error messages) → raise SymbolNotFoundError
  - [ ] Handle network errors → retry with exponential backoff
  - [ ] Handle malformed responses → log and raise DataParsingError
  - [ ] Log all errors with provider and request context
- [ ] Implement integration tests with demo API keys (AC: 9)
  - [ ] Document test API key setup in tests/README.md
  - [ ] Test Polygon adapter with demo API key (requires registration)
  - [ ] Test Alpaca adapter with paper trading API key
  - [ ] Test Alpha Vantage adapter with free tier API key
  - [ ] Mark tests as integration with @pytest.mark.api_integration
  - [ ] Skip tests if API keys not configured
  - [ ] Test rate limiting with actual API calls
- [ ] Create provider setup documentation (AC: 10)
  - [ ] Document API key registration for each provider in docs/architecture/live-trading.md
  - [ ] Provide .env.example with API key placeholders
  - [ ] Document rate limits and tier differences for each provider
  - [ ] Provide configuration examples for each adapter
  - [ ] Add troubleshooting guide for common API errors
  - [ ] Document data coverage and limitations per provider

## Dev Notes

### Previous Story Insights
[From Epic 6 PRD Story 6.9]
- API provider adapters for Polygon, Alpaca, Alpha Vantage
- Authentication support (API keys, OAuth)
- Rate limiting per provider tier
- Error handling for auth failures, quota exceeded, invalid symbols

### Architecture Context

**Data Adapter Pattern:**
[Source: architecture/component-architecture.md#data-adapter-components]
- BaseDataAdapter: Extensible framework for data sources
- Standard schema: timestamp, symbol, open, high, low, close, volume (Decimal columns)
- Validation: OHLCV relationships, outlier detection, temporal consistency
- Standardization: Provider-specific formats converted to RustyBT schema

**External API Integration:**
[Source: architecture/external-api-integration.md#data-api-integration]
- Polygon.io: Stocks, options, forex, crypto; Real-time and historical; $29-$399/month
- Alpaca: Commission-free stock trading; Real-time market data; Free for paper trading
- Alpha Vantage: Stocks, forex, crypto, technical indicators; Free: 5 req/min, 500 req/day; Premium: $49.99-$499/month

**Tech Stack:**
[Source: architecture/tech-stack.md]
- aiohttp for async HTTP requests
- Python Decimal for all price and volume data
- Pydantic for API response validation
- asyncio for async operations

**Coding Standards:**
[Source: architecture/coding-standards.md]
- Type hints: mypy --strict compliance
- Async/await for all API calls
- Structured logging for API requests and errors
- Error handling: AuthenticationError, RateLimitError, SymbolNotFoundError

### File Locations
[Source: architecture/source-tree.md]
- Base adapter: `rustybt/data/adapters/api_provider_base.py`
- Polygon adapter: `rustybt/data/adapters/polygon_adapter.py`
- Alpaca adapter: `rustybt/data/adapters/alpaca_adapter.py`
- Alpha Vantage adapter: `rustybt/data/adapters/alphavantage_adapter.py`
- Rate limiter: `rustybt/data/adapters/rate_limiter.py`
- Tests: `tests/data/adapters/test_polygon.py`, `tests/data/adapters/test_alpaca.py`, `tests/data/adapters/test_alphavantage.py`
- Documentation: `docs/architecture/live-trading.md` (add data API providers section)

### Integration Points
- DataCatalog: Registers API provider adapters for data ingestion
- PolarsDataPortal: Uses adapters to fetch historical data
- BaseDataAdapter: Extended by BaseAPIProviderAdapter

**CCXT Pro Note:** ccxt.pro is a separate package (professional version) with WebSocket support. For this story, implement REST API using standard ccxt 4.x+. WebSocket support via ccxt.pro is optional enhancement, not required for AC compliance.

### API Provider Details

**Polygon.io:**
- Base URL: https://api.polygon.io
- Authentication: API key in query param (?apikey=...) or Authorization header
- Rate limits: Free (5 req/min), Starter (10 req/min), Developer (100 req/min)
- Coverage: Stocks, options, forex, crypto; US and global markets
- Docs: https://polygon.io/docs

**Alpaca:**
- Base URL: https://data.alpaca.markets (market data), https://api.alpaca.markets (trading)
- Authentication: APCA-API-KEY-ID and APCA-API-SECRET-KEY headers
- Rate limits: 200 req/min (data API), 200 req/min (trading API)
- Coverage: US stocks; Free for paper trading
- Docs: https://alpaca.markets/docs

**Alpha Vantage:**
- Base URL: https://www.alphavantage.co/query
- Authentication: apikey query parameter
- Rate limits: Free (5 req/min, 500 req/day), Premium (75 req/min, 1200 req/day)
- Coverage: Stocks, forex, crypto, technical indicators; Global markets
- Docs: https://www.alphavantage.co/documentation

### API Key Configuration Example (.env)
```
POLYGON_API_KEY=your_polygon_api_key_here
ALPACA_API_KEY=your_alpaca_key_id_here
ALPACA_API_SECRET=your_alpaca_secret_key_here
ALPHAVANTAGE_API_KEY=your_alphavantage_api_key_here
```

### Rate Limiting Example
```python
rate_limiter = RateLimiter(
    requests_per_minute=5,  # Free tier limit
    requests_per_day=500     # Free tier daily limit
)

await rate_limiter.acquire()  # Blocks if limit reached
# Make API request
```

### Testing
[Source: architecture/testing-strategy.md]

**Test Location:**
- Unit tests: `tests/data/adapters/test_*_adapter.py` (mock API responses)
- Integration tests: `tests/integration/data/test_api_providers.py` (real API calls)

**Testing Standards:**
- Unit tests: ≥90% coverage (mock HTTP responses with aioresponses)
- Integration tests: Require valid API keys (skip if not configured)
- Mark integration tests: @pytest.mark.api_integration
- Test rate limiting with real API quota tracking

**Key Test Scenarios:**
- Authentication succeeds with valid API key
- Data fetching returns correct OHLCV format
- Rate limiting blocks when quota reached
- Authentication error raised for invalid API key
- Rate limit error raised when quota exceeded
- Symbol not found error raised for invalid symbols
- Response parsing handles various data formats
- Retry logic handles transient network errors

**Test Fixtures:**
- Mock API responses for each provider
- Sample OHLCV data in provider-specific format
- API keys from environment variables (document setup)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation (moved from Epic 3) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
Not yet implemented

### Completion Notes List
Not yet implemented

### File List
Not yet implemented

## QA Results
Not yet implemented
