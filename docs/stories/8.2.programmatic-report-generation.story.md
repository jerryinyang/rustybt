# Story 8.2: Programmatic Report Generation

## Status
Ready for development

## Story
**As a** quantitative trader,
**I want** automated report generation with charts and metrics,
**so that** I can produce professional backtest reports without manual effort.

## Acceptance Criteria
1. ReportGenerator class creates PDF or HTML reports
2. Report includes equity curve, drawdown chart, returns distribution histogram
3. Report includes performance metrics table (Sharpe, Sortino, max drawdown, etc.)
4. Report includes trade statistics (win rate, average win/loss, profit factor)
5. Report includes position distribution (top holdings, sector exposure if applicable)
6. Report customizable (select sections, add custom charts)
7. Report generation uses matplotlib/seaborn for charts (publication-quality)
8. Report exportable as PDF (using reportlab or matplotlib PDF backend) or HTML
9. Tests validate report generation completes without errors
10. Example demonstrates generating report for completed backtest

## Tasks / Subtasks
- [ ] Create ReportGenerator class (AC: 1)
  - [ ] Implement `__init__(backtest_result, config)`
  - [ ] Implement `generate_report(output_path, format='html')`
  - [ ] Support both HTML and PDF output formats
- [ ] Implement chart generation (AC: 2, 7)
  - [ ] Create `_generate_equity_curve()` using matplotlib
  - [ ] Create `_generate_drawdown_chart()` using matplotlib
  - [ ] Create `_generate_returns_distribution()` using seaborn
  - [ ] Ensure publication-quality styling (high DPI, clean fonts)
  - [ ] Save charts as embedded images in report
- [ ] Implement metrics table (AC: 3)
  - [ ] Extract performance metrics from backtest result
  - [ ] Format as HTML table or PDF table
  - [ ] Include: Total Return, Sharpe Ratio, Sortino Ratio, Max Drawdown, Calmar Ratio, Win Rate, etc.
- [ ] Implement trade statistics (AC: 4)
  - [ ] Calculate win rate, average win, average loss, profit factor
  - [ ] Calculate largest win, largest loss, average holding period
  - [ ] Format as table in report
- [ ] Implement position distribution (AC: 5)
  - [ ] Extract top holdings from positions history
  - [ ] Calculate average position size, max position size
  - [ ] If sector/industry data available, show sector exposure
  - [ ] Create bar chart or pie chart for position distribution
- [ ] Implement customization (AC: 6)
  - [ ] Create ReportConfig dataclass with section toggles
  - [ ] Support adding custom charts via callback functions
  - [ ] Support custom report title, subtitle, logo
- [ ] Implement HTML export (AC: 8)
  - [ ] Use Jinja2 templates for HTML layout
  - [ ] Embed base64-encoded images
  - [ ] Include CSS styling for professional appearance
  - [ ] Ensure mobile-responsive layout
- [ ] Implement PDF export (AC: 8)
  - [ ] Use matplotlib PDF backend for simple reports
  - [ ] Or use reportlab for more complex layouts
  - [ ] Ensure charts are high-resolution (300 DPI)
- [ ] Write tests (AC: 9)
  - [ ] Unit test: Each chart generation function
  - [ ] Integration test: Full report generation (HTML and PDF)
  - [ ] Test: Report generation with missing data (graceful degradation)
  - [ ] Test: Custom sections and custom charts
- [ ] Create example (AC: 10)
  - [ ] Example script: `examples/generate_backtest_report.py`
  - [ ] Example notebook: `examples/notebooks/report_generation.ipynb`

## Dev Notes

### Relevant Source Tree
[Source: docs/architecture/source-tree.md]
- ReportGenerator: `rustybt/analytics/reports.py` (NEW)
- Templates: `rustybt/analytics/templates/` directory (HTML templates)
- Example: `examples/generate_backtest_report.py`

### Tech Stack
[Source: docs/architecture/tech-stack.md]
- **Chart Generation**: **matplotlib** and **seaborn** (publication-quality charts)
- **HTML Templates**: **Jinja2** (standard Python templating)
- **PDF Generation**: **matplotlib PDF backend** (simple) or **reportlab** (advanced)
- **Image Handling**: **Pillow** (if needed for logo embedding)

### Report Structure
A typical report should include:
1. **Cover Page**: Title, strategy name, date range, logo (if provided)
2. **Executive Summary**: Key metrics, total return, Sharpe ratio
3. **Performance Charts**: Equity curve, drawdown, returns distribution
4. **Metrics Table**: Comprehensive performance metrics
5. **Trade Statistics**: Win rate, profit factor, average holding period
6. **Position Analysis**: Top holdings, position distribution
7. **Risk Analysis**: Volatility, max drawdown, downside deviation
8. **Appendix**: Full trade log (optional), configuration used

### Example Code Pattern
```python
from dataclasses import dataclass
from pathlib import Path
from typing import Optional, List, Callable
import matplotlib.pyplot as plt
import seaborn as sns
from jinja2 import Environment, PackageLoader

@dataclass
class ReportConfig:
    """Configuration for report generation."""
    title: str = "Backtest Report"
    subtitle: Optional[str] = None
    logo_path: Optional[Path] = None
    include_equity_curve: bool = True
    include_drawdown: bool = True
    include_returns_distribution: bool = True
    include_metrics_table: bool = True
    include_trade_statistics: bool = True
    include_position_distribution: bool = True
    custom_charts: List[Callable] = field(default_factory=list)

class ReportGenerator:
    """Generate professional backtest reports."""

    def __init__(self, backtest_result, config: ReportConfig = None):
        self.backtest_result = backtest_result
        self.config = config or ReportConfig()
        self.env = Environment(loader=PackageLoader('rustybt', 'analytics/templates'))

    def generate_report(self, output_path: Path, format: str = 'html'):
        """Generate report in HTML or PDF format."""
        if format == 'html':
            self._generate_html_report(output_path)
        elif format == 'pdf':
            self._generate_pdf_report(output_path)
        else:
            raise ValueError(f"Unsupported format: {format}")

    def _generate_html_report(self, output_path: Path):
        """Generate HTML report."""
        template = self.env.get_template('report.html')

        # Generate charts
        charts = {}
        if self.config.include_equity_curve:
            charts['equity_curve'] = self._generate_equity_curve()
        if self.config.include_drawdown:
            charts['drawdown'] = self._generate_drawdown_chart()

        # Render template
        html = template.render(
            config=self.config,
            metrics=self._get_metrics(),
            charts=charts,
            trades=self._get_trade_statistics()
        )

        output_path.write_text(html)

    def _generate_equity_curve(self) -> str:
        """Generate equity curve chart, return base64 encoded image."""
        fig, ax = plt.subplots(figsize=(10, 6))
        df = self.backtest_result.to_pandas()
        ax.plot(df['date'], df['portfolio_value'])
        ax.set_title('Equity Curve')
        ax.set_xlabel('Date')
        ax.set_ylabel('Portfolio Value')

        # Save to BytesIO and encode as base64
        from io import BytesIO
        import base64
        buf = BytesIO()
        fig.savefig(buf, format='png', dpi=150)
        buf.seek(0)
        img_base64 = base64.b64encode(buf.read()).decode()
        plt.close(fig)
        return f"data:image/png;base64,{img_base64}"
```

### Testing
[Source: docs/architecture/testing-strategy.md]
- **Test Location**: `tests/analytics/test_reports.py`
- **Test Types**:
  - Unit tests: Chart generation functions, metrics extraction
  - Integration tests: Full report generation (verify output files created)
  - Visual tests: Manual inspection of generated reports (sample saved to `tests/resources/`)
- **Coverage Target**: â‰¥90%

### Zero-Mock Enforcement
[Source: docs/architecture/coding-standards.md#zero-mock-enforcement-mandatory]
- Charts must plot actual backtest data, not hardcoded values
- Metrics must be calculated from actual results, not mocked
- Report generation must create actual files, not return fake paths

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-31 | 1.0 | Initial story draft | Bob (Scrum Master) |

## Dev Agent Record
_This section will be populated by the development agent during implementation._

### Agent Model Used
_Not yet populated_

### Debug Log References
_Not yet populated_

### Completion Notes List
_Not yet populated_

### File List
_Not yet populated_

## QA Results
_This section will be populated by the QA Agent after story completion._
