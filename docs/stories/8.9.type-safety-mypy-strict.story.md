# Story 8.9: Enforce Type Safety with mypy --strict

## Status
Ready for development

## Story
**As a** developer,
**I want** strict type checking enforced across the codebase,
**so that** type-related bugs are caught at development time, not runtime.

## Acceptance Criteria
1. mypy --strict enabled in CI/CD (builds fail on type errors)
2. All functions and methods have type hints (parameters and return types)
3. Type hints cover collections (List[str], Dict[str, Decimal], etc.)
4. Optional types used explicitly (Optional[int] for nullable)
5. Generic types used where applicable (TypeVar for generic functions)
6. External library stubs installed where available (types-* packages)
7. Any types eliminated or explicitly marked as intentional (# type: ignore with justification)
8. Tests validate type hints are correct (mypy passes with no errors)
9. Pre-commit hooks run mypy on changed files (catch errors before commit)
10. Documentation explains type hinting conventions and best practices

## Tasks / Subtasks
- [ ] Configure mypy --strict (AC: 1)
  - [ ] Add mypy configuration to pyproject.toml
  - [ ] Enable --strict mode (all strictness flags)
  - [ ] Configure mypy to check all source files in rustybt/
  - [ ] Add mypy to CI/CD pipeline (GitHub Actions)
  - [ ] Fail builds on any mypy errors
- [ ] Add type hints to all functions/methods (AC: 2)
  - [ ] Audit codebase for functions missing type hints
  - [ ] Add parameter type hints
  - [ ] Add return type hints
  - [ ] Use None for void functions
- [ ] Add type hints for collections (AC: 3)
  - [ ] Replace bare list → List[T] or list[T] (Python 3.12+)
  - [ ] Replace bare dict → Dict[K, V] or dict[K, V]
  - [ ] Use tuple, set with type parameters
  - [ ] Example: `def get_assets() -> List[Asset]:`
- [ ] Use Optional for nullable values (AC: 4)
  - [ ] Replace T | None → Optional[T] (or use union syntax in Python 3.12+)
  - [ ] Make nullable parameters explicit
  - [ ] Example: `def get_position(asset: Asset) -> Optional[Position]:`
- [ ] Implement generic types where applicable (AC: 5)
  - [ ] Use TypeVar for generic functions
  - [ ] Example: Generic data loaders, generic validators
  - [ ] Document when to use generics vs. concrete types
- [ ] Install external library type stubs (AC: 6)
  - [ ] Install types-* packages for third-party libraries
  - [ ] Add to pyproject.toml: types-requests, types-pytz, types-redis, etc.
  - [ ] Verify stubs are detected by mypy
- [ ] Eliminate or justify Any types (AC: 7)
  - [ ] Search codebase for `: Any` type hints
  - [ ] Replace with concrete types where possible
  - [ ] If Any is necessary, add `# type: ignore[<code>]` with justification comment
  - [ ] Document acceptable uses of Any (e.g., truly dynamic data)
- [ ] Fix mypy errors across codebase (AC: 8)
  - [ ] Run mypy --strict rustybt/ and fix all errors
  - [ ] Common fixes: missing return types, untyped function calls, incompatible types
  - [ ] May require refactoring for type safety
- [ ] Add mypy to pre-commit hooks (AC: 9)
  - [ ] Configure pre-commit to run mypy on staged files
  - [ ] Use mypy mirrors-mypy hook
  - [ ] Catch type errors before commit
- [ ] Write documentation (AC: 10)
  - [ ] Document type hinting conventions (follow PEP 484, PEP 526)
  - [ ] Provide examples: common type hint patterns
  - [ ] Document when to use Optional, Union, TypeVar, Protocol
  - [ ] Add to coding standards guide

## Dev Notes

### Relevant Source Tree
[Source: docs/architecture/source-tree.md]
- All Python files in `rustybt/` will be type-checked
- Configuration: `pyproject.toml` (mypy section)
- Pre-commit config: `.pre-commit-config.yaml`

### Tech Stack
[Source: docs/architecture/tech-stack.md]
- **Type Checker**: **mypy** >= 1.10.0 (already in tech stack)
- **Python Version**: 3.12+ (modern type hint syntax)

### mypy --strict Configuration
[Source: docs/architecture/coding-standards.md#type-hints]
```toml
# pyproject.toml

[tool.mypy]
python_version = "3.12"
strict = true
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_any_unimported = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
warn_unreachable = true
strict_equality = true

# Exclude generated files or third-party code
exclude = [
    "build/",
    "dist/",
    ".eggs/",
    "*.egg-info/",
]

# Per-module options (if needed for gradual typing)
[[tool.mypy.overrides]]
module = "rustybt.legacy.*"  # Example: legacy code not yet fully typed
ignore_errors = true
```

### Type Hinting Best Practices
[Source: docs/architecture/coding-standards.md#type-hints]

**1. Function Type Hints:**
```python
from decimal import Decimal
from typing import List, Optional

def calculate_portfolio_value(
    positions: List[DecimalPosition],
    cash: Decimal
) -> Decimal:
    """Calculate total portfolio value."""
    positions_value = sum(p.market_value for p in positions, Decimal(0))
    return positions_value + cash
```

**2. Optional Types:**
```python
def find_position(asset: Asset) -> Optional[DecimalPosition]:
    """Find position for asset, returns None if not found."""
    return self._positions.get(asset.sid)
```

**3. Generic Types:**
```python
from typing import TypeVar, Generic

T = TypeVar('T')

class DataLoader(Generic[T]):
    """Generic data loader."""
    
    def load(self, source: str) -> List[T]:
        """Load data from source."""
        ...
```

**4. Protocol for Structural Typing:**
```python
from typing import Protocol

class BrokerAdapter(Protocol):
    """Protocol for broker adapters."""
    
    def submit_order(self, asset: Asset, amount: Decimal) -> str:
        """Submit order to broker."""
        ...
    
    def get_positions(self) -> List[Position]:
        """Get current positions."""
        ...
```

**5. Union Types (Python 3.12+):**
```python
def process_price(price: Decimal | float) -> Decimal:
    """Process price, accepting Decimal or float."""
    if isinstance(price, float):
        return Decimal(str(price))
    return price
```

### CI/CD Integration
```yaml
# .github/workflows/ci.yml

jobs:
  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Run mypy
        run: |
          mypy --strict rustybt/
```

### Pre-commit Hook
```yaml
# .pre-commit-config.yaml

repos:
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.10.0
    hooks:
      - id: mypy
        additional_dependencies: [types-all]
        args: [--strict, --ignore-missing-imports]
```

### Common mypy Errors and Fixes

**Error: Missing return type**
```python
# ❌ Before
def get_price(asset):
    return asset.price

# ✅ After
def get_price(asset: Asset) -> Decimal:
    return asset.price
```

**Error: Incompatible return type**
```python
# ❌ Before
def get_position(asset: Asset) -> Position:
    return self._positions.get(asset.sid)  # May return None

# ✅ After
def get_position(asset: Asset) -> Optional[Position]:
    return self._positions.get(asset.sid)
```

**Error: Untyped function call**
```python
# ❌ Before (third-party library without stubs)
import some_library

result = some_library.process(data)  # mypy can't infer types

# ✅ After (install type stubs or add explicit type)
import some_library
from typing import cast

result = cast(ProcessedData, some_library.process(data))
```

**Error: Need to use Any (justified)**
```python
# ✅ Acceptable use of Any with justification
from typing import Any

def serialize_to_json(obj: Any) -> str:
    """Serialize any object to JSON.
    
    Uses Any because JSON can represent arbitrary data structures.
    """
    return json.dumps(obj)
```

### Gradual Typing Strategy
If codebase has many type errors initially:
1. Start with critical modules (finance, trading engine)
2. Use `# type: ignore` temporarily for non-critical modules
3. Create tracking issue for each ignored module
4. Fix modules incrementally in future sprints

### Testing
[Source: docs/architecture/testing-strategy.md]
- **Test Type**: Static analysis (mypy runs as part of CI/CD)
- **Success Criteria**: `mypy --strict rustybt/` exits with code 0 (no errors)
- **Pre-commit**: mypy runs on changed files before commit

### Zero-Mock Enforcement
[Source: docs/architecture/coding-standards.md#zero-mock-enforcement-mandatory]
- Type hints must reflect actual types, not fake types
- Tests verify mypy actually runs (not mocked)
- CI must actually fail on type errors (not bypassed)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-31 | 1.0 | Initial story draft | Bob (Scrum Master) |

## Dev Agent Record
_This section will be populated by the development agent during implementation._

### Agent Model Used
_Not yet populated_

### Debug Log References
_Not yet populated_

### Completion Notes List
_Not yet populated_

### File List
_Not yet populated_

## QA Results
_This section will be populated by the QA Agent after story completion._
