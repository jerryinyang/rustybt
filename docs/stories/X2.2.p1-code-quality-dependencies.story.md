# Story X2.2: P1 Code Quality Baseline & Dependencies

## Status
Draft

## Story

**As a** Software Engineer maintaining RustyBT's codebase quality and supply chain security,
**I want** a clean code quality baseline with enforced linting, scoped type checking, secure dependency hygiene, comprehensive CI/CD pipeline, and zero-mock enforcement,
**so that** the codebase maintains high standards, prevents quality drift, minimizes supply chain vulnerability exposure, and enforces real implementations in production.

## Acceptance Criteria

### Phase 1: Linting & Formatting

1. **Ruff Auto-Fixes Applied**
   - Run `ruff check . --fix` to auto-remediate fixable violations
   - Repeat `ruff check . --fix` until no more auto-fixes available
   - Manually fix remaining violations (invalid noqa directives, annotations, etc.)
   - Configure McCabe complexity limit in `pyproject.toml`: `max-complexity = 10`
   - Final `ruff check .` reports 0 errors (warnings acceptable if documented)
   - Document ruff configuration changes in commit message

2. **Legacy Docstring Enforcement Strategy**
   - Identify legacy files with extensive docstring violations
   - Add per-file ignores to `[tool.ruff.lint.extend-per-file-ignores]` for legacy files
   - Ignore codes: D100 (module docstring), D101 (class docstring), D102 (method docstring) as needed
   - New files (Epic 8+) maintain full docstring compliance
   - Document strategy: "Legacy files exempted, new code strict" in CONTRIBUTING.md

3. **Black Formatting Applied**
   - Run `black .` to format all Python files
   - Verify `black --check .` reports 0 files to reformat
   - Line length configuration matches existing: 100 (check pyproject.toml)
   - No functionality changes from formatting (verified via tests)
   - Commit formatting changes separately from functional changes

### Phase 2: Type Checking

4. **Mypy Strict Enforcement on Scoped Modules**
   - Verify scoped strict modules in pyproject.toml: `rustybt/exceptions.py`, `rustybt/utils/logging.py`, `rustybt/utils/error_handling.py`
   - Add Epic 8 modules to strict list: `rustybt/analytics/*`, `rustybt/utils/secure_pickle.py`
   - Run `python3 -m mypy` (project config) → 0 errors for strict modules
   - Legacy modules use relaxed settings via `[[tool.mypy.overrides]]`
   - Document gradual typing migration strategy in docs/guides/type-hinting.md

5. **Type Stubs**
   - Verify dev extras include: `pandas-stubs`, `types-networkx`, `types-requests`, `types-PyYAML`
   - Add missing stubs if identified during mypy execution
   - Configure `ignore_missing_imports = true` for libraries without stubs: `exchange_calendars`, etc.
   - Document stub availability in type-hinting guide

6. **Low-Hanging Type Annotations**
   - Fix `rustybt/extensions.py` annotations per gap analysis:
     - `extension_args: dict[str, str]` (or appropriate type)
     - `custom_types: dict[str, type]` (or appropriate type)
   - Fix any top-level annotation errors that block mypy execution
   - Run mypy to verify fixes resolve errors

### Phase 3: Dependency Hygiene

7. **Production vs Dev Split**
   - Create `[project.optional-dependencies].dev` extra for development-only packages
   - Move to dev extra: `jupyter`, `jupyterlab`, `streamlit`, `torch` (if present)
   - Move to dev extra: Type stubs (`pandas-stubs`, `types-*`)
   - Move to dev extra: Testing tools (already in test extra)
   - Verify core dependencies remain in `[project.dependencies]`
   - Document installation: `uv sync` (prod) vs. `uv sync -E dev -E test` (dev)

8. **Vulnerability Remediation**
   - Run `safety scan` to identify vulnerable packages
   - Prioritize High/Critical vulnerabilities for immediate upgrade
   - Upgrade packages to patched versions where available
   - Pin packages with known vulnerabilities if upgrade breaks compatibility
   - Document unresolved vulnerabilities with justification and mitigation plan
   - Verify production extras exclude dev-only vulnerable packages

9. **Lockfile Verification & License Compliance**
   - Run `uv lock` to update lock file with new versions
   - Verify `uv.lock` includes vulnerability metadata (if supported)
   - Run test suite with new lockfile: `uv sync -E test && pytest`
   - Verify no dependency resolution conflicts
   - Create `scripts/check_licenses.py` to scan dependency licenses
   - Ensure no GPL-licensed dependencies (Apache 2.0/MIT only)
   - Document any exceptions with justification
   - Commit updated `uv.lock` with story changes

### Phase 4: Pre-Commit Hooks

10. **Basic Quality Hooks Installed**
    - `.pre-commit-config.yaml` includes ruff hook with `--fix` arg
    - `.pre-commit-config.yaml` includes black hook
    - `.pre-commit-config.yaml` includes mypy hook (scoped to strict modules)
    - Run `pre-commit install` and document in CONTRIBUTING.md
    - Run `pre-commit run --all-files` passes successfully
    - Hooks tested with sample commit (verify they run and block bad commits)

### Phase 5: Zero-Mock Enforcement

11. **Mock Detection Scripts Created**
    - Create `scripts/detect_mocks.py` → Scan for mock patterns (function names with "mock"/"fake"/"stub", hardcoded return values)
    - Create `scripts/detect_hardcoded_values.py` → Detect functions that return constants (return 10, return True, return 1.5)
    - Create `scripts/verify_validations.py` → Verify validation functions actually reject invalid data
    - Create `scripts/test_unique_results.py` → Verify different inputs produce different outputs
    - Add pre-commit hook for `detect_mocks.py --quick`

12. **Zero-Mock Enforcement Validation**
    - Run `pre-commit run --all-files` → 0 mock violations found
    - Run `python scripts/detect_mocks.py --strict` → 0 mock patterns detected
    - Run `python scripts/detect_hardcoded_values.py --fail-on-found` → 0 hardcoded values found
    - Run `python scripts/verify_validations.py --ensure-real-checks` → All validators functional
    - Run `python scripts/test_unique_results.py` → All functions produce unique outputs
    - Document zero-mock policy in CONTRIBUTING.md with examples of forbidden patterns

### Phase 6: CI/CD Pipeline

13. **Code Quality CI Job**
    - Add `.github/workflows/code-quality.yml` (or equivalent for GitLab/other CI)
    - BLOCKING: `ruff check .` (must pass with 0 errors)
    - BLOCKING: `black --check .` (must pass with 0 files to reformat)
    - BLOCKING: `python3 -m mypy` (must pass for scoped modules)
    - BLOCKING: `python scripts/check_complexity.py` (McCabe ≤10 for all functions)
    - Branch protection rules require this job to pass before merge

14. **Zero-Mock Enforcement CI Job**
    - Add `.github/workflows/zero-mock-enforcement.yml` (BLOCKING)
    - BLOCKING: `python scripts/detect_mocks.py --strict` (0 mock patterns)
    - BLOCKING: `python scripts/detect_hardcoded_values.py --fail-on-found` (0 hardcoded values)
    - BLOCKING: `python scripts/verify_validations.py --ensure-real-checks` (all validators work)
    - BLOCKING: `python scripts/test_unique_results.py` (unique outputs)
    - Branch protection rules require this job to pass before merge

15. **Security CI Job**
    - Add `.github/workflows/security.yml`
    - BLOCKING: `bandit -r rustybt -ll -i` (0 High severity issues)
    - BLOCKING: `truffleHog --regex --entropy=False .` (0 secrets detected)
    - BLOCKING: `detect-secrets scan` (0 secrets detected)
    - Branch protection rules require this job to pass before merge

16. **Testing CI Job**
    - Add `.github/workflows/testing.yml`
    - Run unit tests: `pytest -m "not memory and not api_integration and not live and not ib_integration" --cov=rustybt --cov-report=term --cov-report=html`
    - Verify coverage: Core modules ≥90%, financial modules (finance/*, analytics/*) ≥95%
    - Run property-based tests: `pytest -m "property" --hypothesis-profile=ci` (1000+ examples per test)
    - Upload coverage reports as artifacts
    - BLOCKING: Coverage thresholds must be met

17. **Dependency Security CI Job (Weekly)**
    - Add `.github/workflows/dependency-security.yml` (scheduled: weekly)
    - `safety scan --json > safety-report.json`
    - `pip-audit --format json > pip-audit-report.json`
    - `python scripts/check_licenses.py` (verify no GPL-licensed dependencies)
    - Upload security reports as artifacts
    - NON-BLOCKING: Creates issues for vulnerabilities but doesn't block merges

18. **Performance Regression CI Job (Main Branch Only)**
    - Add `.github/workflows/performance.yml` (on main branch after merge)
    - `python -m rustybt benchmark --suite backtest --output benchmark-results.json`
    - `python scripts/check_performance_regression.py --threshold=0.20 --baseline=benchmark-baseline.json`
    - Fail if performance degrades >20%
    - NON-BLOCKING: Creates issues for regressions but doesn't block merges

### Integration Requirements

19. **Existing Functionality Unchanged**
    - Full test suite passes after formatting/linting: `pytest -m "not memory and not api_integration and not live and not ib_integration"`
    - Smoke test: bundle ingestion, backtest execution, report generation
    - Manual verification: paper trading starts successfully
    - No functionality changes from code quality fixes (pure style/type changes)

20. **Code Quality Enforcement Follows Existing Patterns**
    - Ruff configuration extends existing `[tool.ruff]` settings
    - Black configuration matches existing line length and style
    - Mypy overrides extend existing `[[tool.mypy.overrides]]` pattern
    - Pre-commit hooks follow existing `.pre-commit-config.yaml` structure
    - CI jobs follow existing CI/CD pipeline patterns

21. **Development Workflow Integration**
    - Pre-commit hooks run fast (< 5 seconds for typical commit)
    - Hooks provide clear error messages when blocking commits
    - IDE integrations work (VS Code, PyCharm support ruff/black/mypy)
    - Documentation guides new contributors through setup: `pre-commit install`

### Quality Requirements

22. **Changes Covered by Tests**
    - Test suite passes with new code quality tools
    - Test suite passes with new dependency versions
    - Mypy strict modules have unit tests with good coverage
    - No new untested code introduced by fixes
    - CI pipeline tests verify code quality enforcement

23. **Documentation Updated**
    - `CONTRIBUTING.md` documents pre-commit setup: `pre-commit install`
    - `CONTRIBUTING.md` documents zero-mock policy with forbidden pattern examples
    - `docs/guides/type-hinting.md` updated with gradual typing strategy
    - `docs/guides/type-hinting.md` lists strict modules and migration plan
    - `docs/development/ci-cd-pipeline.md` created documenting all CI jobs
    - README.md updated with dev extras installation: `uv sync -E dev -E test`
    - `docs/security-audit.md` updated with dependency vulnerability tracking
    - `CHANGELOG.md` updated with Epic X2 summary
    - Verify 100% docstring coverage for all public APIs in Epic 8 modules using `docstr-coverage` tool

24. **No Regression Verified**
    - Full test suite passes: `pytest -m "not memory and not api_integration and not live and not ib_integration"`
    - Coverage remains ≥90% for core modules
    - CI/CD pipeline green end-to-end
    - Pre-commit hooks do not block legitimate commits

## Tasks / Subtasks

- [ ] **Task 1: Ruff Linting** (AC: 1-2)
  - [ ] Run `ruff check . --fix` (repeat until stable)
  - [ ] Manually fix remaining violations (invalid noqa, annotations)
  - [ ] Configure McCabe complexity: `max-complexity = 10` in pyproject.toml
  - [ ] Add legacy docstring exemptions to `[tool.ruff.lint.extend-per-file-ignores]`
  - [ ] Verify: `ruff check .` → 0 errors
  - [ ] Document strategy in CONTRIBUTING.md

- [ ] **Task 2: Black Formatting** (AC: 3)
  - [ ] Run `black .` to format all files
  - [ ] Verify: `black --check .` → 0 files to reformat
  - [ ] Verify line length configuration (100)
  - [ ] Run test suite to verify no functionality changes
  - [ ] Commit formatting changes separately

- [ ] **Task 3: Mypy Type Checking** (AC: 4-6)
  - [ ] Verify scoped strict modules in pyproject.toml
  - [ ] Add Epic 8 modules to strict list: `analytics/*`, `utils/secure_pickle.py`
  - [ ] Fix `rustybt/extensions.py` annotations
  - [ ] Fix any top-level annotation errors
  - [ ] Verify dev extras include type stubs: pandas-stubs, types-networkx, types-requests, types-PyYAML
  - [ ] Configure `ignore_missing_imports` for libraries without stubs
  - [ ] Run: `python3 -m mypy` → 0 errors for strict modules
  - [ ] Document gradual typing strategy in docs/guides/type-hinting.md

- [ ] **Task 4: Dependency Hygiene - Production/Dev Split** (AC: 7)
  - [ ] Create `[project.optional-dependencies].dev` extra
  - [ ] Move jupyter/jupyterlab/streamlit/torch to dev extra
  - [ ] Move type stubs to dev extra
  - [ ] Verify core dependencies remain in `[project.dependencies]`
  - [ ] Document installation commands in README

- [ ] **Task 5: Dependency Hygiene - Vulnerability Remediation** (AC: 8)
  - [ ] Run `safety scan` to identify vulnerable packages
  - [ ] Upgrade High/Critical vulnerable packages to patched versions
  - [ ] Pin packages with vulnerabilities if upgrade breaks compatibility
  - [ ] Document unresolved vulnerabilities with justification
  - [ ] Verify production extras exclude dev-only vulnerable packages

- [ ] **Task 6: Dependency Hygiene - Lockfile & License Compliance** (AC: 9)
  - [ ] Run `uv lock` to update lockfile
  - [ ] Run test suite: `uv sync -E test && pytest`
  - [ ] Verify no dependency resolution conflicts
  - [ ] Create `scripts/check_licenses.py` to scan licenses
  - [ ] Verify no GPL-licensed dependencies
  - [ ] Document any license exceptions
  - [ ] Commit updated `uv.lock`

- [ ] **Task 7: Pre-Commit Hooks Configuration** (AC: 10)
  - [ ] Create/update `.pre-commit-config.yaml` with ruff hook (--fix)
  - [ ] Add black hook to `.pre-commit-config.yaml`
  - [ ] Add mypy hook to `.pre-commit-config.yaml` (scoped to strict modules)
  - [ ] Run `pre-commit install`
  - [ ] Run `pre-commit run --all-files` → verify passes
  - [ ] Test with sample commit → verify hooks run and block bad commits
  - [ ] Document setup in CONTRIBUTING.md

- [ ] **Task 8: Zero-Mock Detection Scripts** (AC: 11)
  - [ ] Create `scripts/detect_mocks.py` with mock pattern detection
  - [ ] Create `scripts/detect_hardcoded_values.py` with constant return detection
  - [ ] Create `scripts/verify_validations.py` with validator testing
  - [ ] Create `scripts/test_unique_results.py` with output uniqueness testing
  - [ ] Add `detect_mocks.py --quick` to `.pre-commit-config.yaml`
  - [ ] Test all scripts locally

- [ ] **Task 9: Zero-Mock Enforcement Validation** (AC: 12)
  - [ ] Run `pre-commit run --all-files` → 0 violations
  - [ ] Run all zero-mock detection scripts → verify 0 violations
  - [ ] Document zero-mock policy in CONTRIBUTING.md
  - [ ] Add examples of forbidden patterns to documentation
  - [ ] Add zero-mock enforcement to PR checklist template

- [ ] **Task 10: CI/CD - Code Quality Job** (AC: 13)
  - [ ] Create `.github/workflows/code-quality.yml`
  - [ ] Add job: `ruff check .` (BLOCKING)
  - [ ] Add job: `black --check .` (BLOCKING)
  - [ ] Add job: `python3 -m mypy` (BLOCKING)
  - [ ] Add job: `python scripts/check_complexity.py` (BLOCKING)
  - [ ] Configure branch protection rules
  - [ ] Test CI job with sample PR

- [ ] **Task 11: CI/CD - Zero-Mock Enforcement Job** (AC: 14)
  - [ ] Create `.github/workflows/zero-mock-enforcement.yml`
  - [ ] Add all zero-mock detection scripts as BLOCKING jobs
  - [ ] Configure branch protection rules
  - [ ] Test CI job with sample PR

- [ ] **Task 12: CI/CD - Security Job** (AC: 15)
  - [ ] Create `.github/workflows/security.yml`
  - [ ] Add job: `bandit -r rustybt -ll -i` (BLOCKING)
  - [ ] Add job: `truffleHog --regex --entropy=False .` (BLOCKING)
  - [ ] Add job: `detect-secrets scan` (BLOCKING)
  - [ ] Configure branch protection rules
  - [ ] Test CI job with sample PR

- [ ] **Task 13: CI/CD - Testing Job** (AC: 16)
  - [ ] Create `.github/workflows/testing.yml`
  - [ ] Add job: unit tests with coverage (BLOCKING if coverage < threshold)
  - [ ] Add job: property-based tests (BLOCKING)
  - [ ] Upload coverage reports as artifacts
  - [ ] Configure branch protection rules
  - [ ] Test CI job with sample PR

- [ ] **Task 14: CI/CD - Dependency Security Job (Weekly)** (AC: 17)
  - [ ] Create `.github/workflows/dependency-security.yml`
  - [ ] Configure schedule: weekly
  - [ ] Add job: `safety scan`
  - [ ] Add job: `pip-audit`
  - [ ] Add job: `check_licenses.py`
  - [ ] Upload security reports as artifacts
  - [ ] Test CI job manually

- [ ] **Task 15: CI/CD - Performance Regression Job** (AC: 18)
  - [ ] Create `.github/workflows/performance.yml`
  - [ ] Configure trigger: on main branch after merge
  - [ ] Add job: `benchmark --suite backtest`
  - [ ] Add job: `check_performance_regression.py --threshold=0.20`
  - [ ] Test CI job manually

- [ ] **Task 16: Integration Testing** (AC: 19-21)
  - [ ] Run full test suite after all changes
  - [ ] Run smoke tests: bundle ingestion, backtest, report generation
  - [ ] Verify paper trading starts successfully
  - [ ] Verify no functionality changes (pure style/type changes)
  - [ ] Verify pre-commit hooks run fast (< 5s)
  - [ ] Verify IDE integrations work

- [ ] **Task 17: Documentation Updates** (AC: 23)
  - [ ] Update CONTRIBUTING.md with pre-commit setup
  - [ ] Document zero-mock policy in CONTRIBUTING.md
  - [ ] Update docs/guides/type-hinting.md with gradual typing strategy
  - [ ] Create docs/development/ci-cd-pipeline.md
  - [ ] Update README with dev extras installation
  - [ ] Update docs/security-audit.md with vulnerability tracking
  - [ ] Update CHANGELOG.md with Epic X2 summary
  - [ ] Verify 100% docstring coverage for Epic 8 modules

- [ ] **Task 18: Final Validation** (AC: 24)
  - [ ] Run full test suite → all pass
  - [ ] Verify coverage ≥90% for core modules
  - [ ] Verify CI/CD pipeline green end-to-end
  - [ ] Verify pre-commit hooks work correctly
  - [ ] Create summary report of all changes

## Dev Notes

### Architecture Context

**Source:** [docs/architecture/tech-stack.md](../architecture/tech-stack.md)

**Code Quality Tools:**
- ruff >= 0.11.12 (fast linter, replaces flake8/isort/pyupgrade)
- black 24.1+ (code formatter)
- mypy >= 1.10.0 (static type checker with --strict)
- bandit (SAST security scanning)
- safety (dependency vulnerability scanning)

**Package Manager:**
- uv 0.5.x+ (10-100x faster than pip)
- Lockfile-based dependency resolution
- Support for extras: test, dev

**Python Version:** 3.12+ required

**Source:** [docs/architecture/coding-standards.md](../architecture/coding-standards.md)

**Type Hints:**
- 100% type hint coverage for public APIs
- `mypy --strict` compliance enforced in CI/CD for scoped modules
- Gradual migration: strict for new code (Epic 8+), relaxed for legacy

**Code Formatting:**
- black (line length: 100, target: py312)
- ruff linting (comprehensive rule set)
- Configuration in `pyproject.toml`

**Naming Conventions:**
- Classes: `PascalCase`
- Functions/methods: `snake_case`
- Constants: `UPPER_SNAKE_CASE`
- Private members: prefix with `_`

**Docstrings:**
- All public classes, functions, methods require docstrings
- Use Google-style docstrings
- Epic 8+ modules: 100% docstring coverage enforced

**Source:** [docs/architecture/source-tree.md](../architecture/source-tree.md)

**Relevant Source Locations:**
- Configuration: `pyproject.toml` ([tool.ruff], [tool.black], [tool.mypy], [project.optional-dependencies])
- Pre-commit config: `.pre-commit-config.yaml`
- CI/CD workflows: `.github/workflows/` (or equivalent for GitLab/other CI)
- Scripts: `scripts/` (mock detection, license checking, performance regression)
- Type-annotated modules: `rustybt/exceptions.py`, `rustybt/utils/logging.py`, `rustybt/utils/error_handling.py`, `rustybt/analytics/*`, `rustybt/utils/secure_pickle.py`
- Documentation: `CONTRIBUTING.md`, `docs/guides/type-hinting.md`, `docs/development/ci-cd-pipeline.md`, `docs/security-audit.md`, `CHANGELOG.md`

### Technical Implementation Guidance

**Ruff Configuration:**
```toml
# pyproject.toml
[tool.ruff]
line-length = 100
target-version = "py312"

[tool.ruff.lint.mccabe]
max-complexity = 10

[tool.ruff.lint.extend-per-file-ignores]
"rustybt/data/bundles/*.py" = ["D100", "D101", "D102"]  # Legacy docstrings
"rustybt/gens/*.py" = ["D100", "D101", "D102"]
```

**Black Configuration:**
```toml
# pyproject.toml
[tool.black]
line-length = 100
target-version = ['py312']
```

**Mypy Configuration (Gradual Typing):**
```toml
# pyproject.toml
[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true  # Global default: strict

[[tool.mypy.overrides]]
module = [
    "rustybt.exceptions",
    "rustybt.utils.logging",
    "rustybt.utils.error_handling",
    "rustybt.analytics.*",  # Epic 8 modules
    "rustybt.utils.secure_pickle",  # Epic 8 modules
]
disallow_untyped_defs = true  # Enforce strict typing

[[tool.mypy.overrides]]
module = [
    "rustybt.data.*",
    "rustybt.gens.*",
    "rustybt.pipeline.*",
    # ... other legacy modules
]
disallow_untyped_defs = false  # Relax for legacy
ignore_errors = false  # But still check for obvious issues

[[tool.mypy.overrides]]
module = [
    "exchange_calendars.*",
    "ccxt.*",
    # ... other external packages without stubs
]
ignore_missing_imports = true
```

**Dependency Split (Production vs Dev):**
```toml
# pyproject.toml
[project.dependencies]
# Core runtime dependencies only
# ... existing production dependencies

[project.optional-dependencies]
test = [
    "pytest>=8.0",
    "pytest-cov>=5.0",
    "freezegun",
    "responses",
    "hypothesis>=6.0",
]

dev = [
    # Jupyter/notebook tools
    "jupyter",
    "jupyterlab",
    "notebook",
    # Type stubs (dev-time only)
    "pandas-stubs",
    "types-networkx",
    "types-requests",
    "types-PyYAML",
    # Heavy dev tools
    "streamlit",  # Only if used in examples/
]
```

**Pre-Commit Hooks:**
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.6.0  # Use latest stable
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format

  - repo: https://github.com/psf/black
    rev: 24.8.0  # Use latest stable
    hooks:
      - id: black

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.11.0  # Use latest stable
    hooks:
      - id: mypy
        additional_dependencies:
          - pandas-stubs
          - types-networkx
          - types-requests
          - types-PyYAML
        # Only run on strict modules to keep fast
        files: ^(rustybt/(exceptions|utils/(logging|error_handling|secure_pickle)|analytics/.*)\.py)$

  - repo: local
    hooks:
      - id: detect-mocks
        name: Detect Mock Patterns
        entry: python scripts/detect_mocks.py --quick
        language: system
        types: [python]
```

**CI/CD Example - Code Quality Job:**
```yaml
# .github/workflows/code-quality.yml
name: Code Quality
on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - run: uv sync -E dev -E test
      - run: ruff check .
      - run: black --check .
      - run: python3 -m mypy
      - run: python scripts/check_complexity.py
```

**CI/CD Example - Zero-Mock Enforcement:**
```yaml
# .github/workflows/zero-mock-enforcement.yml
name: Zero-Mock Enforcement
on: [push, pull_request]

jobs:
  mock-detection:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3

      - name: Detect mock patterns (BLOCKING)
        run: |
          python scripts/detect_mocks.py --strict
          if [ $? -ne 0 ]; then
            echo "::error::Mock patterns detected! Real implementations required."
            exit 1
          fi

      - name: Detect hardcoded values (BLOCKING)
        run: |
          python scripts/detect_hardcoded_values.py --fail-on-found

      - name: Verify validations work (BLOCKING)
        run: |
          python scripts/verify_validations.py --ensure-real-checks

      - name: Test result uniqueness (BLOCKING)
        run: |
          python scripts/test_unique_results.py
```

### Testing

**Source:** [docs/architecture/coding-standards.md](../architecture/coding-standards.md)

**Test Standards:**
- All public functions require unit tests
- Coverage targets: ≥90% for core modules, ≥95% for financial modules
- Use pytest fixtures for test data setup
- Mock external dependencies (broker APIs, network calls)
- No mock implementations in production code (zero-mock enforcement)

**CI Test Commands:**
```bash
# Code quality validation
ruff check .
black --check .
python3 -m mypy

# Zero-mock enforcement
python scripts/detect_mocks.py --strict
python scripts/detect_hardcoded_values.py --fail-on-found
python scripts/verify_validations.py --ensure-real-checks
python scripts/test_unique_results.py

# Security scans
bandit -r rustybt -ll -i
truffleHog --regex --entropy=False .
detect-secrets scan

# Unit tests with coverage
pytest -m "not memory and not api_integration and not live and not ib_integration" \
  --cov=rustybt --cov-report=term --cov-report=html

# Property-based tests
pytest -m property --hypothesis-profile=ci

# Dependency security (weekly)
safety scan --json
pip-audit --format json
python scripts/check_licenses.py

# Performance regression (main branch only)
python -m rustybt benchmark --suite backtest --output benchmark-results.json
python scripts/check_performance_regression.py --threshold=0.20 --baseline=benchmark-baseline.json
```

## Change Log

| Date       | Version | Description                                   | Author    |
|------------|---------|-----------------------------------------------|-----------|
| 2025-10-11 | 1.0     | Initial story creation                        | PM/PO     |
| 2025-10-11 | 2.0     | Consolidated X2.2 + X2.2A/B/C/D content       | SM (Bob)  |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
