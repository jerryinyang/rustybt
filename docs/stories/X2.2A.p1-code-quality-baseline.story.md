# Story X2.2A: P1 Code Quality Baseline

## Status
Draft

## Story

**As a** Software Engineer maintaining RustyBT's codebase quality,
**I want** a clean code quality baseline with enforced linting, formatting, scoped type checking, and pre-commit hooks,
**so that** the codebase maintains high standards, prevents quality drift, and provides a foundation for automated CI/CD quality gates.

## Acceptance Criteria

### Phase 1: Linting & Formatting

1. **Ruff Auto-Fixes Applied**
   - Run `ruff check . --fix` to auto-remediate fixable violations
   - Repeat `ruff check . --fix` until no more auto-fixes available
   - Manually fix remaining violations (invalid noqa directives, annotations, etc.)
   - Configure McCabe complexity limit in `pyproject.toml`: `max-complexity = 10`
   - Final `ruff check .` reports 0 errors (warnings acceptable if documented)
   - Document ruff configuration changes in commit message

2. **Legacy Docstring Enforcement Strategy**
   - Identify legacy files with extensive docstring violations
   - Add per-file ignores to `[tool.ruff.lint.extend-per-file-ignores]` for legacy files
   - Ignore codes: D100 (module docstring), D101 (class docstring), D102 (method docstring) as needed
   - New files (Epic 8+) maintain full docstring compliance
   - Document strategy: "Legacy files exempted, new code strict" in CONTRIBUTING.md

3. **Black Formatting Applied**
   - Run `black .` to format all Python files
   - Verify `black --check .` reports 0 files to reformat
   - Line length configuration matches existing: 100 (check pyproject.toml)
   - No functionality changes from formatting (verified via tests)
   - Commit formatting changes separately from functional changes

### Phase 2: Type Checking

4. **Mypy Strict Enforcement on Scoped Modules**
   - Verify scoped strict modules in pyproject.toml: `rustybt/exceptions.py`, `rustybt/utils/logging.py`, `rustybt/utils/error_handling.py`
   - Add Epic 8 modules to strict list: `rustybt/analytics/*`, `rustybt/utils/secure_pickle.py`
   - Run `python3 -m mypy` (project config) → 0 errors for strict modules
   - Legacy modules use relaxed settings via `[[tool.mypy.overrides]]`
   - Document gradual typing migration strategy in docs/guides/type-hinting.md

5. **Type Stubs**
   - Verify dev extras include: `pandas-stubs`, `types-networkx`, `types-requests`, `types-PyYAML`
   - Add missing stubs if identified during mypy execution
   - Configure `ignore_missing_imports = true` for libraries without stubs: `exchange_calendars`, etc.
   - Document stub availability in type-hinting guide

6. **Low-Hanging Type Annotations**
   - Fix `rustybt/extensions.py` annotations per gap analysis:
     - `extension_args: dict[str, str]` (or appropriate type)
     - `custom_types: dict[str, type]` (or appropriate type)
   - Fix any top-level annotation errors that block mypy execution
   - Run mypy to verify fixes resolve errors

### Phase 3: Pre-Commit Hooks

7. **Basic Quality Hooks Installed**
   - `.pre-commit-config.yaml` includes ruff hook with `--fix` arg
   - `.pre-commit-config.yaml` includes black hook
   - `.pre-commit-config.yaml` includes mypy hook (scoped to strict modules)
   - Run `pre-commit install` and document in CONTRIBUTING.md
   - Run `pre-commit run --all-files` passes successfully
   - Hooks tested with sample commit (verify they run and block bad commits)

### Integration Requirements

8. **Existing Functionality Unchanged**
   - Full test suite passes after formatting/linting: `pytest -m "not memory and not api_integration and not live and not ib_integration"`
   - Smoke test: bundle ingestion, backtest execution, report generation
   - Manual verification: paper trading starts successfully
   - No functionality changes from code quality fixes (pure style/type changes)

9. **Code Quality Enforcement Follows Existing Patterns**
   - Ruff configuration extends existing `[tool.ruff]` settings
   - Black configuration matches existing line length and style
   - Mypy overrides extend existing `[[tool.mypy.overrides]]` pattern
   - Pre-commit hooks follow existing `.pre-commit-config.yaml` structure

10. **Development Workflow Integration**
    - Pre-commit hooks run fast (< 5 seconds for typical commit)
    - Hooks provide clear error messages when blocking commits
    - IDE integrations work (VS Code, PyCharm support ruff/black/mypy)
    - Documentation guides new contributors through setup: `pre-commit install`

### Quality Requirements

11. **Changes Covered by Tests**
    - Test suite passes with new code quality tools
    - Mypy strict modules have unit tests with good coverage
    - No new untested code introduced by fixes
    - Pre-commit hooks tested with sample commits

12. **Documentation Updated**
    - `CONTRIBUTING.md` documents pre-commit setup: `pre-commit install`
    - `CONTRIBUTING.md` documents legacy docstring exemption strategy
    - `docs/guides/type-hinting.md` updated with gradual typing strategy
    - `docs/guides/type-hinting.md` lists strict modules and migration plan
    - Verify 100% docstring coverage for all public APIs in Epic 8 modules using `docstr-coverage` tool

13. **No Regression Verified**
    - Full test suite passes: `pytest -m "not memory and not api_integration and not live and not ib_integration"`
    - Coverage remains ≥90% for core modules
    - Pre-commit hooks do not block legitimate commits

## Tasks / Subtasks

- [ ] **Task 1: Ruff Linting** (AC: 1-2)
  - [ ] Run `ruff check . --fix` (repeat until stable)
  - [ ] Manually fix remaining violations (invalid noqa, annotations)
  - [ ] Configure McCabe complexity: `max-complexity = 10` in pyproject.toml
  - [ ] Add legacy docstring exemptions to `[tool.ruff.lint.extend-per-file-ignores]`
  - [ ] Verify: `ruff check .` → 0 errors
  - [ ] Document strategy in CONTRIBUTING.md

- [ ] **Task 2: Black Formatting** (AC: 3)
  - [ ] Run `black .` to format all files
  - [ ] Verify: `black --check .` → 0 files to reformat
  - [ ] Verify line length configuration (100)
  - [ ] Run test suite to verify no functionality changes
  - [ ] Commit formatting changes separately

- [ ] **Task 3: Mypy Type Checking** (AC: 4-6)
  - [ ] Verify scoped strict modules in pyproject.toml
  - [ ] Add Epic 8 modules to strict list: `analytics/*`, `utils/secure_pickle.py`
  - [ ] Fix `rustybt/extensions.py` annotations
  - [ ] Fix any top-level annotation errors
  - [ ] Verify dev extras include type stubs: pandas-stubs, types-networkx, types-requests, types-PyYAML
  - [ ] Configure `ignore_missing_imports` for libraries without stubs
  - [ ] Run: `python3 -m mypy` → 0 errors for strict modules
  - [ ] Document gradual typing strategy in docs/guides/type-hinting.md

- [ ] **Task 4: Pre-Commit Hooks Configuration** (AC: 7)
  - [ ] Create/update `.pre-commit-config.yaml` with ruff hook (--fix)
  - [ ] Add black hook to `.pre-commit-config.yaml`
  - [ ] Add mypy hook to `.pre-commit-config.yaml` (scoped to strict modules)
  - [ ] Run `pre-commit install`
  - [ ] Run `pre-commit run --all-files` → verify passes
  - [ ] Test with sample commit → verify hooks run and block bad commits
  - [ ] Document setup in CONTRIBUTING.md

- [ ] **Task 5: Integration Testing** (AC: 8-10)
  - [ ] Run full test suite after all changes
  - [ ] Run smoke tests: bundle ingestion, backtest, report generation
  - [ ] Verify paper trading starts successfully
  - [ ] Verify no functionality changes (pure style/type changes)
  - [ ] Verify pre-commit hooks run fast (< 5s)
  - [ ] Verify IDE integrations work

- [ ] **Task 6: Documentation Updates** (AC: 12)
  - [ ] Update CONTRIBUTING.md with pre-commit setup
  - [ ] Document legacy docstring exemption strategy in CONTRIBUTING.md
  - [ ] Update docs/guides/type-hinting.md with gradual typing strategy
  - [ ] Verify 100% docstring coverage for Epic 8 modules

- [ ] **Task 7: Final Validation** (AC: 13)
  - [ ] Run full test suite → all pass
  - [ ] Verify coverage ≥90% for core modules
  - [ ] Verify pre-commit hooks work correctly
  - [ ] Create summary report of all changes

## Dev Notes

### Architecture Context

**Source:** [docs/architecture/tech-stack.md](../architecture/tech-stack.md)

**Code Quality Tools:**
- ruff >= 0.11.12 (fast linter, replaces flake8/isort/pyupgrade)
- black 24.1+ (code formatter)
- mypy >= 1.10.0 (static type checker with --strict)

**Package Manager:**
- uv 0.5.x+ (10-100x faster than pip)
- Lockfile-based dependency resolution

**Python Version:** 3.12+ required

**Source:** [docs/architecture/coding-standards.md](../architecture/coding-standards.md)

**Type Hints:**
- 100% type hint coverage for public APIs
- `mypy --strict` compliance enforced in CI/CD for scoped modules
- Gradual migration: strict for new code (Epic 8+), relaxed for legacy

**Code Formatting:**
- black (line length: 100, target: py312)
- ruff linting (comprehensive rule set)
- Configuration in `pyproject.toml`

**Naming Conventions:**
- Classes: `PascalCase`
- Functions/methods: `snake_case`
- Constants: `UPPER_SNAKE_CASE`
- Private members: prefix with `_`

**Docstrings:**
- All public classes, functions, methods require docstrings
- Use Google-style docstrings
- Epic 8+ modules: 100% docstring coverage enforced

**Source:** [docs/architecture/source-tree.md](../architecture/source-tree.md)

**Relevant Source Locations:**
- Configuration: `pyproject.toml` ([tool.ruff], [tool.black], [tool.mypy])
- Pre-commit config: `.pre-commit-config.yaml`
- Type-annotated modules: `rustybt/exceptions.py`, `rustybt/utils/logging.py`, `rustybt/utils/error_handling.py`, `rustybt/analytics/*`, `rustybt/utils/secure_pickle.py`
- Documentation: `CONTRIBUTING.md`, `docs/guides/type-hinting.md`

### Technical Implementation Guidance

**Ruff Configuration:**
```toml
# pyproject.toml
[tool.ruff]
line-length = 100
target-version = "py312"

[tool.ruff.lint.mccabe]
max-complexity = 10

[tool.ruff.lint.extend-per-file-ignores]
"rustybt/data/bundles/*.py" = ["D100", "D101", "D102"]  # Legacy docstrings
"rustybt/gens/*.py" = ["D100", "D101", "D102"]
```

**Black Configuration:**
```toml
# pyproject.toml
[tool.black]
line-length = 100
target-version = ['py312']
```

**Mypy Configuration (Gradual Typing):**
```toml
# pyproject.toml
[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true  # Global default: strict

[[tool.mypy.overrides]]
module = [
    "rustybt.exceptions",
    "rustybt.utils.logging",
    "rustybt.utils.error_handling",
    "rustybt.analytics.*",  # Epic 8 modules
    "rustybt.utils.secure_pickle",  # Epic 8 modules
]
disallow_untyped_defs = true  # Enforce strict typing

[[tool.mypy.overrides]]
module = [
    "rustybt.data.*",
    "rustybt.gens.*",
    "rustybt.pipeline.*",
    # ... other legacy modules
]
disallow_untyped_defs = false  # Relax for legacy
ignore_errors = false  # But still check for obvious issues

[[tool.mypy.overrides]]
module = [
    "exchange_calendars.*",
    "ccxt.*",
    # ... other external packages without stubs
]
ignore_missing_imports = true
```

**Pre-Commit Hooks:**
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.6.0  # Use latest stable
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format

  - repo: https://github.com/psf/black
    rev: 24.8.0  # Use latest stable
    hooks:
      - id: black

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.11.0  # Use latest stable
    hooks:
      - id: mypy
        additional_dependencies:
          - pandas-stubs
          - types-networkx
          - types-requests
          - types-PyYAML
        # Only run on strict modules to keep fast
        files: ^(rustybt/(exceptions|utils/(logging|error_handling|secure_pickle)|analytics/.*)\.py)$
```

### Testing

**Source:** [docs/architecture/coding-standards.md](../architecture/coding-standards.md)

**Test File Locations:**
- All existing test files remain in `tests/` directory structure
- No new test files required (pure code quality changes)

**Test Standards:**
- All public functions require unit tests
- Coverage targets: ≥90% for core modules, ≥95% for financial modules
- Use pytest fixtures for test data setup

**Testing Frameworks:**
- pytest for unit/integration tests
- pytest-cov for coverage measurement

**CI Test Commands:**
```bash
# Code quality validation
ruff check .
black --check .
python3 -m mypy

# Unit tests with coverage
pytest -m "not memory and not api_integration and not live and not ib_integration" \
  --cov=rustybt --cov-report=term --cov-report=html
```

## Change Log

| Date       | Version | Description                                   | Author    |
|------------|---------|-----------------------------------------------|-----------|
| 2025-10-11 | 1.0     | Split from X2.2 per Epic X2 structure         | PO (Sarah)|

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
