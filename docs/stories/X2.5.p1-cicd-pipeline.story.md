# Story X2.5: P1 CI/CD Pipeline

## Status
Draft

## Story

**As a** DevOps Engineer establishing automated quality gates,
**I want** a comprehensive CI/CD pipeline with 6 workflow files covering code quality, zero-mock enforcement, security, testing, dependency security, and performance,
**so that** all quality checks are automated, branch protection is enforced, and production deployments meet all standards.

## Acceptance Criteria

### CI/CD Workflow Files

1. **Code Quality CI Job**
   - Create `.github/workflows/code-quality.yml`
   - BLOCKING: `ruff check .` (must pass with 0 errors)
   - BLOCKING: `black --check .` (must pass with 0 files to reformat)
   - BLOCKING: `python3 -m mypy` (must pass for scoped modules)
   - BLOCKING: `python scripts/check_complexity.py` (McCabe ≤10 for all functions)
   - Branch protection rules require this job to pass before merge

2. **Zero-Mock Enforcement CI Job**
   - Activate `.github/workflows/zero-mock-enforcement.yml` (prepared in Story X2.4)
   - BLOCKING: `python scripts/detect_mocks.py --strict` (0 mock patterns)
   - BLOCKING: `python scripts/detect_hardcoded_values.py --fail-on-found` (0 hardcoded values)
   - BLOCKING: `python scripts/verify_validations.py --ensure-real-checks` (all validators work)
   - BLOCKING: `python scripts/test_unique_results.py` (unique outputs)
   - Branch protection rules require this job to pass before merge

3. **Security CI Job**
   - Create `.github/workflows/security.yml`
   - BLOCKING: `bandit -r rustybt -ll -i` (0 High severity issues)
   - BLOCKING: `truffleHog --regex --entropy=False .` (0 secrets detected)
   - BLOCKING: `detect-secrets scan` (0 secrets detected)
   - Branch protection rules require this job to pass before merge

4. **Testing CI Job**
   - Create `.github/workflows/testing.yml`
   - Run unit tests: `pytest -m "not memory and not api_integration and not live and not ib_integration" --cov=rustybt --cov-report=term --cov-report=html`
   - Verify coverage: Core modules ≥90%, financial modules ≥95%
   - Run property-based tests: `pytest -m "property" --hypothesis-profile=ci`
   - Upload coverage reports as artifacts
   - BLOCKING: Coverage thresholds must be met

5. **Dependency Security CI Job (Weekly)**
   - Create `.github/workflows/dependency-security.yml` (scheduled: weekly)
   - `safety scan --json > safety-report.json`
   - `pip-audit --format json > pip-audit-report.json`
   - `python scripts/check_licenses.py` (verify no GPL-licensed dependencies)
   - Upload security reports as artifacts
   - NON-BLOCKING: Creates issues for vulnerabilities but doesn't block merges

6. **Performance Regression CI Job (Main Branch Only)**
   - Create `.github/workflows/performance.yml` (on main branch after merge)
   - `python -m rustybt benchmark --suite backtest --output benchmark-results.json`
   - `python scripts/check_performance_regression.py --threshold=0.20 --baseline=benchmark-baseline.json`
   - Fail if performance degrades >20%
   - NON-BLOCKING: Creates issues for regressions but doesn't block merges

### Branch Protection & Documentation

7. **Branch Protection Rules Configured**
   - Require status checks to pass before merging
   - Required checks: code-quality, zero-mock-enforcement, security, testing
   - Require branches to be up to date before merging
   - Require pull request reviews (at least 1 approval)

8. **PR Template Created**
   - Create `.github/pull_request_template.md`
   - Include checklist for: code quality, tests, documentation, zero-mock compliance
   - Include links to relevant documentation

9. **CI/CD Documentation**
   - Create `docs/development/ci-cd-pipeline.md`
   - Document all 6 workflows
   - Document branch protection rules
   - Document how to debug CI failures
   - Document CI performance expectations (< 12 minutes total)

### Quality Requirements

10. **CI Performance Optimized**
    - All workflows run in parallel where possible
    - Total CI execution time < 12 minutes for typical PR
    - Caching configured for dependencies (uv, pip)
    - Matrix strategies used for parallel test execution where applicable

11. **No Regression Verified**
    - All CI workflows pass on current codebase
    - Branch protection doesn't block legitimate work
    - CI provides clear, actionable error messages

## Tasks / Subtasks

- [ ] **Task 1: Create Code Quality Workflow** (AC: 1)
  - [ ] Create `.github/workflows/code-quality.yml`
  - [ ] Add ruff linting job (BLOCKING)
  - [ ] Add black formatting check job (BLOCKING)
  - [ ] Add mypy type checking job (BLOCKING)
  - [ ] Add McCabe complexity check job (BLOCKING)
  - [ ] Configure Python 3.12, uv installation
  - [ ] Test workflow locally with `act`
  - [ ] Commit and test in CI

- [ ] **Task 2: Activate Zero-Mock Enforcement Workflow** (AC: 2)
  - [ ] Verify workflow file exists from X2.4: `.github/workflows/zero-mock-enforcement.yml`
  - [ ] Verify all 4 detection scripts exist in `scripts/`
  - [ ] Test workflow locally with `act`
  - [ ] Enable workflow (remove any disabled flags)
  - [ ] Verify BLOCKING configuration
  - [ ] Test with sample PR

- [ ] **Task 3: Create Security Workflow** (AC: 3)
  - [ ] Create `.github/workflows/security.yml`
  - [ ] Add bandit SAST job (BLOCKING)
  - [ ] Add truffleHog secrets detection job (BLOCKING)
  - [ ] Add detect-secrets job (BLOCKING)
  - [ ] Configure fetch-depth: 0 for truffleHog
  - [ ] Test workflow locally with `act`
  - [ ] Commit and test in CI

- [ ] **Task 4: Create Testing Workflow** (AC: 4)
  - [ ] Create `.github/workflows/testing.yml`
  - [ ] Add unit test job with coverage (BLOCKING)
  - [ ] Configure coverage thresholds: ≥90% core, ≥95% financial
  - [ ] Add property-based test job (BLOCKING)
  - [ ] Configure hypothesis profile: ci
  - [ ] Add coverage report upload to Codecov
  - [ ] Add HTML coverage artifact upload
  - [ ] Test workflow locally with `act`
  - [ ] Commit and test in CI

- [ ] **Task 5: Create Dependency Security Workflow** (AC: 5)
  - [ ] Create `.github/workflows/dependency-security.yml`
  - [ ] Configure weekly schedule: `cron: '0 2 * * 1'`
  - [ ] Add workflow_dispatch for manual trigger
  - [ ] Add safety scan job
  - [ ] Add pip-audit job
  - [ ] Add license check job (BLOCKING)
  - [ ] Configure artifact upload for reports
  - [ ] Add issue creation on failure
  - [ ] Test workflow manually

- [ ] **Task 6: Create Performance Regression Workflow** (AC: 6)
  - [ ] Create `.github/workflows/performance.yml`
  - [ ] Configure to run on main branch only
  - [ ] Add benchmark execution job
  - [ ] Add regression check job (threshold: 20%)
  - [ ] Configure artifact upload for benchmark results
  - [ ] Add issue creation on regression
  - [ ] Create baseline: `benchmark-baseline.json`
  - [ ] Create script: `scripts/check_performance_regression.py`
  - [ ] Test workflow on main branch

- [ ] **Task 7: Configure Branch Protection** (AC: 7)
  - [ ] Navigate to GitHub repository settings → Branches
  - [ ] Create branch protection rule for `main`
  - [ ] Enable "Require status checks to pass before merging"
  - [ ] Add required checks: code-quality, zero-mock-enforcement, security, test
  - [ ] Enable "Require branches to be up to date before merging"
  - [ ] Enable "Require pull request reviews before merging" (1 approval)
  - [ ] Save branch protection rules
  - [ ] Test with sample PR

- [ ] **Task 8: Create PR Template** (AC: 8)
  - [ ] Create `.github/pull_request_template.md`
  - [ ] Add description section
  - [ ] Add type of change section
  - [ ] Add code quality checklist
  - [ ] Add zero-mock compliance checklist
  - [ ] Add testing checklist
  - [ ] Add security checklist
  - [ ] Add documentation checklist
  - [ ] Add related issues section
  - [ ] Test with sample PR

- [ ] **Task 9: Write CI/CD Documentation** (AC: 9)
  - [ ] Create `docs/development/ci-cd-pipeline.md`
  - [ ] Document all 6 workflows with purpose and triggers
  - [ ] Document branch protection rules
  - [ ] Document required checks
  - [ ] Document how to debug CI failures
  - [ ] Document CI performance expectations (< 12 minutes)
  - [ ] Add workflow diagrams (optional but recommended)
  - [ ] Add troubleshooting guide for common CI issues

- [ ] **Task 10: Optimize CI Performance** (AC: 10)
  - [ ] Add dependency caching to all workflows (uv cache)
  - [ ] Verify parallel execution configuration
  - [ ] Measure actual CI execution time
  - [ ] Optimize slowest jobs (likely testing)
  - [ ] Configure matrix strategies where applicable
  - [ ] Document caching strategy
  - [ ] Verify target: < 12 minutes total

- [ ] **Task 11: Final Validation** (AC: 11)
  - [ ] Create test PR to verify all workflows run
  - [ ] Verify all workflows pass on current codebase
  - [ ] Verify branch protection blocks merge until checks pass
  - [ ] Verify PR template renders correctly
  - [ ] Verify CI provides clear error messages
  - [ ] Verify CI performance < 12 minutes
  - [ ] Document any issues found

## Dev Notes

### Architecture Context

**Source:** [docs/architecture/tech-stack.md](../architecture/tech-stack.md)

**CI/CD Stack:**
- GitHub Actions (workflow orchestration)
- Parallel job execution for speed (target: < 12 minutes total)
- Branch protection rules (require status checks)
- Artifact archiving (coverage reports, security scans, benchmark results)

**Python Version:** 3.12+ required

**Source:** [docs/architecture/coding-standards.md](../architecture/coding-standards.md)

**Code Quality Tools:**
- ruff >= 0.11.12 (linting)
- black 24.1+ (formatting)
- mypy >= 1.10.0 (type checking)
- McCabe complexity: ≤10 per function

**Security Tools:**
- bandit (SAST - static analysis)
- truffleHog (secrets detection)
- detect-secrets (secrets detection)
- safety (dependency vulnerability scanning)
- pip-audit (dependency security auditing)

**Testing Tools:**
- pytest >= 7.2.0 (test framework)
- pytest-cov >= 3.0.0 (coverage measurement)
- hypothesis >= 6.0 (property-based testing)
- Coverage targets: ≥90% core, ≥95% financial

**Source:** [docs/architecture/source-tree.md](../architecture/source-tree.md)

**Relevant Source Locations:**
- CI workflows: `.github/workflows/` (6 workflow files to create)
- Scripts: `scripts/` (check_complexity.py, check_licenses.py, check_performance_regression.py)
- Zero-mock scripts: `scripts/` (from X2.4: detect_mocks.py, detect_hardcoded_values.py, verify_validations.py, test_unique_results.py)
- Configuration: `pyproject.toml` (tool configurations)
- Branch protection: GitHub repository settings
- PR template: `.github/pull_request_template.md`
- Documentation: `docs/development/ci-cd-pipeline.md`

### Technical Implementation Guidance

**Workflow 1: Code Quality CI Job**

**File:** `.github/workflows/code-quality.yml`

```yaml
name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync -E dev -E test

      - name: Run ruff linting (BLOCKING)
        run: |
          uv run ruff check .

      - name: Run black formatting check (BLOCKING)
        run: |
          uv run black --check .

      - name: Run mypy type checking (BLOCKING)
        run: |
          uv run python3 -m mypy

      - name: Check code complexity (BLOCKING)
        run: |
          uv run python scripts/check_complexity.py --max-complexity 10
```

**Workflow 2: Zero-Mock Enforcement CI Job**

**File:** `.github/workflows/zero-mock-enforcement.yml`

```yaml
name: Zero-Mock Enforcement

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  zero-mock-enforcement:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync -E dev -E test

      - name: Detect mock patterns (BLOCKING)
        run: |
          uv run python scripts/detect_mocks.py --strict

      - name: Detect hardcoded values (BLOCKING)
        run: |
          uv run python scripts/detect_hardcoded_values.py --fail-on-found

      - name: Verify validation functions (BLOCKING)
        run: |
          uv run python scripts/verify_validations.py --ensure-real-checks

      - name: Test result uniqueness (BLOCKING)
        run: |
          uv run python scripts/test_unique_results.py
```

**Workflow 3: Security CI Job**

**File:** `.github/workflows/security.yml`

```yaml
name: Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for truffleHog

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync -E dev -E test

      - name: Run bandit SAST (BLOCKING)
        run: |
          uv run bandit -r rustybt -ll -i

      - name: Install truffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Run truffleHog secrets detection (BLOCKING)
        run: |
          trufflehog git file://. --since-commit HEAD~1 --fail

      - name: Run detect-secrets (BLOCKING)
        run: |
          uv run detect-secrets scan --baseline .secrets.baseline
```

**Workflow 4: Testing CI Job**

**File:** `.github/workflows/testing.yml`

```yaml
name: Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync -E test

      - name: Run unit tests with coverage (BLOCKING)
        run: |
          uv run pytest -m "not memory and not api_integration and not live and not ib_integration" \
            --cov=rustybt \
            --cov-report=term \
            --cov-report=html \
            --cov-report=xml \
            --cov-fail-under=90

      - name: Run property-based tests (BLOCKING)
        run: |
          uv run pytest -m property --hypothesis-profile=ci

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

      - name: Archive coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: htmlcov/
```

**Workflow 5: Dependency Security CI Job (Weekly)**

**File:** `.github/workflows/dependency-security.yml`

```yaml
name: Dependency Security

on:
  schedule:
    - cron: '0 2 * * 1'  # Monday 2 AM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  dependency-security:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync -E dev -E test

      - name: Run safety scan
        run: |
          uv run safety scan --json > safety-report.json || true

      - name: Run pip-audit
        run: |
          uv run pip-audit --format json > pip-audit-report.json || true

      - name: Check licenses (BLOCKING)
        run: |
          uv run python scripts/check_licenses.py

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            safety-report.json
            pip-audit-report.json

      - name: Create issue if vulnerabilities found
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Weekly Dependency Security Scan: Vulnerabilities Found',
              body: 'Automated dependency security scan found vulnerabilities. Check workflow artifacts for details.',
              labels: ['security', 'dependencies']
            })
```

**Workflow 6: Performance Regression CI Job (Main Branch Only)**

**File:** `.github/workflows/performance.yml`

```yaml
name: Performance Regression

on:
  push:
    branches: [ main ]

jobs:
  performance:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync -E test

      - name: Run benchmark suite
        run: |
          uv run python -m rustybt benchmark --suite backtest --output benchmark-results.json

      - name: Check performance regression
        run: |
          uv run python scripts/check_performance_regression.py \
            --threshold=0.20 \
            --baseline=benchmark-baseline.json \
            --current=benchmark-results.json || true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: benchmark-results.json

      - name: Create issue if regression detected
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Performance Regression Detected',
              body: 'Benchmark execution exceeded threshold. Check workflow artifacts for details.',
              labels: ['performance', 'regression']
            })
```

**Branch Protection Configuration:**

**GitHub Repository Settings → Branches → Branch protection rules:**

```yaml
# Branch: main
Require status checks to pass before merging: [x]
  Required status checks:
    - code-quality / code-quality
    - zero-mock-enforcement / zero-mock-enforcement
    - security / security
    - test / test (3.12)

Require branches to be up to date before merging: [x]
Require pull request reviews before merging: [x]
  Required approving reviews: 1
```

**PR Template:**

**File:** `.github/pull_request_template.md`

```markdown
## Description

<!-- Brief description of changes -->

## Type of Change

- [ ] Bug fix (non-breaking change which fixes an issue)
- [ ] New feature (non-breaking change which adds functionality)
- [ ] Breaking change (fix or feature that would cause existing functionality to not work as expected)
- [ ] Documentation update

## Checklist

### Code Quality
- [ ] Code follows style guidelines (ruff + black)
- [ ] Type hints added/updated (mypy strict for new code)
- [ ] Code complexity ≤10 (McCabe)
- [ ] No code quality violations

### Zero-Mock Compliance
- [ ] No mock/fake/stub implementations
- [ ] No hardcoded return values
- [ ] All validators reject invalid data
- [ ] Different inputs produce different outputs

### Testing
- [ ] Unit tests added/updated
- [ ] Property-based tests added (if applicable)
- [ ] All tests pass locally
- [ ] Coverage ≥90% (core modules), ≥95% (financial modules)

### Security
- [ ] No secrets committed
- [ ] No High severity bandit issues
- [ ] Dependencies reviewed for vulnerabilities
- [ ] Security best practices followed

### Documentation
- [ ] Code comments added for complex logic
- [ ] Docstrings added/updated
- [ ] README updated (if needed)
- [ ] CHANGELOG.md updated

## Related Issues

Closes #<!-- issue number -->

## Test Plan

<!-- Describe how you tested this change -->

## Screenshots (if applicable)

<!-- Add screenshots for UI changes -->
```

**CI/CD Performance Optimization:**

**Caching Strategy:**
```yaml
# Add to all workflows that install dependencies
- name: Cache uv dependencies
  uses: actions/cache@v3
  with:
    path: |
      ~/.cache/uv
      ~/.local/share/uv
    key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
    restore-keys: |
      ${{ runner.os }}-uv-
```

**Parallel Execution Strategy:**
- Workflows 1-4 run in parallel on every PR (total: ~8-10 minutes)
- Workflow 5 runs weekly (independent)
- Workflow 6 runs on main only (non-blocking)

**Expected CI Timeline:**
- Code quality: ~2 minutes
- Zero-mock enforcement: ~1 minute
- Security: ~3 minutes
- Testing: ~5-8 minutes (longest job)
- **Total parallel execution:** ~8-10 minutes (limited by longest job)

### Testing

**Source:** [docs/architecture/testing-strategy.md](../architecture/testing-strategy.md)

**Test Standards:**
- CI workflows tested locally using `act` (GitHub Actions local runner)
- Branch protection rules tested with test PRs
- PR template tested with sample PR
- Performance targets verified: < 12 minutes total execution

**Testing Commands:**

```bash
# Test workflows locally with act
act -j code-quality  # Test code quality workflow
act -j zero-mock-enforcement  # Test zero-mock workflow
act -j security  # Test security workflow
act -j test  # Test testing workflow

# Test branch protection (must be done via GitHub UI)
# Create test PR and verify:
# 1. All required checks appear
# 2. Merge blocked until checks pass
# 3. Reviews required

# Test PR template
# Create test PR and verify template renders correctly
```

**CI Integration Tests:**

```bash
# Verify all workflow files are valid YAML
yamllint .github/workflows/*.yml

# Verify all scripts referenced in workflows exist
test -f scripts/check_complexity.py || echo "Missing check_complexity.py"
test -f scripts/detect_mocks.py || echo "Missing detect_mocks.py"
test -f scripts/detect_hardcoded_values.py || echo "Missing detect_hardcoded_values.py"
test -f scripts/verify_validations.py || echo "Missing verify_validations.py"
test -f scripts/test_unique_results.py || echo "Missing test_unique_results.py"
test -f scripts/check_licenses.py || echo "Missing check_licenses.py"
test -f scripts/check_performance_regression.py || echo "Missing check_performance_regression.py"

# Verify all tools are installed
uv run ruff --version
uv run black --version
uv run mypy --version
uv run bandit --version
uv run pytest --version
```

## Change Log

| Date       | Version | Description                          | Author    |
|------------|---------|--------------------------------------|-----------|
| 2025-10-11 | 1.0     | Initial story creation, renumbered   | SM (Bob)  |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
